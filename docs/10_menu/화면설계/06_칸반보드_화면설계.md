# 06. 칸반 보드 화면설계

> 작성일: 2026-02-08
> 버전: v2.1
> 라우트: `/kanban`
> 필요 Capability: `view_kanban` (조회), `manage_kanban` (카드 이동/편집)
> 기본 Preset: 역할에 따라 자동 결정
> 노드 역할: **Action** (실행 노드 -- Task 상태 변경/이동/할당 전용)

> **v2.0 변경**: FilterSpec URL 직렬화 규칙 확정, Swimlane 렌더링 정책 확정,
> DnD(dnd-kit) 상태 머신 정의, WIP Limit 초과 시 서버/UI 동작 확정,
> BLOCKED swimlane 분리 정책, Cycle Time/Lead Time 계산 규칙 확정,
> Card Detail Right Panel 구조 확정, AI Navigation 연동 virtualNode 5종 정의.
>
> **v2.1 변경**: FilterSpec `view` 키 추가(wip-exceeded 온톨로지 승격),
> KanbanCard `createdAt` 필드 추가(Lead Time 기준 시각 확정),
> WIP Count 정의 확정(`IN_PROGRESS + IN_REVIEW`, BLOCKED 제외),
> WipLimitConfig `warningThreshold` 제거(계산 함수 단일 소스),
> Metrics 네이밍 정리(`avgCycleTimeWindow`/`avgCycleTimeAllTime`),
> MoveTaskRequest `expectedVersion` 추가(낙관적 락 동시성 제어),
> Scope 강제 정책 고정(읽기: 강제 재작성+echo / 쓰기: 403),
> Reliability 3-tuple 표준화(`warnings: {code,message,severity}[]`),
> ScopeEcho 보안 경계 세분화(`role_restricted_assignee`/`role_restricted_part`),
> Scope 2-tier(`securityKeys`+`explorationKeys`) 패턴 적용.

---

## 1. 화면 개요

### 1.1 목적

칸반 보드는 **"지금 어떻게 흐르는가?"**에 대한 답을 제공한다.
백로그(03_백로그)에서 4계층 트리로 **"무엇을 할 것인가"**를 정의했다면,
칸반 보드에서는 그 중 Level 4(Task)를 카드로 시각화하여 **실행 흐름을 관리**한다.

> **핵심 분리 원칙**: 백로그 = 계획/편성 홈, 칸반 = **실행 홈**, 스프린트 = 운영 홈.
> 칸반에서는 Task의 상태 전이(TODO -> IN_PROGRESS -> IN_REVIEW -> DONE)와
> 병목 탐지(WIP Limit, BLOCKED)에 집중한다.

### 1.2 설계 원칙

| 원칙 | 설명 |
|------|------|
| **컬럼 = Task 상태** | TODO / IN_PROGRESS / IN_REVIEW / DONE 4개 컬럼 + BLOCKED 수평 swimlane |
| **카드 = Task** | Level 4 엔티티(backlog.ts `Task`)가 카드 단위 |
| **DnD = 상태 전이** | 카드를 다른 컬럼으로 드래그하면 Task.status가 변경됨 |
| **WIP Limit** | 컬럼별 동시 진행 가능 수를 PM이 설정, 초과 시 시각 경고 |
| **Capability 기반 DnD** | `manage_kanban` 없으면 DnD 비활성 + ReadOnlyBanner 표시 |
| **FilterSpec = 온톨로지** | 필터 키가 AI/URL/백엔드 공통 스키마로 통합 |
| **Swimlane 선택** | 기본: 없음(플랫), 옵션: By Assignee / By Story / By Priority |
| **Part 기반 스코프** | DevReader는 자신의 Part에 속한 Task만 표시, 서버에서 강제 |
| **Metrics 실시간** | WIP Count, Cycle Time, Throughput, Blocked Count를 상단 KPI에 표시 |
| **WIP Count = IN_PROGRESS + IN_REVIEW** | BLOCKED는 WIP에 포함하지 않음 -- blockedCount로 별도 집계. TODO/DONE도 제외 |
| **동시성 = 낙관적 락** | Task 이동 시 `expectedVersion`을 포함하여 동시 수정 충돌을 서버에서 감지(409) |
| **Scope 강제 정책** | 읽기(GET): 서버가 allowedPartIds로 강제 재작성 + scope echo 200 / 쓰기(PATCH): Part 위반 시 403 |

### 1.3 행동 무게중심 -- 3개 화면의 역할 분담

> 03_백로그 $1.3과 동일한 구조를 칸반 관점에서 재정의한다.

| 화면 | 역할 | 핵심 행동 |
|------|------|---------|
| **백로그** | **계획/편성 홈** | Epic/Story 생성, Story 정제, SP 추정, Sprint 할당 |
| **칸반** (본 화면) | **실행 홈** | Task 상태 변경, 담당자 배정, 코드리뷰 흐름, 완료 처리 |
| **스프린트** | **운영 홈** | Sprint 구성, 속도 측정, Burndown, 회고 |

**Preset별 AI 라우팅 정책 (do_move_task 예시)**:

| Preset | "태스크 이동해줘" -> AI 라우팅 | 이유 |
|--------|-------------------------------|------|
| PM_WORK | -> `targetNodeId: "kanban"` | PM은 전체 보드에서 흐름 관리 |
| PMO_CONTROL | -> `targetNodeId: "kanban"` | PMO는 병목 확인 후 조치 |
| DEV_EXECUTION | -> `targetNodeId: "kanban"` | DEV는 내 카드 이동 |

```typescript
/** Preset별 do intent 라우팅 정책 */
export const DO_INTENT_ROUTING_KANBAN: Record<ViewModePreset, Record<string, string>> = {
  PM_WORK: {
    do_move_task:    "kanban",
    do_assign_task:  "kanban",
    do_create_issue: "issues",
  },
  PMO_CONTROL: {
    do_move_task:    "kanban",
    do_assign_task:  "kanban",
    do_create_issue: "issues",
  },
  DEV_EXECUTION: {
    do_move_task:    "kanban",
    do_assign_task:  "kanban",
    do_create_issue: "issues",
  },
  EXEC_SUMMARY: {
    do_move_task:    "kanban",
    do_assign_task:  "kanban",
    do_create_issue: "issues",
  },
  CUSTOMER_APPROVAL: {
    do_move_task:    "kanban",
    do_assign_task:  "kanban",
    do_create_issue: "issues",
  },
};
```

> **핵심**: 칸반은 모든 Preset에서 "실행 홈"이다. do_move_task / do_assign_task는
> 어떤 Preset이든 칸반으로 라우팅된다. 이는 백로그/스프린트와의 역할 분담이 명확하기 때문이다.

### 1.4 핵심 질문 -> 위젯 매핑

| 사용자 질문 | 화면 영역 | 설명 |
|-----------|---------|------|
| "지금 병목이 어디야?" | KPI Row + WIP Limit 경고 | WIP 초과 컬럼 하이라이트 |
| "In Progress에 머물러 있는 태스크가 몇 개야?" | IN_PROGRESS 컬럼 | 컬럼 카드 수 + Cycle Time |
| "이번 주 완료된 작업은?" | DONE 컬럼 + Throughput KPI | 완료 카드 수 |
| "내 태스크를 Done으로 옮기고 싶어" | DnD 인터랙션 | manage_kanban 필요 |
| "BLOCKED 된 태스크가 뭐야?" | BLOCKED swimlane | BLOCKED 카드 목록 |
| "내 할당 태스크만 보여줘" | 필터 assigneeId=me | DEV_EXECUTION 기본 필터 |
| "이 스프린트 칸반 보여줘" | 필터 sprintId | Sprint별 칸반 필터 |
| "태스크 TSK-142를 김○○에게 할당해줘" | Quick Assign | Card 컨텍스트 메뉴 |
| "평균 Cycle Time이 얼마야?" | KPI Row | avg_cycle_time 지표 |
| "우선순위 높은 태스크만 보여줘" | 필터 priority=HIGH | 우선순위 필터 |

---

## 2. MenuOntology 노드

### 2.1 타입 확정 (v2.1 변경사항)

01_대시보드 / 02_요구사항 / 03_백로그 v2.0 패턴을 동일하게 적용한다.

| 항목 | v1.0 (00_총괄) | v2.0 (확정) | v2.1 (확정) | 변경 사유 |
| ------ | ------ | ------ | ------ | ---------- |
| `entities` | `["task", "sprint", "user"]` | `["Task", "Sprint", "User", "Story"]` | v2.0 유지 | PascalCase 정규화 + Story 추가 |
| `intents` | 5개 | **8개** 확장 | v2.0 유지 | cycle_time/throughput/wip 질문 추가 |
| Capability | 2개 | **2개** 유지 | v2.0 유지 | view_kanban + manage_kanban |
| `filterSpec` | 없음 | **8키** 정의 | **9키** (+view) | `view` 키 추가 -- wip-exceeded 온톨로지 승격 |
| `virtualNodes` | 없음 | **5개** | **5개** (wip-exceeded 수정) | routeTemplate이 FilterSpec 키만 사용하도록 정규화 |
| `metrics` | 4개 | **6개** | **6개** (네이밍 정리) | avgCycleTimeWindow / avgCycleTimeAllTime 명시적 구분 |
| AI 라우팅 | 단일 | Preset별 분기 | v2.0 유지 | $1.3 DO_INTENT_ROUTING_KANBAN 적용 |
| scope | 단일 | 2키 | **2-tier** | securityKeys + explorationKeys 분리 |
| Reliability | -- | 간이 | **3-tuple 표준** | `warnings: {code,message,severity}[]` |
| ScopeEcho | -- | 3종 scopeReason | **4종** scopeReason | role_restricted_assignee / role_restricted_part 분리 |
| 동시성 제어 | -- | -- | **expectedVersion** 추가 | MoveTaskRequest에 낙관적 락 포함 |

### 2.2 FilterSpec 정의

FilterSpec은 **이 화면이 지원하는 필터 스키마**를 온톨로지 내부에 선언한다.
AI가 딥링크를 생성할 때, URL 파라미터 문자열이 아니라 **FilterSpec 키 기반 필터 객체**를 반환한다.

```typescript
/** 칸반 보드 필터 스키마 -- 온톨로지 내장 (v2.1) */
export interface KanbanFilterSpec {
  /** Sprint 연결 -- 특정 Sprint의 Task만 표시 */
  sprintId?: string;
  /** 담당자 필터 -- "me"이면 현재 사용자 */
  assigneeId?: string;
  /** Part(파트) 범위 */
  partId?: string;
  /** 우선순위 필터 */
  priority?: "CRITICAL" | "HIGH" | "MEDIUM" | "LOW";
  /** Epic 연결 -- 특정 Epic 하위 Task만 */
  epicId?: string;
  /** Story 연결 -- 특정 Story 하위 Task만 */
  storyId?: string;
  /** Task 상태 필터 -- 특정 컬럼만 표시 */
  taskStatus?: "TODO" | "IN_PROGRESS" | "IN_REVIEW" | "DONE" | "BLOCKED";
  /** 자유 검색어 -- 카드 제목/설명/라벨 매칭 */
  q?: string;
  /**
   * v2.1: 보드 뷰 모드 필터 -- virtualNode에서 사용
   * "wip-exceeded": WIP Limit 초과 컬럼의 태스크만 하이라이트
   * FilterSpec에 포함하여 URL 직렬화 왕복을 보장한다.
   */
  view?: "wip-exceeded";
}
```

**필터 조합 규칙**:
- `sprintId`가 없으면 현재 활성 Sprint(ACTIVE 상태)의 Task를 기본 표시
- `assigneeId="me"`는 프론트에서 현재 사용자 ID로 치환 후 서버 전송
- `epicId`와 `storyId`는 상위 계층 드릴다운 용도 (백로그에서 "칸반에서 보기" 클릭 시)
- 복수 필터는 AND 조합

### 2.3 FilterSpec URL 직렬화 규칙

> 03_백로그 $2.4와 동일한 패턴을 적용한다.

**직렬화 방향**: `KanbanFilterSpec -> URL query string -> KanbanFilterSpec` (왕복 보장)

```typescript
/** FilterSpec -> URL 직렬화 */
function serializeKanbanFilter(filter: KanbanFilterSpec): URLSearchParams {
  const params = new URLSearchParams();
  for (const [key, value] of Object.entries(filter)) {
    if (value === undefined || value === null) continue;
    params.set(key, String(value));
  }
  return params;
}

/** URL -> FilterSpec 역직렬화 */
function deserializeKanbanFilter(params: URLSearchParams): KanbanFilterSpec {
  const filter: KanbanFilterSpec = {};
  const enumKeys = {
    priority: ["CRITICAL", "HIGH", "MEDIUM", "LOW"],
    taskStatus: ["TODO", "IN_PROGRESS", "IN_REVIEW", "DONE", "BLOCKED"],
    view: ["wip-exceeded"],           // v2.1: view 키 추가
  } as const;

  for (const [key, value] of params.entries()) {
    // enum validation -- invalid value -> skip (silent drop)
    if (key in enumKeys) {
      if ((enumKeys as any)[key].includes(value)) {
        (filter as any)[key] = value;
      }
      continue;
    }
    // string keys (sprintId, assigneeId, partId, epicId, storyId, q)
    if (["sprintId", "assigneeId", "partId", "epicId", "storyId", "q"].includes(key)) {
      (filter as any)[key] = value;
    }
    // unknown keys -> silent drop (forward compatibility)
  }
  return filter;
}
```

**직렬화 규칙 요약**:

| 규칙 | 예시 | 설명 |
|------|------|------|
| enum은 화이트리스트 검증 | `?priority=HIGH` | 유효하지 않은 값은 silent drop |
| 복수 필터는 `&`로 연결 | `?sprintId=s-5&assigneeId=me` | 표준 query string |
| "me" 값은 프론트에서 치환 | `assigneeId=me` -> `assigneeId=usr-123` | 서버 전송 전 치환 |
| 미지 키는 무시 | `?futureKey=x` -> 무시 | 하위 호환성 보장 |
| partId는 서버 재검증 | `?partId=abc` | Part scope 서버 강제 적용 |

### 2.4 Kanban 노드 (확정본 v2.1)

```typescript
const kanbanNode: MenuOntologyNodeV2 = {
  nodeId: "kanban",
  label: "칸반 보드",
  route: "/kanban",
  icon: "ViewKanban",
  domain: "execution",
  nodeRole: "action",              // ★ 실행 노드 -- 행동/이동 질문에 +10 가산

  requiredCaps: ["view_kanban"],

  // --- 인텐트: 8개 (v2.0: +3) ---
  intents: [
    // Ask 계열 -- 조회/질문
    "ask_bottleneck",               // "병목이 어디야?"
    "ask_progress",                 // "진행 상황 알려줘"
    "ask_my_work",                  // "내 작업 보여줘"
    "ask_wip_status",               // v2.0: "WIP 현황 알려줘"
    "ask_cycle_time",               // v2.0: "평균 Cycle Time은?"
    // Do 계열 -- 실행/변경
    "do_move_task",                 // "태스크 이동해줘"
    "do_assign_task",               // "태스크 할당해줘"
    "do_flag_blocked",              // v2.0: "태스크 블로킹 처리해줘"
  ],
  canonicalQuestions: [
    "지금 병목이 어디야?",
    "In Progress에 머물러 있는 태스크가 몇 개야?",
    "이번 주 완료된 작업은?",
    "내 태스크를 Done으로 옮기고 싶어",
    "BLOCKED 된 태스크가 뭐야?",
    "WIP Limit 초과한 컬럼 있어?",
    "평균 Cycle Time이 얼마야?",
    "이번 스프린트 Throughput은?",
  ],
  entities: ["Task", "Sprint", "User", "Story"],
  keywords: [
    "칸반", "보드", "병목", "WIP", "흐름", "태스크", "카드", "컬럼",
    "드래그", "이동", "블로킹", "사이클타임", "처리량",
    "kanban", "board", "bottleneck", "wip", "flow", "task", "card",
    "column", "drag", "move", "blocked", "cycle time", "throughput",
  ],
  metrics: [
    "wip_count",
    "cycle_time",
    "throughput",
    "blocked_count",
    "avg_lead_time",          // v2.0
    "avg_cycle_time",         // v2.0
  ],

  // --- FilterSpec 온톨로지 내장 (v2.1: +view) ---
  filterSpec: {
    keys: [
      "sprintId", "assigneeId", "partId", "priority",
      "epicId", "storyId", "taskStatus", "q",
      "view",                          // v2.1: wip-exceeded 온톨로지 승격
    ],
    defaults: {},  // Preset별로 오버라이드 가능
  },

  defaultPreset: "PM_WORK",
  presetPolicies: [
    {
      preset: "PM_WORK",
      ui: {
        density: "detailed",
        defaultRightPanel: "open",
        highlight: {
          metricKeys: ["cycle_time", "blocked_count", "wip_count", "throughput"],
          widgetKeys: [
            "KPI_WIP", "KPI_CYCLE_TIME", "KPI_THROUGHPUT", "KPI_BLOCKED",
            "KANBAN_BOARD", "CARD_DETAIL_PANEL",
          ],
        },
      },
      suggestedActions: [
        {
          key: "assign",
          label: "담당자 배정",
          requiredCaps: ["manage_kanban"],
          targetNodeId: "kanban",
        },
        {
          key: "escalate",
          label: "이슈 에스컬레이션",
          requiredCaps: ["manage_issues"],
          targetNodeId: "issues",
        },
        {
          key: "go_sprint",
          label: "스프린트 현황",
          requiredCaps: ["view_sprints"],
          targetNodeId: "sprints",
        },
      ],
    },
    {
      preset: "PMO_CONTROL",
      ui: {
        density: "standard",
        defaultRightPanel: "open",
        defaultFilters: { view: "bottleneck" },
        highlight: {
          metricKeys: ["wip_count", "throughput", "blocked_count", "avg_lead_time"],
          widgetKeys: ["KPI_WIP", "KPI_THROUGHPUT", "KPI_BLOCKED", "BOTTLENECK_VIEW"],
        },
      },
      suggestedActions: [
        {
          key: "export",
          label: "병목 리포트 Export",
          requiredCaps: ["export_reports"],
          targetNodeId: "reports",
        },
        {
          key: "view_health",
          label: "Health Matrix",
          requiredCaps: ["view_pmo"],
          targetNodeId: "pmo-health",
        },
      ],
    },
    {
      preset: "DEV_EXECUTION",
      ui: {
        density: "standard",
        defaultRightPanel: "closed",
        defaultFilters: { assigneeId: "me" },
        highlight: {
          metricKeys: ["wip_count", "cycle_time"],
          widgetKeys: ["KPI_WIP", "KPI_CYCLE_TIME", "KANBAN_BOARD"],
        },
      },
      suggestedActions: [
        {
          key: "move",
          label: "태스크 이동",
          requiredCaps: ["manage_kanban"],
          targetNodeId: "kanban",
        },
        {
          key: "go_my_work",
          label: "내 작업",
          requiredCaps: ["view_my_work"],
          targetNodeId: "my-work",
        },
      ],
    },
    {
      preset: "EXEC_SUMMARY",
      ui: {
        density: "compact",
        defaultRightPanel: "closed",
        hiddenColumns: ["assignee", "estimate", "labels"],
        highlight: {
          metricKeys: ["throughput", "blocked_count"],
          widgetKeys: ["KPI_THROUGHPUT", "COLUMN_COUNTS_SUMMARY"],
        },
      },
    },
    {
      preset: "CUSTOMER_APPROVAL",
      ui: {
        density: "compact",
        defaultRightPanel: "closed",
        highlight: {
          metricKeys: ["throughput"],
          widgetKeys: ["COLUMN_COUNTS_SUMMARY"],
        },
      },
      // CUSTOMER_APPROVAL: 읽기 전용, CTA 없음
    },
    // ★ AUDIT_EVIDENCE 제거 -- 감사는 칸반 접근 불가
  ],

  // --- DeepLink: routeTemplate 표준 (:param 형태) ---
  deepLinks: [
    {
      pattern: "/kanban?taskStatus=:taskStatus",
      description: "상태별 칸반 필터",
      requiredParams: ["taskStatus"],
    },
    {
      pattern: "/kanban?assigneeId=:assigneeId",
      description: "담당자별 칸반 필터",
      requiredParams: ["assigneeId"],
    },
    {
      pattern: "/kanban?sprintId=:sprintId",
      description: "스프린트별 칸반 필터",
      requiredParams: ["sprintId"],
    },
    {
      pattern: "/kanban?priority=:priority",
      description: "우선순위별 칸반 필터",
      requiredParams: ["priority"],
    },
    {
      pattern: "/kanban?storyId=:storyId",
      description: "Story 하위 Task 칸반",
      requiredParams: ["storyId"],
    },
    {
      pattern: "/kanban?epicId=:epicId",
      description: "Epic 하위 Task 칸반",
      requiredParams: ["epicId"],
    },
  ],

  // --- 가상 노드: 딥링크를 온톨로지 2계층으로 승격 (v2.0: 5개) ---
  virtualNodes: [
    {
      virtualId: "kanban.blocked",
      label: "BLOCKED 태스크",
      routeTemplate: "/kanban?taskStatus=BLOCKED",
      requiredParams: [],
      intents: ["ask_bottleneck", "do_flag_blocked"],
      description: "BLOCKED 상태 태스크 목록 -- 병목 제거 진입점",
    },
    {
      virtualId: "kanban.my-tasks",
      label: "내 칸반",
      routeTemplate: "/kanban?assigneeId=me",
      requiredParams: [],
      intents: ["ask_my_work"],
      description: "현재 사용자에게 할당된 태스크 칸반 -- DEV 기본 뷰",
    },
    {
      virtualId: "kanban.in-review",
      label: "리뷰 대기",
      routeTemplate: "/kanban?taskStatus=IN_REVIEW",
      requiredParams: [],
      intents: ["ask_bottleneck", "ask_progress"],
      description: "IN_REVIEW 상태 태스크 -- 코드리뷰 병목 확인",
    },
    {
      virtualId: "kanban.wip-exceeded",
      label: "WIP 초과",
      routeTemplate: "/kanban?view=wip-exceeded",  // v2.1: FilterSpec.view로 정규화
      requiredParams: [],
      intents: ["ask_wip_status", "ask_bottleneck"],
      description: "WIP Limit 초과 컬럼의 태스크 -- 흐름 개선 진입점. view는 FilterSpec 키로 URL 왕복 보장",
    },
    {
      virtualId: "kanban.high-priority",
      label: "긴급 태스크",
      routeTemplate: "/kanban?priority=CRITICAL",
      requiredParams: [],
      intents: ["ask_bottleneck", "ask_progress"],
      description: "CRITICAL 우선순위 태스크 -- 긴급 대응 진입점",
    },
  ],

  // --- Scope 2-tier (v2.1) ---
  scope: {
    securityKeys: ["project", "part"],          // tenant boundary -- always enforced
    explorationKeys: ["sprint"],                // user-driven drill-down axes
    params: ["projectId", "partId", "sprintId"],
  },

  priority: 3,
};
```

---

## 3. 화면 구조

### 3.1 Right Panel panelMode 정의

Right Panel은 항상 동일한 영역이지만, **panelMode**에 따라 표시 내용이 달라진다.

```typescript
/** Right Panel 모드 -- 명시적 enum */
export type KanbanPanelMode =
  | "none"           // Right Panel 숨김 (EXEC_SUMMARY, CUSTOMER_APPROVAL)
  | "card-detail"    // Task 카드 상세 (카드 클릭 시)
  | "story-context"  // Story 컨텍스트 (카드의 상위 Story 정보)
  | "metrics"        // 보드 메트릭스 (Cycle Time 차트, Throughput 그래프)
  | "assignment";    // 담당자 배정 패널 (Quick Assign)
```

**panelMode 결정 규칙**:

| 컨텍스트 | Preset | 기본 panelMode |
|---------|--------|---------------|
| 보드 + 카드 미선택 | PM_WORK | `"metrics"` |
| 보드 + 카드 미선택 | PMO_CONTROL | `"metrics"` |
| 보드 + 카드 미선택 | DEV_EXECUTION | `"none"` |
| 보드 + 카드 미선택 | EXEC_SUMMARY / CUSTOMER_APPROVAL | `"none"` |
| 보드 + 카드 클릭 | PM_WORK / PMO_CONTROL | `"card-detail"` |
| 보드 + 카드 클릭 | DEV_EXECUTION | `"card-detail"` |
| 보드 + 카드 클릭 | EXEC_SUMMARY / CUSTOMER_APPROVAL | `"none"` (클릭 무시) |
| 카드 상세 + Story 링크 클릭 | PM_WORK | `"story-context"` |
| 카드 상세 + 할당 버튼 클릭 | PM_WORK | `"assignment"` |

### 3.2 칸반 보드 전체 레이아웃 (`/kanban`)

```
+--------------------------------------------------------------+
|  Page Header                                                  |
|  칸반 보드  [ AI 보험금지급심사 구축 ]                           |
|  Sprint: [ Sprint-5 (Active) v ]                              |
|  [ 필터 v ]  [ 검색 ? ]  [ Swimlane: 없음 v ]                 |
+--------------------------------------------------------------+
|                                                               |
|  +----------+  +----------+  +----------+  +----------+      |
|  | WIP      |  | Cycle    |  |Throughput|  | Blocked  |      |
|  | Count    |  | Time     |  |          |  |          |      |
|  |   12     |  | 2.3일    |  |  8건/주  |  |   3건    |      |
|  +----------+  +----------+  +----------+  +----------+      |
|                                                               |
|  +----------+  +----------+  +----------+  +----------+      |
|  | Lead     |  | Avg      |  |          |  |          |      |
|  | Time     |  | Cycle    |  |          |  |          |      |
|  | 4.1일    |  | 1.8일    |  |          |  |          |      |
|  +----------+  +----------+  +----------+  +----------+      |
|                                                               |
|  +- 필터 바 ------------------------------------------------+ |
|  | 담당: [전체v] Part: [전체v] 우선순위: [전체v]              | |
|  | Epic: [전체v] Story: [전체v]                    [초기화]  | |
|  +-----------------------------------------------------------+ |
|                                                               |
|  +- ReadOnlyBanner (manage_kanban 없을 때) -----------------+ |
|  |  ! 읽기 전용 모드입니다. 카드를 이동하려면 권한이 필요합니다.| |
|  +-----------------------------------------------------------+ |
|                                                               |
|  +- BLOCKED Swimlane (접기 가능) ---------------------------+ |
|  | ! BLOCKED (3건)                               [펼치기 v] | |
|  | +--------+  +--------+  +--------+                       | |
|  | |TSK-089 |  |TSK-142 |  |TSK-201 |                       | |
|  | |API 연동|  |결제모듈 |  |인증 ...|                       | |
|  | |! 3일째 |  |! 5일째 |  |! 1일째 |                       | |
|  | |김OO    |  |이OO    |  |박OO    |                       | |
|  | +--------+  +--------+  +--------+                       | |
|  +-----------------------------------------------------------+ |
|                                                               |
|  +- Kanban Board -------------------------------------------+ |
|  |                                                           | |
|  | TODO (5)      IN_PROGRESS   IN_REVIEW    DONE (12)       | |
|  | WIP: -        (4/3) !      (2/2) =      WIP: -          | |
|  |                                                           | |
|  | +--------+   +--------+   +--------+   +--------+       | |
|  | |TSK-155 |   |TSK-088 |   |TSK-112 |   |TSK-077 |       | |
|  | |탐지룰  |   |스코어링|   |알림처리 |   |전처리  |       | |
|  | |CRITICAL|   |HIGH    |   |MEDIUM  |   |완료    |       | |
|  | | -      |   |김OO    |   |이OO    |   |박OO    |       | |
|  | |S-01    |   |S-02    |   |S-03    |   |S-04    |       | |
|  | +--------+   +--------+   +--------+   +--------+       | |
|  |                                                           | |
|  | +--------+   +--------+   +--------+   +--------+       | |
|  | |TSK-156 |   |TSK-090 |   |TSK-113 |   |TSK-078 |       | |
|  | |데이터  |   |배치처리 |   |로그수집 |   |정규화  |       | |
|  | |HIGH    |   |HIGH    |   |LOW     |   |완료    |       | |
|  | | -      |   |이OO    |   |박OO    |   |김OO    |       | |
|  | |S-01    |   |S-02    |   |S-03    |   |S-04    |       | |
|  | +--------+   +--------+   +--------+   +--------+       | |
|  |                                                           | |
|  | +--------+   +--------+                +--------+       | |
|  | |TSK-157 |   |TSK-091 |                |TSK-079 |       | |
|  | |검증    |   |API개발  |                |모델학습 |       | |
|  | |MEDIUM  |   |MEDIUM  |                |완료    |       | |
|  | | -      |   |박OO    |                |이OO    |       | |
|  | |S-01    |   |S-02    |                |S-04    |       | |
|  | +--------+   +--------+                +--------+       | |
|  |                                                           | |
|  | +--------+   +--------+                                  | |
|  | |TSK-158 |   |        |                                  | |
|  | |연동    |   |        |                                  | |
|  | |LOW     |   |        |                                  | |
|  | | -      |   |        |                                  | |
|  | |S-05    |   |        |                                  | |
|  | +--------+   +--------+                                  | |
|  |                                                           | |
|  | +--------+                                                | |
|  | |TSK-159 |                                                | |
|  | |문서화  |                                                | |
|  | |LOW     |                                                | |
|  | | -      |                                                | |
|  | |S-05    |                                                | |
|  | +--------+                                                | |
|  |                                                           | |
|  +-----------------------------------------------------------+ |
|                                                               |
+--------------------------------------------------------------+
```

### 3.3 카드 클릭 시 Right Panel 열림

```
+--------------------------------------------------------------+
|  Page Header                                                  |
|  칸반 보드  [ AI 보험금지급심사 구축 ]                           |
+------------------------------------------+-------------------+
|                                          | panelMode:         |
|  +- Kanban Board -----------------------+| "card-detail"      |
|  |                                       ||                   |
|  | TODO     IN_PROGRESS  IN_REVIEW  DONE || -- Task 상세 ---  |
|  |                                       ||                   |
|  | +------+ +------+ +------+ +------+  || TSK-088           |
|  | |TSK.. | |[088]<--selected  |TSK...|  || 스코어링 API 개발 |
|  | +------+ +------+ +------+ +------+  ||                   |
|  |          ^^^^^^^^                     || 상태: IN_PROGRESS |
|  | +------+ +------+ +------+ +------+  || 우선순위: HIGH    |
|  | |TSK.. | |TSK.. | |TSK.. | |TSK...|  || 담당: 김OO        |
|  | +------+ +------+ +------+ +------+  || [변경]            |
|  |                                       ||                   |
|  | +------+ +------+          +------+  || 예상: 16h         |
|  | |TSK.. | |TSK.. |          |TSK...|  || 실제: 12h         |
|  | +------+ +------+          +------+  || Due: 2026-02-15   |
|  |                                       ||                   |
|  +---------------------------------------+| -- Story 컨텍스트 |
|                                          ||                   |
|                                          || S-02 실시간스코어링|
|                                          || Sprint: Sprint-5  |
|                                          || SP: 8pt           |
|                                          || Progress: 50%     |
|                                          || Task: 4건 (2done) |
|                                          ||                   |
|                                          || -- 라벨 ----------|
|                                          || [backend] [api]   |
|                                          ||                   |
|                                          || -- 히스토리 ------|
|                                          || 02-07 IN_PROGRESS |
|                                          || 02-05 TODO 생성   |
|                                          ||                   |
|                                          || -- 액션 ----------|
|                                          || [Done으로 이동]    |
|                                          || [BLOCKED 처리]     |
|                                          || [이슈 등록]        |
|                                          ||                   |
+------------------------------------------+-------------------+
```

### 3.4 Swimlane: By Assignee

```
+--------------------------------------------------------------+
|  Swimlane: [ By Assignee v ]                                  |
+--------------------------------------------------------------+
|                                                               |
|  -- 김OO (4건) -------------------------------------------- |
|  | TODO     | IN_PROGRESS | IN_REVIEW | DONE                | |
|  | +------+ | +------+    |           | +------+            | |
|  | |TSK-155|| |TSK-088|    |           | |TSK-077|            | |
|  | +------+ | +------+    |           | +------+            | |
|  |          | +------+    |           |                      | |
|  |          | |TSK-090|    |           |                      | |
|  |          | +------+    |           |                      | |
|  +-----------------------------------------------------------+ |
|                                                               |
|  -- 이OO (3건) -------------------------------------------- |
|  | TODO     | IN_PROGRESS | IN_REVIEW | DONE                | |
|  | +------+ | +------+    | +------+  | +------+            | |
|  | |TSK-156|| |TSK-091|    | |TSK-113| | |TSK-079|            | |
|  | +------+ | +------+    | +------+  | +------+            | |
|  +-----------------------------------------------------------+ |
|                                                               |
|  -- 미할당 (2건) ------------------------------------------ |
|  | TODO     | IN_PROGRESS | IN_REVIEW | DONE                | |
|  | +------+ |             |           |                      | |
|  | |TSK-158||             |           |                      | |
|  | +------+ |             |           |                      | |
|  | +------+ |             |           |                      | |
|  | |TSK-159||             |           |                      | |
|  | +------+ |             |           |                      | |
|  +-----------------------------------------------------------+ |
|                                                               |
+--------------------------------------------------------------+
```

---

## 4. Preset별 차이

### 4.1 PM_WORK (PM)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | WIP Count, Cycle Time, Throughput, Blocked Count, Lead Time, Avg Cycle Time (6종) |
| Board | **전체 4컬럼** + BLOCKED swimlane + WIP Limit 경고 |
| Right Panel | panelMode: `"card-detail"` + `"metrics"` (기본) |
| Swimlane | By Assignee / By Story / By Priority 선택 가능 |
| DnD | 전체 카드 DnD 활성 (cap: `manage_kanban`) |
| CTA | `담당자 배정`, `이슈 에스컬레이션`, `스프린트 현황` |
| WIP Limit | 설정 + 조회 가능 (PM만 설정 변경 가능) |

**PM_WORK 카드 CTA (컨텍스트 메뉴)**:

| 컨텍스트 | CTA | Capability |
|---------|-----|-----------|
| 카드 우클릭 / ... 메뉴 | `[담당자 변경]` | `manage_kanban` |
| 카드 우클릭 / ... 메뉴 | `[BLOCKED 처리]` | `manage_kanban` |
| 카드 우클릭 / ... 메뉴 | `[BLOCKED 해제]` | `manage_kanban` |
| 카드 우클릭 / ... 메뉴 | `[이슈 등록]` | `manage_issues` |
| 카드 우클릭 / ... 메뉴 | `[상세 보기]` | `view_kanban` |
| WIP Limit 아이콘 | `[WIP Limit 설정]` | `manage_kanban` |

### 4.2 PMO_CONTROL (PMO)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | WIP Count, Throughput, Blocked Count, Avg Lead Time (4종 강조) |
| Board | **전체 4컬럼** + BLOCKED swimlane + WIP Limit 초과 강조 |
| Right Panel | panelMode: `"metrics"` (기본) -- 병목 분석 중심 |
| Swimlane | By Assignee (기본) -- 리소스 병목 확인 |
| DnD | 비활성 (PMO는 직접 이동하지 않음, 읽기 전용) |
| CTA | `병목 리포트 Export`, `Health Matrix` |
| WIP Limit | 조회만 가능 |

### 4.3 DEV_EXECUTION (DEV / DevReader)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | WIP Count, Cycle Time (2종 -- 내 작업 중심) |
| Board | **전체 4컬럼** + BLOCKED swimlane (내 카드만 DnD 가능) |
| Right Panel | panelMode: `"card-detail"` (카드 클릭 시) |
| Swimlane | 없음 (기본) -- 내 카드 필터로 충분 |
| DnD | **내 카드만** DnD 활성 (assigneeId=me 카드만 드래그 가능) |
| CTA | `태스크 이동`, `내 작업` |
| 기본 필터 | `assigneeId: "me"` (자동 적용) |

**DEV vs DevReader 차이**:

| 항목 | DEV | DevReader(파트장) |
|------|-----|-----------------|
| 보드 범위 | 전체 (내 카드 하이라이트) | Part 범위 (서버 강제 필터) |
| DnD | 내 카드만 | 파트 내 전체 카드 |
| 카드 상세 | 내 할당 카드만 편집 | 파트 내 카드 편집 가능 |
| Swimlane | 없음 | By Assignee (파트원 확인) |
| 기본 필터 | `assigneeId: "me"` | `partId: "현재사용자파트ID"` |

### 4.4 EXEC_SUMMARY (Sponsor)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | Throughput, Blocked Count (요약 2종만) |
| Board | **컬럼 카운트 요약만** (카드 미표시, 컬럼당 건수 막대) |
| Right Panel | panelMode: `"none"` (숨김) |
| Swimlane | 없음 |
| DnD | 비활성 (읽기 전용) |
| CTA | 없음 |

```
EXEC_SUMMARY 전용 컴팩트 뷰:

+--------------------------------------------------------------+
|  +----------+  +----------+                                   |
|  |Throughput|  | Blocked  |                                   |
|  |  8건/주  |  |   3건    |                                   |
|  +----------+  +----------+                                   |
|                                                               |
|  +- Column Summary ----------------------------------------+ |
|  |                                                           | |
|  |  TODO        IN_PROGRESS   IN_REVIEW     DONE            | |
|  |  ####        ########      ####          ########        | |
|  |  5건         4건           2건           12건            | |
|  |                                                           | |
|  +-----------------------------------------------------------+ |
+--------------------------------------------------------------+
```

### 4.5 CUSTOMER_APPROVAL (Customer PM)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | Throughput (요약 1종만) |
| Board | **읽기 전용** 보드 (카드 표시, DnD 비활성) |
| Right Panel | panelMode: `"none"` (숨김) |
| DnD | 비활성 |
| CTA | 없음 |

---

## 5. 칸반 보드 상세

### 5.1 컬럼 정의 및 상태 매핑

```
                Kanban Board Columns
+----------+  +-----------+  +----------+  +------+
|   TODO   |  |IN_PROGRESS|  |IN_REVIEW |  | DONE |
|          |  |           |  |          |  |      |
| "할 일"  |  | "진행 중" |  |"리뷰 중" |  |"완료"|
|          |  |           |  |          |  |      |
| 시작 전  |  | 개발 진행 |  | 코드리뷰 |  | 완료 |
| 태스크   |  | 태스크    |  | /QA 대기 |  | 태스크|
+----------+  +-----------+  +----------+  +------+

              BLOCKED Swimlane (수평 분리)
+-------------------------------------------------------+
| BLOCKED                                                |
| "차단됨" -- 외부 의존/이슈로 진행 불가한 태스크         |
| 원래 컬럼 정보 유지 (previousStatus)                    |
+-------------------------------------------------------+
```

```typescript
/** 칸반 컬럼 정의 */
export interface KanbanColumnConfig {
  id: TaskStatus;
  label: string;
  color: string;
  wipLimit?: number;         // PM이 설정, undefined = 제한 없음
  order: number;             // 컬럼 표시 순서
  acceptsDrop: boolean;      // DnD drop 가능 여부
}

export const KANBAN_COLUMNS: KanbanColumnConfig[] = [
  { id: "TODO",         label: "TODO",         color: "#6B7280", order: 0, acceptsDrop: true  },
  { id: "IN_PROGRESS",  label: "In Progress",  color: "#3B82F6", order: 1, acceptsDrop: true  },
  { id: "IN_REVIEW",    label: "In Review",    color: "#8B5CF6", order: 2, acceptsDrop: true  },
  { id: "DONE",         label: "Done",         color: "#10B981", order: 3, acceptsDrop: true  },
];

/** BLOCKED는 컬럼이 아닌 별도 swimlane */
export const BLOCKED_SWIMLANE = {
  id: "BLOCKED" as TaskStatus,
  label: "Blocked",
  color: "#EF4444",
  isSwimLane: true,
};
```

### 5.2 카드(Task) 구조

```typescript
/** 칸반 카드에 표시할 Task 정보 */
export interface KanbanCard {
  // Task 기본 정보 (backlog.ts Task 기반)
  id: string;                    // TSK-088
  title: string;                 // "스코어링 API 개발"
  status: TaskStatus;            // IN_PROGRESS
  previousStatus?: TaskStatus;   // BLOCKED 해제 시 복귀할 상태

  // 담당/Part
  assigneeId?: string;
  assigneeName?: string;
  assigneeAvatar?: string;
  partId?: string;
  partName?: string;

  // 상위 연결 (Story context)
  userStoryId: string;           // S-02
  userStoryTitle: string;        // "실시간 스코어링"
  epicId?: string;               // E-01
  epicTitle?: string;            // "사기탐지 AI 모델"

  // 메타
  priority: "CRITICAL" | "HIGH" | "MEDIUM" | "LOW";
  estimatedHours?: number;
  actualHours?: number;
  dueDate?: string;
  labels?: string[];

  // 칸반 전용
  kanbanOrder: number;           // 컬럼 내 정렬 순서
  blockedDays?: number;          // BLOCKED 상태 일수 (BLOCKED일 때만)
  blockedReason?: string;        // BLOCKED 사유

  // 시간 기록 (v2.1: createdAt 추가)
  /**
   * Task 생성 시각 -- Lead Time 기준점
   * Lead Time = createdAt -> completedAt (시스템에 요청이 들어온 순간부터)
   * 주의: "TODO 진입 시각"이 아니라 "Task row 생성 시각"을 사용한다.
   */
  createdAt: string;             // Task 생성 시각 (ISO 8601)
  startedAt?: string;            // IN_PROGRESS 진입 시각
  reviewedAt?: string;           // IN_REVIEW 진입 시각
  completedAt?: string;          // DONE 진입 시각
  cycleTime?: number;            // 일 단위 (IN_PROGRESS -> DONE)

  // 동시성 제어 (v2.1)
  /** 낙관적 락 버전 -- 서버가 매 변경마다 증가 */
  version: number;
}
```

### 5.3 카드 렌더링 레이아웃

```
+-----------------------------+
| [CRITICAL] TSK-155          |  <- 우선순위 배지 + ID
| 실시간 탐지룰 검증 API      |  <- 제목
|                             |
| S-01 탐지룰 관리            |  <- 상위 Story 참조
| [backend] [validation]      |  <- 라벨
|                             |
| 16h / -     Due: 02-15     |  <- 예상시간/실적 + 마감일
| +--+                       |
| |  | 미할당                 |  <- 아바타 + 담당자
| +--+                       |
+-----------------------------+

카드 상태별 시각 차이:

TODO:         회색 좌측 보더
IN_PROGRESS:  파란색 좌측 보더
IN_REVIEW:    보라색 좌측 보더
DONE:         초록색 좌측 보더 + 텍스트 연하게
BLOCKED:      빨간색 좌측 보더 + 빨간 배경 틴트 + "! N일째" 배지
```

### 5.4 WIP Limit

WIP(Work In Progress) Limit은 **컬럼별 동시 진행 가능한 카드 수**를 제한한다.

```typescript
/**
 * WIP Limit 설정 (v2.1: warningThreshold 제거 -- 계산 함수로 단일 소스)
 *
 * ★ 존재 보장: 서버는 항상 4컬럼(TODO/IN_PROGRESS/IN_REVIEW/DONE) 각각에 대해
 *   WipLimitConfig를 반환한다. limit이 설정되지 않은 컬럼은 limit: null로 표현.
 *   이를 통해 프론트에서 wipLimits.find(...)! 같은 널 단언을 안전하게 사용할 수 있다.
 */
export interface WipLimitConfig {
  columnId: TaskStatus;
  limit: number | null;      // null = 제한 없음
  // v2.1: warningThreshold 제거 -- getWipStatus() 계산 함수가 단일 진실 소스
  // PM이 임계치를 커스터마이즈해야 하면 서버 설정으로 승격 검토
}

/** WIP 상태 판정 */
export type WipStatus = "normal" | "warning" | "exceeded";

/**
 * v2.1: warningThreshold를 별도 필드로 저장하지 않고 계산으로만 판정
 * 기준: limit의 80% 이상이면 warning
 */
function getWipStatus(count: number, limit: number | null): WipStatus {
  if (limit === null) return "normal";
  if (count > limit) return "exceeded";
  if (count >= Math.ceil(limit * 0.8)) return "warning";
  return "normal";
}
```

> **v2.1 WIP Count 정의 확정**:
> `wipCount = IN_PROGRESS + IN_REVIEW` (BLOCKED 제외).
> BLOCKED는 `blockedCount`로 별도 집계한다.
> TODO/DONE은 "진행 중"이 아니므로 WIP에 포함하지 않는다.

**WIP Limit 표시**:

```
IN_PROGRESS (4/3) !        <- 초과: 빨간색 + 경고 아이콘
  count=4, limit=3
  wipStatus: "exceeded"
  컬럼 헤더 빨간색 배경 틴트

IN_REVIEW (2/2) =          <- 한계: 주황색 경고
  count=2, limit=2
  wipStatus: "warning"
  컬럼 헤더 주황색 배경 틴트

TODO (5) / DONE (12)       <- 제한 없음
  limit=null
  wipStatus: "normal"
```

**WIP Limit 설정 API**:

```
PATCH /api/kanban/wip-limits
```

```typescript
interface UpdateWipLimitsRequest {
  projectId: string;
  sprintId?: string;         // Sprint별로 다른 WIP 설정 가능
  limits: {
    columnId: TaskStatus;
    limit: number | null;
  }[];
}

interface UpdateWipLimitsResponse {
  limits: WipLimitConfig[];
  updatedAt: string;
  updatedBy: string;
}
```

> **권한**: WIP Limit 설정 변경은 `manage_kanban` Capability 필요 (PM만).
> DEV_EXECUTION은 WIP Limit을 조회만 가능하다.

**WIP Limit 초과 시 DnD 동작**:

```typescript
/** WIP Limit 초과 시 DnD 정책 */
export type WipExceededPolicy = "warn" | "block";

// 기본: "warn" -- 경고 후 이동 허용 (PM 판단에 맡김)
// 선택: "block" -- 이동 차단 (엄격 모드)

interface DndDropValidation {
  allowed: boolean;
  reason?: string;
  wipStatus?: WipStatus;
  confirmRequired?: boolean;   // "warn" 모드: 확인 다이얼로그 표시
}

function validateDrop(
  targetColumn: TaskStatus,
  wipConfig: WipLimitConfig,
  currentCount: number,
  policy: WipExceededPolicy
): DndDropValidation {
  const newCount = currentCount + 1;
  const status = getWipStatus(newCount, wipConfig.limit);

  if (status === "exceeded") {
    if (policy === "block") {
      return {
        allowed: false,
        reason: `WIP Limit 초과 (${newCount}/${wipConfig.limit}). 먼저 기존 작업을 완료하세요.`,
        wipStatus: status,
      };
    }
    // "warn" 모드
    return {
      allowed: true,
      reason: `WIP Limit 초과 (${newCount}/${wipConfig.limit}). 계속하시겠습니까?`,
      wipStatus: status,
      confirmRequired: true,
    };
  }

  return { allowed: true, wipStatus: status };
}
```

### 5.5 BLOCKED Swimlane

BLOCKED 카드는 일반 컬럼에서 분리되어 **상단 수평 swimlane**으로 표시한다.

```typescript
/** BLOCKED 카드 정보 */
export interface BlockedCardInfo extends KanbanCard {
  status: "BLOCKED";
  previousStatus: TaskStatus;      // BLOCKED 이전 상태 (해제 시 복귀)
  blockedDays: number;             // BLOCKED 상태 일수
  blockedReason: string;           // BLOCKED 사유
  blockedAt: string;               // BLOCKED 처리 시각
  linkedIssueId?: string;          // 연결된 이슈 ID (있는 경우)
}
```

**BLOCKED 처리 흐름**:

```
1. 카드 컨텍스트 메뉴 -> [BLOCKED 처리]
2. BLOCKED 사유 입력 다이얼로그 표시
   - 사유 텍스트 (필수)
   - 이슈 연결 (선택)
3. PATCH /api/kanban/tasks/:taskId/block
   - previousStatus 저장
   - status -> BLOCKED
   - blockedAt 기록
4. 카드가 BLOCKED swimlane으로 이동 (애니메이션)

해제:
1. BLOCKED 카드 -> [BLOCKED 해제]
2. PATCH /api/kanban/tasks/:taskId/unblock
   - status -> previousStatus로 복귀
3. 카드가 원래 컬럼으로 복귀 (애니메이션)
```

### 5.6 Cycle Time / Lead Time 계산

> **v2.1 Lead Time 기준 시각 확정**:
> Lead Time의 시작점은 `card.createdAt`(Task row 생성 시각)이다.
> "TODO 진입 시각"이 아닌 "시스템에 요청이 등록된 시점"을 기준으로 하여,
> 백로그에서 대기한 시간까지 포함한 전체 소요 기간을 측정한다.
> Cycle Time은 `card.startedAt`(IN_PROGRESS 진입 시각)부터 측정하므로,
> Lead Time - Cycle Time = 대기 시간(TODO에서 머문 기간)이 된다.

```typescript
/** Cycle Time: IN_PROGRESS -> DONE (개발 기간) -- 영업일 기준 */
function calculateCycleTime(card: KanbanCard): number | null {
  if (!card.startedAt || !card.completedAt) return null;
  const start = new Date(card.startedAt);
  const end = new Date(card.completedAt);
  return getBusinessDays(start, end);
}

/**
 * Lead Time: createdAt -> DONE (전체 소요 기간) -- 영업일 기준
 * v2.1: KanbanCard.createdAt 필드 추가로 타입 안전성 확보
 */
function calculateLeadTime(card: KanbanCard): number | null {
  if (!card.createdAt || !card.completedAt) return null;
  const start = new Date(card.createdAt);
  const end = new Date(card.completedAt);
  return getBusinessDays(start, end);
}

/** Throughput: 단위 기간당 완료 건수 */
function calculateThroughput(
  completedCards: KanbanCard[],
  periodDays: number = 7
): number {
  const now = new Date();
  const periodStart = new Date(now.getTime() - periodDays * 24 * 60 * 60 * 1000);
  return completedCards.filter(c =>
    c.completedAt && new Date(c.completedAt) >= periodStart
  ).length;
}
```

### 5.7 Swimlane 옵션

```typescript
/** Swimlane 모드 */
export type SwimlaneMode = "none" | "assignee" | "story" | "priority";

/** Swimlane 그룹 */
export interface SwimlaneGroup {
  id: string;              // assigneeId / storyId / priority value
  label: string;           // "김OO" / "S-02 실시간스코어링" / "HIGH"
  cardCount: number;
  cards: KanbanCard[];
  /** Swimlane 접기 상태 */
  collapsed: boolean;
}

/** Swimlane별 렌더링 규칙 */
const SWIMLANE_CONFIGS: Record<SwimlaneMode, SwimlaneConfig> = {
  none: {
    groupBy: null,
    sortGroups: null,
  },
  assignee: {
    groupBy: "assigneeId",
    sortGroups: (a, b) => a.label.localeCompare(b.label, "ko"),
    emptyGroupLabel: "미할당",
    emptyGroupPosition: "last",
  },
  story: {
    groupBy: "userStoryId",
    sortGroups: (a, b) => a.label.localeCompare(b.label, "ko"),
    emptyGroupLabel: "Story 미연결",
    emptyGroupPosition: "last",
  },
  priority: {
    groupBy: "priority",
    sortGroups: (a, b) => PRIORITY_ORDER[a.id] - PRIORITY_ORDER[b.id],
    emptyGroupLabel: null,  // priority는 항상 있음
  },
};

const PRIORITY_ORDER: Record<string, number> = {
  CRITICAL: 0,
  HIGH: 1,
  MEDIUM: 2,
  LOW: 3,
};
```

---

## 6. 데이터 구조 / API

### 6.1 기존 타입 참조

칸반의 핵심 타입은 `PMS_IC_FrontEnd_v1.2/src/types/backlog.ts`의 `Task` 인터페이스를 기반으로 한다.

| 타입 | 출처 | 용도 |
|------|------|------|
| `Task`, `TaskStatus` | backlog.ts | Task 기본 CRUD |
| `UserStory` | backlog.ts | Story 컨텍스트 표시 |
| `Sprint` | backlog.ts | Sprint 필터 |

### 6.2 Kanban Board API

```
GET /api/kanban/board?projectId={projectId}
    &sprintId={sprintId}
    &assigneeId={assigneeId}
    &partId={partId}
    &priority={CRITICAL|HIGH|MEDIUM|LOW}
    &epicId={epicId}
    &storyId={storyId}
    &taskStatus={TODO|IN_PROGRESS|IN_REVIEW|DONE|BLOCKED}
    &q={searchText}
    &swimlane={none|assignee|story|priority}
```

> **참고**: 쿼리 파라미터는 $2.2 FilterSpec 키와 **1:1 매핑**된다.
> `swimlane` 파라미터는 서버에서 그룹화에 사용되지 않고 프론트 전용이다.

```typescript
interface KanbanBoardResponse {
  /** 컬럼별 카드 목록 */
  columns: {
    id: TaskStatus;
    label: string;
    cards: KanbanCard[];
    cardCount: number;
    wipLimit: number | null;
    wipStatus: WipStatus;
  }[];

  /** BLOCKED swimlane */
  blocked: {
    cards: BlockedCardInfo[];
    cardCount: number;
  };

  /** 보드 메트릭스 */
  metrics: KanbanMetrics;

  /** WIP Limit 설정 */
  wipLimits: WipLimitConfig[];

  /** 현재 Sprint 정보 */
  currentSprint?: {
    id: string;
    name: string;
    status: "PLANNING" | "ACTIVE" | "COMPLETED" | "CANCELLED";
    startDate: string;
    endDate: string;
    remainingDays: number;
  };

  // --- scope echo (v2.1 enhanced) ---
  scope: KanbanScopeEcho;

  // --- Reliability 3-tuple (v2.1 standardized) ---
  asOf: string;
  completeness: {
    overall: number;           // 0~1
    breakdown?: {
      tasks: number;
      sprints: number;
      assignments: number;
    };
  };
  warnings: {
    code: string;              // e.g., "WIP_EXCEEDED", "STALE_SPRINT"
    message: string;
    severity: "info" | "warn" | "critical";
  }[];
}
```

### 6.3 Kanban Metrics

```typescript
interface KanbanMetrics {
  /**
   * WIP: IN_PROGRESS + IN_REVIEW 카드 수 (v2.1 정의 확정)
   * BLOCKED 제외 -- blockedCount로 별도 집계
   * TODO/DONE 제외 -- "진행 중"이 아님
   */
  wipCount: number;
  /**
   * v2.1 네이밍 정리: avgCycleTimeWindow
   * 최근 windowDays일 내 완료된 카드의 평균 Cycle Time (IN_PROGRESS->DONE)
   */
  avgCycleTimeWindow: number;
  /** 집계 기간 일수 (기본 7일) */
  windowDays: number;
  /** Throughput: windowDays 기간 내 완료 건수 */
  throughput: number;
  /** Blocked: 현재 BLOCKED 상태 카드 수 */
  blockedCount: number;
  /** Lead Time: windowDays 기간 내 완료된 카드의 평균 createdAt->DONE 소요일 */
  avgLeadTimeWindow: number;
  /**
   * v2.1 네이밍 정리: avgCycleTimeAllTime
   * 전체 기간 완료 카드의 평균 Cycle Time (역사적 기준선)
   */
  avgCycleTimeAllTime: number;

  /** 컬럼별 카드 수 분포 */
  columnDistribution: {
    columnId: TaskStatus;
    count: number;
    percentage: number;
  }[];

  /** 우선순위별 분포 */
  priorityDistribution: {
    priority: string;
    count: number;
  }[];

  /** 일별 Throughput 추이 (최근 14일) */
  throughputTrend: {
    date: string;
    count: number;
  }[];
}
```

### 6.4 Kanban Scope Echo

```typescript
/**
 * 모든 칸반 API 응답에 포함 (v2.1 enhanced)
 *
 * ★ Scope 강제 정책:
 * - 읽기(GET): 서버가 allowedPartIds로 강제 재작성 + scope echo 200 반환
 *   (사용자가 URL로 partId를 바꿔도 서버가 silent rewrite)
 * - 쓰기(PATCH): Part 범위 위반 시 403 반환
 *   (카드 이동/할당 등 변경 요청에서만 명시적 거부)
 */
interface KanbanScopeEcho {
  projectId: string;
  /** 적용된 Sprint ID (null이면 전체) */
  appliedSprintId: string | null;
  /** 실제 적용된 Part ID 목록 (빈 배열 = 전체) */
  appliedPartIds: string[];
  /** Part 이름 목록 (UI 표시용) */
  appliedPartNames: string[];
  /**
   * v2.1: 범위 제한 원인 세분화
   * - full_access: 전체 접근 (PM, PMO)
   * - role_restricted_assignee: DEV -- 자신에게 할당된 카드만
   * - role_restricted_part: DevReader -- 자신의 Part 범위만
   * - explicit_filter: 사용자가 명시적으로 필터 적용
   */
  scopeReason:
    | "full_access"
    | "role_restricted_assignee"
    | "role_restricted_part"
    | "explicit_filter";
}
```

### 6.5 Task Move API -- 카드 상태 변경 (DnD 결과)

```
PATCH /api/kanban/tasks/:taskId/move
```

```typescript
interface MoveTaskRequest {
  /** 이동 대상 컬럼 (새로운 상태) */
  targetStatus: TaskStatus;
  /** 컬럼 내 정렬 순서 */
  newOrder: number;
  /** WIP Limit 초과 확인 (warn 모드에서 사용자 확인 완료 시 true) */
  wipOverrideConfirmed?: boolean;
  /**
   * v2.1: 낙관적 락 -- 동시 수정 충돌 감지
   * 프론트가 보유한 카드의 version 값을 전송.
   * 서버는 현재 DB의 version과 비교하여 불일치 시 409 CONCURRENT_MODIFICATION 반환.
   * 성공 시 version을 +1 하여 응답에 포함.
   */
  expectedVersion: number;
}

interface MoveTaskResponse {
  task: KanbanCard;              // 업데이트된 Task
  /** Story 자동 전이 발생 시 */
  storyTransition?: {
    storyId: string;
    previousStatus: string;
    newStatus: string;
    reason: string;              // "모든 Task DONE -> Story REVIEW"
  };
  /** Epic 자동 전이 발생 시 */
  epicTransition?: {
    epicId: string;
    previousStatus: string;
    newStatus: string;
    reason: string;
  };
  /** 업데이트된 메트릭스 */
  metrics: KanbanMetrics;
}
```

**Task Move 서버 트랜잭션**:

```
[카드를 DONE으로 이동] PATCH /api/kanban/tasks/:taskId/move
  |-- Task.status: {current} -> DONE (직접 전이)
  |-- Task.completedAt: NOW (시각 기록)
  |-- Story 자동 전이 검사:
  |   |-- 해당 Story의 모든 Task가 DONE이면
  |   |-- Story.status: IN_PROGRESS -> REVIEW (자동)
  |-- Epic 자동 전이 검사:
  |   |-- 해당 Epic의 모든 Story가 DONE이면
  |   |-- Epic completable 플래그 갱신
  |-- 한 트랜잭션으로 원자성 보장
  |-- 응답에 storyTransition, epicTransition 포함
```

### 6.6 Task Move 에러 계약

```typescript
/** Task Move 실패 응답 */
interface MoveTaskErrorResponse {
  error: {
    code: MoveTaskErrorCode;
    message: string;
    entityId?: string;
    currentStatus?: string;
  };
}

type MoveTaskErrorCode =
  | "TASK_ALREADY_IN_STATUS"     // 이미 해당 상태
  | "WIP_LIMIT_EXCEEDED"        // WIP Limit 초과 (block 모드)
  | "TASK_IS_BLOCKED"           // BLOCKED 상태에서 직접 이동 불가 (해제 먼저)
  | "INVALID_TRANSITION"        // 유효하지 않은 상태 전이 (e.g., TODO -> DONE 직접)
  | "PART_ACCESS_DENIED"        // Part scope 위반
  | "CONCURRENT_MODIFICATION"   // 동시 수정 감지
  | "SPRINT_NOT_ACTIVE";        // Sprint가 ACTIVE가 아님
```

| 에러 코드 | HTTP | 원인 | 프론트 대응 |
|-----------|------|------|-----------|
| `TASK_ALREADY_IN_STATUS` | 409 | 이미 해당 상태 | 카드 위치 새로고침 |
| `WIP_LIMIT_EXCEEDED` | 409 | WIP 초과 (block) | "WIP Limit 초과" 안내 |
| `TASK_IS_BLOCKED` | 409 | BLOCKED 상태 | "먼저 BLOCKED를 해제하세요" |
| `INVALID_TRANSITION` | 400 | 잘못된 전이 | "허용되지 않는 이동" 안내 |
| `PART_ACCESS_DENIED` | 403 | Part 위반 | "접근 권한이 없습니다" |
| `CONCURRENT_MODIFICATION` | 409 | 동시 수정 | 보드 새로고침 후 재시도 |
| `SPRINT_NOT_ACTIVE` | 409 | Sprint 비활성 | Sprint 선택 새로고침 |

### 6.7 Task Block/Unblock API

```
PATCH /api/kanban/tasks/:taskId/block
```

```typescript
interface BlockTaskRequest {
  reason: string;              // BLOCKED 사유 (필수)
  linkedIssueId?: string;      // 연결 이슈 ID (선택)
}

interface BlockTaskResponse {
  task: BlockedCardInfo;
  metrics: KanbanMetrics;
}
```

```
PATCH /api/kanban/tasks/:taskId/unblock
```

```typescript
interface UnblockTaskResponse {
  task: KanbanCard;            // previousStatus로 복귀된 Task
  metrics: KanbanMetrics;
}
```

### 6.8 Task Quick Assign API

```
PATCH /api/kanban/tasks/:taskId/assign
```

```typescript
interface AssignTaskRequest {
  assigneeId: string | null;   // null이면 할당 해제
}

interface AssignTaskResponse {
  task: KanbanCard;
}
```

### 6.9 Kanban Stats API

```
GET /api/kanban/stats?projectId={projectId}&sprintId={sprintId}&partId={partId}
```

```typescript
interface KanbanStatsResponse {
  metrics: KanbanMetrics;

  /** Cumulative Flow Diagram 데이터 (최근 14일) */
  cumulativeFlow: {
    date: string;
    todo: number;
    inProgress: number;
    inReview: number;
    done: number;
    blocked: number;
  }[];

  /** 담당자별 WIP */
  wipByAssignee: {
    assigneeId: string;
    assigneeName: string;
    wipCount: number;
    blockedCount: number;
  }[];

  // scope echo
  scope: KanbanScopeEcho;

  // --- Reliability 3-tuple (v2.1 standardized) ---
  asOf: string;
  completeness: {
    overall: number;           // 0~1
    breakdown?: {
      tasks: number;
      sprints: number;
      assignments: number;
    };
  };
  warnings: {
    code: string;              // e.g., "STALE_SPRINT", "MISSING_ASSIGNEE"
    message: string;
    severity: "info" | "warn" | "critical";
  }[];
}
```

---

## 7. 컴포넌트 분해

### 7.1 폴더 구조

```
features/
  kanban/
    pages/
      KanbanPage.tsx                <- 메인 페이지 (ViewMode 분기, Board 렌더링)
    components/
      // Board
      KanbanBoard.tsx               <- 메인 보드 컨테이너 (DndContext)
      KanbanColumn.tsx              <- 개별 컬럼 (Droppable)
      KanbanColumnHeader.tsx        <- 컬럼 헤더 (WIP 상태, 카드 수)
      KanbanCard.tsx                <- 개별 카드 (Draggable)
      KanbanCardCompact.tsx         <- 컴팩트 카드 (EXEC_SUMMARY용)
      BlockedSwimlane.tsx           <- BLOCKED 수평 swimlane
      SwimlaneContainer.tsx         <- Swimlane 그룹 컨테이너
      SwimlaneRow.tsx               <- 개별 Swimlane 행
      ColumnCountsSummary.tsx       <- EXEC_SUMMARY: 컬럼 카운트만 표시
      ReadOnlyBanner.tsx            <- manage_kanban 없을 때 읽기 전용 안내

      // DnD
      DragOverlay.tsx               <- 드래그 중 카드 오버레이
      DropIndicator.tsx             <- 드롭 가능 위치 시각 표시
      WipExceededDialog.tsx         <- WIP 초과 확인 다이얼로그

      // 필터 & 툴바
      KanbanToolbar.tsx             <- 상단 툴바 (Sprint 선택, 필터, Swimlane)
      KanbanFilters.tsx             <- 필터 바 (FilterSpec 기반)
      KanbanKpiRow.tsx              <- 상단 KPI 카드 Row
      SprintSelector.tsx            <- Sprint 선택 드롭다운
      SwimlaneSelector.tsx          <- Swimlane 모드 선택

      // Right Panel
      CardDetailPanel.tsx           <- panelMode: "card-detail"
      StoryContextPanel.tsx         <- panelMode: "story-context"
      MetricsPanel.tsx              <- panelMode: "metrics" (차트/그래프)
      AssignmentPanel.tsx           <- panelMode: "assignment" (Quick Assign)
      KanbanRightPanel.tsx          <- panelMode 분기 렌더링
      ScopeRestrictionBanner.tsx    <- Part 범위 제한 안내

      // 카드 상세
      CardPriorityBadge.tsx         <- 우선순위 배지
      CardAssigneeAvatar.tsx        <- 담당자 아바타
      CardStoryRef.tsx              <- 상위 Story 참조 링크
      CardLabels.tsx                <- 라벨 태그 목록
      CardDueDate.tsx               <- 마감일 (지연 시 경고)
      BlockedBadge.tsx              <- BLOCKED 일수 배지

      // 모달 & 다이얼로그
      BlockReasonDialog.tsx         <- BLOCKED 사유 입력
      QuickAssignDialog.tsx         <- 담당자 빠른 배정
      WipLimitSettingsDialog.tsx    <- WIP Limit 설정 (PM 전용)
      CardContextMenu.tsx           <- 카드 우클릭 메뉴

      // 차트 (Metrics Panel)
      CycleTimeChart.tsx            <- Cycle Time 분포 차트
      ThroughputChart.tsx           <- Throughput 추이 그래프
      CumulativeFlowChart.tsx       <- CFD (누적 흐름 다이어그램)
      WipByAssigneeChart.tsx        <- 담당자별 WIP 분포

    api/
      kanbanApi.ts                  <- Kanban API 호출
    hooks/
      useKanbanBoard.ts             <- 보드 TanStack Query
      useKanbanStats.ts             <- 통계 Query
      useKanbanDnd.ts               <- DnD 상태 관리 (dnd-kit)
      useKanbanFilter.ts            <- 필터 상태 + URL 동기화
      useKanbanPanelMode.ts         <- Right Panel 모드 상태
      useSwimlane.ts                <- Swimlane 그룹화 로직
      useWipLimit.ts                <- WIP Limit 조회/설정
      useCardContextMenu.ts         <- 카드 컨텍스트 메뉴 상태
    types/
      kanban.ts                     <- 칸반 전용 타입 정의
```

### 7.2 KanbanPage.tsx ViewMode 분기

```typescript
function KanbanPage() {
  const { viewMode } = useAccessContext();
  const { panelMode, setPanelMode } = useKanbanPanelMode(viewMode);
  const { filter, setFilter, resetFilter } = useKanbanFilter();
  const { data, isLoading, refetch } = useKanbanBoard(filter);
  const { swimlaneMode, setSwimlaneMode, groups } = useSwimlane(data?.columns);
  const canManage = useCapability("manage_kanban");

  // 카드 선택 상태
  const [selectedCardId, setSelectedCardId] = useState<string | null>(null);

  // 카드 클릭 핸들러
  const handleCardClick = useCallback((card: KanbanCard) => {
    if (viewMode === "EXEC_SUMMARY" || viewMode === "CUSTOMER_APPROVAL") return;
    setSelectedCardId(card.id);
    setPanelMode("card-detail");
  }, [viewMode]);

  // panelMode에 따른 Right Panel 컴포넌트 결정
  const rightPanelContent = useMemo(() => {
    switch (panelMode) {
      case "none":           return undefined;
      case "card-detail":    return <CardDetailPanel cardId={selectedCardId} />;
      case "story-context":  return <StoryContextPanel />;
      case "metrics":        return <MetricsPanel />;
      case "assignment":     return <AssignmentPanel />;
      default:               return undefined;
    }
  }, [panelMode, selectedCardId]);

  // EXEC_SUMMARY: 컴팩트 뷰
  if (viewMode === "EXEC_SUMMARY") {
    return (
      <PageLayout header={<KanbanToolbar viewMode={viewMode} />}>
        <KanbanKpiRow viewMode={viewMode} metrics={data?.metrics} />
        <ColumnCountsSummary columns={data?.columns} />
      </PageLayout>
    );
  }

  return (
    <PageLayout
      header={<KanbanToolbar viewMode={viewMode} />}
      rightPanel={rightPanelContent}
      rightPanelDefault={PRESET_POLICIES[viewMode].ui.defaultRightPanel}
    >
      {/* Part 범위 제한 안내 (v2.1: scopeReason 세분화) */}
      {(data?.scope.scopeReason === "role_restricted_part" ||
        data?.scope.scopeReason === "role_restricted_assignee") && (
        <ScopeRestrictionBanner
          scopeReason={data.scope.scopeReason}
          partNames={data.scope.appliedPartNames}
        />
      )}

      {/* ReadOnly 안내 */}
      {!canManage && <ReadOnlyBanner />}

      <KanbanKpiRow viewMode={viewMode} metrics={data?.metrics} />
      <KanbanFilters
        viewMode={viewMode}
        filterSpec={kanbanNode.filterSpec}
        filter={filter}
        onFilterChange={setFilter}
        onReset={resetFilter}
      />

      {/* BLOCKED Swimlane */}
      {data?.blocked.cardCount > 0 && (
        <BlockedSwimlane
          cards={data.blocked.cards}
          onCardClick={handleCardClick}
          canDrag={canManage}
        />
      )}

      {/* Kanban Board with DnD */}
      <KanbanBoard
        columns={data?.columns ?? []}
        swimlaneMode={swimlaneMode}
        swimlaneGroups={groups}
        canDrag={canManage}
        viewMode={viewMode}
        onCardClick={handleCardClick}
        selectedCardId={selectedCardId}
        onMoveComplete={refetch}
      />
    </PageLayout>
  );
}
```

### 7.3 KanbanBoard.tsx -- DnD 컨테이너 (dnd-kit)

```typescript
import {
  DndContext,
  DragEndEvent,
  DragStartEvent,
  DragOverEvent,
  DragOverlay,
  closestCorners,
  PointerSensor,
  useSensor,
  useSensors,
} from "@dnd-kit/core";

interface KanbanBoardProps {
  columns: KanbanBoardResponse["columns"];
  swimlaneMode: SwimlaneMode;
  swimlaneGroups: SwimlaneGroup[];
  canDrag: boolean;
  viewMode: ViewModePreset;
  onCardClick: (card: KanbanCard) => void;
  selectedCardId: string | null;
  onMoveComplete: () => void;
}

function KanbanBoard(props: KanbanBoardProps) {
  const [activeCard, setActiveCard] = useState<KanbanCard | null>(null);
  const { moveTask } = useKanbanDnd();
  const { wipLimits } = useWipLimit();

  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 8,  // 8px 이동 후 드래그 시작 (클릭과 구분)
      },
    })
  );

  const handleDragStart = (event: DragStartEvent) => {
    const card = findCard(event.active.id as string);
    if (!card) return;

    // DEV_EXECUTION: 내 카드만 드래그 가능
    if (props.viewMode === "DEV_EXECUTION" && card.assigneeId !== currentUserId) {
      return;  // 드래그 취소
    }

    setActiveCard(card);
  };

  /**
   * v2.1: DEV_EXECUTION에서 다른 사용자 카드에 draggable=false 시각 피드백
   * (커서: not-allowed, opacity: 0.6)
   */
  const isCardDraggable = (card: KanbanCard): boolean => {
    if (!props.canDrag) return false;
    if (props.viewMode === "DEV_EXECUTION" && card.assigneeId !== currentUserId) return false;
    if (card.status === "BLOCKED") return false;
    return true;
  };

  const handleDragEnd = async (event: DragEndEvent) => {
    const { active, over } = event;
    setActiveCard(null);

    if (!over) return;

    const cardId = active.id as string;
    const targetColumnId = extractColumnId(over.id as string);

    if (!targetColumnId) return;

    // WIP Limit 검증
    const validation = validateDrop(
      targetColumnId,
      wipLimits.find(w => w.columnId === targetColumnId) ?? { columnId: targetColumnId, limit: null },
      getColumnCardCount(targetColumnId),
      "warn"
    );

    if (!validation.allowed) {
      // block 모드: 이동 거부
      toast.error(validation.reason);
      return;
    }

    if (validation.confirmRequired) {
      // warn 모드: 확인 다이얼로그
      const confirmed = await showWipExceededDialog(validation.reason!);
      if (!confirmed) return;
    }

    // API 호출
    try {
      const card = findCard(cardId)!;
      await moveTask({
        taskId: cardId,
        targetStatus: targetColumnId,
        newOrder: calculateNewOrder(over),
        wipOverrideConfirmed: validation.confirmRequired,
        expectedVersion: card.version,  // v2.1: 낙관적 락
      });
      props.onMoveComplete();
    } catch (error) {
      handleMoveError(error);
    }
  };

  return (
    <DndContext
      sensors={sensors}
      collisionDetection={closestCorners}
      onDragStart={handleDragStart}
      onDragEnd={handleDragEnd}
    >
      <div className="kanban-board">
        {props.swimlaneMode === "none" ? (
          // 플랫 보드
          <div className="kanban-columns">
            {props.columns.map(col => (
              <KanbanColumn
                key={col.id}
                column={col}
                canDrag={props.canDrag}
                onCardClick={props.onCardClick}
                selectedCardId={props.selectedCardId}
              />
            ))}
          </div>
        ) : (
          // Swimlane 보드
          <div className="kanban-swimlanes">
            {props.swimlaneGroups.map(group => (
              <SwimlaneRow
                key={group.id}
                group={group}
                columns={props.columns}
                canDrag={props.canDrag}
                onCardClick={props.onCardClick}
                selectedCardId={props.selectedCardId}
              />
            ))}
          </div>
        )}
      </div>

      <DragOverlay>
        {activeCard && <KanbanCard card={activeCard} isDragOverlay />}
      </DragOverlay>
    </DndContext>
  );
}
```

---

## 8. AI Navigation 연동

### 8.1 virtualNode 우선 반환 정책

> 03_백로그 $10.1과 동일한 패턴: AI는 가능한 경우 raw filter 대신
> **virtualId를 우선 반환**한다.

```typescript
/** AI virtualNode 매칭 우선순위 */
const VIRTUAL_NODE_PRIORITY: { virtualId: string; matchFilter: Partial<KanbanFilterSpec> }[] = [
  { virtualId: "kanban.blocked",       matchFilter: { taskStatus: "BLOCKED" } },
  { virtualId: "kanban.my-tasks",      matchFilter: { assigneeId: "me" } },
  { virtualId: "kanban.in-review",     matchFilter: { taskStatus: "IN_REVIEW" } },
  { virtualId: "kanban.high-priority", matchFilter: { priority: "CRITICAL" } },
  /**
   * v2.1: wip-exceeded는 FilterSpec의 view 키로 직렬화
   * URL: /kanban?view=wip-exceeded
   */
  { virtualId: "kanban.wip-exceeded",  matchFilter: { view: "wip-exceeded" } },
];

function resolveKanbanNavigation(filter: KanbanFilterSpec): AiKanbanNavigation {
  // 1. virtualNode 매칭 시도 (우선)
  for (const vn of VIRTUAL_NODE_PRIORITY) {
    if (isSubsetMatch(vn.matchFilter, filter)) {
      return { targetNodeId: "kanban", virtualId: vn.virtualId, filter, reason: "..." };
    }
  }
  // 2. 매칭 실패 시 raw filter 반환
  return { targetNodeId: "kanban", filter, reason: "..." };
}
```

### 8.2 AI 질문 -> 화면 이동 (FilterSpec + virtualId)

```typescript
/** AI가 반환하는 네비게이션 추천 (v2.0) */
interface AiKanbanNavigation {
  targetNodeId: "kanban";
  /** v2.0: virtualNode 우선 반환 */
  virtualId?: string;
  /** FilterSpec 기반 필터 객체 */
  filter: KanbanFilterSpec;
  /** 특정 Task 직접 이동 시 */
  entityId?: string;                   // "TSK-088"
  reason: string;                      // "BLOCKED 태스크 3건 확인 필요"
}
```

| 질문 | AI 반환 | virtualId? | 설명 |
|------|--------|-----------|------|
| "BLOCKED 된 태스크 보여줘" | `{ taskStatus: "BLOCKED" }` | `kanban.blocked` | virtualId 우선 |
| "내 태스크 보여줘" | `{ assigneeId: "me" }` | `kanban.my-tasks` | virtualId 우선 |
| "리뷰 대기 태스크" | `{ taskStatus: "IN_REVIEW" }` | `kanban.in-review` | virtualId 우선 |
| "긴급 태스크만" | `{ priority: "CRITICAL" }` | `kanban.high-priority` | virtualId 우선 |
| "병목이 어디야?" | `{}` (보드 전체) | `kanban.wip-exceeded` | WIP 초과 뷰 |
| "Sprint-5 칸반 보여줘" | `{ sprintId: "s-5" }` | -- | raw filter |
| "TSK-088 상세 보여줘" | `entityId: "TSK-088"` | -- | 직접 이동 |
| "김OO 담당 태스크" | `{ assigneeId: "usr-123" }` | -- | raw filter |

### 8.3 AI 응답 예시 (JSON)

```json
{
  "answer": {
    "summary": "현재 IN_PROGRESS 컬럼에 4건의 태스크가 있으며, WIP Limit(3)을 초과하고 있습니다. BLOCKED 태스크 3건도 확인이 필요합니다.",
    "highlights": [
      "IN_PROGRESS WIP 초과: 4/3 (1건 초과)",
      "BLOCKED: TSK-089(3일), TSK-142(5일), TSK-201(1일)",
      "평균 Cycle Time: 2.3일 (목표 2.0일 대비 0.3일 초과)"
    ],
    "warnings": [
      "TSK-142가 5일째 BLOCKED -- 에스컬레이션 필요"
    ]
  },
  "navigation": {
    "primary": {
      "route": "/kanban",
      "label": "칸반 보드",
      "reason": "WIP 초과 및 BLOCKED 태스크 확인"
    },
    "secondary": [
      {
        "route": "/issues",
        "label": "이슈 관리",
        "reason": "BLOCKED 태스크 관련 이슈 등록"
      },
      {
        "route": "/sprints",
        "label": "스프린트",
        "reason": "스프린트 범위 재조정 검토"
      }
    ]
  },
  "viewMode": {
    "suggested": "PM_WORK",
    "confidence": 0.85,
    "why": [
      "질문이 '병목/WIP/흐름' 중심",
      "WIP 초과 + BLOCKED -> 관리자 시점 필요"
    ]
  },
  "requiredCaps": ["view_kanban"],
  "scopeHints": {
    "projectId": "p-001",
    "sprintId": "sprint-5"
  }
}
```

### 8.4 Preset별 do intent AI 라우팅

AI는 조치(do) 질문 시 $1.3의 `DO_INTENT_ROUTING_KANBAN`에 따라 targetNodeId를 결정한다.

```
PM이 "태스크 이동해줘"   -> targetNodeId: "kanban" (전체 보드)
PMO가 "병목 확인해줘"    -> targetNodeId: "kanban" (bottleneck view)
DEV가 "내 태스크 이동"   -> targetNodeId: "kanban" + assigneeId=me
```

### 8.5 Context Panel에서의 AI 추천

```
-- 추천 액션 ----------------------
! TSK-142 결제모듈 BLOCKED 5일째
  -> [이슈 관리에서 확인]       <- targetNodeId: "issues"

! IN_PROGRESS WIP 초과 (4/3)
  -> [리뷰 처리 우선]           <- virtualId: "kanban.in-review"

i TSK-088 스코어링 Cycle Time 3.1일 (평균 2.3일 초과)
  -> [상세 확인]                <- entityId: "TSK-088"

i Sprint-5 종료까지 3일, TODO 5건 남음
  -> [스프린트에서 확인]        <- targetNodeId: "sprints"
```

---

## 9. 인터랙션 상세 (Drag & Drop)

### 9.1 DnD 상태 머신

```typescript
/** DnD 상태 머신 */
export type DndState =
  | "idle"           // 대기 -- 드래그 시작 전
  | "dragging"       // 드래그 중 -- 카드가 활성화됨
  | "over-column"    // 컬럼 위 -- 드롭 가능 영역 위에 있음
  | "over-card"      // 카드 위 -- 정렬 순서 변경 대상
  | "wip-warning"    // WIP 경고 -- WIP Limit 초과 경고 표시
  | "dropping"       // 드롭 중 -- API 호출 중
  | "dropped"        // 드롭 완료 -- 성공
  | "cancelled";     // 취소 -- ESC 또는 원래 위치로 복귀

/**
 * DnD 상태 전이:
 *
 * idle -> dragging        (PointerDown + 8px 이동)
 * dragging -> over-column (드래그 중 컬럼 영역 진입)
 * dragging -> over-card   (드래그 중 다른 카드 위)
 * over-column -> wip-warning  (WIP Limit 초과 컬럼)
 * over-column -> dropping (PointerUp + drop)
 * over-card -> dropping   (PointerUp + drop)
 * wip-warning -> dropping (사용자 확인 후 drop)
 * wip-warning -> cancelled (사용자 취소)
 * dragging -> cancelled   (ESC 키 또는 원래 위치)
 * dropping -> dropped     (API 성공)
 * dropping -> idle        (API 실패 -> rollback)
 * dropped -> idle         (애니메이션 완료)
 * cancelled -> idle       (복귀 완료)
 */
```

### 9.2 DnD 시각 피드백

```
드래그 시작:
  - 원본 카드: opacity 0.4 (반투명 ghost)
  - 드래그 오버레이: 카드 복제 + 그림자 + 약간 확대(1.02x)
  - 커서: grabbing

컬럼 위 (over-column):
  - 대상 컬럼: 파란색 보더 + 배경 틴트
  - WIP 정상: 초록 점선 가이드
  - WIP 경고: 주황 점선 가이드 + 경고 아이콘
  - WIP 초과: 빨간 점선 가이드 + 경고 텍스트

카드 위 (over-card):
  - 삽입 위치에 수평 파란 선 표시 (drop indicator)
  - 위/아래 카드가 약간 벌어지는 애니메이션

드롭 완료:
  - 카드가 새 위치로 슬라이드 애니메이션 (200ms ease-out)
  - 컬럼 헤더 카운트 즉시 업데이트
  - WIP 상태 배지 즉시 업데이트

드롭 실패:
  - 카드가 원래 위치로 슬라이드 백 (300ms ease-out)
  - 에러 토스트 표시
```

### 9.3 DnD 유효성 검증 (프론트)

```typescript
/** 프론트 DnD 유효성 검증 (서버 전송 전 빠른 필터) */
function validateDndFrontend(
  card: KanbanCard,
  targetColumnId: TaskStatus,
  viewMode: ViewModePreset,
  currentUserId: string,
  canManage: boolean
): DndValidation {
  // 1. 권한 검사
  if (!canManage) {
    return { valid: false, reason: "카드 이동 권한이 없습니다." };
  }

  // 2. BLOCKED 카드는 직접 이동 불가
  if (card.status === "BLOCKED") {
    return { valid: false, reason: "BLOCKED 태스크는 먼저 해제 후 이동하세요." };
  }

  // 3. 같은 컬럼으로 이동 (순서 변경만)
  if (card.status === targetColumnId) {
    return { valid: true, isReorder: true };
  }

  // 4. DEV_EXECUTION: 내 카드만
  if (viewMode === "DEV_EXECUTION" && card.assigneeId !== currentUserId) {
    return { valid: false, reason: "내 태스크만 이동할 수 있습니다." };
  }

  // 5. 유효한 상태 전이 검사
  const validTransitions: Record<TaskStatus, TaskStatus[]> = {
    TODO:         ["IN_PROGRESS"],
    IN_PROGRESS:  ["IN_REVIEW", "TODO"],
    IN_REVIEW:    ["DONE", "IN_PROGRESS"],
    DONE:         ["IN_REVIEW"],         // 재오픈
    BLOCKED:      [],                     // 별도 unblock API
  };

  if (!validTransitions[card.status]?.includes(targetColumnId)) {
    return {
      valid: false,
      reason: `${card.status}에서 ${targetColumnId}로 직접 이동할 수 없습니다.`,
    };
  }

  return { valid: true };
}
```

### 9.4 카드 컨텍스트 메뉴

```
카드 우클릭 또는 ... 버튼 클릭:

+---------------------------+
| 상세 보기             >   |  <- 항상 표시
|---------------------------|
| 담당자 변경           >   |  <- cap: manage_kanban
| In Progress로 이동        |  <- cap: manage_kanban + 유효 전이
| In Review로 이동          |  <- cap: manage_kanban + 유효 전이
| Done으로 이동             |  <- cap: manage_kanban + 유효 전이
|---------------------------|
| BLOCKED 처리              |  <- cap: manage_kanban (BLOCKED 아닐 때)
| BLOCKED 해제              |  <- cap: manage_kanban (BLOCKED일 때)
|---------------------------|
| 이슈 등록             >   |  <- cap: manage_issues
| 백로그에서 보기       >   |  <- 항상 표시
+---------------------------+
```

### 9.5 Quick Assign 인터랙션

```
1. 카드 상세 패널 또는 컨텍스트 메뉴에서 [담당자 변경] 클릭
2. AssignmentPanel 또는 QuickAssignDialog 표시

+- 담당자 선택 ----------------+
| 검색: [ 이름 입력...      ]  |
|                              |
| 현재 Sprint 참여자:          |
|  +--+ 김OO  (WIP: 3)        |
|  +--+ 이OO  (WIP: 2)  v     |  <- 선택
|  +--+ 박OO  (WIP: 4) !      |  <- WIP 높음 경고
|  +--+ 정OO  (WIP: 0)        |
|                              |
| [ ] 할당 해제                |
|                              |
| [확인]  [취소]               |
+------------------------------+

3. 확인 -> PATCH /api/kanban/tasks/:taskId/assign
4. 카드 아바타 즉시 업데이트 (낙관적 업데이트)
```

### 9.6 BLOCKED 토글 인터랙션

```
BLOCKED 처리:
1. 카드 컨텍스트 메뉴 -> [BLOCKED 처리]
2. BlockReasonDialog 표시

+- BLOCKED 사유 입력 ----------+
| 사유: [ API 응답 지연으로   ]|
|       [ 연동 불가           ]|  <- 필수 입력
|                              |
| 연결 이슈: [ ISS-045 v ]    |  <- 선택 (기존 이슈 선택)
|            [ + 이슈 등록 ]   |  <- 이슈 관리로 이동
|                              |
| [확인]  [취소]               |
+------------------------------+

3. PATCH /api/kanban/tasks/:taskId/block
4. 카드가 BLOCKED swimlane으로 이동 애니메이션

BLOCKED 해제:
1. BLOCKED swimlane 카드 -> [BLOCKED 해제]
2. 확인 다이얼로그 (간단)
3. PATCH /api/kanban/tasks/:taskId/unblock
4. 카드가 previousStatus 컬럼으로 복귀 애니메이션
```

### 9.7 데이터 새로고침

| 항목 | 주기 |
|------|------|
| Board 전체 | 페이지 진입 시 + 필터 변경 시 + DnD 완료 후 |
| Metrics | 페이지 진입 시 + 30초 자동 (staleTime: 30s) |
| WIP Limits | 페이지 진입 시 (캐시 5분) |
| Card Detail | 카드 클릭 시 (실시간) |
| Stats (차트) | Metrics Panel 열릴 때 (캐시 1분) |

### 9.8 낙관적 업데이트 (Optimistic Update)

```typescript
/** DnD 낙관적 업데이트 전략 */
const useKanbanDnd = () => {
  const queryClient = useQueryClient();

  const moveTask = useMutation({
    mutationFn: (req: MoveTaskRequest) => kanbanApi.moveTask(req),

    // 낙관적 업데이트: API 호출 전에 UI 먼저 반영
    onMutate: async (req) => {
      // 기존 쿼리 취소
      await queryClient.cancelQueries({ queryKey: ["kanban", "board"] });

      // 이전 데이터 스냅샷
      const previous = queryClient.getQueryData<KanbanBoardResponse>(
        ["kanban", "board"]
      );

      // 낙관적으로 카드 이동
      queryClient.setQueryData<KanbanBoardResponse>(
        ["kanban", "board"],
        (old) => {
          if (!old) return old;
          return moveCardOptimistic(old, req.taskId, req.targetStatus, req.newOrder);
        }
      );

      return { previous };
    },

    // 에러 시 롤백
    onError: (err, req, context) => {
      if (context?.previous) {
        queryClient.setQueryData(["kanban", "board"], context.previous);
      }
      toast.error(getErrorMessage(err));
    },

    // 성공/실패 관계없이 서버 데이터로 동기화
    // v2.1: storyTransition이 있을 때만 board+stats 전체 refetch,
    //        없으면 board만 refetch (stats는 staleTime 내 캐시 활용)
    onSettled: (_data, _error, _variables) => {
      queryClient.invalidateQueries({ queryKey: ["kanban", "board"] });
      if (_data?.storyTransition) {
        queryClient.invalidateQueries({ queryKey: ["kanban", "stats"] });
      }
    },
  });

  return { moveTask: moveTask.mutateAsync };
};
```

---

## 10. 반응형 대응

| 너비 | Board | Right Panel | 카드 | 필터 |
|------|-------|------------|------|------|
| >=1440px | 4컬럼 전체 + BLOCKED swimlane | Right Panel (30%) | 전체 정보 | 인라인 |
| 1280px | 4컬럼 (카드 너비 축소) | Drawer (toggle) | 라벨 축약 | 인라인 |
| <=1024px | **수평 스크롤** 4컬럼 + 스와이프 | Drawer (overlay) | 컴팩트 (제목+담당만) | 접이식 |
| <=768px | **단일 컬럼 뷰** + 탭으로 컬럼 전환 | Full Modal | 최소 (제목+상태배지) | 접이식 |

### 10.1 모바일 칸반 (<=768px)

```
+-------------------------------+
| 칸반 보드                      |
| Sprint: [ Sprint-5 v ]        |
+-------------------------------+
|                                |
| [TODO(5)] [진행(4)] [리뷰(2)] [완료(12)]  <- 탭 컬럼 선택
|                                |
| === IN_PROGRESS (4/3) ! ===   |
|                                |
| +---------------------------+ |
| | TSK-088                   | |
| | 스코어링 API 개발          | |
| | HIGH  김OO  S-02          | |
| +---------------------------+ |
|                                |
| +---------------------------+ |
| | TSK-090                   | |
| | 배치 처리 모듈             | |
| | HIGH  이OO  S-02          | |
| +---------------------------+ |
|                                |
| +---------------------------+ |
| | TSK-091                   | |
| | API 게이트웨이 개발        | |
| | MEDIUM  박OO  S-02        | |
| +---------------------------+ |
|                                |
| +---------------------------+ |
| | TSK-092                   | |
| | 인증 연동                  | |
| | MEDIUM  김OO  S-03        | |
| +---------------------------+ |
|                                |
+-------------------------------+

- DnD 비활성 (모바일)
- 카드 탭 -> Full Modal 상세
- 상태 변경: 카드 내 드롭다운
```

---

## 11. 깨지기 쉬운 곳 체크리스트

> 이 7곳을 막으면 안정화가 빨라진다.

| # | 위험 지점 | 해결책 | 검증 방법 |
|---|----------|--------|----------|
| 1 | **DnD + 낙관적 업데이트 불일치** | 낙관적 UI 반영 후 API 실패 시 이전 상태로 완전 롤백. `onSettled`에서 서버 데이터 재조회. 롤백 시 카드가 원래 위치로 슬라이드 백 애니메이션 | API 실패 시뮬레이션 -> 카드가 원래 컬럼/순서로 복귀 확인. 롤백 후 컬럼 카운트/WIP 상태 정상 확인 |
| 2 | **WIP Limit + 동시 DnD** | 서버에서 WIP Limit 재검증 (프론트 검증은 UX 목적). 동시 이동으로 초과 시 후자에 409 반환. 낙관적 업데이트이므로 롤백 처리 | 두 브라우저에서 같은 컬럼으로 동시 카드 이동 -> WIP Limit 초과 시 후자 롤백 확인 |
| 3 | **Task -> Story -> Epic 연쇄 전이** | 서버 트랜잭션에서 원자적 처리. 응답에 `storyTransition`/`epicTransition` 포함. 프론트는 응답 기반으로 관련 컴포넌트 업데이트 (토스트 알림) | 마지막 Task를 DONE으로 이동 -> Story REVIEW 자동 전이 + Epic completable 플래그 갱신 확인 |
| 4 | **Part scope + DnD 교차** | 서버에서 Part scope 검증. DevReader가 다른 Part의 카드를 DnD 시도 -> 프론트에서 선차단 + 서버 403 이중 방어 | DevReader가 다른 Part 카드를 드래그 -> 드래그 시작 안됨 확인. URL 조작으로 partId 변경 -> 서버 403 확인 |
| 5 | **BLOCKED 상태 + DnD 충돌** | BLOCKED 카드는 DnD 대상에서 제외 (draggable=false). BLOCKED swimlane 내에서도 순서 변경 불가. 반드시 unblock API를 통해서만 복귀 | BLOCKED 카드 드래그 시도 -> 드래그 시작 안됨 확인. BLOCKED 해제 -> previousStatus 컬럼으로 정확히 복귀 확인 |
| 6 | **동시 수정 충돌 (낙관적 락)** | MoveTaskRequest에 `expectedVersion` 포함. 서버가 현재 DB version과 비교하여 불일치 시 409 `CONCURRENT_MODIFICATION` 반환. 프론트는 409 수신 시 서버 데이터 refetch 후 사용자에게 충돌 알림 | 두 브라우저에서 같은 카드를 동시 이동 -> 후자가 409 수신 + 롤백 + 최신 데이터 반영 확인 |
| 7 | **Scope 강제 정책 우회 시도** | 읽기(GET): 서버가 allowedPartIds로 쿼리 강제 재작성 + scope echo 200 반환 (silent rewrite). 쓰기(PATCH): Part 범위 위반 시 403 반환. URL 조작으로 partId 변경해도 서버가 무시 | DevReader가 URL에서 partId를 다른 Part로 변경 -> 응답의 scope echo에 원래 Part만 포함 확인. 다른 Part 카드 이동 시도 -> 403 확인 |

---

## 12. Capability 매핑 총괄

| Capability | 행위 | 대표 역할 |
|-----------|------|---------|
| `view_kanban` | 칸반 보드 조회, 카드 목록 탐색, 메트릭스 조회 | ALL (역할별 범위 제한) |
| `manage_kanban` | 카드 DnD 이동, 담당자 배정, BLOCKED 처리/해제, WIP Limit 설정 | PM, DevReader(파트 내), DEV(내 카드) |
| `manage_issues` | 카드에서 이슈 등록 (칸반 -> 이슈 관리 연동) | PM, PMO |
| `export_reports` | 칸반 메트릭스/병목 리포트 Export | PMO |

> **DEV의 manage_kanban 범위**: DEV는 `manage_kanban` Capability를 보유하지만,
> 프론트에서 `viewMode === "DEV_EXECUTION"`일 때 **자신에게 할당된 카드만** DnD를 활성화한다.
> 서버에서도 DEV가 다른 사용자의 카드를 이동하려 하면 403을 반환한다.

---

## 13. DoD (본 화면 완료 기준)

- [ ] `/kanban` 페이지에서 Preset별 렌더링 분기 동작
- [ ] FilterSpec 기반 다차원 필터 (sprintId/assigneeId/partId/priority/epicId/storyId/taskStatus/q) 동작
- [ ] FilterSpec URL 직렬화/역직렬화 왕복 보장
- [ ] KPI Row: WIP Count, Cycle Time, Throughput, Blocked Count, Lead Time, Avg Cycle Time (6종) 표시
- [ ] 4컬럼 칸반 보드: TODO / IN_PROGRESS / IN_REVIEW / DONE 렌더링
- [ ] BLOCKED swimlane: 상단 수평 분리 영역 렌더링 + 접기/펼치기
- [ ] **DnD (dnd-kit)**: 카드 드래그 -> 컬럼 간 이동 -> PATCH /api/kanban/tasks/:taskId/move
- [ ] **DnD 상태 머신**: idle/dragging/over-column/over-card/wip-warning/dropping/dropped/cancelled 전이
- [ ] **DnD 시각 피드백**: 반투명 ghost, 드래그 오버레이, 드롭 인디케이터, 컬럼 하이라이트
- [ ] **DnD 낙관적 업데이트**: API 전 UI 반영 + 실패 시 롤백 + onSettled 서버 동기화
- [ ] **DnD 유효성 검증 (프론트)**: 권한/BLOCKED/유효전이/DEV내카드만 선차단
- [ ] **WIP Limit**: 컬럼 헤더에 WIP 상태(normal/warning/exceeded) 시각 표시
- [ ] **WIP Limit 초과 DnD**: warn 모드(확인 후 이동) / block 모드(이동 차단) 정책
- [ ] **WIP Limit 설정**: PM만 PATCH /api/kanban/wip-limits (cap: manage_kanban)
- [ ] **BLOCKED 처리**: 사유 입력 다이얼로그 -> PATCH /api/kanban/tasks/:taskId/block
- [ ] **BLOCKED 해제**: 확인 -> PATCH /api/kanban/tasks/:taskId/unblock -> previousStatus 복귀
- [ ] **Quick Assign**: 담당자 선택 -> PATCH /api/kanban/tasks/:taskId/assign
- [ ] 카드 클릭 -> Right Panel: panelMode `"card-detail"` (Task 상세 + Story 컨텍스트)
- [ ] panelMode 기반 Right Panel 분기 (none/card-detail/story-context/metrics/assignment)
- [ ] **Swimlane**: none / assignee / story / priority 4종 모드 전환
- [ ] **카드 컨텍스트 메뉴**: 상세보기/담당변경/상태이동/BLOCKED/이슈등록
- [ ] **서버 트랜잭션**: Task DONE 이동 시 Story REVIEW 자동 전이 + Epic completable 갱신
- [ ] **Task Move 에러 계약**: 7종 에러 코드별 HTTP 상태 + 프론트 대응
- [ ] **Part scope 서버 강제**: allowedPartIds 계산 + 403/빈결과 + scope echo 응답
- [ ] **ScopeRestrictionBanner**: role_restricted일 때 "내 파트 범위만 표시" 안내
- [ ] **ReadOnlyBanner**: manage_kanban 없을 때 "읽기 전용 모드" 안내
- [ ] PM_WORK: 전체 보드 + WIP 경고 + 담당 배정 + 모든 카드 DnD
- [ ] PMO_CONTROL: 병목 뷰 + Throughput 메트릭스 + 읽기 전용 (DnD 비활성)
- [ ] DEV_EXECUTION: 내 카드 필터 + 내 카드만 DnD + 카드 상세
- [ ] EXEC_SUMMARY: 컴팩트 요약 (컬럼 카운트 막대만 표시, 카드 미표시)
- [ ] CUSTOMER_APPROVAL: 읽기 전용 보드 (DnD 비활성, CTA 없음)
- [ ] Cycle Time / Lead Time 계산 (영업일 기준)
- [ ] **virtualNode 5종**: blocked/my-tasks/in-review/wip-exceeded/high-priority AI 우선 반환
- [ ] **Preset별 do intent 라우팅**: 모든 Preset에서 do_move_task -> kanban
- [ ] AI 추천 액션: FilterSpec + virtualId 딥링크 + BLOCKED/WIP초과/CycleTime 알림
- [ ] Metrics Panel: CycleTimeChart, ThroughputChart, CumulativeFlowChart, WipByAssigneeChart
- [ ] 반응형 레이아웃 (>=1440 / 1280 / <=1024 / <=768)
- [ ] 모바일 (<=768px): 탭 컬럼 전환 + DnD 비활성 + 드롭다운 상태 변경
- [ ] **동시 편집 충돌**: 낙관적 잠금 + 409 롤백 + 서버 재조회
- [ ] **v2.1 FilterSpec `view` 키**: wip-exceeded virtualNode가 URL 직렬화 왕복 보장
- [ ] **v2.1 KanbanCard `createdAt`**: Lead Time 계산이 타입 안전하게 동작
- [ ] **v2.1 WIP Count 정의**: wipCount = IN_PROGRESS + IN_REVIEW (BLOCKED 제외) 일관 적용
- [ ] **v2.1 WipLimitConfig 4컬럼 보장**: wipLimits.find() 널 안전 (nullish coalescing 적용)
- [ ] **v2.1 Metrics 네이밍**: avgCycleTimeWindow / avgCycleTimeAllTime 구분 적용
- [ ] **v2.1 낙관적 락**: MoveTaskRequest.expectedVersion → 409 CONCURRENT_MODIFICATION 핸들링
- [ ] **v2.1 Scope 강제 정책**: 읽기=silent rewrite+echo / 쓰기=403 이중 방어
- [ ] **v2.1 Reliability 3-tuple**: Board + Stats API 모두 `warnings: {code,message,severity}[]` 형태
- [ ] **v2.1 ScopeEcho 4-type**: full_access / role_restricted_assignee / role_restricted_part / explicit_filter
- [ ] **v2.1 refetch 최적화**: storyTransition 있을 때만 stats invalidate

---

## 부록 A. 변경이력

| 버전 | 날짜 | 변경 내용 |
|------|------|---------|
| v1.0 | 2026-02-08 | 초안 작성 -- 4컬럼 칸반 구조, FilterSpec 내장, Preset별 분기, DnD(dnd-kit) 상세, WIP Limit 정책, BLOCKED swimlane, Cycle Time/Lead Time, Swimlane 옵션, AI Navigation virtualNode, 컴포넌트 분해, API 스펙 |
| v2.0 | 2026-02-08 | 10개 영역 반영: (1) FilterSpec URL 직렬화 규칙 확정, (2) DnD 상태 머신 8단계 정의, (3) WIP Limit warn/block 이중 정책, (4) BLOCKED swimlane 분리 + previousStatus 복귀, (5) Cycle Time/Lead Time 영업일 기준 확정, (6) Card Detail Right Panel 5종 panelMode, (7) virtualNode 5종 AI 우선 반환, (8) Task Move 에러 계약 7종, (9) 낙관적 업데이트 + 롤백 전략, (10) 깨지기 쉬운 5곳 체크리스트 |
| v2.1 | 2026-02-08 | 10개 영역 반영: (1) FilterSpec `view` 키 추가(wip-exceeded 온톨로지 승격), (2) KanbanCard `createdAt`+`version` 필드 추가, (3) WIP Count 정의 확정(IN_PROGRESS+IN_REVIEW, BLOCKED 제외), (4) WipLimitConfig `warningThreshold` 제거+4컬럼 보장, (5) Metrics 네이밍 정리(avgCycleTimeWindow/avgCycleTimeAllTime), (6) MoveTaskRequest `expectedVersion` 낙관적 락, (7) Scope 강제 정책 고정(읽기: silent rewrite+echo / 쓰기: 403), (8) Reliability 3-tuple 표준화(Board+Stats API), (9) ScopeEcho 4-type 세분화+Scope 2-tier, (10) 깨지기 쉬운 곳 5→7 확장+DoD v2.1 항목 추가 |
