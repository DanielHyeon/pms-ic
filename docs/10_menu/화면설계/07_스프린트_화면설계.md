# 07. 스프린트 화면설계

> 작성일: 2026-02-08
> 버전: v2.1
> 라우트: `/sprints`, `/sprints/:sprintId`
> 필요 Capability: `view_sprints` (조회), `manage_sprints` (생성/편집/종료)
> 기본 Preset: 역할에 따라 자동 결정
> 노드 역할: **Detail** (상세 노드 — 필터/조회/편집 전용)

> **v2.0 변경**: Sprint 생명주기 상태 전이 서버 트랜잭션 확정,
> Burndown/Velocity 차트 스펙 확정, Sprint Planning D&D 인터랙션,
> Sprint Close 시 미완료 Story 자동 복귀 정책, Preset별 AI 라우팅 정책,
> FilterSpec URL 직렬화 규칙, KPI 카드 클릭 인터랙션,
> 깨지기 쉬운 곳 5곳 체크리스트 확정.
>
> **v2.1 변경**: FilterSpec 키 수 정합(6→4 확정, 2.1 표 수정),
> Sprint Start 날짜 검증 완화(경고 전환, 강제 차단 옵션화),
> Sprint Close Task 리셋 대상 열거(IN_PROGRESS/IN_REVIEW→TODO, BLOCKED/DONE/CANCELLED 유지),
> Burndown "completed SP" 기준 확정(Story.status==DONE),
> 영업일 계산 규칙 확정(주말 제외 기본, 캘린더 확장 로드맵),
> BurndownChartData에 currentDayIndex/currentDate 추가(서버 기준),
> Lifecycle API 멱등성 규칙 확정(이미 전이된 상태면 200 반환),
> Burndown 재계산 비용 모델 명확화(Redis 30s TTL = 재계산 억제),
> Planning 탭 권한 분리(assign_story_sprint ↔ manage_sprints),
> Retrospective Action Item → Backlog 승격 연결 고리 설계,
> 프로젝트 단위 단일 Sprint 정책 명시,
> Reliability 3-tuple 표준화(`warnings: {code,message,severity}[]`),
> Scope 2-tier(`securityKeys`+`explorationKeys`) 패턴 적용,
> 깨지기 쉬운 곳 5→7 확장, DoD v2.1 항목 추가.

---

## 1. 화면 개요

### 1.1 목적

스프린트는 **"지금 이 반복 주기에서 팀이 뭘 하고 있고, 속도는 어떤가?"**에 대한 답을 제공한다.
백로그에서 READY 상태의 Story를 Sprint에 할당하고, 2주 단위의 반복 주기 동안 실행 현황을
Burndown 차트와 Velocity 지표로 실시간 추적하며, Sprint 종료 시 회고를 통해 다음 Sprint의 계획을 개선한다.

> **핵심 분리 원칙**: 백로그(Backlog)는 **"우리가 뭘 만들 것인가"**(계획/편성 홈),
> 칸반(Kanban)은 **"지금 어떻게 흐르는가"**(실행 홈),
> 스프린트(Sprint)는 **"이 반복 주기를 어떻게 운영하는가"**(운영 홈).
> 세 화면은 같은 Story/Task 데이터를 공유하되 **관점(lens)**이 다르다.

### 1.2 설계 원칙

| 원칙 | 설명 |
|------|------|
| **Sprint = 타임박스** | 고정 기간(보통 2주) 내에서 약속한 Story를 완료하는 것이 목표 |
| **Burndown = 진실의 원천** | SP 잔여량의 일별 추이가 Sprint 건강도를 보여준다 |
| **Velocity = 예측의 기반** | 최근 N개 Sprint의 완료 SP 평균으로 다음 Sprint 계획 수립 |
| **Sprint Close = 정산** | 미완료 Story는 자동으로 Backlog READY 풀로 복귀 (서버 트랜잭션) |
| **FilterSpec = 온톨로지** | 필터 키가 AI/URL/백엔드 공통 스키마로 통합 |
| **상태 전이 = 서버 트랜잭션** | Sprint 상태 전이는 프론트 임의 변경 불가, 서버에서만 처리 |
| **Capability 기반 권한** | Sprint 생성/편집/종료는 `manage_sprints`, 조회는 `view_sprints` |
| **Part 독립 운영** | Sprint는 프로젝트 단위이며, Part별 필터는 Story 레벨에서 적용 |
| **프로젝트 단일 Sprint 운영** | 프로젝트 당 ACTIVE Sprint는 최대 1개. Part별 별도 Sprint는 허용하지 않음 -- Part 독립성은 Story 레벨 필터로 확보 |
| **영업일 = 주말 제외** | Burndown의 totalWorkingDays는 주말(토/일) 제외 기준. 공휴일 캘린더 반영은 향후 확장 (프로젝트 캘린더/국가별 공휴일) |
| **Burndown 완료 = Story.status==DONE** | Burndown의 "completed SP"는 `Story.status == DONE`인 Story의 SP 합계. Task 완료 여부와 무관하게 Story 단위로 집계 |
| **Lifecycle 멱등성** | start/close/cancel 요청이 이미 전이된 상태면 200으로 현재 상태를 반환 (중복 클릭/네트워크 재시도 안전) |
| **READY = Task 포함 가능** | Sprint Close로 복귀한 READY Story는 기존 Task(TODO/BLOCKED)를 유지. 다음 Sprint에서 이어서 실행 가능 |

### 1.3 행동 무게중심 -- 3개 화면의 역할 분담

> 03_백로그 설계의 역할 분담 원칙을 동일하게 적용한다.

| 화면 | 역할 | 핵심 행동 |
|------|------|---------|
| **백로그** | **계획/편성 홈** | Epic/Story 생성, Story 정제, SP 추정, Sprint 할당 |
| **칸반** | **실행 홈** | Task 상태 변경, 코드리뷰, 완료 처리 |
| **스프린트** (본 화면) | **운영 홈** | Sprint 구성, 속도 측정, Burndown, 회고 |

**Preset별 AI 라우팅 정책 (do_close_sprint 예시)**:

| Preset | "Sprint 종료해줘" -> AI 라우팅 | 이유 |
|--------|-------------------------------|------|
| PM_WORK | -> `targetNodeId: "sprints"` | PM은 Sprint 운영 권한 보유 |
| PMO_CONTROL | -> `targetNodeId: "sprints"` | PMO는 Sprint 통제 관점 |
| DEV_EXECUTION | -> `targetNodeId: "sprints"` (읽기 안내) | DEV는 Sprint 종료 권한 없음 |
| EXEC_SUMMARY | -> `targetNodeId: "sprints"` (요약 안내) | 요약만 제공 |

```typescript
/** Preset별 do intent 라우팅 정책 — Sprint 화면 */
export const SPRINT_DO_INTENT_ROUTING: Record<ViewModePreset, Record<string, string>> = {
  PM_WORK: {
    do_create_sprint:    "sprints",
    do_close_sprint:     "sprints",
    do_plan_sprint:      "sprints",     // Sprint Planning
    do_start_sprint:     "sprints",
    do_cancel_sprint:    "sprints",
    do_assign_sprint:    "backlog",     // READY 풀에서 할당
    do_retrospective:    "sprints",
  },
  PMO_CONTROL: {
    do_create_sprint:    "sprints",
    do_close_sprint:     "sprints",
    do_plan_sprint:      "sprints",
    do_start_sprint:     "sprints",
    do_cancel_sprint:    "sprints",
    do_assign_sprint:    "sprints",     // Sprint 구성 통제
    do_retrospective:    "sprints",
  },
  DEV_EXECUTION: {
    do_create_sprint:    "sprints",     // 안내만 (권한 없음)
    do_close_sprint:     "sprints",     // 안내만 (권한 없음)
    do_plan_sprint:      "sprints",     // 안내만
    do_start_sprint:     "sprints",     // 안내만
    do_cancel_sprint:    "sprints",     // 안내만
    do_assign_sprint:    "kanban",      // 실행 관점
    do_retrospective:    "sprints",
  },
  EXEC_SUMMARY: {
    do_create_sprint:    "sprints",
    do_close_sprint:     "sprints",
    do_plan_sprint:      "sprints",
    do_start_sprint:     "sprints",
    do_cancel_sprint:    "sprints",
    do_assign_sprint:    "sprints",
    do_retrospective:    "sprints",
  },
  CUSTOMER_APPROVAL: {
    do_create_sprint:    "sprints",
    do_close_sprint:     "sprints",
    do_plan_sprint:      "sprints",
    do_start_sprint:     "sprints",
    do_cancel_sprint:    "sprints",
    do_assign_sprint:    "sprints",
    do_retrospective:    "sprints",
  },
};
```

> **핵심**: Preset의 동적 전환은 단순 UI 밀도 변경이 아니라 **AI 라우팅 정책까지 함께 바뀌는 진짜 Preset**이다.

### 1.4 핵심 질문 -> 위젯 매핑

| 사용자 질문 | 화면 영역 | 설명 |
|-----------|---------|------|
| "현재 Sprint 진행률은?" | KPI + Burndown | current_sprint_progress |
| "이번 Sprint Story 목록은?" | Sprint Backlog 테이블 | Sprint에 할당된 Story 목록 |
| "Burndown 보여줘" | Burndown 차트 | 이상선 vs 실제선 |
| "팀 Velocity 알려줘" | Velocity 차트 | 최근 N개 Sprint 평균 |
| "Sprint Goal은 뭐야?" | Sprint Header | Sprint 목표 텍스트 |
| "미완료 Story 몇 건이야?" | KPI 카드 | stories_remaining |
| "다음 Sprint 언제 시작해?" | Sprint 목록 | 다음 PLANNING Sprint |
| "Sprint-5 상세 보여줘" | Sprint 상세 | `/sprints/:sprintId` 직접 이동 |
| "지난 Sprint 회고 내용은?" | Retrospective 탭 | Sprint 회고 내역 |
| "SP 커밋 vs 완료 비교" | KPI 카드 | sp_committed_vs_completed |
| "Sprint 생성해줘" | Sprint 생성 모달 | do_create_sprint |
| "Sprint 종료해줘" | Sprint 종료 다이얼로그 | do_close_sprint |

---

## 2. MenuOntology 노드

### 2.1 타입 확정

01_대시보드 / 02_요구사항 / 03_백로그 v2.0 패턴을 동일하게 적용한다.

| 항목 | v1.0 | v2.0 | v2.1 (확정) | 변경 사유 |
|------|------|------|------------|----------|
| `entities` | PascalCase | 동일 | 동일 | -- |
| `intents` | 8개 | **13개** | 동일 | Planning/Close/Retrospective/Velocity 질문 추가 |
| Capability | 2개 | **2개** | **3개** (명시) | `assign_story_sprint` Planning 탭 분리 |
| `filterSpec` | 4키 | 4키 | **4키** (확정) | v2.0 "6키" 표기는 오류 -- status/dateRange/partId/q 4키가 최종 |
| `virtualNodes` | 2개 | **4개** | 동일 | `active-sprint`, `planning`, `velocity`, `retrospective` |
| `metrics` | 4개 | **8개** | 동일 | Velocity/Burndown/Goal 관련 추가 |
| AI 라우팅 | 단일 | Preset별 분기 | 동일 | SPRINT_DO_INTENT_ROUTING 적용 |
| Scope | -- | project-level | **2-tier** | `securityKeys` + `explorationKeys` 분리 |
| Reliability | -- | `completeness: number` | **3-tuple** | `completeness: {overall, breakdown?}`, `warnings: {code,message,severity}[]` |
| 멱등성 | -- | -- | **확정** | start/close/cancel 이미 전이된 상태면 200 반환 |

### 2.2 FilterSpec 정의

FilterSpec은 **이 화면이 지원하는 필터 스키마**를 온톨로지 내부에 선언한다.
AI가 딥링크를 생성할 때, URL 파라미터 문자열이 아니라 **FilterSpec 키 기반 필터 객체**를 반환한다.

```typescript
/** Sprint 필터 스키마 -- 온톨로지 내장 (v2.0) */
export interface SprintFilterSpec {
  /** Sprint 상태 */
  status?: "PLANNING" | "ACTIVE" | "COMPLETED" | "CANCELLED";
  /** 기간 범위 (ISO 8601 날짜) */
  dateRange?: {
    from?: string;   // "2026-01-01"
    to?: string;     // "2026-03-31"
  };
  /** Part(파트) 범위 -- Story 레벨 필터 */
  partId?: string;
  /** 자유 검색어 */
  q?: string;
}
```

> **queryMode 판정 규칙**: Sprint 화면은 목록 구조가 단순(플랫 리스트)하므로
> 백로그의 TREE/SEARCH 분리가 불필요하다. 모든 필터는 서버 API 파라미터로 직접 전달된다.

### 2.3 FilterSpec URL 직렬화 규칙

> 03_백로그 v2.1 패턴을 동일하게 적용한다.

**직렬화 방향**: `SprintFilterSpec -> URL query string -> SprintFilterSpec` (왕복 보장)

```typescript
/** FilterSpec -> URL 직렬화 */
function serializeSprintFilter(filter: SprintFilterSpec): URLSearchParams {
  const params = new URLSearchParams();
  for (const [key, value] of Object.entries(filter)) {
    if (value === undefined || value === null) continue;
    if (key === "dateRange" && typeof value === "object") {
      if (value.from) params.set("dateFrom", value.from);
      if (value.to) params.set("dateTo", value.to);
      continue;
    }
    params.set(key, String(value));
  }
  return params;
}

/** URL -> FilterSpec 역직렬화 */
function deserializeSprintFilter(params: URLSearchParams): SprintFilterSpec {
  const filter: SprintFilterSpec = {};
  const enumKeys = {
    status: ["PLANNING", "ACTIVE", "COMPLETED", "CANCELLED"],
  } as const;

  for (const [key, value] of params.entries()) {
    // enum validation
    if (key in enumKeys) {
      if ((enumKeys as any)[key].includes(value)) {
        (filter as any)[key] = value;
      }
      continue;
    }
    // dateRange reconstruction
    if (key === "dateFrom") {
      filter.dateRange = { ...filter.dateRange, from: value };
      continue;
    }
    if (key === "dateTo") {
      filter.dateRange = { ...filter.dateRange, to: value };
      continue;
    }
    // string keys (partId, q)
    if (["partId", "q"].includes(key)) {
      (filter as any)[key] = value;
    }
    // unknown keys -> silent drop (forward compatibility)
  }
  return filter;
}
```

**직렬화 규칙 요약**:

| 규칙 | 예시 | 설명 |
|------|------|------|
| enum은 화이트리스트 검증 | `?status=ACTIVE` | 유효하지 않은 값은 silent drop |
| dateRange는 flat 전개 | `?dateFrom=2026-01-01&dateTo=2026-03-31` | 중첩 객체 -> flat 키 |
| 미지 키는 무시 | `?futureKey=x` -> 무시 | 하위 호환성 보장 |
| dateRange 빈 객체 정규화 | `dateRange: {}` -> `undefined` | 역직렬화 후 `from`/`to` 모두 없으면 키 자체 삭제 |
| 개방 구간 허용 | `?dateFrom=2026-01-01` (dateTo 없음) | dateFrom-only = "해당 일 이후", dateTo-only = "해당 일 이전" -- 서버가 open range로 처리 |

### 2.4 Sprint 노드 (확정본 v2.0)

```typescript
const sprintNode: MenuOntologyNodeV2 = {
  nodeId: "sprints",
  label: "스프린트",
  route: "/sprints",
  icon: "SprintRounded",
  domain: "execution",
  nodeRole: "detail",              // detail node -- action/filter queries get +10 boost

  requiredCaps: ["view_sprints"],

  // --- intents: 13 (v2.0: +5) ---
  intents: [
    // Ask -- inquiry/query
    "ask_sprint_status",             // "현재 Sprint 진행률은?"
    "ask_sprint_stories",            // "이번 Sprint Story 목록은?"
    "ask_burndown",                  // "Burndown 보여줘"
    "ask_velocity",                  // "팀 Velocity 알려줘"
    "ask_sprint_goal",               // "Sprint Goal은 뭐야?"
    "ask_sprint_remaining",          // "미완료 Story 몇 건이야?"
    "ask_sprint_detail",             // "Sprint-5 상세 보여줘"
    "ask_retrospective",             // "지난 Sprint 회고 내용은?"
    "ask_sp_committed_vs_completed", // v2.0: "SP 커밋 vs 완료 비교"
    // Do -- execution/change
    "do_create_sprint",              // "Sprint 생성해줘"
    "do_close_sprint",               // "Sprint 종료해줘"
    "do_plan_sprint",                // v2.0: "Sprint Planning 시작"
    "do_start_sprint",               // v2.0: "Sprint 시작해줘"
  ],
  canonicalQuestions: [
    "현재 Sprint 진행률 보여줘",
    "이번 Sprint에 할당된 Story는?",
    "Burndown 차트 보여줘",
    "팀 Velocity 알려줘",
    "Sprint Goal은 뭐야?",
    "미완료 Story 몇 건이야?",
    "Sprint-5 상세 보여줘",
    "지난 Sprint 회고 내용은?",
    "새 Sprint 만들어줘",
    "Sprint 종료해줘",
    "SP 커밋 vs 완료 비교해줘",
  ],
  entities: ["Sprint", "Story", "Task", "Burndown", "Velocity"],
  keywords: [
    "스프린트", "Sprint", "sprint", "번다운", "burndown",
    "벨로시티", "velocity", "회고", "retrospective",
    "스프린트 계획", "sprint planning", "스프린트 목표",
    "sprint goal", "스프린트 백로그", "sprint backlog",
    "반복", "iteration", "타임박스", "timebox",
  ],
  metrics: [
    "current_sprint_progress",           // 현재 Sprint 진행률 (%)
    "velocity",                          // 최근 N Sprint 평균 완료 SP
    "burndown_remaining",                // Burndown 잔여 SP
    "sprint_goal_completion",            // Sprint Goal 달성률
    "story_completion_rate",             // Story 완료율 (완료/전체)
    "sp_committed_vs_completed",         // 커밋 SP vs 완료 SP
    "total_active_sprints",              // 활성 Sprint 수 (보통 1)
    "sprint_count_by_status",            // 상태별 Sprint 수
  ],

  // --- FilterSpec ontology embedded (v2.0) ---
  filterSpec: {
    keys: [
      "status", "dateRange", "partId", "q",
    ],
    defaults: {},  // Preset-overridable
  },

  defaultPreset: "PM_WORK",
  presetPolicies: [
    {
      preset: "EXEC_SUMMARY",
      ui: {
        density: "compact",
        defaultRightPanel: "closed",
        highlight: {
          metricKeys: ["current_sprint_progress", "velocity", "sprint_goal_completion"],
          widgetKeys: ["KPI_PROGRESS", "BURNDOWN_MINI", "VELOCITY_MINI"],
        },
        hiddenColumns: ["partId", "assigneeId"],
      },
    },
    {
      preset: "PMO_CONTROL",
      ui: {
        density: "standard",
        defaultRightPanel: "open",
        highlight: {
          metricKeys: [
            "current_sprint_progress", "velocity",
            "sp_committed_vs_completed", "story_completion_rate",
          ],
          widgetKeys: [
            "KPI_PROGRESS", "BURNDOWN_CHART", "VELOCITY_CHART",
            "SPRINT_COMPARISON_TABLE",
          ],
        },
      },
      suggestedActions: [
        {
          key: "view_backlog",
          label: "백로그 현황",
          requiredCaps: ["view_backlog"],
          targetNodeId: "backlog",
        },
        {
          key: "export_sprint_report",
          label: "Sprint 리포트 Export",
          requiredCaps: ["export_reports"],
          targetNodeId: "reports",
        },
      ],
    },
    {
      preset: "PM_WORK",
      ui: {
        density: "detailed",
        defaultRightPanel: "open",
        highlight: {
          metricKeys: [
            "current_sprint_progress", "velocity", "burndown_remaining",
            "sprint_goal_completion", "story_completion_rate",
            "sp_committed_vs_completed",
          ],
          widgetKeys: [
            "KPI_PROGRESS", "KPI_VELOCITY", "KPI_REMAINING",
            "BURNDOWN_CHART", "VELOCITY_CHART",
            "SPRINT_BACKLOG_TABLE", "SPRINT_PLANNING_ZONE",
          ],
        },
      },
      suggestedActions: [
        {
          key: "create_sprint",
          label: "Sprint 생성",
          requiredCaps: ["manage_sprints"],
          targetNodeId: "sprints",
        },
        {
          key: "plan_sprint",
          label: "Sprint Planning",
          requiredCaps: ["manage_sprints"],
          targetNodeId: "sprints",
        },
        {
          key: "close_sprint",
          label: "Sprint 종료",
          requiredCaps: ["manage_sprints"],
          targetNodeId: "sprints",
        },
        {
          key: "go_backlog",
          label: "백로그",
          requiredCaps: ["view_backlog"],
          targetNodeId: "backlog",
        },
        {
          key: "go_kanban",
          label: "칸반 보드",
          requiredCaps: ["view_kanban"],
          targetNodeId: "kanban",
        },
      ],
    },
    {
      preset: "DEV_EXECUTION",
      ui: {
        density: "standard",
        defaultRightPanel: "closed",
        defaultFilters: { status: "ACTIVE" },
        highlight: {
          metricKeys: ["current_sprint_progress", "burndown_remaining", "story_completion_rate"],
          widgetKeys: ["KPI_PROGRESS", "BURNDOWN_CHART", "MY_STORIES_TABLE"],
        },
      },
      suggestedActions: [
        {
          key: "go_my_work",
          label: "내 작업",
          requiredCaps: ["view_my_work"],
          targetNodeId: "my-work",
        },
        {
          key: "go_kanban",
          label: "칸반 보드",
          requiredCaps: ["view_kanban"],
          targetNodeId: "kanban",
        },
      ],
    },
    {
      preset: "CUSTOMER_APPROVAL",
      ui: {
        density: "compact",
        defaultRightPanel: "closed",
        highlight: {
          metricKeys: ["current_sprint_progress", "sprint_goal_completion"],
          widgetKeys: ["KPI_PROGRESS", "SPRINT_MILESTONE_VIEW"],
        },
        hiddenColumns: ["partId", "assigneeId", "storyPoints", "taskStatus"],
      },
    },
  ],

  // --- DeepLink: routeTemplate standard (:param format) ---
  deepLinks: [
    {
      pattern: "/sprints?status=:status",
      description: "Sprint status filter",
      requiredParams: ["status"],
    },
    {
      pattern: "/sprints?dateFrom=:dateFrom&dateTo=:dateTo",
      description: "Sprint date range filter",
      requiredParams: ["dateFrom", "dateTo"],
    },
    {
      pattern: "/sprints?partId=:partId",
      description: "Part-scoped Sprint view",
      requiredParams: ["partId"],
    },
    {
      pattern: "/sprints/:sprintId",
      description: "Sprint detail (Burndown + Story list + Velocity)",
      requiredParams: ["sprintId"],
    },
  ],

  // --- Virtual Nodes: DeepLink promoted to ontology L2 (v2.0: 4) ---
  virtualNodes: [
    {
      virtualId: "sprints.active",
      label: "Active Sprint",
      routeTemplate: "/sprints?status=ACTIVE",
      requiredParams: [],
      intents: ["ask_sprint_status", "ask_burndown", "ask_sprint_stories"],
      description: "Current active Sprint -- Burndown + Story list",
    },
    {
      virtualId: "sprints.planning",
      label: "Sprint Planning",
      routeTemplate: "/sprints?status=PLANNING",
      requiredParams: [],
      intents: ["do_plan_sprint", "do_create_sprint"],
      description: "PLANNING Sprint -- Story assignment entry point",
    },
    {
      virtualId: "sprints.velocity",
      label: "Velocity Trend",
      routeTemplate: "/sprints?status=COMPLETED",
      requiredParams: [],
      intents: ["ask_velocity"],
      description: "Completed Sprints -- Velocity rolling average",
    },
    {
      virtualId: "sprints.retrospective",
      label: "Sprint Retrospective",
      routeTemplate: "/sprints/:sprintId#retrospective",
      requiredParams: ["sprintId"],
      intents: ["ask_retrospective"],
      description: "Sprint Retrospective notes and action items",
    },
  ],

  // --- Scope: 2-tier (v2.1) ---
  scope: {
    securityKeys: ["projectId"],           // tenant boundary -- 서버가 JWT + projectId 교차 검증
    explorationKeys: ["partId", "status"], // user drill-down -- 프론트 필터 전용, 보안 경계 아님
  },

  priority: 3,
};
```

---

## 3. 화면 구조

### 3.1 Right Panel panelMode 정의

Right Panel은 항상 동일한 영역이지만, **panelMode**에 따라 표시 내용이 달라진다.

```typescript
/** Right Panel mode -- explicit enum */
export type SprintPanelMode =
  | "none"             // Right Panel hidden (EXEC_SUMMARY, CUSTOMER_APPROVAL)
  | "sprint-summary"   // Sprint summary info (list -> row selected)
  | "story-detail"     // Story detail (Sprint Backlog -> Story row selected)
  | "burndown"         // Burndown chart full view
  | "velocity"         // Velocity trend full view
  | "planning"         // Sprint Planning zone (D&D Story assignment)
  | "retrospective";   // Sprint Retrospective
```

**panelMode 결정 규칙**:

| 컨텍스트 | Preset | 기본 panelMode |
|---------|--------|---------------|
| 목록 + 행 미선택 | ALL | `"none"` |
| 목록 + Sprint 행 선택 | EXEC_SUMMARY / CUSTOMER_APPROVAL | `"none"` (Right Panel hidden) |
| 목록 + Sprint 행 선택 | PM_WORK / PMO_CONTROL | `"sprint-summary"` |
| 목록 + Sprint 행 선택 | DEV_EXECUTION | `"sprint-summary"` (read-only) |
| 상세 페이지 | PM_WORK | `"burndown"` (default) |
| 상세 페이지 + Story 선택 | PM_WORK | `"story-detail"` |
| 상세 페이지 + Planning 탭 | PM_WORK | `"planning"` |
| 상세 페이지 + Retrospective 탭 | ALL | `"retrospective"` |

### 3.2 Sprint 목록 (`/sprints`)

```
+--------------------------------------------------------------+
|  Page Header                                                  |
|  스프린트  [ AI 보험금지급심사 구축 ]                            |
|  [ 필터 v ]  [ 검색 ]                    [ + Sprint 생성 ]    |
+--------------------------------------------------------------+
|                                                              |
|  +----------+  +----------+  +----------+  +----------+      |
|  | Current  |  | Velocity |  | Goal     |  | Stories  |      |
|  | Sprint   |  |          |  | Achieve  |  | Remain   |      |
|  | 68%      |  | 28 SP    |  | 75%      |  | 5건      |      |
|  | ###....  |  | /sprint  |  |          |  |          |      |
|  +----------+  +----------+  +----------+  +----------+      |
|                                                              |
|  +----------+  +----------+  +----------+  +----------+      |
|  | Committed|  | Completed|  | Burndown |  | Active   |      |
|  | SP       |  | SP       |  | Remain   |  | Sprints  |      |
|  | 42 SP    |  | 28 SP    |  | 14 SP    |  | 1        |      |
|  +----------+  +----------+  +----------+  +----------+      |
|                                                              |
|  +-- Filter Bar ----------------------------------------+    |
|  | Status: [All v] Date: [From] ~ [To]  Part: [All v]  |    |
|  |                                 <- FilterSpec 1:1    |    |
|  +------------------------------------------------------+    |
|                                                              |
|  +-- Sprint List ----------------------------+-----------+   |
|  |                                           | panelMode:|   |
|  |  >> Sprint-6 (Active)                     | "sprint-  |   |
|  |     ACTIVE | 2026-02-03 ~ 02-14           |  summary" |   |
|  |     Goal: 사기탐지 API MVP 완성             |           |   |
|  |     Progress: ########.... 68%            | -- Summary|   |
|  |     Stories: 8건 (3 Done, 5 Remaining)    | Goal: ... |   |
|  |     SP: 28/42 completed                   | Days: 4   |   |
|  |                                           | Remaining |   |
|  |  -- Sprint-5 (Completed)                  |           |   |
|  |     COMPLETED | 2026-01-20 ~ 02-02        | Stories:  |   |
|  |     Goal: 데이터 파이프라인 구축              |  8건     |   |
|  |     Velocity: 32 SP                       | SP: 28/42 |   |
|  |                                           |           |   |
|  |  -- Sprint-4 (Completed)                  | Burndown  |   |
|  |     COMPLETED | 2026-01-06 ~ 01-19        | mini:     |   |
|  |     Velocity: 26 SP                       |   \.      |   |
|  |                                           |    `---.  |   |
|  |  -- Sprint-7 (Planning)                   |        \  |   |
|  |     PLANNING | 2026-02-17 ~ 03-02         |           |   |
|  |     Goal: 미정                             | Actions:  |   |
|  |     Planned SP: 0                         | [Detail]  |   |
|  |                                           | [Kanban]  |   |
|  +-------------------------------------------+-----------+   |
|                                                              |
+--------------------------------------------------------------+
```

### 3.3 Sprint 상세 (`/sprints/:sprintId`)

```
+--------------------------------------------------------------+
|  Page Header                                                  |
|  <- 스프린트  Sprint-6  사기탐지 API MVP 완성                   |
|                [ 편집 ] [ Sprint 시작 | 종료 ] [ 회고 ]        |
+--------------------------------------------------------------+
|                                                              |
|  +-- Sprint Info Bar -----------------------------------+    |
|  | Status: ACTIVE   Period: 2026-02-03 ~ 02-14          |    |
|  | Goal: 사기탐지 API MVP 완성                             |    |
|  | Days Remaining: 4   Total SP: 42   Done SP: 28       |    |
|  +------------------------------------------------------+    |
|                                                              |
|  +-- Tab Bar -------------------------------------------+    |
|  | [ Burndown ] [ Stories ] [ Velocity ] [ Retrospective]|    |
|  +------------------------------------------------------+    |
|                                                              |
|  === Tab: Burndown (default) ===                             |
|                                                              |
|  +-- Burndown Chart ---------------------+-----------+       |
|  |                                       | panelMode:|       |
|  |  SP                                   | "burndown"|       |
|  |  42 |*                                |           |       |
|  |     | *  .                            | -- Stats  |       |
|  |  35 |  * .                            | Ideal:    |       |
|  |     |   *.                            |  -4.2/day |       |
|  |  28 |    *  .                         | Actual:   |       |
|  |     |    |*  .                        |  -3.5/day |       |
|  |  21 |    | * .                        |           |       |
|  |     |    |  *.                        | Gap: +2SP |       |
|  |  14 |    |    *                       | (behind)  |       |
|  |     |    |    |                       |           |       |
|  |   7 |    |    |   .                   | Forecast: |       |
|  |     |    |    |    .                  | 6 SP will |       |
|  |   0 +----+----+----+----+----+       | remain at |       |
|  |     D1   D3   D5   D7   D9  D10      | sprint end|       |
|  |                                       |           |       |
|  |  --- Ideal line (dashed)              |           |       |
|  |  *** Actual line (solid)              |           |       |
|  |                                       |           |       |
|  +---------------------------------------+-----------+       |
|                                                              |
|  === Tab: Stories ===                                        |
|                                                              |
|  +-- Sprint Backlog Table ----------------+-----------+      |
|  |                                        | panelMode:|      |
|  | ID    | Title          |SP|Status     | "story-   |      |
|  | ------+----------------+--+---------  |  detail"  |      |
|  | S-02  | 실시간 스코어링  | 8|DONE      |           |      |
|  | S-03  | 알림 처리       | 3|IN_PROGRE  | -- Detail |      |
|  | S-06  | 룰 엔진 통합    | 5|IN_PROGRE  | S-03      |      |
|  | S-07  | 배치 처리       | 8|IN_SPRINT  | 알림 처리  |      |
|  | S-08  | API Gateway     | 5|REVIEW    | Status:   |      |
|  | S-09  | 로깅 연동       | 3|IN_SPRINT  | IN_PROGR  |      |
|  | S-10  | 모니터링 대시보드 | 5|TODO      | SP: 3     |      |
|  | S-11  | 알림 템플릿     | 5|TODO      | Assignee: |      |
|  |                                        | 이OO      |      |
|  | Total: 42 SP | Done: 28 SP            | Tasks: 3  |      |
|  |              | Remaining: 14 SP       |  (1 block)|      |
|  +----------------------------------------+-----------+      |
|                                                              |
|  === Tab: Velocity ===                                       |
|                                                              |
|  +-- Velocity Chart ----------------------------+            |
|  |                                              |            |
|  |  SP                                          |            |
|  |  40 |                                        |            |
|  |     |         +-+                             |            |
|  |  32 |         | |  +-+                        |            |
|  |     |    +-+  | |  | |                        |            |
|  |  26 |    | |  | |  | |  +-+                   |            |
|  |     |    | |  | |  | |  | |                   |            |
|  |  20 | +--+ |  | |  | |  | |                   |            |
|  |     | |  | |  | |  | |  | |                   |            |
|  |     +-+--+-+--+-+--+-+--+-+--                 |            |
|  |     S-1  S-2  S-3  S-4  S-5  S-6(진행중)      |            |
|  |                                              |            |
|  |  --- Rolling Avg: 28 SP/Sprint (dashed line) |            |
|  |  Trend: Improving (+8% vs previous)          |            |
|  +----------------------------------------------+            |
|                                                              |
|  === Tab: Retrospective ===                                  |
|                                                              |
|  +-- Retrospective --------------------------------+         |
|  |                                                 |         |
|  |  +-- What went well -------------------------+  |         |
|  |  | - API 설계 리뷰 프로세스 안정화              |  |         |
|  |  | - 페어 프로그래밍으로 코드 품질 향상          |  |         |
|  |  +-------------------------------------------+  |         |
|  |                                                 |         |
|  |  +-- What could improve ----------------------+  |         |
|  |  | - Sprint 중간 요구사항 변경이 2건 발생       |  |         |
|  |  | - 테스트 자동화 커버리지 부족                |  |         |
|  |  +-------------------------------------------+  |         |
|  |                                                 |         |
|  |  +-- Action Items ----------------------------+  |         |
|  |  | [ ] 요구사항 변경 프로세스 강화               |  |         |
|  |  | [ ] E2E 테스트 커버리지 70% 목표              |  |         |
|  |  | [x] 코드 리뷰 체크리스트 도입 (완료)          |  |         |
|  |  +-------------------------------------------+  |         |
|  |                                                 |         |
|  +---Retrospective는 Sprint COMPLETED 후 작성------+         |
|                                                              |
+--------------------------------------------------------------+
```

### 3.4 Sprint Planning 뷰 (`/sprints/:sprintId?tab=planning`)

```
+--------------------------------------------------------------+
|  Sprint Planning -- Sprint-7 (PLANNING)                      |
|  Goal: [                                           ]         |
|  Period: 2026-02-17 ~ 03-02  |  Capacity: ~30 SP (avg)      |
+--------------------------------------------------------------+
|                                                              |
|  +-- READY Pool (Backlog) -----+  +-- Sprint Backlog ------+|
|  |  Drag Stories to Sprint ->  |  |  <- Sprint-7 Backlog    ||
|  |                             |  |                         ||
|  |  +- S-12 보고서 생성 ----+  |  |  +- S-14 알림 연동 --+ ||
|  |  | READY | 5 SP | AI팀   |  |  |  | IN_SPRINT | 3 SP  | ||
|  |  +----------------------+  |  |  +-------------------+ ||
|  |                             |  |                         ||
|  |  +- S-13 대시보드 위젯 --+  |  |  +- S-15 로그 수집 --+ ||
|  |  | READY | 8 SP | FE팀   |  |  |  | IN_SPRINT | 5 SP  | ||
|  |  +----------------------+  |  |  +-------------------+ ||
|  |                             |  |                         ||
|  |  +- S-16 배치 스케줄러 --+  |  |  Total: 8 SP / ~30 SP  ||
|  |  | READY | 5 SP | BE팀   |  |  |  Remaining capacity:   ||
|  |  +----------------------+  |  |  22 SP                   ||
|  |                             |  |                         ||
|  |  +- S-17 권한 관리 ------+  |  |                         ||
|  |  | READY | 3 SP | BE팀   |  |  |                         ||
|  |  +----------------------+  |  |                         ||
|  |                             |  |                         ||
|  |  Available: 21 SP          |  |                         ||
|  +-----------------------------+  +-------------------------+|
|                                                              |
|  [Sprint 시작] -- PLANNING -> ACTIVE 전이 (서버 트랜잭션)      |
+--------------------------------------------------------------+
```

---

## 4. Preset별 차이

### 4.1 EXEC_SUMMARY (Sponsor)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | 현재 Sprint 진행률, Sprint Goal 달성률, Velocity (요약) |
| Sprint 목록 | Active Sprint만 표시 (완료/계획 Sprint 숨김) |
| Burndown | Mini Burndown (간략 차트) |
| Right Panel | panelMode: `"none"` (hidden) |
| CTA | 없음 (read-only) |

### 4.2 PMO_CONTROL (PMO)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | 진행률, Velocity, SP 커밋 vs 완료, Story 완료율 |
| Sprint 목록 | 전체 Sprint (상태별 필터 가능) |
| Burndown | Full Burndown 차트 + Velocity 차트 |
| Right Panel | panelMode: `"sprint-summary"` (Sprint 선택 시) |
| CTA | `Sprint 리포트 Export` -> targetNodeId: `reports`, `백로그 현황` -> targetNodeId: `backlog` |

### 4.3 PM_WORK (PM)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | 전체 8개 KPI (진행률, Velocity, Burndown, Goal, Story 완료율, SP 커밋/완료, 활성 Sprint, 상태별 Sprint) |
| Sprint 목록 | **전체 Sprint** (상태별 필터, 생성/편집/종료 CTA) |
| Burndown | Full Burndown 차트 + Forecast 라인 |
| Velocity | Full Velocity 차트 + Rolling Average |
| Right Panel | panelMode: `"burndown"` (default) + 추천 액션 |
| CTA | `Sprint 생성` (cap: `manage_sprints`), `Sprint Planning` (cap: `manage_sprints`), `Sprint 종료` (cap: `manage_sprints`), `백로그` -> targetNodeId: `backlog`, `칸반 보드` -> targetNodeId: `kanban` |

**PM_WORK 인라인 CTA**:

| 컨텍스트 | CTA | Capability |
|---------|-----|-----------|
| Sprint 목록 상단 | `[+ Sprint 생성]` | `manage_sprints` |
| PLANNING Sprint 행 | `[Sprint 시작]` | `manage_sprints` |
| ACTIVE Sprint 행 | `[Sprint 종료]` | `manage_sprints` |
| Sprint 상세 | `[편집]` | `manage_sprints` |
| Sprint 상세 (COMPLETED) | `[회고 작성]` | `manage_sprints` |

### 4.4 DEV_EXECUTION (DEV / DevReader)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | 현재 Sprint 진행률, Burndown 잔여, Story 완료율 |
| Sprint 목록 | Active Sprint만 (기본 필터: `status=ACTIVE`) |
| Burndown | Full Burndown 차트 (read-only) |
| Right Panel | panelMode: `"sprint-summary"` (read-only) |
| CTA | `내 작업` -> targetNodeId: `my-work`, `칸반 보드` -> targetNodeId: `kanban` |
| 기본 필터 | `status: "ACTIVE"` |

### 4.5 CUSTOMER_APPROVAL (Customer PM)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | 현재 Sprint 진행률, Sprint Goal 달성률 |
| Sprint 목록 | Active + 최근 Completed Sprint (milestone view) |
| Burndown | Mini Burndown (간략) |
| Right Panel | panelMode: `"none"` (hidden) |
| CTA | 없음 (read-only, milestone confirmation) |

---

## 5. Sprint 생명주기 상세

### 5.1 Sprint 상태 전이

```
PLANNING -----> ACTIVE -----> COMPLETED
    |                            ^
    |                            |
    +--- CANCELLED               |
                                 |
           ACTIVE ----> CANCELLED (비정상 종료)
```

### 5.2 상태 전이 규칙 -- 서버 트랜잭션 필수

> **핵심 원칙**: Sprint 상태 전이는 프론트 임의 변경 불가.
> 모든 전이는 **서버 트랜잭션**으로만 처리한다.

#### 5.2.1 PLANNING -> ACTIVE (Sprint Start)

```
서버 트랜잭션 (R2DBC reactive transaction):

[Sprint 시작 요청] PATCH /api/sprints/:sprintId/start
  +-- 사전 조건 (서버 검증):
  |   +-- Sprint.status == PLANNING (필수) -- 이미 ACTIVE이면 멱등 응답 (아래 참조)
  |   +-- 다른 ACTIVE Sprint가 없어야 함 (프로젝트 당 1개 ACTIVE 정책)
  |   +-- startDate <= endDate (필수 -- hard fail)
  |   +-- startDate <= today <= endDate → 경고 전환 (v2.1):
  |   |     today < startDate: warning "Sprint 시작일 이전입니다"
  |   |     today > endDate:   warning "Sprint 종료일이 지났습니다"
  |   |     → 응답 warnings[]에 포함, 트랜잭션은 계속 진행
  |   +-- Sprint Backlog에 최소 1건 Story 할당 필수
  |
  +-- 멱등성 규칙 (v2.1):
  |   +-- Sprint.status == ACTIVE (이미 시작됨) → 200 + 현재 Sprint/Burndown 반환
  |   +-- 중복 클릭/네트워크 재시도에 안전
  |
  +-- 트랜잭션 내부:
  |   +-- Sprint.status: PLANNING -> ACTIVE
  |   +-- 모든 할당된 Story.status: IN_SPRINT -> IN_SPRINT (변화 없음, 확인)
  |   +-- plannedPoints 확정 (Snapshot)
  |   +-- Burndown 시계열 데이터 초기화 (Day 0 = totalPoints)
  |
  +-- 응답: StartSprintResponse (Sprint + Burndown 초기 데이터 + warnings[])
```

#### 5.2.2 ACTIVE -> COMPLETED (Sprint Close)

```
서버 트랜잭션 (R2DBC reactive transaction):

[Sprint 종료 요청] PATCH /api/sprints/:sprintId/close
  +-- 사전 조건 (서버 검증):
  |   +-- Sprint.status == ACTIVE (필수)
  |
  +-- 사전 조건 멱등성 (v2.1):
  |   +-- Sprint.status == COMPLETED (이미 종료) → 200 + 현재 Sprint 반환
  |
  +-- 트랜잭션 내부:
  |   +-- Sprint.status: ACTIVE -> COMPLETED
  |   +-- Sprint.velocity = Story.status==DONE인 Story의 SP 합계 (Snapshot)
  |   +-- 미완료 Story 자동 복귀 (핵심 정산 로직):
  |   |   +-- Story.status != DONE && != CANCELLED인 Story
  |   |   +-- Story.sprintId: 현재 Sprint -> null
  |   |   +-- Story.status: IN_SPRINT/IN_PROGRESS/REVIEW -> READY (복귀)
  |   |   +-- Task 리셋 대상 (v2.1 명시):
  |   |   |     IN_PROGRESS -> TODO (리셋)
  |   |   |     IN_REVIEW   -> TODO (리셋)
  |   |   +-- Task 유지 대상 (v2.1 명시):
  |   |   |     TODO       -> TODO (변화 없음)
  |   |   |     BLOCKED    -> BLOCKED (이슈 해결 필요)
  |   |   |     DONE       -> DONE (완료 유지)
  |   |   |     CANCELLED  -> CANCELLED (취소 유지)
  |   |   +-- Task.sprintId: 현재 Sprint -> null
  |   |
  |   +-- Burndown 최종 포인트 기록
  |   +-- Velocity 히스토리 업데이트
  |
  +-- 응답: CloseSprintResponse (Sprint + 복귀된 Story 목록)

-- 미완료 Story 복귀 정책:
  +-- Story는 Backlog READY 풀로 복귀 (재할당 대기)
  +-- Task 리셋: IN_PROGRESS/IN_REVIEW → TODO (진행 중이던 작업 초기화)
  +-- Task 유지: TODO, BLOCKED, DONE, CANCELLED (상태 보존)
  +-- READY 복귀 Story는 기존 Task(TODO/BLOCKED)를 유지하여 다음 Sprint에서 이어서 실행 가능
  +-- 복귀된 Story 목록을 응답에 포함 -> PM에게 안내
```

#### 5.2.3 PLANNING / ACTIVE -> CANCELLED

```
서버 트랜잭션:

[Sprint 취소 요청] PATCH /api/sprints/:sprintId/cancel
  +-- 사전 조건:
  |   +-- Sprint.status == PLANNING || ACTIVE
  |   +-- 멱등성 (v2.1): Sprint.status == CANCELLED → 200 + 현재 Sprint 반환
  |
  +-- 트랜잭션 내부:
  |   +-- Sprint.status -> CANCELLED
  |   +-- 할당된 모든 Story -> Backlog READY 복귀 (COMPLETED와 동일)
  |   +-- Burndown/Velocity 데이터 삭제 (취소된 Sprint는 Velocity 평균에서 제외)
  |
  +-- 응답: CancelSprintResponse
```

### 5.3 Sprint 타임라인 시각화

```
Sprint Lifecycle Timeline:

  PLANNING          ACTIVE                    COMPLETED
  |<-- Setup -->|<-- Execution (2 weeks) -->|<-- Review -->|
  |             |                           |              |
  |  Goal 설정   |  D1  D2  D3 ... D9  D10   |  회고 작성    |
  |  Story 할당  |  Burndown 추적            |  Velocity 기록 |
  |  SP 추정     |  Daily Standup            |  미완료 복귀   |
  |             |  Task 실행                |              |
  |             |  상태 업데이트              |              |
```

### 5.4 Burndown Chart 스펙

```typescript
/** Burndown 차트 데이터 포인트 */
interface BurndownDataPoint {
  /** 날짜 (ISO 8601 date, e.g., "2026-02-03") */
  date: string;
  /** Sprint 시작일부터의 일수 (0-indexed) */
  dayIndex: number;
  /** 이상선(Ideal) 잔여 SP -- linear decline */
  idealRemaining: number;
  /** 실제 잔여 SP */
  actualRemaining: number;
}

/** Burndown 차트 전체 데이터 */
interface BurndownChartData {
  sprintId: string;
  /** Sprint 시작 시 총 커밋 SP */
  totalCommittedPoints: number;
  /** Sprint 기간 (영업일 기준) */
  totalWorkingDays: number;
  /** 일별 데이터 포인트 */
  dataPoints: BurndownDataPoint[];
  /** 이상선 기울기 (SP/day, 음수) */
  idealBurnRate: number;
  /** 실제 기울기 (SP/day, 음수 -- 최근 3일 기준) */
  actualBurnRate: number;
  /** 예측 종료 시 잔여 SP (actualBurnRate 기준 선형 외삽) */
  forecastRemainingAtEnd: number;

  // --- v2.1 additions ---
  /** 서버 기준 현재 영업일 인덱스 (0-indexed, 프론트 timezone drift 방지) */
  currentDayIndex: number;
  /** 서버 기준 현재 날짜 (ISO 8601 date, e.g., "2026-02-07") */
  currentDate: string;
}

/**
 * Ideal line calculation:
 *   idealRemaining(day) = totalCommittedPoints * (1 - day / totalWorkingDays)
 *
 * Actual line:
 *   actualRemaining(day) = totalCommittedPoints - sum(completed SP from day 0 to day)
 *
 * Forecast line (dashed, from current day to sprint end):
 *   forecast(day) = currentActualRemaining - (day - currentDay) * |actualBurnRate|
 *
 * --- v2.1 확정 규칙 ---
 *
 * 영업일 계산:
 *   totalWorkingDays = startDate ~ endDate 중 토/일 제외한 일수
 *   공휴일 캘린더 반영은 향후 확장 (프로젝트 캘린더 / 국가별 공휴일)
 *   서버가 currentDayIndex/currentDate를 계산하여 프론트 timezone drift 방지
 *
 * "completed SP" 기준:
 *   actualRemaining(day) = totalCommittedPoints - Σ(story.storyPoints WHERE story.status == DONE)
 *   → Task 완료 여부와 무관, Story 단위 집계
 *   → Story.status가 DONE으로 전이되는 순간 해당 Story의 SP가 차감됨
 */
```

**Burndown 차트 렌더링 규칙**:

| 항목 | 설명 |
|------|------|
| X축 | Sprint 기간 (영업일 기준, D1 ~ DN) |
| Y축 | 잔여 Story Points (0 ~ totalCommittedPoints) |
| Ideal Line | 점선, 회색, linear decline from totalCommittedPoints to 0 |
| Actual Line | 실선, 파란색, 실제 잔여 SP |
| Forecast Line | 점선, 주황색, actualBurnRate 기반 선형 외삽 (현재 ~ 종료) |
| Gap 표시 | Actual > Ideal: 빨간 영역 (behind), Actual < Ideal: 녹색 영역 (ahead) |
| 차트 크기 | 최소 width: 400px, height: 300px |
| 반응형 | < 768px: 차트 높이 200px, 범례 하단 이동 |

### 5.5 Velocity Chart 스펙

```typescript
/** Velocity 차트 데이터 */
interface VelocityChartData {
  /** 최근 N개 완료 Sprint (기본 N=6) */
  sprints: {
    sprintId: string;
    sprintName: string;
    /** 커밋 SP */
    committedPoints: number;
    /** 완료 SP */
    completedPoints: number;
    /** Sprint 기간 */
    startDate: string;
    endDate: string;
  }[];
  /** Rolling Average (최근 3개 Sprint 기준) */
  rollingAverage: number;
  /** 전체 평균 */
  overallAverage: number;
  /** 트렌드 방향 */
  trend: "improving" | "stable" | "declining";
  /** 트렌드 변화율 (%) */
  trendPercentage: number;
}
```

**Velocity 차트 렌더링 규칙**:

| 항목 | 설명 |
|------|------|
| X축 | Sprint 이름 (S-1, S-2, ...) |
| Y축 | Story Points |
| Committed Bar | 밝은 파란색 (planned/committed SP) |
| Completed Bar | 짙은 파란색 (actually completed SP) |
| Rolling Avg Line | 점선, 빨간색, 최근 3개 Sprint 평균 |
| 차트 유형 | Grouped Bar Chart + Overlay Line |

---

## 6. 데이터 구조 / API

### 6.1 기존 타입 참조

Sprint의 핵심 타입은 `PMS_IC_FrontEnd_v1.2/src/types/backlog.ts`에 이미 정의되어 있다.
본 설계에서는 해당 타입을 그대로 사용하며, 추가되는 API 응답 타입만 별도 정의한다.

| 타입 | 출처 | 용도 |
|------|------|------|
| `Sprint`, `SprintFormData` | backlog.ts | Sprint CRUD |
| `SprintStatus` | backlog.ts | Sprint 상태 enum |
| `SprintWithItems` | backlog.ts | Sprint + Story + Burndown |
| `UserStory`, `UserStoryWithTasks` | backlog.ts | Sprint Backlog Story |
| `Task` | backlog.ts | Story 하위 Task |

### 6.2 Sprint List API

```
GET /api/sprints?projectId={projectId}
    &status={PLANNING|ACTIVE|COMPLETED|CANCELLED}
    &dateFrom={ISO date}
    &dateTo={ISO date}
    &partId={partId}
    &q={searchText}
```

> **참고**: 쿼리 파라미터는 FilterSpec 키와 **1:1 매핑**된다 (dateRange는 flat 전개).

```typescript
interface SprintListResponse {
  /** Sprint 목록 (최신 순) */
  items: SprintListItem[];
  /** 통계 요약 */
  stats: SprintStats;
  /** 현재 Active Sprint (있으면) */
  activeSprint?: SprintListItem;

  // --- reliability 3-tuple (v2.1 standardized) ---
  asOf: string;
  completeness: { overall: number; breakdown?: Record<string, number> };
  warnings: { code: string; message: string; severity: "info" | "warn" | "critical" }[];

  // --- scope echo (v2.1) ---
  scope: { projectId: string };
}

interface SprintListItem extends Sprint {
  /** 할당된 Story 수 */
  storyCount: number;
  /** 완료된 Story 수 */
  completedStoryCount: number;
  /** 총 커밋 SP */
  committedPoints: number;
  /** 완료 SP */
  completedPoints: number;
  /** 진행률 (%) */
  progress: number;
  /** 남은 일수 (ACTIVE Sprint) */
  daysRemaining?: number;
}

interface SprintStats {
  /** 상태별 Sprint 수 */
  countByStatus: Record<SprintStatus, number>;
  /** 현재 Sprint 진행률 */
  currentSprintProgress: number;
  /** Velocity (최근 3개 Sprint rolling avg) */
  velocity: number;
  /** 총 활성 Sprint 수 */
  totalActiveSprints: number;
}
```

### 6.3 Sprint Detail API

```
GET /api/sprints/:sprintId
```

```typescript
interface SprintDetailResponse {
  sprint: Sprint;
  /** Sprint Backlog Stories (with Tasks) */
  stories: UserStoryWithTasks[];
  /** Burndown 차트 데이터 */
  burndown: BurndownChartData;
  /** 통계 */
  stats: {
    totalStories: number;
    completedStories: number;
    inProgressStories: number;
    remainingStories: number;
    totalPoints: number;
    completedPoints: number;
    remainingPoints: number;
    blockedTasks: number;
    /** Sprint Goal 달성률 (0~100) */
    goalCompletion: number;
    /** 커밋 vs 완료 비율 */
    commitmentRatio: number;  // completedPoints / committedPoints * 100
  };

  /** Retrospective 데이터 (COMPLETED Sprint만) */
  retrospective?: SprintRetrospective;

  /** 관련 Part 정보 (Story에서 추출) */
  relatedParts: {
    partId: string;
    partName: string;
    storyCount: number;
    pointCount: number;
  }[];

  // --- reliability 3-tuple (v2.1 standardized) ---
  asOf: string;
  completeness: { overall: number; breakdown?: Record<string, number> };
  warnings: { code: string; message: string; severity: "info" | "warn" | "critical" }[];

  // --- scope echo (v2.1) ---
  scope: { projectId: string };
}

interface SprintRetrospective {
  sprintId: string;
  /** 잘된 점 */
  wentWell: string[];
  /** 개선할 점 */
  couldImprove: string[];
  /** 액션 아이템 */
  actionItems: {
    id: string;
    description: string;
    assigneeId?: string;
    assigneeName?: string;
    completed: boolean;
  }[];
  createdAt: string;
  updatedAt: string;
}
```

### 6.4 Sprint CRUD API

```
POST   /api/sprints                         // Sprint 생성 (cap: manage_sprints)
GET    /api/sprints/:sprintId              // Sprint 상세 (cap: view_sprints)
PATCH  /api/sprints/:sprintId              // Sprint 수정 (cap: manage_sprints)
DELETE /api/sprints/:sprintId              // Sprint 삭제 (cap: manage_sprints, PLANNING only)
```

### 6.5 Sprint Lifecycle API -- 서버 트랜잭션

```
PATCH  /api/sprints/:sprintId/start        // Sprint 시작 (cap: manage_sprints)
PATCH  /api/sprints/:sprintId/close        // Sprint 종료 (cap: manage_sprints)
PATCH  /api/sprints/:sprintId/cancel       // Sprint 취소 (cap: manage_sprints)

-- 멱등성 규칙 (v2.1):
   이미 목표 상태에 도달한 Sprint에 대해 동일 전이 요청이 오면
   → HTTP 200 + 현재 Sprint 상태를 반환한다 (에러 아님).
   start → 이미 ACTIVE면 200 + StartSprintResponse
   close → 이미 COMPLETED면 200 + CloseSprintResponse
   cancel → 이미 CANCELLED면 200 + CancelSprintResponse
   → 중복 클릭, 네트워크 재시도, 프론트 낙관적 업데이트 충돌에 안전
```

```typescript
/** Sprint 시작 요청 */
interface StartSprintRequest {
  /** Sprint Goal 확정 (optional update) */
  goal?: string;
}

/** Sprint 시작 응답 */
interface StartSprintResponse {
  sprint: Sprint;
  burndown: BurndownChartData;
  /** 시작 시 확정된 커밋 SP */
  committedPoints: number;
  /** 할당된 Story 수 */
  storyCount: number;
}

/** Sprint 종료 응답 */
interface CloseSprintResponse {
  sprint: Sprint;
  /** 최종 Velocity */
  velocity: number;
  /** 완료된 Story 목록 */
  completedStories: {
    id: string;
    title: string;
    storyPoints: number;
  }[];
  /** 미완료 Story 목록 -- Backlog READY 복귀 */
  incompleteStories: {
    id: string;
    title: string;
    storyPoints: number;
    previousStatus: string;
    /** 복귀 상태 (READY) */
    returnedStatus: "READY";
  }[];
  /** 미완료 Story SP 합계 */
  incompletePoints: number;
}

/** Sprint 취소 응답 */
interface CancelSprintResponse {
  sprint: Sprint;
  /** 복귀된 Story 목록 */
  returnedStories: {
    id: string;
    title: string;
    storyPoints: number;
  }[];
}
```

### 6.6 Sprint Lifecycle Error Contract

> 서버는 아래 조건을 검증하고, 실패 시 트랜잭션 전체를 롤백한다.

```typescript
/** Sprint lifecycle error response */
interface SprintLifecycleErrorResponse {
  error: {
    code: SprintLifecycleErrorCode;
    message: string;
    entityId?: string;
    currentStatus?: string;
  };
}

type SprintLifecycleErrorCode =
  | "SPRINT_WRONG_STATUS"            // Sprint status is not the expected value
  | "ACTIVE_SPRINT_EXISTS"           // Another ACTIVE Sprint already exists
  | "SPRINT_EMPTY"                   // No Stories assigned to Sprint
  | "SPRINT_DATE_INVALID"            // startDate/endDate out of valid range
  | "SPRINT_NOT_FOUND"               // Sprint ID does not exist
  | "CONCURRENT_MODIFICATION";       // Optimistic lock conflict
```

| Error Code | HTTP | Cause | Frontend Response |
|------------|------|-------|-------------------|
| `SPRINT_WRONG_STATUS` | 409 | Sprint status does not match expected | "Sprint status has changed. Refresh." |
| `ACTIVE_SPRINT_EXISTS` | 409 | Another ACTIVE Sprint exists | "Sprint-N is already active. Close it first." |
| `SPRINT_EMPTY` | 409 | No Stories in Sprint | "Add at least 1 Story to start Sprint." |
| `SPRINT_DATE_INVALID` | 400 | Date range invalid | "Check Sprint start/end dates." |
| `SPRINT_NOT_FOUND` | 404 | Sprint ID not found | "Sprint not found." |
| `CONCURRENT_MODIFICATION` | 409 | Optimistic lock conflict | "Refresh and retry." |

### 6.7 Burndown API

```
GET /api/sprints/:sprintId/burndown
```

```typescript
/** Burndown API response */
interface BurndownResponse {
  burndown: BurndownChartData;
  /** Last updated timestamp */
  asOf: string;
}
```

> **갱신 주기**: Burndown 데이터는 **Story.status 변경 시** 서버에서 재계산된다 (completed SP = Story.status==DONE 기준).
> 프론트는 Sprint 상세 페이지 진입 시 + 30초 간격 polling으로 갱신한다.
>
> **재계산 비용 모델 (v2.1)**: Redis 30s TTL이 캐시와 재계산 억제를 겸한다.
> Story 상태 변경 이벤트가 발생하면 Redis 키를 invalidate하고 다음 조회 시 재계산.
> 30초 이내 연속 변경은 마지막 조회 시점에 한 번만 재계산되므로 burst write에 안전하다.
> 프론트 30s polling과 Redis 30s TTL이 동기화되어 있으므로 매 poll마다 최신 데이터를 보장.

### 6.8 Velocity API

```
GET /api/sprints/velocity?projectId={projectId}&count={N}
```

```typescript
/** Velocity API response */
interface VelocityResponse {
  velocity: VelocityChartData;
  asOf: string;
}
```

### 6.9 Retrospective API

```
GET    /api/sprints/:sprintId/retrospective     // 회고 조회 (cap: view_sprints)
POST   /api/sprints/:sprintId/retrospective     // 회고 작성 (cap: manage_sprints)
PATCH  /api/sprints/:sprintId/retrospective     // 회고 수정 (cap: manage_sprints)
```

```typescript
interface RetrospectiveFormData {
  wentWell: string[];
  couldImprove: string[];
  actionItems: {
    description: string;
    assigneeId?: string;
    /** v2.1: Backlog 승격 연결 고리 -- Action Item → Story/Task로 전환 시 참조 ID */
    promotedToStoryId?: string;
    promotedToTaskId?: string;
  }[];
}
```

### 6.10 Sprint Planning -- Story Assignment

> Sprint에 Story를 할당/해제하는 API는 백로그(03_백로그 설계 7.8)의 API를 공유한다.

```
PATCH  /api/backlog/stories/:storyId/sprint
```

```typescript
// Reuses AssignSprintRequest / AssignSprintResponse from backlog spec
interface AssignSprintRequest {
  sprintId: string | null;    // null -> unassign
}
```

> **Sprint 화면에서의 차이**: Sprint 상세 -> Planning 탭에서
> READY 풀 Story를 D&D로 Sprint에 할당할 때 동일한 API를 호출한다.
> 다만 UI는 D&D 인터랙션이 추가된다 (9 인터랙션 상세 참조).

### 6.11 Sprint Stats API

```
GET /api/sprints/stats?projectId={projectId}
```

```typescript
interface SprintStatsResponse {
  stats: SprintStats;
  /** 현재 Active Sprint 요약 */
  activeSprint?: {
    id: string;
    name: string;
    progress: number;
    daysRemaining: number;
    burndownRemaining: number;
    goalCompletion: number;
    committedPoints: number;
    completedPoints: number;
  };
  /** 최근 Velocity 트렌드 */
  velocityTrend: {
    current: number;
    previous: number;
    trend: "improving" | "stable" | "declining";
    trendPercentage: number;
  };

  // --- reliability 3-tuple (v2.1 standardized) ---
  asOf: string;
  completeness: { overall: number; breakdown?: Record<string, number> };
  warnings: { code: string; message: string; severity: "info" | "warn" | "critical" }[];

  // --- scope echo (v2.1) ---
  scope: { projectId: string };
}
```

---

## 7. 컴포넌트 분해

### 7.1 폴더 구조

```
features/
  sprints/
    pages/
      SprintListPage.tsx                <- Sprint list (ViewMode branching)
      SprintDetailPage.tsx              <- Sprint detail (Burndown + Stories + Velocity + Retro)
    components/
      // List
      SprintList.tsx                    <- Sprint list container
      SprintListRow.tsx                 <- Sprint list row (status, progress, goal)
      SprintStatusBadge.tsx             <- Sprint status badge (4 values)

      // Toolbar & Filters
      SprintToolbar.tsx                 <- Top toolbar (create CTA, search)
      SprintFilters.tsx                 <- Filter bar (FilterSpec-based)
      SprintKpiRow.tsx                  <- Top KPI card row

      // Right Panel
      SprintSummaryPanel.tsx            <- panelMode: "sprint-summary"
      SprintBurndownPanel.tsx           <- panelMode: "burndown"
      SprintVelocityPanel.tsx           <- panelMode: "velocity"
      SprintPlanningPanel.tsx           <- panelMode: "planning"
      SprintRetrospectivePanel.tsx      <- panelMode: "retrospective"
      SprintStoryDetailPanel.tsx        <- panelMode: "story-detail"
      SprintRightPanel.tsx              <- panelMode routing renderer

      // Charts
      BurndownChart.tsx                 <- Burndown chart (Recharts)
      BurndownMiniChart.tsx             <- Mini Burndown for list/KPI
      VelocityChart.tsx                 <- Velocity bar + line chart
      SprintProgressBar.tsx             <- Sprint progress bar

      // Sprint Detail Tabs
      SprintBurndownTab.tsx             <- Tab: Burndown
      SprintStoriesTab.tsx              <- Tab: Stories (Sprint Backlog table)
      SprintVelocityTab.tsx             <- Tab: Velocity
      SprintRetrospectiveTab.tsx        <- Tab: Retrospective

      // Sprint Backlog
      SprintBacklogTable.tsx            <- Story list table within Sprint
      SprintStoryRow.tsx                <- Story row in Sprint Backlog

      // Sprint Planning
      SprintPlanningView.tsx            <- D&D Planning layout
      ReadyPoolPanel.tsx                <- READY stories from Backlog
      SprintBacklogDropZone.tsx         <- Drop target for Sprint assignment
      PlanningStoryCard.tsx             <- Draggable Story card
      CapacityIndicator.tsx             <- SP capacity gauge

      // Modals & Dialogs
      SprintCreateModal.tsx             <- Sprint create modal
      SprintEditModal.tsx               <- Sprint edit modal
      SprintStartDialog.tsx             <- Sprint start confirmation
      SprintCloseDialog.tsx             <- Sprint close confirmation + incomplete story list
      SprintCancelDialog.tsx            <- Sprint cancel confirmation
      RetrospectiveFormModal.tsx         <- Retrospective create/edit form

    api/
      sprintApi.ts                      <- Sprint API calls
    hooks/
      useSprintList.ts                  <- Sprint list TanStack Query
      useSprintDetail.ts                <- Sprint detail TanStack Query
      useBurndown.ts                    <- Burndown data Query (polling 30s)
      useVelocity.ts                    <- Velocity data Query
      useSprintStats.ts                 <- Sprint stats Query
      useSprintPlanning.ts              <- Sprint Planning state (D&D)
      useRetrospective.ts               <- Retrospective Query
      useSprintPanelMode.ts             <- Right Panel mode state
```

### 7.2 SprintListPage.tsx ViewMode 분기

```typescript
function SprintListPage() {
  const { viewMode } = useAccessContext();
  const { panelMode, setPanelMode } = useSprintPanelMode(viewMode);
  const { data, isLoading } = useSprintList();

  const rightPanelContent = useMemo(() => {
    switch (panelMode) {
      case "none":              return undefined;
      case "sprint-summary":    return <SprintSummaryPanel />;
      case "burndown":          return <SprintBurndownPanel />;
      case "velocity":          return <SprintVelocityPanel />;
      default:                  return undefined;
    }
  }, [panelMode]);

  return (
    <PageLayout
      header={<SprintToolbar viewMode={viewMode} />}
      rightPanel={rightPanelContent}
      rightPanelDefault={PRESET_POLICIES[viewMode].ui.defaultRightPanel}
    >
      <SprintKpiRow viewMode={viewMode} />
      <SprintFilters
        viewMode={viewMode}
        filterSpec={sprintNode.filterSpec}
      />
      <SprintList
        viewMode={viewMode}
        onSprintSelect={(sprint) => {
          if (["PM_WORK", "PMO_CONTROL", "DEV_EXECUTION"].includes(viewMode)) {
            setPanelMode("sprint-summary");
          }
        }}
      />
    </PageLayout>
  );
}
```

### 7.3 SprintDetailPage.tsx Tab 분기

```typescript
type SprintDetailTab = "burndown" | "stories" | "velocity" | "retrospective" | "planning";

function SprintDetailPage() {
  const { sprintId } = useParams<{ sprintId: string }>();
  const { viewMode } = useAccessContext();
  const [activeTab, setActiveTab] = useState<SprintDetailTab>("burndown");
  const { panelMode, setPanelMode } = useSprintPanelMode(viewMode);
  const { data: sprint } = useSprintDetail(sprintId);
  const { data: burndown } = useBurndown(sprintId);

  // Tab-based panelMode sync
  useEffect(() => {
    switch (activeTab) {
      case "burndown":
        setPanelMode("burndown");
        break;
      case "stories":
        setPanelMode("story-detail");
        break;
      case "velocity":
        setPanelMode("velocity");
        break;
      case "retrospective":
        setPanelMode("retrospective");
        break;
      case "planning":
        setPanelMode("planning");
        break;
    }
  }, [activeTab]);

  // Planning tab: PLANNING status + assign_story_sprint cap (v2.1: manage_sprints → assign_story_sprint)
  // manage_sprints = Sprint lifecycle (start/close/cancel), assign_story_sprint = Story D&D
  const showPlanningTab = sprint?.status === "PLANNING"
    && hasCapability("assign_story_sprint");

  const rightPanelContent = useMemo(() => {
    switch (panelMode) {
      case "none":              return undefined;
      case "burndown":          return <SprintBurndownPanel />;
      case "story-detail":      return <SprintStoryDetailPanel />;
      case "velocity":          return <SprintVelocityPanel />;
      case "planning":          return <SprintPlanningPanel />;
      case "retrospective":     return <SprintRetrospectivePanel />;
      default:                  return undefined;
    }
  }, [panelMode]);

  return (
    <PageLayout
      header={
        <SprintDetailHeader
          sprint={sprint}
          viewMode={viewMode}
          onStart={() => handleStartSprint()}
          onClose={() => handleCloseSprint()}
        />
      }
      rightPanel={rightPanelContent}
    >
      <SprintInfoBar sprint={sprint} />
      <TabBar
        tabs={[
          { key: "burndown", label: "Burndown" },
          { key: "stories", label: "Stories" },
          { key: "velocity", label: "Velocity" },
          { key: "retrospective", label: "Retrospective",
            disabled: sprint?.status !== "COMPLETED" },
          ...(showPlanningTab
            ? [{ key: "planning" as const, label: "Planning" }]
            : []),
        ]}
        active={activeTab}
        onChange={setActiveTab}
      />

      {activeTab === "burndown" && <SprintBurndownTab burndown={burndown} />}
      {activeTab === "stories" && <SprintStoriesTab sprintId={sprintId} />}
      {activeTab === "velocity" && <SprintVelocityTab />}
      {activeTab === "retrospective" && <SprintRetrospectiveTab sprintId={sprintId} />}
      {activeTab === "planning" && <SprintPlanningView sprintId={sprintId} />}
    </PageLayout>
  );
}
```

---

## 8. AI Navigation 연동

### 8.1 virtualNode 우선 반환 정책

> 03_백로그 설계와 동일 패턴. AI는 가능한 경우 raw filter 대신 **virtualId를 우선 반환**한다.

```typescript
/** AI virtualNode matching priority */
const SPRINT_VIRTUAL_NODE_PRIORITY: {
  virtualId: string;
  matchFilter: Partial<SprintFilterSpec>;
}[] = [
  { virtualId: "sprints.active",    matchFilter: { status: "ACTIVE" } },
  { virtualId: "sprints.planning",  matchFilter: { status: "PLANNING" } },
  { virtualId: "sprints.velocity",  matchFilter: { status: "COMPLETED" } },
];

function resolveSprintNavigation(filter: SprintFilterSpec): AiSprintNavigation {
  // 1. virtualNode matching (priority)
  for (const vn of SPRINT_VIRTUAL_NODE_PRIORITY) {
    if (isSubsetMatch(vn.matchFilter, filter)) {
      return { targetNodeId: "sprints", virtualId: vn.virtualId, filter, reason: "..." };
    }
  }
  // 2. fallback: raw filter
  return { targetNodeId: "sprints", filter, reason: "..." };
}
```

### 8.2 AI 질문 -> 화면 이동 (FilterSpec + virtualId)

```typescript
/** AI navigation recommendation (v2.0) */
interface AiSprintNavigation {
  targetNodeId: "sprints";
  virtualId?: string;
  filter: SprintFilterSpec;
  entityId?: string;               // "sprint-5"
  reason: string;                  // "현재 Sprint Burndown 확인 필요"
}
```

| 질문 | AI 반환 | virtualId? | 설명 |
|------|--------|-----------|------|
| "현재 Sprint 보여줘" | `{ status: "ACTIVE" }` | `sprints.active` | virtualId priority |
| "Burndown 보여줘" | `{ status: "ACTIVE" }` | `sprints.active` | Active Sprint Burndown |
| "Sprint Planning 해줘" | `{ status: "PLANNING" }` | `sprints.planning` | PLANNING Sprint |
| "Velocity 보여줘" | `{ status: "COMPLETED" }` | `sprints.velocity` | Completed history |
| "Sprint-5 상세" | `entityId: "sprint-5"` | -- | direct navigation |
| "지난 Sprint 회고" | `entityId: "sprint-5"` | `sprints.retrospective` | specific Sprint |

### 8.3 Preset별 do intent AI 라우팅

AI는 조치(do) 질문 시 1.3의 `SPRINT_DO_INTENT_ROUTING`에 따라 targetNodeId를 결정한다.

```
PM이 "Sprint 생성해줘" -> targetNodeId: "sprints" (Sprint 생성 모달)
PM이 "Story 할당해줘"  -> targetNodeId: "backlog" (READY 풀에서)
PMO가 "Sprint 종료해줘" -> targetNodeId: "sprints" (Sprint 통제)
DEV가 "Sprint 종료해줘" -> targetNodeId: "sprints" + "권한 없음" 안내
```

### 8.4 Context Panel에서의 AI 추천

```
-- 추천 액션 -------------------------
>> Sprint-6 진행률 68% (4일 남음)
   Burndown gap: +2 SP behind ideal
   -> [Burndown 확인]           <- panelMode: "burndown"

>> 미완료 Story 5건 (14 SP)
   -> [Sprint Backlog 확인]     <- tab: "stories"

>> Velocity trend: Improving (+8%)
   Rolling avg: 28 SP/Sprint
   -> [Velocity 상세]           <- tab: "velocity"

!! Sprint-7 PLANNING -- Story 0건
   -> [Sprint Planning]         <- tab: "planning"
   -> [백로그에서 Story 할당]    <- targetNodeId: "backlog"
```

---

## 9. 인터랙션 상세

### 9.1 Sprint 목록 인터랙션

```
Sprint 행 단일 클릭:
  EXEC_SUMMARY / CUSTOMER_APPROVAL: 변화 없음
  PM_WORK / PMO_CONTROL / DEV_EXECUTION: sprint-summary panel 표시

Sprint 행 더블 클릭:
  -> /sprints/:sprintId 상세 페이지로 이동
```

### 9.2 Sprint 생성 인터랙션

```
[+ Sprint 생성] 클릭 (cap: manage_sprints)
  -> SprintCreateModal 표시
  -> 입력: name, goal, startDate, endDate
  -> 기본값: startDate = 이전 Sprint endDate + 1일, endDate = startDate + 14일
  -> POST /api/sprints
  -> 생성 후: Sprint 목록 새로고침, 새 Sprint PLANNING 상태
```

### 9.3 Sprint 시작 인터랙션

```
[Sprint 시작] 클릭 (PLANNING Sprint, cap: manage_sprints)
  -> SprintStartDialog 표시
  -> 표시 내용:
     Sprint Goal: 편집 가능
     할당된 Story: N건 (SP 합계)
     다른 ACTIVE Sprint: 없음 / Sprint-X (경고)
  -> 확인 클릭:
     PATCH /api/sprints/:sprintId/start
  -> 성공: Sprint ACTIVE 전이, Burndown 초기화
  -> 실패: Error contract 기반 안내 (6.6)
```

### 9.4 Sprint 종료 인터랙션

```
[Sprint 종료] 클릭 (ACTIVE Sprint, cap: manage_sprints)
  -> SprintCloseDialog 표시
  -> 표시 내용:
     Sprint Summary:
       완료: N건 (SP)
       미완료: M건 (SP) -- Backlog READY로 복귀 예정
     미완료 Story 목록:
       S-07 배치 처리 (8 SP) -- IN_SPRINT -> READY
       S-09 로깅 연동 (3 SP) -- IN_SPRINT -> READY
       S-10 모니터링 (5 SP) -- TODO -> READY
     경고: "미완료 Story는 Backlog READY 풀로 자동 복귀됩니다"
  -> 확인 클릭:
     PATCH /api/sprints/:sprintId/close
  -> 성공: Sprint COMPLETED, 미완료 Story READY 복귀, Velocity 기록
  -> 성공 후: 회고 작성 유도 안내 표시
```

### 9.5 Sprint Planning D&D 인터랙션

```
Sprint Planning View (/sprints/:sprintId?tab=planning)
  PLANNING Sprint에서만 활성화 (cap: assign_story_sprint -- v2.1 분리)

Left Panel: READY Pool (Backlog에서 가져옴)
  -> GET /api/backlog?storyStatus=READY&projectId={projectId}
  -> Story 카드: title, SP, Part, assignee
  -> 카드는 Draggable

Right Panel: Sprint Backlog
  -> 현재 Sprint에 할당된 Story 목록
  -> Drop Zone (Droppable)
  -> Capacity Indicator: 현재 SP / 평균 Velocity

D&D Flow:
  1. READY Pool에서 Story 카드 Drag 시작
  2. Sprint Backlog Drop Zone으로 Drop
  3. PATCH /api/backlog/stories/:storyId/sprint { sprintId: currentSprintId }
  4. 서버 트랜잭션: Story READY -> IN_SPRINT
     (Epic 자동 전이 규칙은 03_백로그 설계 5.4 참조 -- 하위 Story 전체 DONE 시 Epic 상태 전이)
  5. 성공: Story가 Sprint Backlog로 이동, Capacity 업데이트
  6. 실패: Error contract 기반 안내 (03_백로그 7.8 에러)

Reverse D&D (Sprint -> READY Pool):
  1. Sprint Backlog에서 Story 카드 Drag
  2. READY Pool Drop Zone으로 Drop
  3. PATCH /api/backlog/stories/:storyId/sprint { sprintId: null }
  4. Story IN_SPRINT -> READY 복귀
  5. Capacity 업데이트

Capacity Warning:
  현재 SP > rolling avg velocity * 1.2 일 때:
  "Sprint capacity를 초과했습니다 (현재: 36 SP, 평균: 28 SP)"
  경고만 표시 (강제 차단은 안 함)
```

### 9.6 Tab 전환 인터랙션

```
Tab Bar:
  [Burndown] -> SprintBurndownTab + panelMode: "burndown"
  [Stories]  -> SprintStoriesTab + panelMode: "story-detail" (Story 선택 시)
  [Velocity] -> SprintVelocityTab + panelMode: "velocity"
  [Retrospective] -> SprintRetrospectiveTab + panelMode: "retrospective"
       Disabled when Sprint.status != COMPLETED
  [Planning] -> SprintPlanningView + panelMode: "planning"
       Only visible when Sprint.status == PLANNING && cap: assign_story_sprint (v2.1)
```

### 9.7 KPI 카드 클릭 -> 필터 활성화

```typescript
/** KPI card click filter mapping */
const SPRINT_KPI_CARD_FILTER_MAP: Record<string, {
  filter: Partial<SprintFilterSpec>;
  virtualId?: string;
  action?: string;    // Tab or navigation action
}> = {
  KPI_PROGRESS:      { filter: { status: "ACTIVE" }, virtualId: "sprints.active" },
  KPI_VELOCITY:      { filter: { status: "COMPLETED" }, virtualId: "sprints.velocity" },
  KPI_GOAL:          { filter: { status: "ACTIVE" }, virtualId: "sprints.active" },
  KPI_REMAINING:     { filter: { status: "ACTIVE" }, virtualId: "sprints.active",
                       action: "tab:stories" },
  KPI_COMMITTED_SP:  { filter: { status: "ACTIVE" }, virtualId: "sprints.active" },
  KPI_COMPLETED_SP:  { filter: { status: "ACTIVE" }, virtualId: "sprints.active" },
  KPI_BURNDOWN:      { filter: { status: "ACTIVE" }, virtualId: "sprints.active",
                       action: "tab:burndown" },
  KPI_ACTIVE_COUNT:  { filter: { status: "ACTIVE" } },
};
```

**인터랙션 흐름**:

```
1. KPI 카드 클릭
2. SPRINT_KPI_CARD_FILTER_MAP에서 filter/action 조회
3. 필터 바 업데이트 (기존 필터 초기화 -> 새 필터 적용)
4. action이 "tab:*"이면 해당 탭으로 전환
5. URL 업데이트 (serializeSprintFilter)
6. 동일 카드 재클릭 시 필터 해제 (toggle)
```

### 9.8 데이터 새로고침

| 항목 | 주기 |
|------|------|
| Sprint 목록 | 페이지 진입 시 + 필터 변경 시 |
| Sprint 상세 | 페이지 진입 시 |
| Burndown 데이터 | 페이지 진입 시 + **30초 간격 polling** (ACTIVE Sprint) |
| Velocity 데이터 | 페이지 진입 시 (캐시 10분) |
| Sprint Backlog Stories | 페이지 진입 시 + Story 상태 변경 시 |
| Retrospective | 탭 진입 시 |
| READY Pool (Planning) | Planning 탭 진입 시 + Story 할당/해제 시 |

### 9.9 동시 편집 충돌 대응

```text
낙관적 잠금 (Optimistic Locking):
  +-- Sprint PATCH 요청에 If-Match: {version} 헤더 포함
  +-- 서버는 현재 version과 비교
  +-- 불일치 시 409 Conflict + 현재 데이터 반환
  +-- 프론트는 "다른 사용자가 수정했습니다" 안내 + 새로고침

적용 범위:
  +-- Sprint PATCH (이름/목표/기간 수정) -> 낙관적 잠금
  +-- Sprint Lifecycle (start/close/cancel) -> CONCURRENT_MODIFICATION error
  +-- Story Sprint 할당 (Planning D&D) -> 03_백로그 에러 계약 적용
```

---

## 10. 반응형 대응

| 너비 | Sprint 목록 | Sprint 상세 | Right Panel | 차트 |
|------|------------|-----------|------------|------|
| >=1440px | Full list + KPI 8개 | Tab + Full chart | Right Panel (30%) | Full size |
| 1280px | Full list + KPI 4개 | Tab + Chart | Drawer (toggle) | Standard |
| <=1024px | Compact list + KPI 4개 | Tab + Chart (축소) | Drawer (overlay) | Responsive |
| <=768px | Card list + KPI 2개 | Stacked layout | Full Modal | Mini chart |

**차트 반응형 규칙**:

| 너비 | Burndown | Velocity |
|------|----------|----------|
| >=1024px | Full (400x300) + Forecast line + Gap shading | Full bar chart (6 sprints) |
| 768~1023px | Standard (350x250) + Forecast only | Bar chart (4 sprints) |
| <768px | Mini (300x200) + Ideal/Actual only | Simplified (3 sprints) |

---

## 11. 깨지기 쉬운 7곳 체크리스트 (v2.1: 5→7)

| # | 위험 지점 | 해결책 | 검증 방법 |
|---|----------|-------|----------|
| 1 | **Sprint Close 미완료 Story 복귀** | 서버 트랜잭션에서 모든 미완료 Story/Task를 원자적으로 복귀 (Story->READY, Task->TODO). BLOCKED Task는 유지. 복귀 목록을 응답에 포함 | Sprint 종료 후 미완료 Story가 Backlog READY 풀에 표시되는지 확인, Story의 sprintId가 null인지 확인, BLOCKED Task가 BLOCKED 유지인지 확인 |
| 2 | **ACTIVE Sprint 중복** | 프로젝트 당 1개 ACTIVE 정책을 서버에서 강제. `ACTIVE_SPRINT_EXISTS` 에러 반환. 프론트에서도 Sprint Start 전 Active Sprint 존재 여부 표시 | 두 번째 Sprint 시작 시도 시 409 에러 수신 확인, 에러 메시지에 현재 Active Sprint 이름 포함 확인 |
| 3 | **Burndown 실시간 갱신 vs 성능** | 30초 polling (WebSocket 아님). ACTIVE Sprint만 polling. 상세 페이지 이탈 시 polling 중단. Burndown 데이터는 서버 캐시 (Redis 30s TTL) | polling 간격 확인 (30s), 페이지 이탈 시 네트워크 요청 중단 확인, 서버 캐시 적중률 확인 |
| 4 | **Sprint Planning D&D 동시성** | D&D Story 할당 시 서버 트랜잭션으로 원자성 보장. 동시에 같은 Story를 두 PM이 할당하면 후자가 409(STORY_ALREADY_IN_SPRINT) 수신. 프론트는 READY Pool을 새로고침 후 재시도 안내 | 두 브라우저에서 같은 READY Story를 동시에 Sprint에 D&D -> 후자가 409 수신 확인 |
| 5 | **Velocity 계산 정합성** | Velocity는 Sprint COMPLETED 시점에 Snapshot으로 저장 (Sprint.velocity 필드). Rolling avg는 최근 3개 COMPLETED Sprint에서 계산. CANCELLED Sprint는 Velocity에서 제외 | CANCELLED Sprint가 Velocity 평균에 포함되지 않는지 확인, Sprint 종료 시 velocity 값이 완료 SP 합계와 일치하는지 확인 |
| 6 | **Lifecycle 멱등성** (v2.1) | start/close/cancel 요청이 이미 목표 상태면 200 반환. 이미 ACTIVE인 Sprint에 start 요청 → 현재 Sprint+Burndown 반환. 프론트 낙관적 업데이트와 서버 응답 불일치 방지 | 동일 start 요청 2회 연속 전송 시 둘 다 200 반환 확인, 두 번째 응답이 첫 번째와 동일한지 확인, DB에 중복 트랜잭션 기록이 없는지 확인 |
| 7 | **Scope 경계 검증** (v2.1) | 모든 API 응답에 `scope: { projectId }` echo 포함. 프론트는 응답 scope.projectId와 현재 컨텍스트 projectId 불일치 시 경고. Sprint Detail API에서 다른 프로젝트 Story 누출 방지 | 프로젝트 A의 Sprint API에 프로젝트 B의 projectId를 전달하면 빈 결과 또는 403 반환 확인, 응답 scope.projectId가 요청 projectId와 일치하는지 확인 |

---

## 12. Capability 매핑 총괄

| Capability | 행위 | 대표 역할 |
|-----------|------|---------|
| `view_sprints` | Sprint 조회, Burndown/Velocity 차트, Sprint Backlog 조회 | ALL (역할별 범위 제한) |
| `manage_sprints` | Sprint 생성/편집/삭제, Sprint Start/Close/Cancel, Planning, Retrospective 작성 | PM, PMO |

> **DEV/DevReader**: `view_sprints`만 보유. Sprint 목록과 상세를 조회하고
> Burndown/Velocity를 확인할 수 있지만, Sprint 생성/수정/종료/Planning은 불가.

> **Story Sprint 할당**: Sprint Planning D&D에서의 Story 할당은
> `assign_story_sprint` Capability (백로그 화면 소속)를 사용한다.
> `manage_sprints`와는 별개이며, PM에게 부여된다.

**Capability 의존 관계**:

```
view_sprints            -- Sprint 조회 (전 역할)
  |
  +-- manage_sprints    -- Sprint CRUD + Lifecycle (PM, PMO)
  |
  +-- assign_story_sprint  -- Story Sprint 할당 (PM) -- 백로그 소속
```

---

## 13. DoD (본 화면 완료 기준)

- [ ] `/sprints` 목록에서 Preset별 Sprint 표시 분기 동작
- [ ] FilterSpec 기반 필터 (status/dateRange/partId/q) 동작
- [ ] FilterSpec URL 직렬화 왕복 보장 (dateRange flat 전개 포함)
- [ ] KPI Row: 현재 Sprint 진행률, Velocity, Sprint Goal 달성률, Stories Remaining, SP Committed/Completed, Burndown Remaining, Active Sprint 수, 상태별 Sprint 수 표시
- [ ] Sprint 목록: 상태별 표시 (PLANNING/ACTIVE/COMPLETED/CANCELLED) + 진행률 바
- [ ] Sprint 행 클릭 -> sprint-summary Right Panel 표시
- [ ] Sprint 행 더블 클릭 -> `/sprints/:sprintId` 상세 페이지 이동
- [ ] `/sprints/:sprintId` 상세 페이지: 4개 탭 (Burndown/Stories/Velocity/Retrospective)
- [ ] **Burndown 차트**: Ideal line (점선) + Actual line (실선) + Forecast line (점선) 표시
- [ ] **Burndown 차트**: Gap shading (ahead=녹색, behind=빨간색)
- [ ] **Burndown polling**: ACTIVE Sprint 30초 간격, 페이지 이탈 시 중단
- [ ] **Velocity 차트**: Grouped Bar (Committed/Completed) + Rolling Avg Line
- [ ] **Velocity 계산**: CANCELLED Sprint 제외, 최근 3개 COMPLETED Sprint rolling avg
- [ ] Sprint Backlog Stories 테이블: Story 목록 + 상태 + SP + 담당자
- [ ] Story 행 클릭 -> story-detail Right Panel 표시
- [ ] **Sprint 생성** (cap: `manage_sprints`): SprintCreateModal, 기본 기간 2주
- [ ] **Sprint 편집** (cap: `manage_sprints`): SprintEditModal, PLANNING/ACTIVE만
- [ ] **Sprint 시작** (cap: `manage_sprints`): PLANNING->ACTIVE 서버 트랜잭션, 사전 검증 (ACTIVE 중복, Story 최소 1건, 기간 유효)
- [ ] **Sprint 종료** (cap: `manage_sprints`): ACTIVE->COMPLETED 서버 트랜잭션, 미완료 Story READY 복귀, Task TODO 리셋, BLOCKED 유지
- [ ] **Sprint 종료 후 회고 유도**: 회고 작성 안내 표시
- [ ] **Sprint 취소** (cap: `manage_sprints`): PLANNING/ACTIVE->CANCELLED, 모든 Story 복귀, Velocity에서 제외
- [ ] **ACTIVE Sprint 중복 방지**: 프로젝트 당 1개 ACTIVE 서버 강제
- [ ] **Sprint Planning D&D**: READY Pool <-> Sprint Backlog Drag & Drop
- [ ] **Sprint Planning Capacity**: 현재 SP / avg Velocity 표시, 초과 시 경고
- [ ] **Sprint Lifecycle Error Contract**: 5종 에러 코드별 HTTP 상태 + 프론트 대응
- [ ] **Retrospective**: 잘된 점 / 개선할 점 / 액션 아이템 CRUD (COMPLETED Sprint만)
- [ ] panelMode 기반 Right Panel 분기 (none/sprint-summary/story-detail/burndown/velocity/planning/retrospective)
- [ ] **virtualNode 우선 반환**: active/planning/velocity/retrospective 4개 virtualId AI 우선
- [ ] **Preset별 do intent 라우팅** (PM->sprints, PMO->sprints, DEV->sprints 읽기 안내)
- [ ] AI 추천 액션: Burndown gap 경고, 미완료 Story 안내, Velocity 트렌드
- [ ] KPI 카드 클릭 -> 필터 활성화 / 탭 전환 (toggle 동작)
- [ ] 동시 편집 충돌: 낙관적 잠금 (If-Match + version) + 409 안내
- [ ] 반응형 레이아웃 (>=1440 / 1280 / <=1024 / <=768), 차트 반응형

**v2.1 추가 DoD**:

- [ ] **Reliability 3-tuple**: SprintListResponse, SprintDetailResponse, SprintStatsResponse에 `completeness: {overall, breakdown?}`, `warnings: {code, message, severity}[]` 적용
- [ ] **Scope echo**: 모든 API 응답에 `scope: { projectId }` 포함, 프론트 projectId 불일치 경고
- [ ] **Lifecycle 멱등성**: start/close/cancel이 이미 목표 상태면 200 반환 (중복 클릭 안전)
- [ ] **Sprint Start 날짜 경고**: today가 startDate~endDate 범위 밖이면 warning (hard fail 아님)
- [ ] **Task 리셋 열거**: Sprint Close 시 IN_PROGRESS/IN_REVIEW→TODO, BLOCKED/DONE/CANCELLED 유지
- [ ] **Burndown completed SP = Story.status==DONE**: Task 완료와 무관하게 Story 단위 집계
- [ ] **BurndownChartData currentDayIndex/currentDate**: 서버 기준 영업일 인덱스 포함
- [ ] **영업일 = 주말 제외**: totalWorkingDays 계산에서 토/일 제외
- [ ] **dateRange 빈 객체 정규화**: 역직렬화 후 `from`/`to` 모두 없으면 dateRange 키 삭제
- [ ] **Planning 탭 Capability**: `assign_story_sprint` (manage_sprints와 분리)
- [ ] **Retrospective Action Item → Backlog 승격**: promotedToStoryId/promotedToTaskId 연결 고리
- [ ] **Burndown 재계산 비용**: Redis 30s TTL = 캐시 + 재계산 억제 겸용

---

## 부록 A. 변경이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| v1.0 | 2026-02-08 | 초안 작성 -- Sprint 목록/상세, Burndown/Velocity 차트 스펙, Sprint 생명주기 (PLANNING->ACTIVE->COMPLETED/CANCELLED), Sprint Planning D&D, Retrospective, FilterSpec 내장, Preset별 분기, AI Navigation 연동, 컴포넌트 분해, 데이터 모델/API |
| v2.0 | 2026-02-08 | 11개 영역 피드백 반영: (1) AI 라우팅 정책 per Preset -- SPRINT_DO_INTENT_ROUTING 확정, (2) Sprint Close 미완료 Story 자동 복귀 정책 확정 (Story->READY, Task->TODO, BLOCKED 유지), (3) ACTIVE Sprint 중복 방지 서버 강제, (4) Burndown 차트 Forecast line + Gap shading 스펙 확정, (5) Velocity 계산 정합성 -- CANCELLED 제외, Snapshot 저장, rolling avg 3개, (6) Sprint Planning D&D 동시성 대응, (7) Sprint Lifecycle Error Contract 5종 확정, (8) FilterSpec URL 직렬화 규칙 (dateRange flat 전개), (9) KPI 카드 클릭 인터랙션 확정, (10) 깨지기 쉬운 곳 5곳 체크리스트, (11) 동시 편집 낙관적 잠금 |
| v2.1 | 2026-02-08 | 14개 교차 검증 반영: (1) FilterSpec 키 수 정합 6→4 확정, (2) Sprint Start 날짜 검증 완화 (경고 전환), (3) Sprint Close Task 리셋 대상 열거 (IN_PROGRESS/IN_REVIEW→TODO, BLOCKED/DONE/CANCELLED 유지), (4) Burndown "completed SP" 기준 확정 (Story.status==DONE), (5) 영업일 계산 규칙 (주말 제외, 캘린더 확장 로드맵), (6) BurndownChartData currentDayIndex/currentDate 추가, (7) Lifecycle API 멱등성 규칙 확정, (8) Burndown 재계산 비용 모델 (Redis 30s TTL = 억제), (9) Planning 탭 Capability 분리 (assign_story_sprint), (10) Retrospective Action Item → Backlog 승격 연결 고리, (11) Reliability 3-tuple 표준화, (12) Scope 2-tier 패턴 적용, (13) 깨지기 쉬운 곳 5→7 확장, (14) dateRange 빈 객체 정규화 + 개방 구간 정의 |
