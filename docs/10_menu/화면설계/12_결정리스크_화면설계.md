# 12. 결정/리스크 보드 화면설계

> 작성일: 2026-02-08
> 버전: v2.1
> 라우트: `/decisions`
> 필요 Capability: `view_decisions` (조회), `manage_decisions` (등록/처리/에스컬레이션)
> 기본 Preset: 역할에 따라 자동 결정
> 노드 역할: **Detail** (상세 노드 — 필터·조회·처리 전용)

---

## 1. 화면 개요

### 1.1 목적

결정/리스크 보드는 **"뭘 문제로 결정하나? 리스크는 어디에 있나?"**에 대한 답을 제공한다.
기존 엑셀 기반 의사결정/리스크 목록을 **"살아있는 통제 보드"**로 전환하여,
프로젝트 결정사항(Decision)과 리스크(Risk)를 **단일 화면에서 통합 관리**한다.

두 엔티티는 본질적으로 연관된다:
- **Decision**: "무엇을 결정해야 하는가" — 아키텍처 변경, 범위 조정, 리소스 재배치 등
- **Risk**: "무엇이 프로젝트를 위협하는가" — 일정 지연, 기술 불확실성, 외부 의존성 등

리스크가 통제 불가능한 수준에 이르면 **에스컬레이션 체인**(Issue -> Risk -> Decision)을 통해
의사결정으로 승격되며, 이 전체 흐름을 하나의 보드에서 추적한다.

> **v2.0 변경**: Risk Matrix(5x5) 뷰 추가, Decision Kanban 뷰 추가,
> Escalation Chain 시각화, FilterSpec 온톨로지 내장, 에스컬레이션 자동 알림 정책,
> Audit Trail 전수 기록, AI 리스크 평가 보조 연동.

> **v2.1 변경**: FilterSpec `view`/`hasEscalation` 키 추가 + 다중 상태 필터,
> Summary DTO 도입(리스트 경량화), Server-driven `allowedTransitions` 일원화,
> Escalation create-vs-link 분리(중복 생성 방지), Idempotency-Key/If-Match 헤더,
> ScopeEcho + reliability 3-tuple 표준화, RiskAssessment score/severity 서버 파생,
> Decision APPROVED 전이 최소 요건(options>=2, selectedOption, rationale 필수),
> SLA 기준 상태별 분리, panelMode auto/manual 개념, URL 상태 복원(selected/view),
> Capability vs Policy 2-레이어 분리, 알림 디바운스/다이제스트 정책,
> Metric 정의 확정(active risk 기준 trend), 깨지기 쉬운 곳 5→11개 확장.

### 1.2 설계 원칙

| 원칙 | 설명 |
|------|------|
| **단일 보드, 두 엔티티** | Decision + Risk를 하나의 `/decisions`에서 관리, 탭으로 전환 |
| **에스컬레이션 = 연결** | Issue -> Risk -> Decision 체인을 ID 기반으로 추적 |
| **Risk Matrix 필수** | 5x5 Impact x Probability 매트릭스로 리스크 포지셔닝 시각화 |
| **Decision Kanban** | Proposed -> Under Review -> Decided (Approved/Rejected/Deferred) 칸반 흐름 |
| **Audit Trail 전수** | 모든 상태 변경을 timestamp + actor와 함께 기록 (감사 증빙 연동) |
| **FilterSpec = 온톨로지** | 필터 키가 AI/URL/백엔드 공통 스키마로 통합 |
| **서버 트랜잭션 강제** | 상태 전이/에스컬레이션은 프론트 임의 변경 불가, 서버에서만 처리 |
| **Capability 세분화** | 조회(view_decisions)와 관리(manage_decisions)를 분리 |
| **Server-driven transitions** | 서버가 `allowedTransitions` 목록을 내려주면 프론트는 그것만 렌더링 (v2.1) |
| **Summary DTO 분리** | 리스트는 경량 DTO, 상세만 풀 엔티티 — auditTrail은 별도 endpoint (v2.1) |
| **Idempotency + Concurrency** | 모든 mutation에 `Idempotency-Key`, 상태 전이에 `If-Match` ETag (v2.1) |
| **Escalation = 생성 or 연결** | 에스컬레이션 시 신규 생성뿐 아니라 기존 엔티티 연결도 지원 (v2.1) |
| **Derived Score/Severity** | `score = impact * probability`, `severity = f(score)` — 서버 파생, READ-ONLY (v2.1) |
| **Capability vs Policy** | Capability = 접근 가능성, Policy = 허용 행위 — 2-레이어 분리 (v2.1) |
| **URL 상태 복원** | `view`, `selected` 파라미터로 새로고침/뒤로가기 안정성 확보 (v2.1) |
| **알림 디바운스** | 동일 엔티티 24시간 내 중복 알림 억제 + 일간 다이제스트 (v2.1) |

### 1.3 행동 무게중심 -- 관련 화면의 역할 분담

> 결정/리스크는 이슈 관리, 산출물 관리, 대시보드와 밀접하게 연관된다.
> AI가 조치 질문을 받았을 때 어디로 보낼지의 정책이 Preset별로 달라진다.

| 화면 | 역할 | 핵심 행동 |
|------|------|---------|
| **결정/리스크** (본 화면) | **통제/판단 홈** | Decision 등록/처리, Risk 평가, 에스컬레이션 |
| **이슈 관리** | **이슈 추적 홈** | Issue 등록/처리, 블로커 관리 |
| **산출물 관리** | **승인 홈** | 산출물 승인/반려, 완료 기록 |
| **대시보드** | **요약 허브** | 전체 리스크/결정 현황 KPI |

**Preset별 AI 라우팅 정책 (do_escalate_risk 예시)**:

| Preset | "리스크 에스컬레이션 해줘" -> AI 라우팅 | 이유 |
|--------|--------------------------------------|------|
| PM_WORK | -> `targetNodeId: "decisions"` | PM은 에스컬레이션 실행 주체 |
| PMO_CONTROL | -> `targetNodeId: "decisions"` | PMO는 교차 프로젝트 리스크 통제 |
| DEV_EXECUTION | -> `targetNodeId: "issues"` | DEV는 이슈 레벨에서 리스크 제안 |
| EXEC_SUMMARY | -> `targetNodeId: "decisions"` | Sponsor는 결정 승인 관점 |
| CUSTOMER_APPROVAL | -> `targetNodeId: "decisions"` | Customer는 결정 승인/반려 |

```typescript
/** Preset별 do intent 라우팅 정책 */
export const DECISION_RISK_DO_INTENT_ROUTING: Record<ViewModePreset, Record<string, string>> = {
  PM_WORK: {
    do_create_decision:     "decisions",
    do_escalate_risk:       "decisions",
    do_assess_risk:         "decisions",
    do_approve_decision:    "decisions",
    do_create_risk:         "decisions",
  },
  PMO_CONTROL: {
    do_create_decision:     "decisions",
    do_escalate_risk:       "decisions",
    do_assess_risk:         "decisions",
    do_approve_decision:    "decisions",
    do_create_risk:         "decisions",
  },
  DEV_EXECUTION: {
    do_create_decision:     "decisions",     // propose only
    do_escalate_risk:       "issues",        // DEV raises issue first
    do_assess_risk:         "decisions",
    do_approve_decision:    "decisions",     // read-only for DEV
    do_create_risk:         "issues",        // DEV creates issue, PM escalates to risk
  },
  EXEC_SUMMARY: {
    do_create_decision:     "decisions",
    do_escalate_risk:       "decisions",
    do_assess_risk:         "decisions",
    do_approve_decision:    "decisions",
    do_create_risk:         "decisions",
  },
  CUSTOMER_APPROVAL: {
    do_create_decision:     "decisions",
    do_escalate_risk:       "decisions",
    do_assess_risk:         "decisions",
    do_approve_decision:    "decisions",
    do_create_risk:         "decisions",
  },
};
```

### 1.4 핵심 질문 -> 위젯 매핑

| 사용자 질문 | 화면 영역 | 설명 |
|-----------|---------|------|
| "미결정 사항이 몇 건이야?" | 상단 KPI | pending_decisions 건수 |
| "Critical 리스크가 있어?" | 상단 KPI + Risk Matrix | critical_risks 건수 + 매트릭스 |
| "리스크 매트릭스 보여줘" | Risk Matrix 뷰 | 5x5 Impact x Probability 그리드 |
| "결정 대기 중인 건 목록" | Decision Kanban | PROPOSED + UNDER_REVIEW 컬럼 |
| "에스컬레이션 된 이슈 있어?" | 필터 + 배지 | escalatedFrom 필터 |
| "평균 결정 소요일은?" | 상단 KPI | avg_decision_time 지표 |
| "이번 단계 리스크는?" | 필터 | phaseId 필터 + 리스크 목록 |
| "리스크 점수 추세는?" | Trend Chart | risk_score_trend 시계열 |
| "DEC-004 승인해줘" | Right Panel | Decision 상세 + 승인/반려 버튼 |
| "에스컬레이션 체인 보여줘" | Right Panel | Issue -> Risk -> Decision 시각화 |

---

## 2. MenuOntology 노드

### 2.1 타입 확정 (v2.0 변경사항)

01_대시보드 / 03_백로그 v2.0 패턴을 동일하게 적용한다.

| 항목 | v1.0 | v2.0 (확정) | 변경 사유 |
|------|------|------------|----------|
| `entities` | 소문자 | PascalCase `"Decision"`, `"Risk"` | EntityType enum 정규화 |
| `intents` | 5개 | **16개** 확장 | 리스크 평가/에스컬레이션/매트릭스 질문 추가 |
| Capability | 2개 | **2개** 유지 | `view_decisions`, `manage_decisions` |
| `filterSpec` | 5키 | **10키** | `severity`, `ownerId`, `escalatedFrom`, `dateRange` 등 추가 |
| `virtualNodes` | 없음 | **5개** | Risk Matrix, Pending Decisions 등 |
| `metrics` | 4개 | **7개** | `escalation_count`, `risk_score_trend`, `avg_decision_time` 추가 |
| AI 라우팅 | 단일 | Preset별 분기 | DO_INTENT_ROUTING 적용 |
| `nodeRole` | 없음 | `"detail"` | AI 스코어링 기준 |

### 2.2 FilterSpec 정의

FilterSpec은 **이 화면이 지원하는 필터 스키마**를 온톨로지 내부에 선언한다.
AI가 딥링크를 생성할 때, URL 파라미터 문자열이 아니라 **FilterSpec 키 기반 필터 객체**를 반환한다.

```typescript
/** 결정/리스크 필터 스키마 -- 온톨로지 내장 (v2.1 updated) */
export interface DecisionRiskFilterSpec {
  /** 엔티티 유형: decision 또는 risk */
  type?: "decision" | "risk";
  /** Decision 상태 -- 단일 또는 다중 (v2.1) */
  decisionStatus?: DecisionStatus | DecisionStatus[];
  /** Risk 상태 -- 단일 또는 다중 (v2.1) */
  riskStatus?: RiskStatus | RiskStatus[];
  /** 심각도 (Risk 전용) */
  severity?: "critical" | "high" | "medium" | "low";
  /** 담당자 */
  ownerId?: string;
  /** 관련 파트 */
  partId?: string;
  /** 관련 단계 */
  phaseId?: string;
  /** 날짜 범위 */
  dateRange?: {
    from?: string;    // ISO date
    to?: string;      // ISO date
  };
  /** 에스컬레이션 존재 여부 (v2.1: replaces escalatedFrom="*" wildcard) */
  hasEscalation?: boolean;
  /** 에스컬레이션 출처 엔티티 ID (specific lookup) */
  escalatedFromId?: string;
  /** 뷰 모드 (v2.1: FilterSpec 정식 키로 승격) */
  view?: DecisionRiskViewMode;
  /** 선택된 엔티티 ID -- URL 상태 복원용 (v2.1) */
  selected?: string;
  /** 자유 검색어 */
  q?: string;
}

type DecisionRiskViewMode = "all" | "kanban" | "matrix";
type DecisionStatus = "PROPOSED" | "UNDER_REVIEW" | "APPROVED" | "REJECTED" | "DEFERRED";
type RiskStatus = "IDENTIFIED" | "ASSESSED" | "MITIGATING" | "RESOLVED" | "ACCEPTED";
```

> **뷰 모드 결정 우선순위 (v2.1)**:
> 1. URL에 `view=`가 명시되면 해당 뷰를 따른다 (사용자 명시적 선택)
> 2. `view`가 없고 `type=decision`이면 `kanban` 기본 추천 (1회)
> 3. `view`가 없고 `type=risk`이면 `matrix` 기본 추천 (1회)
> 4. 사용자가 탭을 클릭하면 `view`가 URL에 기록되어 "명시적 선택"이 된다
> 5. `type` 미지정이면 `all` (통합 목록 테이블)

### 2.3 FilterSpec URL 직렬화 규칙

**직렬화 방향**: `DecisionRiskFilterSpec -> URL query string -> DecisionRiskFilterSpec` (왕복 보장)

```typescript
/** FilterSpec -> URL 직렬화 (v2.1: view, hasEscalation, array status 지원) */
function serializeDecisionRiskFilter(filter: DecisionRiskFilterSpec): URLSearchParams {
  const params = new URLSearchParams();
  for (const [key, value] of Object.entries(filter)) {
    if (value === undefined || value === null) continue;
    // dateRange is nested
    if (key === "dateRange" && typeof value === "object") {
      if (value.from) params.set("dateFrom", value.from);
      if (value.to) params.set("dateTo", value.to);
      continue;
    }
    // v2.1: array status -> repeat key serialization
    if (Array.isArray(value)) {
      for (const v of value) params.append(key, String(v));
      continue;
    }
    // v2.1: boolean -> "true"/"false" string
    if (typeof value === "boolean") {
      params.set(key, value ? "true" : "false");
      continue;
    }
    params.set(key, String(value));
  }
  return params;
}

/** URL -> FilterSpec 역직렬화 (v2.1 updated) */
function deserializeDecisionRiskFilter(params: URLSearchParams): DecisionRiskFilterSpec {
  const filter: DecisionRiskFilterSpec = {};

  // v2.1: enum whitelist with array support
  const enumKeys = {
    type: ["decision", "risk"],
    decisionStatus: ["PROPOSED", "UNDER_REVIEW", "APPROVED", "REJECTED", "DEFERRED"],
    riskStatus: ["IDENTIFIED", "ASSESSED", "MITIGATING", "RESOLVED", "ACCEPTED"],
    severity: ["critical", "high", "medium", "low"],
    view: ["all", "kanban", "matrix"],
  } as const;

  // v2.1: multi-value enum keys (repeat key -> array)
  const multiValueKeys = new Set(["decisionStatus", "riskStatus"]);

  for (const key of Object.keys(enumKeys)) {
    const allValues = params.getAll(key);
    if (allValues.length === 0) continue;
    const validValues = allValues.filter(v =>
      (enumKeys as any)[key].includes(v),
    );
    if (validValues.length === 0) continue;
    if (multiValueKeys.has(key) && validValues.length > 1) {
      (filter as any)[key] = validValues;        // array
    } else {
      (filter as any)[key] = validValues[0];     // single
    }
  }

  // dateRange reconstruction
  const dateFrom = params.get("dateFrom");
  const dateTo = params.get("dateTo");
  if (dateFrom || dateTo) {
    filter.dateRange = {};
    if (dateFrom) filter.dateRange.from = dateFrom;
    if (dateTo) filter.dateRange.to = dateTo;
  }

  // v2.1: boolean key
  const hasEsc = params.get("hasEscalation");
  if (hasEsc === "true") filter.hasEscalation = true;

  // string keys (v2.1: escalatedFrom -> escalatedFromId, +selected)
  for (const key of ["ownerId", "partId", "phaseId", "escalatedFromId", "selected", "q"]) {
    const val = params.get(key);
    if (val) (filter as any)[key] = val;
  }

  // unknown keys -> silent drop (forward compatibility)
  return filter;
}
```

**직렬화 규칙 요약**:

| 규칙 | 예시 | 설명 |
|------|------|------|
| enum은 화이트리스트 검증 | `?type=decision` | 유효하지 않은 값은 silent drop |
| 다중 상태는 repeat key (v2.1) | `?decisionStatus=PROPOSED&decisionStatus=UNDER_REVIEW` | 배열로 역직렬화 |
| dateRange은 flat화 | `?dateFrom=2026-01-01&dateTo=2026-02-28` | nested -> flat |
| boolean은 문자열화 (v2.1) | `?hasEscalation=true` | `"true"` / `"false"` |
| view는 정식 키 (v2.1) | `?view=kanban` | FilterSpec 왕복 보장 |
| selected로 상태 복원 (v2.1) | `?selected=DEC-04` | 새로고침 시 선택 유지 |
| 복수 필터는 `&`로 연결 | `?type=risk&severity=critical` | 표준 query string |
| 미지 키는 무시 | `?futureKey=x` -> 무시 | 하위 호환성 보장 |

### 2.4 Decisions/Risk 노드 (확정본 v2.1)

```typescript
const decisionsNode: MenuOntologyNodeV2 = {
  nodeId: "decisions",
  label: "결정/리스크 보드",
  route: "/decisions",
  icon: "GavelRounded",
  domain: "control",
  nodeRole: "detail",              // detail node -- action/filter questions get +10 bonus

  requiredCaps: ["view_decisions"],

  // --- intents: 16 (v2.0) ---
  intents: [
    // Ask family -- query/question
    "ask_decision_pending",          // "미결정 사항이 몇 건이야?"
    "ask_decision_status",           // "결정 사항 현황 알려줘"
    "ask_risk",                      // "리스크 현황 알려줘"
    "ask_risk_assessment",           // "리스크 매트릭스 보여줘"
    "ask_risk_trend",                // "리스크 점수 추세는?"
    "ask_escalation_chain",          // "에스컬레이션 체인 보여줘"
    "ask_critical_risks",            // "Critical 리스크 있어?"
    "ask_decision_time",             // "평균 결정 소요일은?"
    "ask_phase_risks",               // "이번 단계 리스크는?"
    "ask_escalation_count",          // "에스컬레이션 된 건수는?"
    // Do family -- execute/change
    "do_create_decision",            // "결정 등록해줘"
    "do_create_risk",                // "리스크 등록해줘"
    "do_approve_decision",           // "결정 승인해줘"
    "do_escalate_risk",              // "리스크 에스컬레이션 해줘"
    "do_assess_risk",                // "리스크 평가해줘"
    "do_export_decisions",           // "결정/리스크 Export 해줘"
  ],
  canonicalQuestions: [
    "미결정 사항이 몇 건이야?",
    "Critical 리스크가 있어?",
    "리스크 매트릭스 보여줘",
    "결정 대기 중인 건 목록",
    "에스컬레이션 된 이슈 있어?",
    "평균 결정 소요일은?",
    "이번 단계 리스크는?",
    "리스크 점수 추세는?",
    "DEC-004 승인해줘",
    "새 리스크 등록해줘",
    "에스컬레이션 체인 보여줘",
    "결정/리스크 현황 Export 해줘",
  ],
  entities: ["Decision", "Risk", "Issue", "Project", "Phase"],
  keywords: [
    "결정", "리스크", "위험", "에스컬레이션", "승인", "반려",
    "의사결정", "리스크매트릭스", "리스크평가", "리스크점수",
    "decision", "risk", "escalation", "approval", "reject",
    "deferred", "matrix", "impact", "probability", "mitigation",
  ],
  metrics: [
    "total_decisions",
    "pending_decisions",
    "total_risks",
    "critical_risks",
    "avg_decision_time",
    "escalation_count",
    "risk_score_trend",
  ],

  // --- FilterSpec ontology embedding (v2.1 updated) ---
  filterSpec: {
    keys: [
      "type", "decisionStatus", "riskStatus", "severity",
      "ownerId", "partId", "phaseId", "dateRange",
      "hasEscalation", "escalatedFromId",
      "view", "selected", "q",
    ],
    allowedViews: ["all", "kanban", "matrix"],  // v2.1
    defaults: { view: "all" },
  },

  defaultPreset: "PM_WORK",
  presetPolicies: [
    {
      preset: "EXEC_SUMMARY",
      ui: {
        density: "compact",
        defaultRightPanel: "closed",
        highlight: {
          metricKeys: ["total_decisions", "pending_decisions", "critical_risks"],
          widgetKeys: ["KPI_DECISIONS", "KPI_RISKS", "DECISION_SUMMARY_TABLE"],
        },
        hiddenColumns: ["ownerId", "partId", "escalatedFrom"],
      },
      suggestedActions: [
        {
          key: "approve_decision",
          label: "결정 승인",
          requiredCaps: ["manage_decisions"],
          targetNodeId: "decisions",
        },
      ],
    },
    {
      preset: "PMO_CONTROL",
      ui: {
        density: "standard",
        defaultRightPanel: "open",
        highlight: {
          metricKeys: [
            "total_decisions", "pending_decisions", "total_risks",
            "critical_risks", "escalation_count",
          ],
          widgetKeys: [
            "KPI_DECISIONS", "KPI_RISKS", "RISK_MATRIX",
            "DECISION_AUDIT_TRAIL", "CROSS_PROJECT_RISK_TABLE",
          ],
        },
      },
      suggestedActions: [
        {
          key: "export_decisions",
          label: "결정/리스크 Export",
          requiredCaps: ["export_reports"],
          targetNodeId: "reports",
        },
        {
          key: "view_audit_trail",
          label: "감사 이력 확인",
          requiredCaps: ["view_decisions"],
          targetNodeId: "decisions",
        },
      ],
    },
    {
      preset: "PM_WORK",
      ui: {
        density: "detailed",
        defaultRightPanel: "open",
        highlight: {
          metricKeys: [
            "pending_decisions", "critical_risks", "avg_decision_time",
            "escalation_count", "risk_score_trend",
          ],
          widgetKeys: [
            "KPI_PENDING", "KPI_CRITICAL", "DECISION_KANBAN",
            "RISK_MATRIX", "ESCALATION_CHAIN", "DETAIL_PANEL",
          ],
        },
      },
      suggestedActions: [
        {
          key: "create_decision",
          label: "결정 등록",
          requiredCaps: ["manage_decisions"],
          targetNodeId: "decisions",
        },
        {
          key: "create_risk",
          label: "리스크 등록",
          requiredCaps: ["manage_decisions"],
          targetNodeId: "decisions",
        },
        {
          key: "assess_risk",
          label: "리스크 평가",
          requiredCaps: ["manage_decisions"],
          targetNodeId: "decisions",
        },
        {
          key: "escalate",
          label: "에스컬레이션",
          requiredCaps: ["manage_decisions"],
          targetNodeId: "decisions",
        },
      ],
    },
    {
      preset: "DEV_EXECUTION",
      ui: {
        density: "standard",
        defaultRightPanel: "closed",
        highlight: {
          metricKeys: ["total_risks", "critical_risks"],
          widgetKeys: ["KPI_RISKS", "RISK_LIST", "MY_RELATED_RISKS"],
        },
      },
      suggestedActions: [
        {
          key: "propose_decision",
          label: "결정 제안",
          requiredCaps: ["manage_decisions"],
          targetNodeId: "decisions",
        },
        {
          key: "go_issues",
          label: "이슈 관리",
          requiredCaps: ["view_issues"],
          targetNodeId: "issues",
        },
      ],
    },
    {
      preset: "CUSTOMER_APPROVAL",
      ui: {
        density: "compact",
        defaultRightPanel: "open",
        highlight: {
          metricKeys: ["pending_decisions", "total_decisions"],
          widgetKeys: ["KPI_PENDING", "DECISION_APPROVAL_LIST", "APPROVAL_DETAIL"],
        },
      },
      suggestedActions: [
        {
          key: "approve_decision",
          label: "결정 승인",
          requiredCaps: ["manage_decisions"],
          targetNodeId: "decisions",
        },
        {
          key: "request_escalation",
          label: "에스컬레이션 요청",
          requiredCaps: ["manage_decisions"],
          targetNodeId: "decisions",
        },
      ],
    },
    // AUDIT_EVIDENCE removed -- auditor has no direct access to /decisions
  ],

  // --- DeepLink: routeTemplate standard (:param format) (v2.1 updated) ---
  deepLinks: [
    {
      pattern: "/decisions?type=decision&view=kanban",
      description: "Decision Kanban view",
      requiredParams: [],
    },
    {
      pattern: "/decisions?type=risk&view=matrix",
      description: "Risk Matrix view",
      requiredParams: [],
    },
    {
      pattern: "/decisions?type=risk&severity=:severity",
      description: "Severity-filtered risk list",
      requiredParams: ["severity"],
    },
    {
      pattern: "/decisions?decisionStatus=:decisionStatus",
      description: "Decision status filter (supports repeat key for multi)",
      requiredParams: ["decisionStatus"],
    },
    {
      pattern: "/decisions?riskStatus=:riskStatus",
      description: "Risk status filter (supports repeat key for multi)",
      requiredParams: ["riskStatus"],
    },
    {
      pattern: "/decisions?phaseId=:phaseId",
      description: "Phase-scoped decision/risk view",
      requiredParams: ["phaseId"],
    },
    {
      pattern: "/decisions?hasEscalation=true",
      description: "All escalated items (v2.1: replaces escalatedFrom=*)",
      requiredParams: [],
    },
    {
      pattern: "/decisions?escalatedFromId=:entityId",
      description: "Specific escalation source filter",
      requiredParams: ["entityId"],
    },
    {
      pattern: "/decisions?type=risk&severity=critical&view=matrix",
      description: "Critical risks on matrix",
      requiredParams: [],
    },
    {
      pattern: "/decisions?selected=:entityId",
      description: "Direct entity selection (URL state restore)",
      requiredParams: ["entityId"],
    },
  ],

  // --- Virtual nodes: deep links promoted to ontology L2 nodes (v2.1 updated) ---
  virtualNodes: [
    {
      virtualId: "decisions.risk-matrix",
      label: "리스크 매트릭스",
      routeTemplate: "/decisions?type=risk&view=matrix",
      matchFilters: { type: "risk", view: "matrix" },
      requiredParams: [],
      intents: ["ask_risk_assessment", "ask_risk"],
      description: "5x5 Impact x Probability risk matrix visualization",
    },
    {
      virtualId: "decisions.pending",
      label: "미결정 사항",
      routeTemplate: "/decisions?type=decision&decisionStatus=PROPOSED&decisionStatus=UNDER_REVIEW&view=kanban",
      matchFilters: { type: "decision", decisionStatus: ["PROPOSED", "UNDER_REVIEW"] },
      requiredParams: [],
      intents: ["ask_decision_pending"],
      description: "Pending decisions awaiting review or approval",
    },
    {
      virtualId: "decisions.critical-risks",
      label: "Critical 리스크",
      routeTemplate: "/decisions?type=risk&severity=critical&view=matrix",
      matchFilters: { type: "risk", severity: "critical" },
      requiredParams: [],
      intents: ["ask_critical_risks"],
      description: "Critical severity risks requiring immediate attention",
    },
    {
      virtualId: "decisions.escalated",
      label: "에스컬레이션 건",
      routeTemplate: "/decisions?hasEscalation=true",
      matchFilters: { hasEscalation: true },
      requiredParams: [],
      intents: ["ask_escalation_chain", "ask_escalation_count"],
      description: "Items escalated from issues -- shows escalation chain",
    },
    {
      virtualId: "decisions.kanban",
      label: "결정 칸반",
      routeTemplate: "/decisions?type=decision&view=kanban",
      matchFilters: { type: "decision", view: "kanban" },
      requiredParams: [],
      intents: ["ask_decision_status"],
      description: "Decision Kanban board: Proposed -> Under Review -> Decided",
    },
  ],

  // --- Scope 2-layer separation ---
  scope: {
    keys: ["project", "part", "phase"],
    params: ["projectId", "partId", "phaseId"],
  },

  priority: 4,
};
```

---

## 3. 화면 구조

### 3.1 Right Panel panelMode 정의

Right Panel은 항상 동일한 영역이지만, **panelMode**에 따라 표시 내용이 달라진다.

```typescript
/** Right Panel mode -- explicit enum */
export type DecisionRiskPanelMode =
  | "none"                 // Right Panel hidden
  | "decision-detail"      // Decision detail + approval chain
  | "risk-detail"          // Risk detail + impact analysis
  | "risk-assessment"      // Risk assessment form (Impact x Probability)
  | "escalation-chain"     // Issue -> Risk -> Decision chain visualization
  | "audit-trail"          // Change history timeline
  | "approval";            // Decision approval/rejection form

/** v2.1: panelMode 선택 모드 -- auto vs manual */
export type PanelModeSource = "auto" | "manual";
// auto:   selection 기반 자동 결정 (아래 규칙 테이블 참조)
// manual: 사용자가 패널 탭/버튼으로 명시적 변경 → 선택이 바뀌면 auto로 복귀
```

**panelMode 결정 규칙**:

| 컨텍스트 | Preset | 기본 panelMode |
|---------|--------|---------------|
| 목록 + 행 미선택 | ALL | `"none"` |
| Decision 행 선택 | EXEC_SUMMARY | `"none"` (Right Panel hidden) |
| Decision 행 선택 | PM_WORK / PMO_CONTROL | `"decision-detail"` |
| Decision 행 선택 | CUSTOMER_APPROVAL | `"approval"` |
| Decision 행 선택 | DEV_EXECUTION | `"decision-detail"` (read-only) |
| Risk 행 선택 | PM_WORK | `"risk-detail"` |
| Risk 행 선택 | PMO_CONTROL | `"risk-detail"` |
| Risk 행 + "평가" 클릭 | PM_WORK | `"risk-assessment"` |
| 에스컬레이션 배지 클릭 | ALL | `"escalation-chain"` |
| "감사 이력" 클릭 | PMO_CONTROL | `"audit-trail"` |

### 3.2 메인 뷰 모드 (3-Tab)

화면은 상단 탭으로 3가지 뷰 모드를 제공한다:

```typescript
/** Main view modes */
export type DecisionRiskViewMode =
  | "all"        // Integrated table (Decision + Risk)
  | "kanban"     // Decision Kanban board
  | "matrix";    // Risk Matrix (5x5)
```

| 뷰 모드 | 탭 라벨 | 표시 대상 | 기본 적용 |
|---------|---------|----------|----------|
| `all` | 전체 목록 | Decision + Risk 통합 테이블 | `type` 미지정 시 |
| `kanban` | 결정 칸반 | Decision만 칸반 보드 형태 | `type=decision` 시 |
| `matrix` | 리스크 매트릭스 | Risk만 5x5 매트릭스 | `type=risk` 시 |

#### 3.2.1 Decision Kanban Column Key (v2.1)

칸반 뷰의 DECIDED 컬럼은 가상 컬럼이다 (상태 enum에 "DECIDED"는 없음).
프론트/서버가 같은 언어를 쓰도록 KanbanColumnKey를 분리한다.

```typescript
/** Kanban column keys -- UI layer only */
export type KanbanColumnKey = "PROPOSED" | "UNDER_REVIEW" | "DECIDED";

/** DECIDED = virtual column: groups APPROVED + REJECTED + DEFERRED */
const DECIDED_STATUSES: DecisionStatus[] = ["APPROVED", "REJECTED", "DEFERRED"];

/** Column -> Filter mapping */
const KANBAN_COLUMN_FILTER: Record<KanbanColumnKey, DecisionStatus[]> = {
  PROPOSED:     ["PROPOSED"],
  UNDER_REVIEW: ["UNDER_REVIEW"],
  DECIDED:      DECIDED_STATUSES,
};

// Drag-and-drop policy (v2.1):
// - PROPOSED -> UNDER_REVIEW: auto transition on drag (PM_WORK only)
// - UNDER_REVIEW -> DECIDED: PROHIBITED via drag — must use action buttons
//   (Approve/Reject/Defer are high-impact decisions, drag is too error-prone)
// - DECIDED -> any: no drag allowed (terminal states)
```

### 3.3 통합 목록 뷰 (`/decisions` 기본)

```
+--------------------------------------------------------------+
|  Page Header                                                  |
|  결정/리스크 보드  [ AI 보험금지급심사 구축 ]                   |
|  [ 필터 V ]  [ 검색 ]                 [ + 결정 등록 ] [ + 리스크 등록 ] |
+--------------------------------------------------------------+
|                                                              |
|  +----------+  +----------+  +----------+  +----------+      |
|  | Pending  |  | Total    |  | Critical |  | Avg      |      |
|  | Decisions|  | Risks    |  | Risks    |  | Decision |      |
|  |   5건    |  |  12건    |  |   2건    |  | Time     |      |
|  |  !       |  |          |  |  !!      |  |  4.2일   |      |
|  +----------+  +----------+  +----------+  +----------+      |
|                                                              |
|  +----------+  +----------+  +----------+                    |
|  | Total    |  | Escala-  |  | Risk     |                    |
|  | Decisions|  | tions    |  | Score    |                    |
|  |  18건    |  |   3건    |  | Trend    |                    |
|  |          |  |  !       |  |  ^       |                    |
|  +----------+  +----------+  +----------+                    |
|                                                              |
|  +- Filter Bar -----------------------------------------+    |
|  | Type: [All V]  Status: [All V]  Severity: [All V]   |    |
|  | Owner: [All V] Part: [All V]  Phase: [All V]        |    |
|  | Date: [From] ~ [To]  Escalated: [ ]  Search: [    ] |    |
|  +------------------------------------------------------+    |
|                                                              |
|  [Tab: All List]  [Tab: Decision Kanban]  [Tab: Risk Matrix] |
|                                                              |
|  +- Integrated Table -------------------------+-----------+  |
|  |                                            | panelMode:|  |
|  |  ID    | Type | Title      | Status   |Sev | "detail"  |  |
|  |  ------|------|------------|----------|----|---------   |  |
|  |  DEC-01| Dec  | Arch Change| APPROVED | -  |           |  |
|  |        |      |            |          |    | -- Info -- |  |
|  | >DEC-04| Dec  | Scope Adj. | UNDER_RE.| -  | DEC-04    |  |
|  |        |      |            |          |    | Scope Adj  |  |
|  |  DEC-05| Dec  | Resource   | PROPOSED | -  |           |  |
|  |        |      |            |          |    | Status:    |  |
|  |  RSK-01| Risk | Infra Delay| MITIGAT. |Cri | UNDER_REV |  |
|  |        |      |            |          |    | Owner:     |  |
|  |  RSK-03| Risk | Vendor Dep.| ASSESSED |Hi  | Park PM   |  |
|  |        |      |            |          |    | Requested: |  |
|  |  RSK-05| Risk | Data Qual. | IDENTIF. |Med | 2026-02-05|  |
|  |        |      |            |          |    |           |  |
|  |  ISS>  | Esc  | ISS-042 >  | -> RSK-01|    | -- Chain --|  |
|  |        |      | RSK-01     |          |    | ISS-042   |  |
|  |        |      |            |          |    |  > RSK-01 |  |
|  |                                            |  > DEC-04 |  |
|  |                                            |           |  |
|  |                                            | [Approve] |  |
|  |                                            | [Reject ] |  |
|  |                                            | [Defer  ] |  |
|  +--------------------------------------------+-----------+  |
|                                                              |
+--------------------------------------------------------------+
```

### 3.4 Decision Kanban 뷰 (`/decisions?type=decision&view=kanban`)

```
+--------------------------------------------------------------+
|  Page Header                                                  |
|  결정/리스크 보드 > 결정 칸반  [ AI 보험금지급심사 구축 ]       |
|  [ 필터 V ]                           [ + 결정 등록 ]         |
+--------------------------------------------------------------+
|                                                              |
|  [Tab: All List]  [Tab: *Decision Kanban*]  [Tab: Risk Matrix]|
|                                                              |
|  +- Decision Kanban Board --------------------------------+  |
|  |                                                        |  |
|  |  PROPOSED (2)    UNDER_REVIEW (2)  DECIDED             |  |
|  |  +----------+    +----------+      +----------+        |  |
|  |  | DEC-05   |    | DEC-04   |      |          |        |  |
|  |  | Resource |    | Scope    |      | APPROVED |        |  |
|  |  | Realloc. |    | Adjust.  |      |          |        |  |
|  |  | Owner:   |    | Owner:   |      | +------+ |        |  |
|  |  |  Lee PM  |    |  Park PM |      | |DEC-01| |        |  |
|  |  | D+3      |    | D+7      |      | |Arch  | |        |  |
|  |  | !        |    | !!       |      | |Change| |        |  |
|  |  +----------+    +----------+      | +------+ |        |  |
|  |  +----------+    +----------+      |          |        |  |
|  |  | DEC-06   |    | DEC-07   |      | REJECTED |        |  |
|  |  | Testing  |    | Budget   |      |          |        |  |
|  |  | Strategy |    | Override |      | +------+ |        |  |
|  |  | Owner:   |    | Owner:   |      | |DEC-02| |        |  |
|  |  |  Kim QA  |    |  Hong PM |      | |Feat  | |        |  |
|  |  | D+1      |    | D+5      |      | |Cut   | |        |  |
|  |  +----------+    +----------+      | +------+ |        |  |
|  |                                    |          |        |  |
|  |                                    | DEFERRED |        |  |
|  |                                    |          |        |  |
|  |                                    | +------+ |        |  |
|  |                                    | |DEC-03| |        |  |
|  |                                    | |Deploy| |        |  |
|  |                                    | |Window| |        |  |
|  |                                    | +------+ |        |  |
|  |                                    +----------+        |  |
|  +--------------------------------------------------------+  |
|                                                              |
|  * D+N = days since proposal submitted                       |
|  * Drag-and-drop: PM_WORK only (manage_decisions required)   |
+--------------------------------------------------------------+
```

### 3.5 Risk Matrix 뷰 (`/decisions?type=risk&view=matrix`)

```
+--------------------------------------------------------------+
|  Page Header                                                  |
|  결정/리스크 보드 > 리스크 매트릭스  [ AI 보험금지급심사 구축 ] |
|  [ 필터 V ]                           [ + 리스크 등록 ]       |
+--------------------------------------------------------------+
|                                                              |
|  [Tab: All List]  [Tab: Decision Kanban]  [Tab: *Risk Matrix*]|
|                                                              |
|  +- Risk Matrix (5x5) -----------------------------------+   |
|  |                                                       |   |
|  |  Impact                                               |   |
|  |    ^                                                  |   |
|  |  5 |  5   | 10   | 15   | 20  || 25   |              |   |
|  |    |      |      |RSK-05|     ||RSK-01|              |   |
|  |    | Low  | Med  | High | High|| Crit |              |   |
|  |    +------+------+------+-----++------+              |   |
|  |  4 |  4   |  8   | 12   | 16  || 20   |              |   |
|  |    |      |      |      |RSK-03|      |              |   |
|  |    | Low  | Med  | Med  | High|| High |              |   |
|  |    +------+------+------+-----++------+              |   |
|  |  3 |  3   |  6   |  9   | 12  || 15   |              |   |
|  |    |      |RSK-07|      |     ||      |              |   |
|  |    | Low  | Low  | Med  | Med || High |              |   |
|  |    +------+------+------+-----++------+              |   |
|  |  2 |  2   |  4   |  6   |  8  || 10   |              |   |
|  |    |RSK-09|      |      |     ||      |              |   |
|  |    | Low  | Low  | Low  | Med || Med  |              |   |
|  |    +------+------+------+-----++------+              |   |
|  |  1 |  1   |  2   |  3   |  4  ||  5   |              |   |
|  |    |      |      |      |     ||      |              |   |
|  |    | Low  | Low  | Low  | Low || Med  |              |   |
|  |    +------+------+------+-----++------+              |   |
|  |      1      2      3      4      5  --> Probability  |   |
|  |                                                       |   |
|  +-------------------------------------------------------+   |
|                                                              |
|  Legend:                                                     |
|  +------+  +------+  +------+  +------+                     |
|  | Low  |  |Medium|  | High |  |Critic|                     |
|  | 1-3  |  | 4-9  |  |10-16 |  |17-25 |                     |
|  |green |  |amber |  |orange|  | red  |                     |
|  +------+  +------+  +------+  +------+                     |
|                                                              |
|  * Cell click -> Right Panel opens with risk detail          |
|  * Drag risk between cells to re-assess (manage_decisions)   |
+--------------------------------------------------------------+
```

### 3.6 Risk Matrix 점수 체계

```typescript
/** Risk Score = Impact x Probability (1~5 each, score 1~25) */
export interface RiskAssessment {
  impact: 1 | 2 | 3 | 4 | 5;
  probability: 1 | 2 | 3 | 4 | 5;
  // v2.1: score and severity are SERVER-DERIVED (READ-ONLY)
  // DB stores impact + probability only; score = impact * probability (CHECK constraint)
  // severity = f(score) via RISK_SEVERITY_THRESHOLDS
  score: number;              // impact * probability (1~25) -- server-computed
  severity: RiskSeverity;     // derived from score -- server-computed
  assessedAt: string;         // ISO datetime
  assessedBy: string;         // user ID
}

export type RiskSeverity = "low" | "medium" | "high" | "critical";

/** Score -> Severity mapping */
const RISK_SEVERITY_THRESHOLDS: { min: number; max: number; severity: RiskSeverity }[] = [
  { min: 1,  max: 3,  severity: "low" },
  { min: 4,  max: 9,  severity: "medium" },
  { min: 10, max: 16, severity: "high" },
  { min: 17, max: 25, severity: "critical" },
];

function deriveRiskSeverity(score: number): RiskSeverity {
  const match = RISK_SEVERITY_THRESHOLDS.find(t => score >= t.min && score <= t.max);
  return match?.severity ?? "low";
}
```

**Impact 기준 (1~5)**:

| 등급 | 의미 | 예시 |
|------|------|------|
| 1 | Negligible | 경미한 일정 조정 (1~2일) |
| 2 | Minor | 소규모 일정 지연 (1주 이내) |
| 3 | Moderate | 중규모 일정/비용 영향 (2~3주) |
| 4 | Major | 주요 마일스톤 지연 또는 예산 초과 |
| 5 | Catastrophic | 프로젝트 실패 또는 중단 가능성 |

**Probability 기준 (1~5)**:

| 등급 | 의미 | 확률 범위 |
|------|------|---------|
| 1 | Rare | < 10% |
| 2 | Unlikely | 10~30% |
| 3 | Possible | 30~50% |
| 4 | Likely | 50~70% |
| 5 | Almost Certain | > 70% |

---

## 4. Preset별 차이

### 4.1 PM_WORK (PM)

> **목표**: "결정을 등록/처리하고, 리스크를 평가/관리하고, 에스컬레이션한다"

| 항목 | 설정 |
|------|------|
| 기본 뷰 | 통합 목록 (All) |
| KPI 강조 | pending_decisions, critical_risks, avg_decision_time, escalation_count |
| Right Panel | `open` -- decision/risk 상세 |
| 가용 액션 | Full CRUD + Risk Assessment + Decision Recording + Escalation |
| 숨김 컬럼 | 없음 (all visible) |
| 밀도 | detailed |

### 4.2 PMO_CONTROL (PMO)

> **목표**: "교차 프로젝트 리스크를 통제하고, 결정 감사 이력을 확인한다"

| 항목 | 설정 |
|------|------|
| 기본 뷰 | 통합 목록 (All) -- 교차 프로젝트 필터 가능 |
| KPI 강조 | total_decisions, total_risks, critical_risks, escalation_count |
| Right Panel | `open` -- audit trail 포함 |
| 가용 액션 | 조회 + Export + Audit Trail + Cross-project risk overview |
| 밀도 | standard |

### 4.3 DEV_EXECUTION (DEV / DevReader)

> **목표**: "내 관련 리스크를 확인하고, 결정을 제안한다"

| 항목 | 설정 |
|------|------|
| 기본 뷰 | 통합 목록 -- assignee/part 기본 필터 |
| KPI 강조 | total_risks, critical_risks |
| Right Panel | `closed` |
| 가용 액션 | 조회 + 결정 제안 (PROPOSED만 생성 가능) |
| 숨김 컬럼 | ownerId, escalatedFrom |
| 밀도 | standard |

### 4.4 EXEC_SUMMARY (Sponsor)

> **목표**: "결정 요약을 보고, 승인이 필요한 건을 처리한다"

| 항목 | 설정 |
|------|------|
| 기본 뷰 | 통합 목록 (compact) |
| KPI 강조 | total_decisions, pending_decisions, critical_risks |
| Right Panel | `closed` |
| 가용 액션 | 결정 승인 + 최상위 리스크 조회 |
| 숨김 컬럼 | ownerId, partId, escalatedFrom |
| 밀도 | compact |

### 4.5 CUSTOMER_APPROVAL (Customer PM)

> **목표**: "결정 승인/반려하고, 에스컬레이션을 요청한다"

| 항목 | 설정 |
|------|------|
| 기본 뷰 | 결정 중심 (type=decision 기본 필터) |
| KPI 강조 | pending_decisions, total_decisions |
| Right Panel | `open` -- 승인/반려 UI |
| 가용 액션 | 결정 승인/반려 + 에스컬레이션 요청 |
| 밀도 | compact |

---

## 5. 결정/리스크 생명주기 상세

### 5.1 Decision 상태 전이도

```
                        +---> APPROVED
                        |
  PROPOSED ---> UNDER_REVIEW ---+---> REJECTED
                        |
                        +---> DEFERRED ---> UNDER_REVIEW (reopen)

  States:
  - PROPOSED:      Decision registered, awaiting review
  - UNDER_REVIEW:  Under discussion / analysis
  - APPROVED:      Decision accepted and enforced
  - REJECTED:      Decision rejected with rationale
  - DEFERRED:      Decision postponed to later phase/sprint
```

**전이 규칙 (서버 트랜잭션 강제)**:

```typescript
/** Decision state transition rules */
const DECISION_TRANSITIONS: Record<DecisionStatus, DecisionStatus[]> = {
  PROPOSED:      ["UNDER_REVIEW"],
  UNDER_REVIEW:  ["APPROVED", "REJECTED", "DEFERRED"],
  APPROVED:      [],                          // terminal
  REJECTED:      [],                          // terminal
  DEFERRED:      ["UNDER_REVIEW"],            // reopen
};

/** Transition capability requirements */
const DECISION_TRANSITION_CAPS: Record<string, Capability[]> = {
  "PROPOSED->UNDER_REVIEW":      ["manage_decisions"],
  "UNDER_REVIEW->APPROVED":      ["manage_decisions"],
  "UNDER_REVIEW->REJECTED":      ["manage_decisions"],
  "UNDER_REVIEW->DEFERRED":      ["manage_decisions"],
  "DEFERRED->UNDER_REVIEW":      ["manage_decisions"],
};

/** v2.1: APPROVED transition minimum requirements (server-enforced) */
const APPROVED_TRANSITION_PRECONDITIONS = {
  minOptions: 2,            // Decision must have >= 2 options defined
  selectedOptionRequired: true,
  rationaleRequired: true,
  // Server returns 422 UNPROCESSABLE_ENTITY if not met:
  // { code: "APPROVAL_PRECONDITION_FAILED", missing: ["selectedOption", "rationale"] }
};
```

> **v2.1: Server-driven transitions** — 프론트에서 `DECISION_TRANSITIONS`를 이중 정의하지 않는다.
> 대신 상세 API 응답의 `allowedTransitions` 필드를 참조하여 버튼/드래그/다이얼로그를 구성한다.
> 이렇게 하면 프리셋/역할/프로젝트 정책이 바뀌어도 프론트 수정이 최소화된다.
> 위 `DECISION_TRANSITIONS` 정의는 **서버 구현의 레퍼런스**로만 사용한다.

### 5.2 Risk 상태 전이도

```
  IDENTIFIED ---> ASSESSED ---> MITIGATING ---> RESOLVED
                     |                              ^
                     |                              |
                     +---------> ACCEPTED ----------+
                                (risk accepted, no mitigation)

  States:
  - IDENTIFIED:  Risk discovered, not yet assessed
  - ASSESSED:    Impact x Probability evaluated, severity assigned
  - MITIGATING:  Mitigation plan in progress
  - RESOLVED:    Risk eliminated or reduced to acceptable level
  - ACCEPTED:    Risk acknowledged, no further mitigation planned
```

**전이 규칙 (서버 트랜잭션 강제)**:

```typescript
/** Risk state transition rules */
const RISK_TRANSITIONS: Record<RiskStatus, RiskStatus[]> = {
  IDENTIFIED:   ["ASSESSED"],
  ASSESSED:     ["MITIGATING", "ACCEPTED"],
  MITIGATING:   ["RESOLVED", "ACCEPTED"],
  RESOLVED:     [],                          // terminal
  ACCEPTED:     ["RESOLVED"],                // can still resolve later
};

/** Transition capability requirements */
const RISK_TRANSITION_CAPS: Record<string, Capability[]> = {
  "IDENTIFIED->ASSESSED":        ["manage_decisions"],
  "ASSESSED->MITIGATING":        ["manage_decisions"],
  "ASSESSED->ACCEPTED":          ["manage_decisions"],
  "MITIGATING->RESOLVED":        ["manage_decisions"],
  "MITIGATING->ACCEPTED":        ["manage_decisions"],
  "ACCEPTED->RESOLVED":          ["manage_decisions"],
};
```

> **v2.1**: Risk 전이도 동일하게 서버 `allowedTransitions` 기반으로 프론트가 동작한다.

### 5.2.1 SLA 기준 상태별 분리 (v2.1)

D+N 경고 로직의 기준 시점을 상태별로 정의한다.

| 상태 | SLA 기준 시점 | SLA 기본값 | 경고 색상 |
|------|-------------|----------|---------|
| Decision PROPOSED | `proposedDate` | D+5 | amber-500 |
| Decision UNDER_REVIEW | `reviewStartDate` (없으면 `proposedDate` fallback) | D+7 | red-500 |
| Decision DEFERRED | `deferredUntil` (재심의 기한) | 기한 초과 시 | red-500 |
| Risk IDENTIFIED | `identifiedDate` | D+3 (미평가 경고) | amber-500 |
| Risk MITIGATING | `assessment.assessedAt` | D+14 (완화 지연) | orange-500 |

> SLA 임계값은 프로젝트 설정으로 오버라이드 가능 (서버 `/api/projects/{id}/settings`).

### 5.3 에스컬레이션 체인 (Escalation Chain)

```
  Issue (이슈 관리)
    |
    | escalate (PM/DevReader)
    v
  Risk (결정/리스크 보드)
    |
    | escalate (PM)
    v
  Decision (결정/리스크 보드)

  +---------+         +---------+         +-----------+
  | ISS-042 | ------> | RSK-01  | ------> | DEC-04    |
  | Blocker |  esc.   | Infra   |  esc.   | Scope     |
  | Issue   |         | Delay   |         | Adjustment|
  +---------+         +---------+         +-----------+
```

**에스컬레이션 규칙**:

```typescript
interface EscalationChain {
  /** Source entity */
  source: {
    type: "issue" | "risk";
    id: string;
    title: string;
    status: string;
  };
  /** Target entity */
  target: {
    type: "risk" | "decision";
    id: string;
    title: string;
    status: string;
  };
  /** Escalation metadata */
  escalatedBy: string;         // user ID
  escalatedAt: string;         // ISO datetime
  reason: string;              // escalation rationale
  autoNotify: boolean;         // whether auto-notification was sent
}

/** Escalation auto-notification rules */
const ESCALATION_NOTIFY_POLICY = {
  "issue->risk": {
    notifyRoles: ["PM", "PMO_HEAD"],
    channel: "in-app",
    urgency: "normal",
  },
  "risk->decision": {
    notifyRoles: ["PM", "PMO_HEAD", "SPONSOR"],
    channel: "in-app+email",
    urgency: "high",
  },
  "critical_risk_created": {
    notifyRoles: ["PM", "PMO_HEAD", "SPONSOR"],
    channel: "in-app+email",
    urgency: "urgent",
  },
};

/** v2.1: Notification debounce / digest policy */
const NOTIFICATION_DEBOUNCE_POLICY = {
  // Same entityId + same urgency -> suppress within window
  dedupeWindow: "24h",
  // Digest: aggregate non-urgent into daily summary
  digestSchedule: "daily_09:00_KST",
  // Only "urgent" bypasses digest (immediate delivery)
  immediateOnly: ["urgent"],
  // Per-user opt-out: users can mute specific entities
  userMuteSupported: true,
};
```

### 5.3.1 에스컬레이션 생성 vs 연결 분리 (v2.1)

v2.0에서는 에스컬레이션이 항상 **신규 엔티티를 생성**했다.
v2.1에서는 **기존 엔티티에 연결만** 하는 모드를 추가한다.

```typescript
/** v2.1: Escalation mode */
export type EscalationMode =
  | "create"    // create new target entity + link (v2.0 default)
  | "link";     // link to existing target entity only

interface EscalateRequestV2 {
  sourceType: "issue" | "risk";
  sourceId: string;
  targetType: "risk" | "decision";
  reason: string;
  // v2.1: escalation mode
  mode: EscalationMode;
  /** Required when mode="link" -- existing target entity ID */
  targetExistingId?: string;
}
```

> **운영 필요성**: 동일한 Issue에서 이미 만들어진 Risk로 "연결만" 하거나,
> Risk를 기존 Decision에 연결하는 경우가 빈번하다.
> `mode="link"`이면 서버는 신규 생성 없이 관계만 등록 + Audit Trail 기록.
> 이를 통해 에스컬레이션 남발로 인한 Decision/Risk 중복 생성을 방지한다.

### 5.4 Audit Trail (감사 이력)

모든 상태 변경은 Audit Trail에 기록된다.

```typescript
interface DecisionRiskAuditEntry {
  id: string;
  entityType: "decision" | "risk";
  entityId: string;
  action: AuditAction;
  previousState?: Record<string, unknown>;
  newState?: Record<string, unknown>;
  actor: {
    userId: string;
    displayName: string;
    role: string;
  };
  timestamp: string;           // ISO datetime
  comment?: string;            // optional rationale
}

type AuditAction =
  | "CREATED"
  | "STATUS_CHANGED"
  | "ASSESSMENT_UPDATED"
  | "OWNER_CHANGED"
  | "ESCALATED"
  | "APPROVED"
  | "REJECTED"
  | "DEFERRED"
  | "COMMENT_ADDED"
  | "ATTACHMENT_ADDED"
  | "DELETED";
```

---

## 6. 데이터 구조 / API

### 6.1 Decision Entity

```typescript
interface Decision {
  id: string;                     // e.g., "DEC-004"
  projectId: string;
  title: string;
  description: string;
  status: DecisionStatus;
  category: DecisionCategory;

  // Context
  background: string;             // decision context / background
  options: DecisionOption[];       // considered alternatives
  selectedOption?: string;        // chosen option ID
  rationale?: string;             // why this option was chosen

  // Participants
  ownerId: string;                // decision owner (usually PM)
  requestedBy: string;            // who requested this decision
  approvers: string[];            // user IDs of required approvers

  // Scope
  phaseId?: string;
  partId?: string;

  // Impact
  impactedAreas: string[];        // affected components/modules
  relatedIssueIds: string[];      // linked issues
  relatedRiskIds: string[];       // linked risks
  relatedTaskIds: string[];       // affected tasks

  // Escalation
  escalatedFromId?: string;       // source risk/issue ID
  escalatedFromType?: "risk" | "issue";

  // Timeline
  proposedDate: string;           // ISO datetime
  reviewStartDate?: string;
  decidedDate?: string;
  deferredUntil?: string;         // if DEFERRED, when to revisit

  // Server-driven transition hints (v2.1)
  allowedTransitions: DecisionStatus[];
  requiredCapsForTransition: Record<string, Capability[]>;

  // Metadata
  attachments: Attachment[];
  // v2.1: auditTrail is DETAIL-ONLY -- not included in list responses.
  // Use GET /api/decisions/{id}/audit-trail for paginated access.
  auditTrail: DecisionRiskAuditEntry[];

  createdAt: string;
  updatedAt: string;
}

type DecisionCategory =
  | "architecture"
  | "scope"
  | "resource"
  | "schedule"
  | "budget"
  | "technology"
  | "process"
  | "vendor"
  | "other";

interface DecisionOption {
  id: string;
  label: string;
  description: string;
  pros: string[];
  cons: string[];
  estimatedImpact?: string;
}

interface Attachment {
  id: string;
  name: string;
  url: string;
  mimeType: string;
  uploadedBy: string;
  uploadedAt: string;
}
```

### 6.2 Risk Entity

```typescript
interface Risk {
  id: string;                     // e.g., "RSK-001"
  projectId: string;
  title: string;
  description: string;
  status: RiskStatus;
  category: RiskCategory;

  // Assessment
  assessment: RiskAssessment;
  assessmentHistory: RiskAssessment[];  // previous assessments

  // Mitigation
  mitigationPlan?: string;
  mitigationActions: MitigationAction[];
  contingencyPlan?: string;       // fallback if mitigation fails

  // Context
  ownerId: string;
  identifiedBy: string;

  // Scope
  phaseId?: string;
  partId?: string;

  // Relations
  relatedIssueIds: string[];
  relatedDecisionIds: string[];
  relatedTaskIds: string[];

  // Escalation
  escalatedFromId?: string;       // source issue ID
  escalatedToId?: string;         // target decision ID (if escalated up)

  // Timeline
  identifiedDate: string;
  targetResolutionDate?: string;
  resolvedDate?: string;

  // Server-driven transition hints (v2.1)
  allowedTransitions: RiskStatus[];
  requiredCapsForTransition: Record<string, Capability[]>;

  // Metadata
  attachments: Attachment[];
  // v2.1: auditTrail is DETAIL-ONLY -- not included in list responses.
  // Use GET /api/risks/{id}/audit-trail for paginated access.
  auditTrail: DecisionRiskAuditEntry[];

  createdAt: string;
  updatedAt: string;
}

type RiskCategory =
  | "technical"
  | "schedule"
  | "resource"
  | "external"
  | "business"
  | "compliance"
  | "security"
  | "performance"
  | "other";

interface MitigationAction {
  id: string;
  description: string;
  assigneeId: string;
  dueDate: string;
  status: "pending" | "in_progress" | "completed";
  completedAt?: string;
}
```

### 6.2.1 Summary DTOs (v2.1)

리스트 응답은 경량 Summary DTO를 사용한다.
풀 엔티티(auditTrail, assessmentHistory, options 등)는 상세 API에서만 반환한다.

```typescript
/** Board-level item -- used in integrated table, kanban, matrix list */
interface BoardItem {
  id: string;                     // "DEC-004" or "RSK-001"
  kind: "decision" | "risk";
  projectId: string;
  title: string;
  status: DecisionStatus | RiskStatus;
  // Risk-specific (null for decisions)
  severity?: RiskSeverity;
  score?: number;
  // Common
  ownerId: string;
  phaseId?: string;
  partId?: string;
  category: string;               // DecisionCategory | RiskCategory
  // Escalation
  hasEscalation: boolean;
  escalatedFromId?: string;
  escalatedFromType?: "issue" | "risk";
  // Unified sort key (v2.1)
  sortKeyDate: string;            // Decision: proposedDate, Risk: assessedAt ?? identifiedDate
  // Timestamps
  createdAt: string;
  updatedAt: string;
}

/** Decision summary for list view */
interface DecisionSummary extends BoardItem {
  kind: "decision";
  status: DecisionStatus;
  proposedDate: string;
  decidedDate?: string;
  deferredUntil?: string;
  approverCount: number;          // approvers.length
  optionCount: number;            // options.length
  daysSinceProposal: number;      // D+N (server-computed)
}

/** Risk summary for list view */
interface RiskSummary extends BoardItem {
  kind: "risk";
  status: RiskStatus;
  severity: RiskSeverity;
  score: number;
  identifiedDate: string;
  targetResolutionDate?: string;
  mitigationActionCount: number;  // mitigationActions.length
  completedActionCount: number;   // completed actions count
}
```

> **통합 테이블/칸반/매트릭스는 모두 `BoardItem` 소스를 재사용한다.**
> 타입 분기는 `kind` discriminant로 수행하며, 프론트 타입 지옥을 방지한다.

### 6.3 API Endpoints

#### 6.3.1 Decision/Risk List API

```
GET /api/decisions?projectId={projectId}&type={type}
    &decisionStatus={decisionStatus}&riskStatus={riskStatus}&severity={severity}
    &ownerId={ownerId}&partId={partId}&phaseId={phaseId}
    &dateFrom={dateFrom}&dateTo={dateTo}
    &hasEscalation={hasEscalation}&escalatedFromId={escalatedFromId}
    &q={q}&page={page}&size={size}&sort={sort}
```

> v2.1: `status` -> `decisionStatus`/`riskStatus` 분리, `escalatedFrom` -> `hasEscalation`/`escalatedFromId` 분리,
> `sort` 기본값은 `sortKeyDate` desc.

```typescript
/** v2.1: List response uses BoardItem (Summary DTO) */
interface DecisionRiskListResponse {
  items: BoardItem[];             // v2.1: lightweight DTO, not full entity
  pagination: {
    page: number;
    size: number;
    totalItems: number;
    totalPages: number;
  };
  metrics: DecisionRiskMetrics;
  // v2.1: Reliability 3-tuple (standardized)
  asOf: string;
  completeness: {
    overall: number;
    breakdown?: Record<string, number>;
  };
  warnings: {
    code: string;
    message: string;
    severity: "info" | "warn" | "critical";
  }[];
  // v2.1: ScopeEcho
  scope: { projectId: string };
}

interface DecisionRiskMetrics {
  totalDecisions: number;
  pendingDecisions: number;
  approvedDecisions: number;
  rejectedDecisions: number;
  deferredDecisions: number;
  totalRisks: number;
  criticalRisks: number;
  highRisks: number;
  mediumRisks: number;
  lowRisks: number;
  avgDecisionTimeDays: number;
  escalationCount: number;
  riskScoreTrend: RiskScoreTrendPoint[];
}

interface RiskScoreTrendPoint {
  date: string;           // ISO date
  avgScore: number;       // average risk score on that date
  maxScore: number;       // max risk score on that date
  totalRisks: number;     // number of active risks
}
```

#### 6.3.2 Decision Detail API

```
GET /api/decisions/{decisionId}
```

Response: `Decision` entity (section 6.1) with:

```typescript
// v2.1: server-driven transition hints included in detail response
{
  ...Decision,
  allowedTransitions: DecisionStatus[],
  requiredCapsForTransition: Record<string, Capability[]>,
  // v2.1: ScopeEcho
  scope: { projectId: string },
}
```

> 프론트는 `allowedTransitions`만 보고 액션 버튼을 렌더링한다.
> `DECISION_TRANSITIONS` 상수를 프론트에서 이중 정의하지 않는다.

#### 6.3.3 Risk Detail API

```
GET /api/risks/{riskId}
```

Response: `Risk` entity (section 6.2) with:

```typescript
{
  ...Risk,
  allowedTransitions: RiskStatus[],
  requiredCapsForTransition: Record<string, Capability[]>,
  scope: { projectId: string },
}
```

#### 6.3.4 Decision Create/Update API

```
POST /api/decisions
PUT  /api/decisions/{decisionId}
```

```typescript
interface CreateDecisionRequest {
  projectId: string;
  title: string;
  description: string;
  category: DecisionCategory;
  background: string;
  options?: DecisionOption[];
  ownerId: string;
  requestedBy: string;
  approvers?: string[];
  phaseId?: string;
  partId?: string;
  relatedIssueIds?: string[];
  relatedRiskIds?: string[];
  escalatedFromId?: string;
  escalatedFromType?: "risk" | "issue";
}

interface UpdateDecisionRequest {
  title?: string;
  description?: string;
  category?: DecisionCategory;
  background?: string;
  options?: DecisionOption[];
  selectedOption?: string;
  rationale?: string;
  approvers?: string[];
  deferredUntil?: string;
  comment?: string;              // audit trail comment
}
```

#### 6.3.5 Risk Create/Update API

```
POST /api/risks
PUT  /api/risks/{riskId}
```

```typescript
interface CreateRiskRequest {
  projectId: string;
  title: string;
  description: string;
  category: RiskCategory;
  ownerId: string;
  identifiedBy: string;
  assessment?: {
    impact: 1 | 2 | 3 | 4 | 5;
    probability: 1 | 2 | 3 | 4 | 5;
  };
  mitigationPlan?: string;
  contingencyPlan?: string;
  phaseId?: string;
  partId?: string;
  relatedIssueIds?: string[];
  escalatedFromId?: string;
  targetResolutionDate?: string;
}

interface UpdateRiskRequest {
  title?: string;
  description?: string;
  category?: RiskCategory;
  assessment?: {
    impact: 1 | 2 | 3 | 4 | 5;
    probability: 1 | 2 | 3 | 4 | 5;
  };
  mitigationPlan?: string;
  contingencyPlan?: string;
  mitigationActions?: MitigationAction[];
  targetResolutionDate?: string;
  comment?: string;              // audit trail comment
}
```

#### 6.3.6 Status Transition API

```
POST /api/decisions/{decisionId}/transition
POST /api/risks/{riskId}/transition

Headers (v2.1):
  Idempotency-Key: {uuid}          -- duplicate request safety
  If-Match: {etag}                 -- optimistic concurrency (412 if mismatch)
```

```typescript
interface StatusTransitionRequest {
  targetStatus: DecisionStatus | RiskStatus;
  comment?: string;              // rationale for transition
  selectedOption?: string;       // for APPROVED decision (v2.1: REQUIRED)
  rationale?: string;            // for APPROVED/REJECTED decision (v2.1: REQUIRED for APPROVED)
  deferredUntil?: string;        // for DEFERRED decision
}

/** v2.1: enriched response */
interface StatusTransitionResponse {
  success: boolean;
  entityId: string;
  entityType: "decision" | "risk";
  previousStatus: string;
  newStatus: string;
  actorId: string;
  actorRole: string;
  occurredAt: string;
  comment?: string;
  // v2.1: server-driven next transitions
  allowedTransitions: string[];
  auditEntry: DecisionRiskAuditEntry;
  notifications?: {
    sentTo: string[];
    channel: string;
  };
  // v2.1: ScopeEcho
  scope: { projectId: string };
}

/** Error contract (v2.1: expanded) */
interface TransitionErrorResponse {
  code:
    | "INVALID_TRANSITION"
    | "INSUFFICIENT_CAPABILITY"
    | "CONFLICT"
    | "CONCURRENCY_TOKEN_MISMATCH"      // v2.1: 412 Precondition Failed
    | "IDEMPOTENCY_KEY_CONFLICT"        // v2.1: 409
    | "APPROVAL_PRECONDITION_FAILED";   // v2.1: 422 (missing options/rationale)
  message: string;
  currentStatus: string;
  requestedStatus: string;
  allowedTransitions: string[];
  missing?: string[];            // v2.1: for APPROVAL_PRECONDITION_FAILED
}
```

#### 6.3.7 Escalation API (v2.1: create-vs-link)

```
POST /api/escalations

Headers (v2.1):
  Idempotency-Key: {uuid}
```

```typescript
/** v2.1: supports both create and link modes */
interface EscalateRequest {
  sourceType: "issue" | "risk";
  sourceId: string;
  targetType: "risk" | "decision";
  reason: string;
  // v2.1: escalation mode
  mode: "create" | "link";       // default: "create"
  /** Required when mode="link" */
  targetExistingId?: string;
}

interface EscalateResponse {
  success: boolean;
  escalation: EscalationChain;
  // v2.1: null when mode="link" (no entity created)
  createdEntity: Risk | Decision | null;
  linkedEntityId?: string;       // v2.1: existing entity ID when mode="link"
  notifications: {
    sentTo: string[];
    channel: string;
    urgency: string;
  };
  // v2.1: ScopeEcho
  scope: { projectId: string };
}

/** v2.1: Escalation error codes */
interface EscalationErrorResponse {
  code:
    | "CIRCULAR_ESCALATION"        // DAG violation
    | "TARGET_NOT_FOUND"           // mode="link" but targetExistingId doesn't exist
    | "DUPLICATE_ESCALATION"       // same source-target pair already linked
    | "INVALID_ESCALATION_TYPE";   // e.g., decision cannot escalate further
  message: string;
}
```

#### 6.3.8 Risk Matrix API

```
GET /api/risks/matrix?projectId={projectId}&phaseId={phaseId}
```

```typescript
interface RiskMatrixResponse {
  cells: RiskMatrixCell[];
  summary: {
    totalRisks: number;
    criticalCount: number;
    highCount: number;
    mediumCount: number;
    lowCount: number;
    avgScore: number;
  };
  // v2.1: reliability 3-tuple
  asOf: string;
  completeness: {
    overall: number;
    breakdown?: Record<string, number>;
  };
  warnings: {
    code: string;
    message: string;
    severity: "info" | "warn" | "critical";
  }[];
  // v2.1: ScopeEcho
  scope: { projectId: string };
}

interface RiskMatrixCell {
  impact: 1 | 2 | 3 | 4 | 5;
  probability: 1 | 2 | 3 | 4 | 5;
  score: number;
  severity: RiskSeverity;
  risks: {
    id: string;
    title: string;
    status: RiskStatus;
  }[];
}
```

#### 6.3.9 Audit Trail API (v2.1: paginated)

```
GET /api/decisions/{entityId}/audit-trail?page={page}&size={size}&action={action}
GET /api/risks/{entityId}/audit-trail?page={page}&size={size}&action={action}
```

> v2.1: Audit Trail is always paginated (전수 기록이므로 데이터 폭증 대비 필수).
> `action` 파라미터로 필터링 가능 (e.g., `?action=APPROVED&action=REJECTED`).

```typescript
interface AuditTrailResponse {
  entries: DecisionRiskAuditEntry[];
  pagination: {
    page: number;
    size: number;
    totalItems: number;
    totalPages: number;
  };
  // v2.1: ScopeEcho
  scope: { projectId: string };
}
```

#### 6.3.10 Decision/Risk Metrics API

```
GET /api/decisions/metrics?projectId={projectId}
```

Response: `DecisionRiskMetrics` (section 6.3.1)

> **v2.1: Metric 정의 확정**
>
> | 지표 | 정의 | 기준 |
> |------|------|------|
> | `avgDecisionTimeDays` | PROPOSED→DECIDED 평균 소요일 | APPROVED/REJECTED/DEFERRED 된 건만 |
> | `riskScoreTrend` | 일별 활성 리스크 평균/최대 점수 | status != RESOLVED (Active Risks only) + latest assessment 기준 |
> | `criticalRisks` | severity=critical 활성 리스크 수 | status != RESOLVED |
> | `escalationCount` | 에스컬레이션 관계 수 | 현재 프로젝트 내 모든 active chain |
> | `pendingDecisions` | PROPOSED + UNDER_REVIEW 건수 | - |

---

## 7. 컴포넌트 분해

### 7.1 폴더 구조

```
features/
  decisions/
    pages/
      DecisionsPage.tsx              <- Main page with tab routing
    layout/
      DecisionRiskShell.tsx          <- Shell: KPI + Tabs + Main + RightPanel
      KpiSlot.tsx                    <- KPI Row slot renderer
      MainSlot.tsx                   <- Main area slot renderer (tab-based)
      RightPanelSlot.tsx             <- Right Panel slot renderer
    components/
      // KPI Cards
      KpiCardRow.tsx                 <- KPI row
      PendingDecisionsCard.tsx       <- pending_decisions KPI
      TotalRisksCard.tsx             <- total_risks KPI
      CriticalRisksCard.tsx          <- critical_risks KPI
      AvgDecisionTimeCard.tsx        <- avg_decision_time KPI
      EscalationCountCard.tsx        <- escalation_count KPI
      RiskScoreTrendCard.tsx         <- risk_score_trend mini-chart

      // Views
      IntegratedTable.tsx            <- All List view (Decision + Risk table)
      DecisionKanbanBoard.tsx        <- Decision Kanban view
      RiskMatrixGrid.tsx             <- Risk Matrix 5x5 view

      // Decision Components
      DecisionCard.tsx               <- Kanban card for decision
      DecisionDetailPanel.tsx        <- Right Panel: decision detail
      DecisionApprovalPanel.tsx      <- Right Panel: approval/rejection form
      DecisionOptionsList.tsx        <- Options comparison in detail

      // Risk Components
      RiskDetailPanel.tsx            <- Right Panel: risk detail
      RiskAssessmentForm.tsx         <- Right Panel: Impact x Probability form
      RiskMatrixCell.tsx             <- Single cell in risk matrix
      RiskTrendChart.tsx             <- Risk score trend line chart
      MitigationActionList.tsx       <- Mitigation actions in risk detail

      // Escalation
      EscalationChainViz.tsx         <- Issue -> Risk -> Decision chain visual
      EscalationBadge.tsx            <- Badge showing escalation source/target

      // Audit
      AuditTrailTimeline.tsx         <- Chronological audit entries
      AuditEntryRow.tsx              <- Single audit entry

      // Common
      FilterBar.tsx                  <- FilterSpec-based filter bar
      StatusBadge.tsx                <- Decision/Risk status badge
      SeverityBadge.tsx              <- Risk severity badge (Low~Critical)
      TypeBadge.tsx                  <- Decision/Risk type badge
      EntityLink.tsx                 <- Deep link to related entity

    config/
      presetLayouts.ts               <- DecisionRiskPresetLayout definitions
      viewModeConfig.ts              <- View mode (all/kanban/matrix) config
      kanbanColumnConfig.ts          <- KanbanColumnKey + DECIDED_STATUSES mapping (v2.1)
      statusTransitions.ts           <- State machine definitions (reference only, v2.1)
      riskSeverityConfig.ts          <- Severity thresholds and colors
      slaConfig.ts                   <- SLA thresholds per status (v2.1)
    api/
      decisionsApi.ts                <- API call functions
    hooks/
      useDecisionRiskData.ts         <- TanStack Query wrapper for BoardItem[] list
      useDecisionDetail.ts           <- Decision detail query (includes allowedTransitions)
      useRiskDetail.ts               <- Risk detail query (includes allowedTransitions)
      useRiskMatrix.ts               <- Risk matrix query
      useStatusTransition.ts         <- Mutation for status changes (Idempotency-Key, If-Match)
      useEscalation.ts               <- Mutation for escalation (create + link modes)
      useAuditTrail.ts               <- Audit trail query (paginated)
      useDecisionRiskFilter.ts       <- FilterSpec state management (URL sync, v2.1)
      usePanelMode.ts                <- panelMode auto/manual state (v2.1)
      useUrlStateRestore.ts          <- URL selected/view restoration (v2.1)
```

### 7.2 Widget Registry

```typescript
// config/widgetRegistry.ts
import { lazy } from "react";

type DecisionRiskWidgetKey =
  // KPI Cards
  | "KPI_DECISIONS"
  | "KPI_PENDING"
  | "KPI_RISKS"
  | "KPI_CRITICAL"
  | "KPI_AVG_TIME"
  | "KPI_ESCALATIONS"
  | "KPI_TREND"
  // Views
  | "INTEGRATED_TABLE"
  | "DECISION_KANBAN"
  | "RISK_MATRIX"
  // Right Panel
  | "DECISION_DETAIL"
  | "RISK_DETAIL"
  | "RISK_ASSESSMENT"
  | "ESCALATION_CHAIN"
  | "AUDIT_TRAIL"
  | "APPROVAL_DETAIL"
  // PMO Specific
  | "CROSS_PROJECT_RISK_TABLE"
  | "DECISION_AUDIT_TRAIL"
  // DEV Specific
  | "MY_RELATED_RISKS"
  | "RISK_LIST"
  // Customer Specific
  | "DECISION_APPROVAL_LIST"
  | "DECISION_SUMMARY_TABLE";

const widgetRegistry: Record<DecisionRiskWidgetKey, React.LazyExoticComponent<any>> = {
  KPI_DECISIONS:            lazy(() => import("../components/KpiCardRow")),
  KPI_PENDING:              lazy(() => import("../components/PendingDecisionsCard")),
  KPI_RISKS:                lazy(() => import("../components/TotalRisksCard")),
  KPI_CRITICAL:             lazy(() => import("../components/CriticalRisksCard")),
  KPI_AVG_TIME:             lazy(() => import("../components/AvgDecisionTimeCard")),
  KPI_ESCALATIONS:          lazy(() => import("../components/EscalationCountCard")),
  KPI_TREND:                lazy(() => import("../components/RiskScoreTrendCard")),
  INTEGRATED_TABLE:         lazy(() => import("../components/IntegratedTable")),
  DECISION_KANBAN:          lazy(() => import("../components/DecisionKanbanBoard")),
  RISK_MATRIX:              lazy(() => import("../components/RiskMatrixGrid")),
  DECISION_DETAIL:          lazy(() => import("../components/DecisionDetailPanel")),
  RISK_DETAIL:              lazy(() => import("../components/RiskDetailPanel")),
  RISK_ASSESSMENT:          lazy(() => import("../components/RiskAssessmentForm")),
  ESCALATION_CHAIN:         lazy(() => import("../components/EscalationChainViz")),
  AUDIT_TRAIL:              lazy(() => import("../components/AuditTrailTimeline")),
  APPROVAL_DETAIL:          lazy(() => import("../components/DecisionApprovalPanel")),
  CROSS_PROJECT_RISK_TABLE: lazy(() => import("../components/IntegratedTable")),
  DECISION_AUDIT_TRAIL:     lazy(() => import("../components/AuditTrailTimeline")),
  MY_RELATED_RISKS:         lazy(() => import("../components/IntegratedTable")),
  RISK_LIST:                lazy(() => import("../components/IntegratedTable")),
  DECISION_APPROVAL_LIST:   lazy(() => import("../components/IntegratedTable")),
  DECISION_SUMMARY_TABLE:   lazy(() => import("../components/IntegratedTable")),
};
```

### 7.3 Preset Layout

```typescript
interface DecisionRiskPresetLayout {
  preset: ViewModePreset;
  slots: {
    kpiRow: DecisionRiskWidgetKey[];
    main: DecisionRiskWidgetKey[];
    rightPanel?: DecisionRiskWidgetKey[];
  };
  ui: {
    density: "compact" | "standard" | "detailed";
    defaultRightPanel: "open" | "closed";
    defaultView: DecisionRiskViewMode;
  };
}

const presetLayouts: Record<ViewModePreset, DecisionRiskPresetLayout> = {
  EXEC_SUMMARY: {
    preset: "EXEC_SUMMARY",
    slots: {
      kpiRow: ["KPI_DECISIONS", "KPI_PENDING", "KPI_CRITICAL"],
      main: ["DECISION_SUMMARY_TABLE"],
    },
    ui: { density: "compact", defaultRightPanel: "closed", defaultView: "all" },
  },
  PMO_CONTROL: {
    preset: "PMO_CONTROL",
    slots: {
      kpiRow: ["KPI_DECISIONS", "KPI_RISKS", "KPI_CRITICAL", "KPI_ESCALATIONS"],
      main: ["INTEGRATED_TABLE"],
      rightPanel: ["DECISION_AUDIT_TRAIL"],
    },
    ui: { density: "standard", defaultRightPanel: "open", defaultView: "all" },
  },
  PM_WORK: {
    preset: "PM_WORK",
    slots: {
      kpiRow: [
        "KPI_PENDING", "KPI_CRITICAL", "KPI_AVG_TIME",
        "KPI_ESCALATIONS", "KPI_TREND",
      ],
      main: ["INTEGRATED_TABLE"],
      rightPanel: ["DECISION_DETAIL"],
    },
    ui: { density: "detailed", defaultRightPanel: "open", defaultView: "all" },
  },
  DEV_EXECUTION: {
    preset: "DEV_EXECUTION",
    slots: {
      kpiRow: ["KPI_RISKS", "KPI_CRITICAL"],
      main: ["RISK_LIST"],
    },
    ui: { density: "standard", defaultRightPanel: "closed", defaultView: "all" },
  },
  CUSTOMER_APPROVAL: {
    preset: "CUSTOMER_APPROVAL",
    slots: {
      kpiRow: ["KPI_PENDING", "KPI_DECISIONS"],
      main: ["DECISION_APPROVAL_LIST"],
      rightPanel: ["APPROVAL_DETAIL"],
    },
    ui: { density: "compact", defaultRightPanel: "open", defaultView: "all" },
  },
};
```

### 7.4 Page Component

```typescript
function DecisionsPage() {
  const { viewMode, effectivePreset } = useAccessContext();
  const { isTemporarySwitch, readOnlyOverride } = usePresetSwitch();
  const [filter, setFilter] = useDecisionRiskFilter();
  const [selectedEntity, setSelectedEntity] = useState<string | null>(
    filter.selected ?? null,  // v2.1: URL state restore
  );
  const { panelMode, panelModeSource, setPanelMode } = usePanelMode();

  const layout = presetLayouts[effectivePreset];
  if (!layout) return <Navigate to="/unauthorized" />;

  // v2.1: View priority -- URL > user tab click > filter.type default
  // filter.view is the single source of truth (synced to URL)
  const activeView: DecisionRiskViewMode = filter.view ?? "all";
  const setActiveView = (v: DecisionRiskViewMode) =>
    setFilter(prev => ({ ...prev, view: v }));  // writes to URL

  // v2.1: one-time default from filter.type (only if view not explicitly set)
  useEffect(() => {
    if (filter.view) return;  // already explicit
    if (filter.type === "decision") setFilter(prev => ({ ...prev, view: "kanban" }));
    if (filter.type === "risk") setFilter(prev => ({ ...prev, view: "matrix" }));
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);  // run once on mount only

  return (
    <DecisionRiskShell
      layout={layout}
      readOnly={readOnlyOverride}
      isTemporarySwitch={isTemporarySwitch}
    >
      {/* KPI Row */}
      <KpiSlot widgets={layout.slots.kpiRow} />

      {/* Filter Bar */}
      <FilterBar
        filterSpec={filter}
        onChange={setFilter}
        preset={effectivePreset}
      />

      {/* View Tabs */}
      <ViewTabs
        active={activeView}
        onChange={setActiveView}
        tabs={[
          { key: "all", label: "All List" },
          { key: "kanban", label: "Decision Kanban" },
          { key: "matrix", label: "Risk Matrix" },
        ]}
      />

      {/* Main Content */}
      <MainSlot
        activeView={activeView}
        filter={filter}
        onSelect={setSelectedEntity}
        readOnly={readOnlyOverride}
      />

      {/* Right Panel (v2.1: auto/manual panelMode) */}
      {layout.slots.rightPanel && (
        <RightPanelSlot
          selectedEntity={selectedEntity}
          panelMode={panelMode}
          panelModeSource={panelModeSource}
          onPanelModeChange={setPanelMode}
          defaultOpen={layout.ui.defaultRightPanel === "open"}
          readOnly={readOnlyOverride}
        />
      )}
    </DecisionRiskShell>
  );
}
```

---

## 8. AI Navigation 연동

### 8.1 AI Insight Widget: Decision/Risk Context

```typescript
interface AiDecisionRiskInsight {
  asOf: string;
  summary: string;               // "3건의 Critical 리스크가 미완료 상태입니다"
  severity: "info" | "warning" | "critical";

  // --- Drivers (rationale) ---
  drivers: {
    type: "metric" | "entity" | "event";
    label: string;               // "Critical Risks"
    value?: string;              // "3건"
    link?: {
      targetNodeId: string;      // "decisions"
      label: string;             // "리스크 매트릭스에서 확인"
      deepLinkParams?: Record<string, string>;
    };
  }[];

  // --- Next Actions (navigation + action) ---
  nextActions: {
    label: string;               // "리스크 매트릭스에서 Critical 확인"
    targetNodeId: string;        // "decisions"
    deepLinkParams?: Record<string, string>;
    suggestedPreset?: ViewModePreset;
    requiredCaps?: Capability[];
    reason: string;              // "Critical 리스크 2건 미완화"
  }[];
}
```

**AI Navigation Contract Example**:

```json
{
  "answer": {
    "summary": "현재 3건의 Critical 리스크가 미완화 상태이며, 2건의 결정이 7일 이상 UNDER_REVIEW 상태입니다.",
    "highlights": [
      "RSK-01 인프라 지연 (Critical, MITIGATING)",
      "RSK-08 벤더 의존성 (Critical, ASSESSED)",
      "DEC-04 범위 조정 (UNDER_REVIEW, D+7)"
    ],
    "warnings": [
      "RSK-01 목표 해소일까지 3일 남음"
    ]
  },
  "navigation": {
    "primary": {
      "targetNodeId": "decisions",
      "filter": { "type": "risk", "severity": "critical", "view": "matrix" }
    },
    "secondary": [
      {
        "targetNodeId": "decisions",
        "filter": { "type": "decision", "decisionStatus": "UNDER_REVIEW", "view": "kanban" }
      },
      {
        "targetNodeId": "issues",
        "filter": { "status": "OPEN", "priority": "blocker" }
      }
    ]
  },
  "viewMode": {
    "suggested": "PM_WORK",
    "confidence": 0.85,
    "why": [
      "Critical risk resolution requires PM intervention",
      "Decision pending for 7+ days needs follow-up"
    ]
  },
  "requiredCaps": ["view_decisions", "manage_decisions"],
  "scopeHints": {
    "projectId": "PRJ-001"
  }
}
```

### 8.2 AI Navigation Rules

1. **Risk-related questions**: Always route to `decisions` with `filter: { type: "risk" }`
2. **Decision-related questions**: Route to `decisions` with `filter: { type: "decision" }`
3. **Escalation questions**: Route to `decisions` with `filter: { hasEscalation: true }` (v2.1: no wildcard)
4. **"Critical risks"**: Directly to `decisions.critical-risks` virtual node
5. **"Risk matrix"**: Directly to `decisions.risk-matrix` virtual node
6. **Hub penalty**: Dashboard should get -20 when "risk list" or "decision list" is asked
7. **Detail bonus**: `decisions` node gets +10 for action/filter risk/decision questions
8. **v2.1: Navigation uses `filter` (FilterSpec subset)** instead of `deepLinkParams` (raw key-value)
   — URL은 UI 레이어에서만 직렬화한다. AI는 FilterSpec 객체를 반환한다.

```typescript
/** AI routing decision tree for decision/risk queries (v2.1: filter-based) */
const DECISION_RISK_AI_ROUTING = {
  "ask_risk":              { targetNodeId: "decisions", filter: { type: "risk" } },
  "ask_risk_assessment":   { targetNodeId: "decisions.risk-matrix" },
  "ask_decision_pending":  { targetNodeId: "decisions.pending" },
  "ask_critical_risks":    { targetNodeId: "decisions.critical-risks" },
  "ask_escalation_chain":  { targetNodeId: "decisions.escalated" },
  "ask_decision_status":   { targetNodeId: "decisions.kanban" },
  "do_create_decision":    { targetNodeId: "decisions", filter: { type: "decision", view: "kanban" } },
  "do_create_risk":        { targetNodeId: "decisions", filter: { type: "risk", view: "matrix" } },
  "do_approve_decision":   { targetNodeId: "decisions", filter: { type: "decision", view: "kanban" } },
  "do_escalate_risk":      { targetNodeId: "decisions", filter: { hasEscalation: true } },
  "do_assess_risk":        { targetNodeId: "decisions.risk-matrix" },
};
```

### 8.3 AI Risk Assessment Assistant

AI can assist with risk assessment by analyzing project data and suggesting Impact/Probability scores.

```typescript
interface AiRiskAssessmentSuggestion {
  riskId: string;
  suggestedImpact: 1 | 2 | 3 | 4 | 5;
  suggestedProbability: 1 | 2 | 3 | 4 | 5;
  suggestedScore: number;
  reasoning: string;
  dataPoints: {
    factor: string;              // e.g., "Schedule dependency"
    evidence: string;            // e.g., "3 tasks on critical path"
    contribution: "impact" | "probability";
  }[];
  confidence: number;            // 0.0 ~ 1.0
}
```

> **Guardrail**: AI suggestion is always presented as a draft. PM must confirm or override.
> The form pre-fills AI suggestion but requires explicit user action to submit.

---

## 9. 인터랙션 상세

### 9.1 Decision Kanban Interactions

```
Decision Kanban Board interactions:

1. Card Click:
   -> Right Panel opens with decision detail
   -> panelMode: "decision-detail"

2. Card Drag (PM_WORK only, manage_decisions required):
   -> PROPOSED -> UNDER_REVIEW: auto transition on drag
   -> UNDER_REVIEW -> DECIDED: PROHIBITED via drag (v2.1)
      (Approve/Reject/Defer are high-impact — must use action buttons in Right Panel)
   -> DECIDED -> any: no drag (terminal states)
   -> Server-side status transition via Idempotency-Key + If-Match (v2.1)

3. "+" button (PROPOSED column):
   -> Drawer opens: CreateDecisionForm
   -> On save: card appears in PROPOSED column

4. D+N badge:
   -> Shows days since proposal
   -> Red if D+7 or more (SLA warning)

5. Escalation badge on card:
   -> Click: panelMode: "escalation-chain"
   -> Shows full Issue -> Risk -> Decision chain
```

### 9.2 Risk Matrix Interactions

```
Risk Matrix Grid interactions:

1. Cell Click (cell with risks):
   -> Right Panel opens with risk detail
   -> If multiple risks in cell: shows picker

2. Risk Dot Click:
   -> panelMode: "risk-detail"
   -> Shows risk detail with assessment history

3. Drag Risk between cells (PM_WORK, manage_decisions):
   -> Confirmation dialog: "Re-assess RSK-01 from 5x5=25 to 4x3=12?"
   -> Comment required
   -> Server-side assessment update
   -> Assessment history updated

4. Empty Cell Click:
   -> Nothing (no action)

5. Cell Hover:
   -> Tooltip: shows risk count and IDs
   -> Severity color coding

6. Matrix Filter:
   -> Phase filter: shows only risks for selected phase
   -> Status filter: shows only active risks (excludes RESOLVED)
```

### 9.3 Right Panel Interactions

```
Right Panel interactions by panelMode:

1. decision-detail:
   -> Title, status badge, owner, dates
   -> Background / context
   -> Options comparison (pros/cons table)
   -> Related issues/risks links
   -> Action buttons: [Start Review], [Approve], [Reject], [Defer]
      (visibility based on current status + capability)
   -> Audit trail timeline (collapsible)

2. risk-detail:
   -> Title, status badge, severity badge, owner
   -> Assessment: Impact x Probability = Score
   -> Mitigation plan text
   -> Mitigation actions checklist
   -> Contingency plan (collapsible)
   -> Related issues/decisions links
   -> Action buttons: [Assess], [Start Mitigation], [Resolve], [Accept]
   -> Assessment history chart
   -> Audit trail timeline (collapsible)

3. risk-assessment:
   -> Impact slider (1~5) with description
   -> Probability slider (1~5) with description
   -> Calculated score (auto)
   -> Derived severity (auto, color-coded)
   -> AI suggestion panel (if available)
   -> Comment field
   -> [Save Assessment] button

4. escalation-chain:
   -> Visual chain: Issue -> Risk -> Decision
   -> Each node is clickable (navigates to entity)
   -> Status of each entity in chain
   -> Timeline of escalation events

5. audit-trail:
   -> Chronological list of all changes
   -> Each entry: timestamp, actor, action, old->new state
   -> Filter by action type
   -> Exportable (PMO_CONTROL only)

6. approval:
   -> Decision summary (read-only)
   -> Options comparison
   -> [Approve] [Reject] buttons
   -> Comment field (required for reject)
   -> Confirmation dialog
```

### 9.4 Escalation Flow

```
Escalation from Issues page to Decision/Risk page:

1. User is on /issues, selects ISS-042
2. Clicks "Escalate to Risk" button
   -> Confirmation dialog: "ISS-042를 리스크로 에스컬레이션하시겠습니까?"
   -> Reason field (required)
3. On confirm:
   -> Mode selector: "Create new Risk" (default) or "Link to existing Risk" (v2.1)
   -> Create mode:
      POST /api/escalations { mode: "create", sourceType: "issue", sourceId: "ISS-042", targetType: "risk", reason: "..." }
      -> Server creates RSK-XX with escalatedFromId: "ISS-042"
   -> Link mode (v2.1):
      POST /api/escalations { mode: "link", sourceType: "issue", sourceId: "ISS-042", targetType: "risk", targetExistingId: "RSK-01", reason: "..." }
      -> Server links ISS-042 -> RSK-01 (no new entity created)
   -> Server sends notification to PM, PMO_HEAD
   -> Navigates to /decisions?selected={riskId} with the risk selected

4. Later, PM escalates RSK-XX to Decision:
   -> On risk detail panel, clicks "Escalate to Decision"
   -> Mode selector: "Create new Decision" or "Link to existing Decision" (v2.1)
   -> POST /api/escalations { mode: "create"|"link", sourceType: "risk", sourceId: "RSK-XX", targetType: "decision", reason: "...", targetExistingId?: "DEC-04" }
   -> Server sends notification to PM, PMO_HEAD, SPONSOR
   -> panelMode switches to "decision-detail"
```

### 9.5 Data Refresh Policy

| 항목 | 주기 |
|------|------|
| KPI Cards | 5-minute auto-refresh (TanStack Query `refetchInterval`) |
| Risk Matrix | Page entry + manual refresh |
| Decision Kanban | Page entry + optimistic update on drag |
| Audit Trail | On-demand (panel open) |
| AI Insight | Page entry, 10-minute cache |
| Full page | Manual refresh button (Page Header) |

### 9.5.1 Event-based Refetch (v2.1)

상태 전이/에스컬레이션 등 mutation 성공 후 관련 쿼리를 자동 무효화한다.

| Event | Invalidate Query Keys |
|-------|----------------------|
| `transition.success` | `["decisions", "list"]`, `["decisions", "metrics"]`, `["decisions", entityId]` |
| `escalation.success` | `["decisions", "list"]`, `["decisions", "metrics"]`, `["risks", "matrix"]` |
| `assessment.updated` | `["risks", riskId]`, `["risks", "matrix"]`, `["decisions", "metrics"]` |
| `decision.created` | `["decisions", "list"]`, `["decisions", "metrics"]` |
| `risk.created` | `["decisions", "list"]`, `["decisions", "metrics"]`, `["risks", "matrix"]` |
| `audit.created` | `["audit-trail", entityId]` |

### 9.6 KPI Card Click Interactions

```
KPI Card -> Navigation (v2.1: Preset-aware stacking):

1. Pending Decisions card click:
   -> setFilter({ type: "decision", decisionStatus: ["PROPOSED", "UNDER_REVIEW"], view: "kanban" })

2. Critical Risks card click:
   -> setFilter({ type: "risk", severity: "critical", view: "matrix" })

3. Total Risks card click:
   -> setFilter({ type: "risk", view: "all" })

4. Avg Decision Time card click:
   -> setFilter({ type: "decision", view: "all" })
   -> sort: "sortKeyDate" ascending (oldest first)

5. Escalation Count card click:
   -> setFilter({ hasEscalation: true, view: "all" })

6. Risk Score Trend card click:
   -> Opens trend detail in Drawer (420px)
   -> Full risk score trend chart
   -> Date range selector

v2.1 KPI Click Preset-aware Stacking Rules:
- EXEC_SUMMARY:      reset all existing filters (Sponsor sees global view)
- PMO_CONTROL:       keep phaseId + partId (PMO keeps scope context)
- PM_WORK:           keep phaseId + partId (PM keeps scope context)
- DEV_EXECUTION:     keep ownerId (DEV keeps "my items" context)
- CUSTOMER_APPROVAL: keep type=decision (Customer stays in decision scope)
```

---

## 10. 반응형 대응

### 10.1 브레이크포인트별 레이아웃

| 너비 | KPI Row | Main Content | Right Panel | Tab Bar |
|------|---------|-------------|-------------|---------|
| >=1440px | 4-5 cards horizontal | 70% | 30% (visible) | Full labels |
| 1280px | 4 cards horizontal | 100% | Drawer (toggle) | Full labels |
| <=1024px | 2x2 grid | 100% | Drawer (overlay) | Icon + text |
| <=768px | 1 column stack | 100% | Full Modal | Icons only |

### 10.2 View-Specific Responsive Rules

**Risk Matrix**:
- >=1440px: Full 5x5 grid with risk dots
- 1280px: Full 5x5 grid, compact risk labels
- <=1024px: 5x5 grid with count-only cells (no risk names)
- <=768px: Risk list view (flat list sorted by score, matrix hidden)

**Decision Kanban**:
- >=1440px: 3 main columns + subcolumns
- 1280px: 3 columns, scrollable
- <=1024px: 2 columns visible, horizontal scroll
- <=768px: Single column (stacked), swipe to change column

**Integrated Table**:
- >=1440px: All columns visible
- 1280px: Hide `partId`, `escalatedFrom` columns
- <=1024px: Hide `partId`, `ownerId`, `escalatedFrom`; compact rows
- <=768px: Card list view (table hidden)

### 10.3 Widget Collapse Rules

- <=1280px: KPI Trend card -> hide chart, show value only
- <=1024px: Audit Trail in Right Panel -> collapsible by default
- <=768px: AI Insight -> collapsible (expand button)
- <=768px: Filter bar -> collapsible ("Show filters" button)

---

## 11. 깨지기 쉬운 곳 체크리스트

### 11.1 상태 전이 동시성

> **문제**: 두 사용자가 동시에 같은 Decision에 APPROVED/REJECTED를 시도할 때
> **대응**: 서버에서 낙관적 잠금(optimistic lock) + 프론트에서 version 확인
> **발생 빈도**: 중간 (Sponsor + PM 동시 처리 시)

```typescript
interface TransitionRequestWithVersion {
  targetStatus: DecisionStatus;
  expectedVersion: number;        // optimistic lock
  comment?: string;
}

// Server returns 409 CONFLICT if version mismatch
// Frontend: show "This item was updated. Please refresh and try again."
```

### 11.2 에스컬레이션 순환 참조

> **문제**: Issue -> Risk -> Decision -> (다시 Issue로 되돌아오는 경우)
> **대응**: 서버에서 순환 참조 감지 (DAG 검증)
> **발생 빈도**: 낮음

```typescript
// Server validates escalation chain is a DAG (Directed Acyclic Graph)
// Returns 400 BAD_REQUEST with code: "CIRCULAR_ESCALATION" if cycle detected
```

### 11.3 Risk Matrix Drag UX

> **문제**: 리스크를 매트릭스 셀 간에 드래그할 때, 작은 셀에서 정확한 위치 지정이 어려움
> **대응**: 셀에 drop highlight + 확인 다이얼로그로 오조작 방지
> **발생 빈도**: 높음 (매트릭스 사용 시마다)

### 11.4 Decision Kanban Column Overflow

> **문제**: PROPOSED 컬럼에 카드가 너무 많이 쌓이면 스크롤이 길어짐
> **대응**: 7건 이상 시 "Show all" 접이식 + 컬럼 내 스크롤
> **발생 빈도**: 중간

### 11.5 FilterSpec Type/Status 교차 검증

> **문제**: `type=decision`인데 `riskStatus=ASSESSED`가 설정되면 결과가 0건
> **대응**: 프론트에서 type 변경 시 반대측 status 필터 자동 해제 + 서버는 무시(silent)
> **발생 빈도**: 중간 (필터 전환 시)

```typescript
// Filter auto-cleanup rule
function cleanFilter(filter: DecisionRiskFilterSpec): DecisionRiskFilterSpec {
  const cleaned = { ...filter };
  if (cleaned.type === "decision") {
    delete cleaned.riskStatus;
    delete cleaned.severity;
  }
  if (cleaned.type === "risk") {
    delete cleaned.decisionStatus;
  }
  return cleaned;
}
```

### 11.6 URL 상태 복원 깨짐 (v2.1)

> **문제**: 탭(view), 선택(selected), panelMode가 URL과 동기화되지 않으면 뒤로가기/새로고침에서 UX 깨짐
> **대응**: `view`와 `selected`를 FilterSpec 정식 키로 URL에 기록. panelMode는 selected 기반 auto 복원.
> **발생 빈도**: 높음 (사용자 브라우저 내비게이션 시)

### 11.7 통합 테이블 정렬 키 충돌 (v2.1)

> **문제**: Decision(proposedDate)과 Risk(assessedAt/identifiedDate)를 한 테이블에 섞으면 정렬이 부자연스러움
> **대응**: 서버가 `sortKeyDate`를 계산해 내려줌 (BoardItem.sortKeyDate). 기본 정렬은 sortKeyDate desc.
> **발생 빈도**: 높음 (통합 목록 뷰 사용 시마다)

### 11.8 Risk Score Trend 정의 모호성 (v2.1)

> **문제**: "그 날짜에 활성인 리스크의 평균 점수"인지 "평가 이벤트 기반 평균"인지 해석이 달라짐
> **대응**: 정의를 확정 — **Active Risks only (status != RESOLVED)** + **latest assessment snapshot 기준**.
> **발생 빈도**: 낮음 (초기 구현 시 1회 확정)

### 11.9 Audit Trail 데이터 폭증 (v2.1)

> **문제**: 전수 기록이면 Audit Trail이 급격히 커져 조회 성능 저하
> **대응**: Audit Trail API를 pagination 필수로 변경 (v2.1). `?page=&size=&action=` 지원.
> **발생 빈도**: 중간 (프로젝트 규모에 비례)

### 11.10 에스컬레이션 중복 생성 (v2.1)

> **문제**: `mode="create"`만 있으면 동일 Issue에서 같은 Risk를 또 생성할 수 있음
> **대응**: `mode="link"` 도입 (v2.1) + `DUPLICATE_ESCALATION` 에러 코드.
> 서버에서 같은 source-target 쌍이 이미 존재하면 409 반환.
> **발생 빈도**: 중간 (PM이 에스컬레이션 남발 시)

### 11.11 Decision APPROVED 전이 시 Options 미입력 (v2.1)

> **문제**: PM이 options 없이 바로 APPROVED로 전이하면 감사/리포트 품질 저하
> **대응**: 서버에서 APPROVED 전이 최소 요건 강제 (options>=2, selectedOption, rationale).
> 미충족 시 422 `APPROVAL_PRECONDITION_FAILED` 반환.
> **발생 빈도**: 중간 (PM이 귀찮아서 비워둘 때)

---

## 12. Capability 매핑

### 12.1 화면 수준 Capability

| Capability | 설명 | 필요 역할 |
|-----------|------|---------|
| `view_decisions` | 결정/리스크 화면 조회 | ALL (메뉴 노출 역할) |
| `manage_decisions` | 결정/리스크 등록/수정/전이/에스컬레이션 | PM, PMO_HEAD |

#### 12.1.1 Capability vs Policy 2-레이어 (v2.1)

Capability와 Policy는 서로 다른 레이어에서 동작한다.

| 레이어 | 설명 | 판정 주체 | 예시 |
|--------|------|---------|------|
| **Capability** | "접근 가능성" — 이 화면/기능을 볼 수 있는가 | JWT Role → Capability 매핑 | `manage_decisions` 보유 |
| **Policy** | "허용 행위" — 이 상태/프리셋에서 이 행동이 가능한가 | 서버 `allowedTransitions` + Preset policy | DEV는 manage_decisions 있어도 PROPOSED 생성만 허용 |

> **핵심**: Capability가 있어도 Policy에서 막힐 수 있다.
> 서버는 `allowedTransitions` 배열에 Policy 결과를 반영하여 내려준다.
> 프론트는 Capability로 메뉴/버튼 노출 여부를 판단하고,
> `allowedTransitions`로 실제 행동 가능 여부를 판단한다.

```typescript
// Example: DEV_EXECUTION preset
// Capability: manage_decisions = true (DEV has it)
// Policy: allowedTransitions for Decision = [] (no transitions allowed)
//         but CreateDecision -> allowed (PROPOSED only)
// Result: "Create Decision" button visible, transition buttons hidden
```

### 12.2 Preset별 가용 액션

| 액션 | PM_WORK | PMO_CONTROL | DEV_EXECUTION | EXEC_SUMMARY | CUSTOMER_APPROVAL |
|------|---------|-------------|---------------|-------------|-------------------|
| Decision 조회 | O | O | O | O | O |
| Risk 조회 | O | O | O | O | O |
| Decision 등록 (PROPOSED) | O | O | O (propose only) | - | O |
| Decision 상태 전이 | O | O | - | O (approve only) | O (approve/reject) |
| Risk 등록 | O | O | - | - | - |
| Risk 평가 | O | O | - | - | - |
| Risk 상태 전이 | O | O | - | - | - |
| 에스컬레이션 실행 | O | O | - | - | O (request) |
| Audit Trail 조회 | O | O | - | O | - |
| Export | O | O | - | - | - |
| Decision Kanban Drag | O | - | - | - | - |
| Risk Matrix Drag | O | - | - | - | - |

### 12.3 Action Guard Implementation

```typescript
function DecisionActionGuard({
  action,
  preset,
  children,
}: {
  action: string;
  preset: ViewModePreset;
  children: React.ReactNode;
}) {
  const { capabilities } = useAccessContext();
  const { readOnlyOverride } = usePresetSwitch();

  // Preset-specific action availability
  const actionMatrix: Record<string, Record<ViewModePreset, Capability[]>> = {
    "create_decision":    {
      PM_WORK: ["manage_decisions"],
      PMO_CONTROL: ["manage_decisions"],
      DEV_EXECUTION: ["manage_decisions"],
      EXEC_SUMMARY: [],
      CUSTOMER_APPROVAL: ["manage_decisions"],
      AUDIT_EVIDENCE: [],
    },
    "approve_decision":   {
      PM_WORK: ["manage_decisions"],
      PMO_CONTROL: ["manage_decisions"],
      DEV_EXECUTION: [],
      EXEC_SUMMARY: ["manage_decisions"],
      CUSTOMER_APPROVAL: ["manage_decisions"],
      AUDIT_EVIDENCE: [],
    },
    "assess_risk":        {
      PM_WORK: ["manage_decisions"],
      PMO_CONTROL: ["manage_decisions"],
      DEV_EXECUTION: [],
      EXEC_SUMMARY: [],
      CUSTOMER_APPROVAL: [],
      AUDIT_EVIDENCE: [],
    },
    // ... additional actions
  };

  const requiredCaps = actionMatrix[action]?.[preset] ?? [];
  if (requiredCaps.length === 0) return null;  // action not available for this preset
  if (readOnlyOverride) return null;           // read-only mode
  if (!requiredCaps.every(c => capabilities.includes(c))) return null;

  return <>{children}</>;
}
```

---

## 13. DoD (본 화면 완료 기준)

- [ ] 단일 `/decisions` 라우트에서 3가지 뷰 모드(All List / Decision Kanban / Risk Matrix) 렌더링
- [ ] **Decision Kanban**: PROPOSED -> UNDER_REVIEW -> DECIDED(APPROVED/REJECTED/DEFERRED) 칸반 보드
- [ ] **Risk Matrix**: 5x5 Impact x Probability 매트릭스 + 셀 내 리스크 배치 + 클릭 상세
- [ ] **통합 테이블**: Decision + Risk 혼합 테이블, 타입/상태/심각도 필터링
- [ ] Decision 상태 전이: PROPOSED -> UNDER_REVIEW -> APPROVED/REJECTED/DEFERRED (서버 트랜잭션)
- [ ] Risk 상태 전이: IDENTIFIED -> ASSESSED -> MITIGATING -> RESOLVED/ACCEPTED (서버 트랜잭션)
- [ ] **Risk Assessment**: Impact x Probability 폼 + Score 자동 계산 + Severity 자동 결정
- [ ] **에스컬레이션 체인**: Issue -> Risk -> Decision 시각화 + 각 노드 클릭 네비게이션
- [ ] **Audit Trail**: 모든 상태 변경 timestamp + actor 기록, PMO_CONTROL에서 열람 가능
- [ ] **에스컬레이션 자동 알림**: Issue->Risk (PM/PMO), Risk->Decision (PM/PMO/SPONSOR)
- [ ] **FilterSpec URL 직렬화**: 왕복 보장, type 변경 시 반대측 status 자동 해제
- [ ] KPI Cards: pending_decisions, total_risks, critical_risks, avg_decision_time, escalation_count, risk_score_trend
- [ ] KPI Card 클릭 시 해당 필터 + 뷰 자동 전환
- [ ] Right Panel: 6개 panelMode (decision-detail, risk-detail, risk-assessment, escalation-chain, audit-trail, approval)
- [ ] **Preset별 차이**: PM_WORK(Full CRUD), PMO_CONTROL(Audit+CrossProject), DEV_EXECUTION(View+Propose), EXEC_SUMMARY(Summary+Approve), CUSTOMER_APPROVAL(Approve/Reject)
- [ ] **AI Navigation**: nodeId 기반 + deepLinkParams(type, severity, status) + Hub penalty 적용
- [ ] **AI Risk Assessment**: AI가 Impact/Probability 제안 -> PM이 확인/오버라이드
- [ ] Decision Kanban drag-and-drop (PM_WORK only, manage_decisions required)
- [ ] Risk Matrix drag (re-assessment) with confirmation dialog
- [ ] 낙관적 잠금: 동시 상태 전이 시 409 CONFLICT 처리 + UI 갱신 안내
- [ ] 순환 참조 방지: 에스컬레이션 DAG 검증 (서버)
- [ ] 5-minute auto-refresh + manual refresh button
- [ ] 반응형 레이아웃 (>=1440 / 1280 / <=1024 / <=768)
- [ ] Risk Matrix <=768px: flat list fallback (matrix hidden)
- [ ] WCAG AA accessibility compliance
- [ ] Completeness badge: data missing -> KPI badge display

**v2.1 추가 DoD**

- [ ] FilterSpec `view` 키 URL 왕복 보장 + `hasEscalation` boolean 필터
- [ ] 다중 상태 필터 (`decisionStatus` repeat key) 역직렬화 + 통합 테이블 적용
- [ ] Summary DTO (`BoardItem`) 기반 리스트 응답 — auditTrail 제외 확인
- [ ] Server-driven `allowedTransitions` 기반 액션 버튼 렌더링 (프론트 상태 전이 상수 이중정의 제거)
- [ ] Decision APPROVED 전이 최소 요건 서버 강제 (options>=2, selectedOption, rationale)
- [ ] `Idempotency-Key` + `If-Match` 헤더 전 mutation API 적용
- [ ] Escalation create-vs-link: `mode="link"` + `targetExistingId` 지원 + `DUPLICATE_ESCALATION` 에러
- [ ] `sortKeyDate` 기반 통합 테이블 기본 정렬
- [ ] panelMode auto/manual: 사용자 명시적 모드 전환 + selection 변경 시 auto 복귀
- [ ] URL `selected` 파라미터로 새로고침/뒤로가기 시 선택 상태 복원
- [ ] KanbanColumnKey DECIDED 가상 컬럼 + UNDER_REVIEW→DECIDED 드래그 금지
- [ ] KPI 클릭 Preset-aware 필터 스태킹 규칙 적용
- [ ] SLA 기준 상태별 분리 (PROPOSED: proposedDate, UNDER_REVIEW: reviewStartDate)
- [ ] Audit Trail API 페이지네이션 필수 + action 필터
- [ ] Reliability 3-tuple (asOf + completeness + warnings) 전 응답 표준화
- [ ] ScopeEcho (`scope: { projectId }`) 전 응답 포함
- [ ] Capability vs Policy 2-레이어: allowedTransitions이 Policy 결과 반영
- [ ] Notification debounce: 동일 엔티티 24시간 중복 억제 + daily digest
- [ ] Metric 정의 확정: riskScoreTrend = active risks only, avgDecisionTimeDays = closed decisions only
- [ ] 깨지기 쉬운 곳 11개 항목 전수 확인

---

## 부록 A. Decision/Risk Status Color Scheme

| Entity | Status | Color | Badge Text |
|--------|--------|-------|-----------|
| Decision | PROPOSED | blue-500 | Proposed |
| Decision | UNDER_REVIEW | amber-500 | Under Review |
| Decision | APPROVED | green-500 | Approved |
| Decision | REJECTED | red-500 | Rejected |
| Decision | DEFERRED | gray-500 | Deferred |
| Risk | IDENTIFIED | blue-400 | Identified |
| Risk | ASSESSED | amber-400 | Assessed |
| Risk | MITIGATING | orange-500 | Mitigating |
| Risk | RESOLVED | green-500 | Resolved |
| Risk | ACCEPTED | teal-500 | Accepted |

## 부록 B. Risk Severity Color Scheme

| Severity | Score Range | Background | Border | Text |
|----------|-----------|-----------|--------|------|
| Low | 1~3 | green-50 | green-300 | green-800 |
| Medium | 4~9 | amber-50 | amber-300 | amber-800 |
| High | 10~16 | orange-50 | orange-400 | orange-900 |
| Critical | 17~25 | red-50 | red-500 | red-900 |

## 부록 C. Escalation Notification Template

```typescript
const ESCALATION_NOTIFICATION_TEMPLATES = {
  "issue_to_risk": {
    title: "[Escalation] Issue -> Risk",
    body: "{{issueId}} '{{issueTitle}}' has been escalated to Risk by {{actorName}}.\n\nReason: {{reason}}\n\nNew Risk: {{riskId}} '{{riskTitle}}'",
    channels: ["in-app"],
  },
  "risk_to_decision": {
    title: "[Escalation] Risk -> Decision (Attention Required)",
    body: "{{riskId}} '{{riskTitle}}' (Severity: {{severity}}) has been escalated to Decision by {{actorName}}.\n\nReason: {{reason}}\n\nNew Decision: {{decisionId}} '{{decisionTitle}}'\n\nPlease review and take action.",
    channels: ["in-app", "email"],
  },
  "critical_risk_created": {
    title: "[URGENT] Critical Risk Created",
    body: "A critical risk has been identified:\n\n{{riskId}} '{{riskTitle}}'\nImpact: {{impact}} / Probability: {{probability}} / Score: {{score}}\n\nIdentified by: {{actorName}}\n\nImmediate attention required.",
    channels: ["in-app", "email"],
  },
};
```

## 부록 D. Risk Matrix Cell Rendering Spec

```typescript
interface RiskMatrixCellProps {
  impact: number;
  probability: number;
  score: number;
  severity: RiskSeverity;
  risks: { id: string; title: string; status: RiskStatus }[];
  isDropTarget: boolean;
  isDragging: boolean;
  onClick: (risks: Risk[]) => void;
}

/** Cell size: 80x80px (desktop), 56x56px (tablet), count-only (mobile) */
/** Max 3 risk dots per cell; "+N more" if exceeds */
/** Dot size: 12px circle, colored by risk status */
/** Score displayed in top-right corner of cell */
/** Severity color fills entire cell background */
```

## 부록 E. 접근성 (Accessibility)

| 항목 | 대응 |
|------|------|
| 색상 대비 | WCAG AA (4.5:1) -- severity colors tested |
| 스크린 리더 | KPI: `aria-label="미결정 사항 5건"` |
| | Matrix: `aria-label="Impact 5, Probability 4, Score 20, Critical, 리스크 2건"` |
| | Kanban: `aria-label="DEC-04, Scope Adjustment, Under Review, 7일 경과"` |
| 키보드 | Tab: KPI -> Filter -> Tabs -> Table/Kanban/Matrix -> Right Panel |
| | Enter: open detail / confirm action |
| | Escape: close Right Panel / cancel dialog |
| | Arrow keys: navigate matrix cells / kanban cards |
| Drag alternative | Keyboard users: "Move to..." dropdown instead of drag-and-drop |
| 상태 표시 | Color + text label + icon (color-blind safe) |
| Audit Trail | `aria-live="polite"` on status change notifications |

## 부록 F. v1.0 -> v2.0 변경 이력

| 섹션 | 변경 | 사유 |
|------|------|------|
| S1.1 | 에스컬레이션 체인 시각화 추가 | Issue->Risk->Decision 전체 추적 |
| S2 전체 | MenuOntologyNodeV2 + FilterSpec 내장 | AI 딥링크 정확도 |
| S3 | Risk Matrix 뷰, Decision Kanban 뷰 추가 | 시각적 리스크 포지셔닝 |
| S3.6 | Risk Score 체계 확정 (1~25, 4단계) | 표준 리스크 평가 프레임워크 |
| S5 | Decision/Risk 상태 전이 서버 강제 | 프론트 임의 변경 방지 |
| S5.3 | 에스컬레이션 자동 알림 정책 | 역할별 통지 채널 확정 |
| S5.4 | Audit Trail 전수 기록 | 감사 증빙 연동 |
| S6 전체 | API 계약 명세 확정 (10개 endpoint) | 프론트-백 계약 |
| S7 | 컴포넌트 구조 + widgetRegistry | 재사용성 확보 |
| S8 | AI Navigation + Risk Assessment 보조 | AI 연동 확장 |
| S9 | 인터랙션 상세 6개 시나리오 | UX 모호성 해소 |
| S11 | 깨지기 쉬운 곳 5개 항목 | 장애 사전 방지 |

## 부록 G. v2.0 -> v2.1 변경 이력

| 섹션 | 변경 | 사유 |
|------|------|------|
| S1.1 | v2.1 변경노트 추가 | 14개 핵심 변경 요약 |
| S1.2 | 설계 원칙 8개 추가 | Server-driven transitions, Summary DTO, Idempotency, Escalation link, Derived Score, Cap vs Policy, URL 복원, 알림 디바운스 |
| S2.2 | FilterSpec `view`, `hasEscalation`, `selected` 키 추가 + 다중 상태 배열 | URL 왕복 보장 + 와일드카드 제거 |
| S2.3 | URL 직렬화 array/boolean 지원 | repeat key + `"true"`/`"false"` 직렬화 |
| S2.4 | 노드 filterSpec keys `allowedViews` + virtualNodes `matchFilters` + deepLinks `view`/`hasEscalation` | FilterSpec-URL-DeepLink 단일화 |
| S3.1 | panelMode auto/manual 개념 | 사용자 명시적 모드 전환 존중 |
| S3.2.1 | KanbanColumnKey + DECIDED 가상 컬럼 + drag 금지 정책 | 고위험 승인 행위의 드래그 방지 |
| S5.1 | APPROVED 전이 최소 요건 + server-driven transitions 주석 | 감사 품질 + 이중정의 제거 |
| S5.2.1 | SLA 기준 상태별 분리 | D+N 경고 정확도 |
| S5.3 | 알림 디바운스/다이제스트 정책 | 스팸 방지 |
| S5.3.1 | 에스컬레이션 create vs link 분리 | 중복 생성 방지 |
| S6.1/6.2 | allowedTransitions, requiredCapsForTransition 추가 + auditTrail detail-only 명시 | 서버 주도 전이 + 리스트 경량화 |
| S6.2.1 | Summary DTOs (BoardItem, DecisionSummary, RiskSummary) | 통합 테이블 타입 통일 + sortKeyDate |
| S6.3.1 | List API: BoardItem[], reliability 3-tuple, ScopeEcho | 표준화 |
| S6.3.2/3 | Detail API: allowedTransitions + ScopeEcho | 서버 주도 전이 |
| S6.3.6 | Transition API: Idempotency-Key, If-Match, 확장 에러 코드 | 동시성 안전 + 승인 전제조건 |
| S6.3.7 | Escalation API: mode create/link, 확장 에러 코드 | 중복 방지 |
| S6.3.8 | Risk Matrix API: reliability 3-tuple + ScopeEcho | 표준화 |
| S6.3.9 | Audit Trail API: pagination 필수 + action 필터 | 데이터 폭증 대비 |
| S6.3.10 | Metric 정의 확정 (active risk 기준) | 해석 모호성 해소 |
| S7.1 | 폴더: kanbanColumnConfig, slaConfig, usePanelMode, useUrlStateRestore 추가 | 신규 기능 반영 |
| S8.2 | AI Navigation: filter 기반 (deepLinkParams→filter), hasEscalation | 단일 언어 |
| S9.1 | Kanban drag: UNDER_REVIEW→DECIDED 금지 | 고위험 행위 보호 |
| S9.4 | Escalation flow: create/link 모드 선택 UI | 중복 방지 UX |
| S9.5.1 | Event-based refetch 테이블 (6개 이벤트) | 실시간 일관성 |
| S9.6 | KPI 클릭: Preset-aware 스태킹 + hasEscalation | 필터 충돌 방지 |
| S11 | 깨지기 쉬운 곳 5→11개 | URL 복원, 정렬 키, Trend 정의, Audit 폭증, 중복 에스컬레이션, APPROVED 미입력 |
| S12.1.1 | Capability vs Policy 2-레이어 | 접근 가능성 ≠ 허용 행위 |
| S13 | DoD v2.1 항목 20개 추가 | 구현 완료 기준 |
