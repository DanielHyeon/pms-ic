# 10. 테스트관리 화면설계

> 작성일: 2026-02-08
> 버전: v2.0
> 라우트: `/tests`, `/tests/:testCaseId`
> 필요 Capability: `view_tests` (조회), `manage_tests` (테스트 케이스 생성/편집/실행/결과 기록)
> 기본 Preset: 역할에 따라 자동 결정
> 노드 역할: **Detail** (상세 노드 -- 필터/조회/실행 전용)

> **v2.0 변경** (cross-review):
> (1) TC 상태 2축 분리 (definitionStatus + lastOutcome → derivedStatus),
> (2) FilterSpec view 키 추가 (coverage-gaps 타입 불일치 해소),
> (3) ScopeEcho + Reliability 3-tuple 전 API 표준화,
> (4) TestRun runNumber 동시성 안전화 (DB-level serialization),
> (5) 결함 생성 멱등/재시도 API (defectCreateStatus + retry endpoint),
> (6) Bulk → QuickRun 분리 + TestRun.mode 필드,
> (7) Coverage 2단계 (linkCoverage / passCoverage),
> (8) Suite 완료 = 통계 기반 (기계적 COMPLETED 조건 폐기),
> (9) 구조화된 검증 오류 (violations[]),
> (10) 깨지기 쉬운 곳 5→10, (11) DoD v2.0 항목 추가

---

## 1. 화면 개요

### 1.1 목적

테스트관리는 **"품질이 지금 어떤 상태인가? 테스트가 어디까지 진행됐는가?"**에 대한 답을 제공한다.
기존 스프레드시트 기반 테스트 결과 기록을 **"생명주기를 가진 테스트 객체"**로 전환하여,
테스트 계획(Test Suite) -> 테스트 케이스(Test Case) -> 테스트 실행(Test Run)의
**3계층 생명주기**를 실시간으로 관리한다.

> **핵심 분리 원칙**: 요구사항(Requirement)은 **"고객이 뭘 원하는가"**(계약/RFP 기반),
> 테스트(Test Case)는 **"그것이 잘 만들어졌는가를 어떻게 검증하는가"**(품질 검증).
> 두 객체는 ID 기반 Trace 연결로 연결되며, 테스트 화면에서는 검증 관점에 집중한다.

### 1.2 설계 원칙

| 원칙 | 설명 |
|------|------|
| **3계층 생명주기** | TestSuite -> TestCase -> TestRun 계층으로 테스트 계획/실행/이력을 구조화 |
| **Trace Chain 일부** | Requirement -> Story -> TestCase 추적 체인의 끝단으로, Coverage 측정의 핵심 |
| **실행 = 스냅샷** | TestRun은 실행 시점의 스냅샷(누가, 언제, 결과, 환경)으로 변경 불가 이력 |
| **결함 연동** | TC 실패 -> Issue 자동 연결 (Defect Linking), 품질 데이터 순환 |
| **FilterSpec = 온톨로지** | 필터 키가 AI/URL/백엔드 공통 스키마로 통합 |
| **QA = RW, DEV = RO** | QA 역할은 테스트 실행/결과 기록 권한, 일반 DEV는 결과 조회만 |
| **Coverage = 정량 품질** | 요구사항/Story 대비 TC 커버리지를 정량 측정 |
| **TC 상태 2축 분리** | definitionStatus(작성 상태) + lastOutcome(실행 결과) → derivedStatus(서버 계산, 표시용) |
| **FilterSpec view 키** | coverage-gaps 같은 특수 뷰를 FilterSpec에 포함하여 AI/URL/백엔드 타입 일치 보장 |
| **ScopeEcho 필수** | 모든 API 응답에 `scope: { projectId }` 포함, 화면이 어떤 범위를 보는지 항상 검증 가능 |
| **QuickRun ≠ DetailedRun** | Bulk 일괄 기록(QuickRun)과 Step-by-step 실행(DetailedRun)을 mode로 명시 구분 |
| **Coverage 2단계** | linkCoverage(링크 존재) + passCoverage(전체 PASS) 분리 → 분쟁 방지 |
| **구조화된 검증 오류** | 상태 전이 실패 시 `violations[]` 반환 → 프론트 UX 안내 즉시 가능 |

### 1.3 핵심 질문 -> 위젯 매핑

| 사용자 질문 | 화면 영역 | 설명 |
|-----------|---------|------|
| "테스트 현황 어떻게 돼?" | 상단 KPI | 전체/통과/실패/차단/미실행 건수 |
| "테스트 통과율 얼마야?" | 상단 KPI | pass_rate 지표 |
| "실패한 테스트 뭐가 있어?" | 필터 + 테이블 | executionResult=FAILED 필터 |
| "요구사항 커버리지 얼마야?" | 상단 KPI | coverage_rate (Req 대비 TC) |
| "이번 스프린트 테스트 결과는?" | 필터 | phaseId/sprintId 필터 |
| "차단된 테스트 있어?" | 필터 + 배지 | status=BLOCKED 필터 |
| "TC-21 실행 이력 보여줘" | Right Panel | 특정 TC의 TestRun 타임라인 |
| "회귀 테스트 통과율은?" | 상단 KPI | regression_pass_rate 지표 |
| "미실행 테스트 몇 건이야?" | KPI + 필터 | executionResult=NOT_RUN 필터 |
| "이 요구사항에 연결된 TC는?" | 필터 | requirementId 필터 |

---

## 2. MenuOntology 노드

### 2.1 타입 확정

01_대시보드 / 02_요구사항 / 03_백로그 v2.0 패턴을 동일하게 적용한다.

| 항목 | 확정 내용 | 비고 |
|------|----------|------|
| `entities` | PascalCase `"TestSuite"`, `"TestCase"`, `"TestRun"` | EntityType enum 정규화 |
| `intents` | 16개 | Ask 10 + Do 6 |
| Capability | 2개 (`view_tests`, `manage_tests`) | QA=RW, DEV=RO |
| `filterSpec` | 12키 | suiteId, definitionStatus, lastOutcome, priority, assigneeId, requirementId, storyId, phaseId, view, dateRange, q + scope(projectId) |
| `virtualNodes` | 5개 | failed/blocked/not-run/low-coverage/regression |
| `metrics` | 7개 | total/pass_rate/fail/blocked/coverage/execution_rate/regression |
| `nodeRole` | `"detail"` | 행동/필터 질문에 +10 가산 |

### 2.2 FilterSpec 정의

FilterSpec은 **이 화면이 지원하는 필터 스키마**를 온톨로지 내부에 선언한다.
AI가 딥링크를 생성할 때, URL 파라미터 문자열이 아니라 **FilterSpec 키 기반 필터 객체**를 반환한다.

```typescript
/** 테스트관리 필터 스키마 -- 온톨로지 내장 (v2.0: 2축 분리) */
export interface TestFilterSpec {
  /** Test Suite ID */
  suiteId?: string;
  /**
   * v2.0: TC 정의 상태 (작성 라이프사이클)
   * - DRAFT: 작성 중, 실행 불가
   * - READY: 실행 가능
   * - DEPRECATED: 더 이상 사용하지 않음 (이력 보존)
   */
  definitionStatus?: "DRAFT" | "READY" | "DEPRECATED";
  /**
   * v2.0: 최종 실행 결과 (TestRun으로부터 파생)
   * - NOT_RUN: 한 번도 실행되지 않음 (READY이지만 Run 없음)
   */
  lastOutcome?: "PASSED" | "FAILED" | "BLOCKED" | "SKIPPED" | "NOT_RUN";
  /** 우선순위 */
  priority?: "CRITICAL" | "HIGH" | "MEDIUM" | "LOW";
  /** 담당자 */
  assigneeId?: string;
  /** 요구사항 연결 */
  requirementId?: string;
  /** Story 연결 */
  storyId?: string;
  /** Phase 연결 */
  phaseId?: string;
  /**
   * v2.0: 특수 뷰 모드
   * - "coverage-gaps": 미연결 요구사항/스토리 커버리지 갭 분석 뷰
   * - "default": 일반 테스트 목록 (생략 시 기본값)
   */
  view?: "coverage-gaps" | "default";
  /** 실행일 범위 (ISO 8601) */
  dateRange?: {
    from?: string;
    to?: string;
  };
  /** 자유 검색어 */
  q?: string;
}
```

> **v1.0 → v2.0 변경**: 기존 `status` (6-value 혼합)를 `definitionStatus` (3-value 작성 상태)와
> `lastOutcome` (5-value 실행 결과)로 **2축 분리**. `view` 키 추가로 virtualNode `tests.low-coverage`의
> 타입 불일치 해소. 기존 `executionResult` 파라미터는 `lastOutcome`으로 통합.

### 2.3 Tests 노드 (확정본)

```typescript
const testsNode: MenuOntologyNodeV2 = {
  nodeId: "tests",
  label: "테스트 관리",
  route: "/tests",
  icon: "BugReportRounded",
  domain: "control",
  nodeRole: "detail",              // detail node -- action/filter questions get +10

  requiredCaps: ["view_tests"],

  // --- intents: 16 ---
  intents: [
    // Ask -- query/question
    "ask_test_coverage",           // "테스트 커버리지 얼마야?"
    "ask_test_status",             // "테스트 현황 알려줘"
    "ask_test_pass_rate",          // "통과율 얼마야?"
    "ask_test_failures",           // "실패한 테스트 뭐가 있어?"
    "ask_test_blocked",            // "차단된 테스트 있어?"
    "ask_test_execution_history",  // "TC-21 실행 이력 보여줘"
    "ask_regression_status",       // "회귀 테스트 결과 어때?"
    "ask_test_by_requirement",     // "이 요구사항 연결 TC는?"
    "ask_test_by_story",           // "이 Story 연결 TC는?"
    "ask_test_not_run",            // "미실행 테스트 몇 건이야?"
    // Do -- execute/modify
    "do_create_test_case",         // "테스트 케이스 만들어줘"
    "do_execute_test",             // "테스트 실행해줘"
    "do_record_test_result",       // "테스트 결과 기록해줘"
    "do_link_defect",              // "결함 이슈 연결해줘"
    "do_bulk_execute_tests",       // "일괄 실행해줘"
    "do_export_test_report",       // "테스트 리포트 Export"
  ],
  canonicalQuestions: [
    "테스트 현황 보여줘",
    "테스트 통과율 얼마야?",
    "실패한 테스트 케이스 보여줘",
    "요구사항 커버리지 몇 %야?",
    "차단된 테스트 있어?",
    "TC-21 실행 이력 알려줘",
    "회귀 테스트 결과 어때?",
    "미실행 테스트 몇 건이야?",
    "이 요구사항에 연결된 TC는?",
    "테스트 리포트 뽑아줘",
  ],
  entities: ["TestSuite", "TestCase", "TestRun", "Requirement", "Story", "Issue"],
  keywords: [
    "테스트", "QA", "테케", "TC", "통과", "실패", "커버리지",
    "test", "test case", "test suite", "test run", "coverage",
    "pass", "fail", "blocked", "regression", "결함", "defect",
    "품질", "quality", "execution", "미실행",
  ],
  metrics: [
    "total_test_cases",
    "pass_rate",
    "fail_count",
    "blocked_count",
    "coverage_rate",
    "execution_rate",
    "regression_pass_rate",
  ],

  // --- FilterSpec inline (v2.0: 2축 + view) ---
  filterSpec: {
    keys: [
      "suiteId", "definitionStatus", "lastOutcome", "priority",
      "assigneeId", "requirementId", "storyId", "phaseId",
      "view", "dateRange", "q",
    ],
    defaults: {},
    // v2.0: scope 2-tier
    securityKeys: ["projectId"],         // JWT enforced
    explorationKeys: [                   // frontend drill-down
      "suiteId", "definitionStatus", "lastOutcome", "priority",
      "assigneeId", "requirementId", "storyId", "phaseId",
      "view", "dateRange", "q",
    ],
  },

  defaultPreset: "PM_WORK",
  presetPolicies: [
    {
      preset: "EXEC_SUMMARY",
      ui: {
        density: "compact",
        defaultRightPanel: "closed",
        highlight: {
          metricKeys: ["total_test_cases", "pass_rate", "coverage_rate"],
          widgetKeys: ["KPI_TOTAL", "KPI_PASS_RATE", "KPI_COVERAGE"],
        },
        hiddenColumns: [
          "assigneeId", "priority", "suiteId", "linkedStoryId",
        ],
      },
    },
    {
      preset: "PMO_CONTROL",
      ui: {
        density: "standard",
        defaultRightPanel: "open",
        highlight: {
          metricKeys: [
            "pass_rate", "fail_count", "coverage_rate",
            "execution_rate", "regression_pass_rate",
          ],
          widgetKeys: [
            "KPI_PASS_RATE", "KPI_FAIL", "KPI_COVERAGE",
            "COVERAGE_CHART", "EXECUTION_PROGRESS",
          ],
        },
      },
      suggestedActions: [
        {
          key: "export_test_report",
          label: "테스트 리포트 Export",
          requiredCaps: ["export_reports"],
          targetNodeId: "reports",
        },
        {
          key: "view_issues",
          label: "결함 이슈 확인",
          requiredCaps: ["view_issues"],
          targetNodeId: "issues",
        },
      ],
    },
    {
      preset: "PM_WORK",
      ui: {
        density: "detailed",
        defaultRightPanel: "open",
        highlight: {
          metricKeys: [
            "total_test_cases", "pass_rate", "fail_count",
            "blocked_count", "coverage_rate", "execution_rate",
          ],
          widgetKeys: [
            "KPI_TOTAL", "KPI_PASS_RATE", "KPI_FAIL",
            "KPI_BLOCKED", "KPI_COVERAGE", "COVERAGE_CHART",
          ],
        },
      },
      suggestedActions: [
        {
          key: "create_test_case",
          label: "테스트 케이스 생성",
          requiredCaps: ["manage_tests"],
          targetNodeId: "tests",
        },
        {
          key: "view_coverage_gaps",
          label: "미연결 요구사항 확인",
          requiredCaps: ["view_requirements"],
          targetNodeId: "requirements",
        },
        {
          key: "view_issues",
          label: "결함 이슈 확인",
          requiredCaps: ["view_issues"],
          targetNodeId: "issues",
        },
      ],
    },
    {
      preset: "DEV_EXECUTION",
      ui: {
        density: "standard",
        defaultRightPanel: "closed",
        highlight: {
          metricKeys: ["total_test_cases", "pass_rate", "fail_count"],
          widgetKeys: ["KPI_TOTAL", "KPI_PASS_RATE", "EXECUTION_PROGRESS"],
        },
      },
      suggestedActions: [
        {
          key: "execute_test",
          label: "테스트 실행",
          requiredCaps: ["manage_tests"],
          targetNodeId: "tests",
        },
        {
          key: "link_defect",
          label: "결함 이슈 등록",
          requiredCaps: ["manage_issues"],
          targetNodeId: "issues",
        },
      ],
    },
    {
      preset: "CUSTOMER_APPROVAL",
      ui: {
        density: "compact",
        defaultRightPanel: "closed",
        highlight: {
          metricKeys: ["total_test_cases", "pass_rate", "coverage_rate"],
          widgetKeys: ["KPI_TOTAL", "KPI_PASS_RATE", "KPI_COVERAGE"],
        },
        hiddenColumns: [
          "assigneeId", "suiteId", "priority", "linkedStoryId",
        ],
      },
    },
    // AUDIT_EVIDENCE excluded -- auditors do not access /tests directly
  ],

  // --- DeepLink: routeTemplate standard (:param format) ---
  deepLinks: [
    {
      pattern: "/tests?definitionStatus=:definitionStatus",
      description: "TC definition status filter (DRAFT/READY/DEPRECATED)",
      requiredParams: ["definitionStatus"],
    },
    {
      pattern: "/tests?lastOutcome=:lastOutcome",
      description: "Last execution outcome filter",
      requiredParams: ["lastOutcome"],
    },
    {
      pattern: "/tests?suiteId=:suiteId",
      description: "Test Suite filter",
      requiredParams: ["suiteId"],
    },
    {
      pattern: "/tests?requirementId=:requirementId",
      description: "Requirement linked TC filter",
      requiredParams: ["requirementId"],
    },
    {
      pattern: "/tests?storyId=:storyId",
      description: "Story linked TC filter",
      requiredParams: ["storyId"],
    },
    {
      pattern: "/tests?assigneeId=:assigneeId",
      description: "Assignee filter",
      requiredParams: ["assigneeId"],
    },
    {
      pattern: "/tests/:testCaseId",
      description: "TestCase detail + execution history",
      requiredParams: ["testCaseId"],
    },
  ],

  // --- Virtual nodes: deep links promoted to ontology layer 2 ---
  virtualNodes: [
    {
      virtualId: "tests.failed",
      label: "Failed tests",
      routeTemplate: "/tests?lastOutcome=FAILED",
      requiredParams: [],
      intents: ["ask_test_failures", "do_link_defect"],
      description: "List of test cases with FAILED last execution -- defect triage entry point",
    },
    {
      virtualId: "tests.blocked",
      label: "Blocked tests",
      routeTemplate: "/tests?lastOutcome=BLOCKED",
      requiredParams: [],
      intents: ["ask_test_blocked"],
      description: "List of BLOCKED test cases -- blocker resolution entry point",
    },
    {
      virtualId: "tests.not-run",
      label: "Not executed tests",
      routeTemplate: "/tests?lastOutcome=NOT_RUN",
      requiredParams: [],
      intents: ["ask_test_not_run", "do_execute_test"],
      description: "List of test cases never executed -- test execution backlog",
    },
    {
      virtualId: "tests.low-coverage",
      label: "Low coverage items",
      routeTemplate: "/tests?view=coverage-gaps",
      requiredParams: [],
      intents: ["ask_test_coverage"],
      description: "Requirements/Stories with no linked TC -- coverage gap analysis",
    },
    {
      virtualId: "tests.regression",
      label: "Regression test results",
      routeTemplate: "/tests?suiteId=regression",
      requiredParams: [],
      intents: ["ask_regression_status"],
      description: "Regression test suite results -- release readiness check",
    },
  ],

  // --- Scope 2-tier (v2.0) ---
  scope: {
    keys: ["project"],
    params: ["projectId"],
    // v2.0: 2-tier scope separation
    securityKeys: ["projectId"],         // JWT enforced, server-side validation
    explorationKeys: [                   // frontend drill-down, no security enforcement
      "suiteId", "definitionStatus", "lastOutcome", "priority",
      "assigneeId", "requirementId", "storyId", "phaseId",
      "view", "dateRange", "q",
    ],
  },

  priority: 4,
};
```

---

## 3. 화면 구조

### 3.1 Right Panel panelMode 정의

Right Panel은 항상 동일한 영역이지만, **panelMode**에 따라 표시 내용이 달라진다.
조건 분기 대신 명시적 모드 enum으로 관리한다.

```typescript
/** Right Panel mode -- explicit enum */
export type TestPanelMode =
  | "none"           // Right Panel hidden (EXEC_SUMMARY)
  | "preview"        // TC quick preview (list row selected)
  | "detail"         // TC full detail (detail page)
  | "execution"      // Test execution form (QA running a test)
  | "history"        // Execution history timeline (TestRun list)
  | "coverage";      // Coverage analysis (linked Req/Story)
```

**panelMode determination rules**:

| Context | Preset | Default panelMode |
|---------|--------|-------------------|
| List + no row selected | ALL | `"none"` |
| List + row selected | EXEC_SUMMARY | `"none"` (Right Panel hidden) |
| List + row selected | PM_WORK / PMO_CONTROL | `"preview"` |
| List + row selected | DEV_EXECUTION (QA) | `"preview"` |
| List + row selected | DEV_EXECUTION (DEV) | `"preview"` (read-only) |
| List + row selected | CUSTOMER_APPROVAL | `"preview"` (read-only) |
| Detail page | ALL | `"history"` |
| Detail page + coverage tab | ALL | `"coverage"` |
| Test execution | DEV_EXECUTION (QA) | `"execution"` |

### 3.2 테스트 목록 (`/tests`)

```
+--------------------------------------------------------------+
|  Page Header                                                  |
|  Test Management  [ AI Insurance Claims ]                     |
|  [ Filter v ]  [ Search ]              [ + Create TC ] [Bulk] |
+--------------------------------------------------------------+
|                                                               |
|  +----------+  +----------+  +----------+  +----------+      |
|  | Total    |  | Pass     |  | Failed   |  | Blocked  |      |
|  | 156 TC   |  | Rate     |  |   12     |  |    5     |      |
|  |          |  |  78.2%   |  |   !!     |  |   !!     |      |
|  +----------+  +----------+  +----------+  +----------+      |
|                                                               |
|  +----------+  +----------+  +----------+                     |
|  | Coverage |  | Execution|  | Regress  |                     |
|  |  85.3%   |  | Rate     |  | Pass     |                     |
|  | Req:88%  |  |  72.4%   |  |  94.1%   |                     |
|  | Story:83%|  |          |  |          |                     |
|  +----------+  +----------+  +----------+                     |
|                                                               |
|  +- Filter Bar ----------------------------------------+      |
|  | Suite: [All v] Status: [All v] Priority: [All v]    |      |
|  | Result: [All v] Assignee: [All v] Phase: [All v]    |      |
|  | Req: [All v] Story: [All v]                         |      |
|  |                    <- FilterSpec key 1:1 mapping     |      |
|  +-----------------------------------------------------+      |
|                                                               |
|  +- TestCase Table -----------------------+------------------+|
|  |                                        | panelMode:       ||
|  | ID     | Name      |Suite| Prio|Status | "preview"        ||
|  |        |           |     |     |Result |                  ||
|  | -------+-----------+-----+-----+------ |                  ||
|  | TC-001 | Login     |Auth | HIGH|PASSED | TC Quick Preview ||
|  |        | auth test |Suite|     | PASS  |                  ||
|  |        |           |     |     |       | +==============+ ||
|  | TC-012 | Claim     |Claim| CRIT|FAILED | |Suite: Claim  | ||
|  |        | validation|Suite|     | FAIL  | |Status: READY | ||
|  |        |           |     |     |       | |Last Run:     | ||
|  | TC-021 | Payment   |Pay  | MED |READY  | | 2026-02-07   | ||
|  |        | process   |Suite|     |NOT_RUN| | Result: FAIL | ||
|  |        |           |     |     |       | |Assignee: QA1 | ||
|  | TC-035 | Export    |Rpt  | LOW |BLOCKED| |              | ||
|  |        | report    |Suite|     |BLOCKED| |Linked:       | ||
|  |        |           |     |     |       | | REQ-034  (1) | ||
|  | ...                                    | | S-88     (1) | ||
|  |                                        | |              | ||
|  |                                        | |Last 3 Runs:  | ||
|  |                                        | | #5 FAIL 02-07| ||
|  |                                        | | #4 PASS 02-03| ||
|  |                                        | | #3 PASS 01-28| ||
|  |                                        | +==============+ ||
|  |                                        | [Detail ->]      ||
|  | < 1 2 3 4 5 >  (20/page)              |                  ||
|  +----------------------------------------+------------------+|
|                                                               |
+---------------------------------------------------------------+
```

### 3.3 테스트 상세 (`/tests/:testCaseId`)

```
+--------------------------------------------------------------+
|  Page Header                                                  |
|  <- Tests  TC-012  Claim validation test                      |
|                              [ Edit ] [ Execute ] [ History ] |
+--------------------------------------------------------------+
|                                                               |
|  +- Basic Info ----------------------+- panelMode: "history"-+|
|  |                                   |                       ||
|  |  Test Case ID: TC-012             |  [ Execution History ]||
|  |  Name: Claim validation test      |                       ||
|  |  Suite: Claim Suite               |  Run #5  2026-02-07   ||
|  |  Priority: CRITICAL              |    Result: FAILED !!   ||
|  |  Status: READY                    |    Executor: QA Kim   ||
|  |  Assignee: QA Kim                |    Env: Staging        ||
|  |                                   |    Duration: 12m 30s  ||
|  |  Type: Integration               |    Note: "Validation  ||
|  |  Preconditions:                   |     error on field X" ||
|  |    - User logged in              |    Defect: ISS-045 !!  ||
|  |    - Claim form loaded           |    [View Defect ->]    ||
|  |                                   |                       ||
|  +- Test Steps --------------------+  Run #4  2026-02-03   ||
|  |                                   |    Result: PASSED     ||
|  |  Step 1: Navigate to claim form  |    Executor: QA Lee   ||
|  |    Expected: Form loads          |    Env: Staging        ||
|  |    Actual: (last run result)     |    Duration: 8m 15s    ||
|  |    Status: PASS                  |                       ||
|  |                                   |  Run #3  2026-01-28   ||
|  |  Step 2: Enter invalid amount    |    Result: PASSED     ||
|  |    Expected: Validation error    |    Executor: QA Kim   ||
|  |    Actual: No error shown        |    Env: Dev            ||
|  |    Status: FAIL !!               |    Duration: 9m 00s    ||
|  |                                   |                       ||
|  |  Step 3: Submit form             |  Run #2  2026-01-20   ||
|  |    Expected: Error prevents sub  |    Result: PASSED     ||
|  |    Actual: Form submitted        |    Executor: QA Lee   ||
|  |    Status: FAIL !!               |                       ||
|  |                                   |  Run #1  2026-01-10   ||
|  +- Linked Items ------------------+    Result: PASSED     ||
|  |                                   |    Executor: QA Kim   ||
|  |  Requirements:                   |                       ||
|  |    REQ-034  Claim processing     |  -- Pass Rate Trend -- ||
|  |    REQ-041  Validation rules     |  #1  #2  #3  #4  #5   ||
|  |                                   |  P   P   P   P   F    ||
|  |  Stories:                        |  100% -> 80% (last 5) ||
|  |    S-88  Claim submission        |                       ||
|  |    S-92  Claim validation        |  -- Linked Defects --- ||
|  |                                   |  ISS-045  OPEN  !!    ||
|  |  Issues (Defects):               |  ISS-031  RESOLVED    ||
|  |    ISS-045  Validation bypass    |                       ||
|  |      Status: OPEN               |  -- Coverage Info ---- ||
|  |    ISS-031  Amount rounding      |  Req Coverage: 2 Reqs ||
|  |      Status: RESOLVED           |  Story Coverage: 2 St ||
|  |                                   |                       ||
|  +-----------------------------------+-----------------------+|
|                                                               |
+---------------------------------------------------------------+
```

---

## 4. Preset별 차이

### 4.1 PM_WORK (PM) -- Test planning + coverage analysis

| Area | Content |
|------|---------|
| KPI Row | Total TC, Pass Rate, Fail Count, Blocked Count, Coverage Rate, Execution Rate, Regression Pass Rate |
| Table | Full columns (Suite, Priority, Status, Result, Assignee, Linked Req/Story) |
| Right Panel | panelMode: `"preview"` (row selected) -> `"history"` (detail page) |
| CTA | `Create TC` (cap: `manage_tests`), `Coverage Gaps` -> requirements, `Defect Issues` -> issues |
| Key Focus | Coverage gap analysis, test planning, defect trend monitoring |

### 4.2 PMO_CONTROL (PMO) -- Quality metrics overview + coverage reports

| Area | Content |
|------|---------|
| KPI Row | Pass Rate, Fail Count, Coverage Rate, Execution Rate, Regression Pass Rate |
| Table | Standard columns (Priority, Status, Result, Coverage indicators) |
| Right Panel | panelMode: `"preview"` (open by default) |
| CTA | `Test Report Export` -> reports, `Defect Issues` -> issues |
| Key Focus | Quality metrics oversight, release readiness assessment |

### 4.3 DEV_EXECUTION -- QA role (Full RW)

| Area | Content |
|------|---------|
| KPI Row | Total TC, Pass Rate, Fail Count |
| Table | Standard columns (Suite, Priority, Status, Result, Assignee) |
| Right Panel | panelMode: `"preview"` -> `"execution"` (when executing) |
| CTA | `Execute Test` (cap: `manage_tests`), `Link Defect` -> issues |
| Key Focus | Test execution, result recording, defect linking |

### 4.4 DEV_EXECUTION -- DEV role (Read-Only)

| Area | Content |
|------|---------|
| KPI Row | Total TC, Pass Rate, Fail Count |
| Table | Standard columns (read-only) |
| Right Panel | panelMode: `"preview"` (read-only) |
| CTA | None (read-only) |
| Key Focus | Understanding test results related to own code |

### 4.5 EXEC_SUMMARY (Sponsor) -- Summary only

| Area | Content |
|------|---------|
| KPI Row | Total TC, Pass Rate, Coverage Rate |
| Table | Condensed columns (Name, Status, Result only) |
| Right Panel | panelMode: `"none"` (hidden) |
| CTA | None (read-only) |
| Key Focus | High-level quality health check |

### 4.6 CUSTOMER_APPROVAL (Customer PM) -- Test results read-only

| Area | Content |
|------|---------|
| KPI Row | Total TC, Pass Rate, Coverage Rate |
| Table | Condensed columns (Name, Status, Result, linked Req) |
| Right Panel | panelMode: `"preview"` (read-only) |
| CTA | None (read-only) |
| Key Focus | Acceptance test results review, requirements coverage confirmation |

---

## 5. 테스트 생명주기

### 5.1 3계층 구조 및 상태 흐름

```
Level 1: Test Suite (test plan grouping)
  |  Lifecycle: DRAFT -> ACTIVE -> ARCHIVED
  |  Owner: PM / QA Lead
  |  Examples: "Claim Processing Suite", "Regression Suite", "UAT Suite"
  |  Note (v2.0): "완료"는 Suite 상태가 아닌 Stats로 계산
  |    (executionRate=100% && 모든 TC 최소 1회 실행)
  |
  +- Level 2: Test Case (individual verification item)
  |    |  v2.0 2축 분리:
  |    |    definitionStatus: DRAFT -> READY -> DEPRECATED
  |    |    lastOutcome: NOT_RUN / PASSED / FAILED / BLOCKED / SKIPPED
  |    |    derivedStatus: 서버가 2축 조합으로 계산 (READ-ONLY)
  |    |  Owner: QA / QA Lead (assignee: individual QA engineer)
  |    |  Trace: Requirement -> Story -> TestCase
  |    |
  |    +- Level 3: Test Run (execution snapshot -- immutable history)
  |         Result: PASSED / FAILED / BLOCKED / SKIPPED
  |         Mode: MANUAL_DETAILED / MANUAL_QUICK / AUTOMATED  (v2.0)
  |         Owner: executor (QA engineer)
  |         Immutable: once recorded, cannot be changed
  |         Contains: who, when, result, environment, duration, notes, steps, mode
```

### 5.2 Test Suite 생명주기

```
DRAFT -----> ACTIVE -----> ARCHIVED
                |
                +-----> (remains ACTIVE -- "completion" is stats-derived)

DRAFT: Suite created, TC being added
ACTIVE: Suite ready for execution, TC can be executed
ARCHIVED: Historical reference only, no new executions

v2.0 변경: COMPLETED 상태 제거.
  - "완료"는 Suite 자체 상태가 아닌 Stats에서 계산:
    executionRate === 100% && 모든 TC가 최소 1회 실행
  - 회귀/상시 스위트(Regression)는 영원히 ACTIVE
  - 스프린트/페이즈 스코프 완료율은 Stats API에서 phaseId/sprintId 필터로 계산
```

### 5.3 Test Case 상태 전이 (v2.0: 2축 분리)

**축 1: definitionStatus** (작성 라이프사이클 -- 명시적 전환)

```
DRAFT -----> READY -----> DEPRECATED
  |                           |
  +--- (preconditions met) ---+--- (TC retired / replaced)
```

**축 2: lastOutcome** (실행 결과 -- TestRun으로부터 자동 파생)

```
NOT_RUN -----> PASSED / FAILED / BLOCKED / SKIPPED
                 |         |        |
                 +-----> (re-execute: new TestRun overwrites lastOutcome)
```

**derivedStatus** (서버 계산, READ-ONLY -- 표시용 종합 상태)

```typescript
type DerivedStatus =
  | "DRAFT"            // definitionStatus=DRAFT (lastOutcome ignored)
  | "READY"            // definitionStatus=READY, lastOutcome=NOT_RUN
  | "PASSED"           // definitionStatus=READY, lastOutcome=PASSED
  | "FAILED"           // definitionStatus=READY, lastOutcome=FAILED
  | "BLOCKED"          // definitionStatus=READY, lastOutcome=BLOCKED
  | "SKIPPED"          // definitionStatus=READY, lastOutcome=SKIPPED
  | "DEPRECATED";      // definitionStatus=DEPRECATED (lastOutcome preserved but grayed)
```

**State transition rules (server-enforced)**:

```
definitionStatus transitions:
  - DRAFT -> READY: preconditions and test steps must be defined (minimum 1 step)
    * Server validates: testSteps.length >= 1
    * On failure: returns structured error with violations[]
  - READY -> DEPRECATED: manual transition (TC retired)
  - DEPRECATED -> READY: manual reactivation (rare)

lastOutcome transitions:
  - NOT_RUN -> PASSED/FAILED/BLOCKED/SKIPPED: TestRun must be recorded
  - FAILED -> PASSED: new TestRun with PASSED result must be recorded
  - BLOCKED -> (any): new TestRun or manual unblock -> TestRun
  - definitionStatus must be READY to record a TestRun (DRAFT/DEPRECATED blocked)

derivedStatus:
  - 100% server-computed from (definitionStatus, lastOutcome) pair
  - Front-end displays derivedStatus badge only, cannot set it directly
```

> **Core principle (v2.0)**: TC 상태는 **2축의 조합**에서 파생된다.
> `definitionStatus`는 명시적 전환(PM/QA가 변경), `lastOutcome`은 TestRun 기록 시 자동 전환.
> `derivedStatus`는 서버가 2축을 조합하여 계산하는 **READ-ONLY** 표시용 상태.
> 이 분리로 "READY인데 아직 미실행"과 "실행했는데 SKIPPED"가 명확히 구분된다.

### 5.4 TestRun -- Immutable Execution Snapshot

```typescript
/** TestRun is an immutable execution record (v2.0: +mode, +defect metadata) */
interface TestRunSnapshot {
  // Immutable after creation
  id: string;                        // TRUN-001
  testCaseId: string;                // TC-012
  /**
   * Sequential per TC (1, 2, 3...).
   * v2.0: DB-level serialization required (SELECT max+1 FOR UPDATE
   * or per-TC sequence). Display-only -- sort by executedAt + id.
   */
  runNumber: number;

  /**
   * v2.0: Execution mode -- distinguishes evidence quality
   * - MANUAL_DETAILED: Step-by-step execution with per-step results (full evidence)
   * - MANUAL_QUICK: Bulk/quick recording without step details (smoke/checkpoint)
   * - AUTOMATED: CI/CD or test automation framework result (machine-generated)
   */
  mode: "MANUAL_DETAILED" | "MANUAL_QUICK" | "AUTOMATED";

  // Execution context
  executedBy: string;                // User ID (QA engineer)
  executedAt: string;                // ISO 8601 timestamp
  environment: TestEnvironment;      // DEV / STAGING / PRODUCTION / UAT
  duration?: number;                 // Seconds

  // Result
  result: "PASSED" | "FAILED" | "BLOCKED" | "SKIPPED";

  // Step-level results (empty for MANUAL_QUICK / AUTOMATED)
  stepResults: {
    stepNumber: number;
    expectedResult: string;
    actualResult: string;
    status: "PASS" | "FAIL" | "SKIP" | "BLOCKED";
    screenshot?: string;             // Attachment ID
    note?: string;
  }[];

  // Defect linking
  linkedIssueIds: string[];          // ISS-045, ISS-031

  /**
   * v2.0: Defect creation metadata -- tracks inline defect creation attempts
   * - NONE: no defect creation attempted
   * - CREATED: defect successfully created (linkedIssueIds updated)
   * - FAILED: defect creation failed (TestRun saved, defect not)
   */
  defectCreateStatus: "NONE" | "CREATED" | "FAILED";
  defectCreateError?: string;        // Error message if FAILED

  // Notes
  notes?: string;
  attachments?: string[];            // File attachment IDs

  // Metadata
  projectId: string;
  createdAt: string;                 // Same as executedAt (immutable)
}

type TestEnvironment = "DEV" | "STAGING" | "PRODUCTION" | "UAT";
```

> **Immutability guarantee**: Once a TestRun is created, it cannot be modified or deleted.
> This provides an auditable execution trail for compliance and traceability purposes.

> **v2.0 runNumber 동시성 안전화**: 여러 QA가 같은 TC를 동시 기록할 때 runNumber 충돌을 방지하기 위해
> DB에서 `SELECT max(run_number)+1 FROM test_runs WHERE test_case_id = ? FOR UPDATE` 또는
> per-TC sequence로 직렬화해야 한다. 표시용으로만 사용하며, 정렬은 `executedAt + id`로 보장.

> **v2.0 mode 필드**: `MANUAL_QUICK` 모드의 TestRun은 stepResults가 비어 있으므로,
> 품질 보고서에서 "이 통과율의 근거가 무엇인가?"를 mode별로 설명할 수 있다.
> 예: "통과율 85% (Detailed 60건, Quick 30건, Automated 10건)".

### 5.5 TC Status Derivation from TestRun (v2.0: 2축)

```typescript
/**
 * v2.0: derivedStatus is computed from 2-axis (definitionStatus + lastOutcome).
 * Server-side only -- front-end receives derivedStatus as READ-ONLY.
 */
function deriveTestCaseStatus(
  definitionStatus: DefinitionStatus,
  lastOutcome: LastOutcome
): DerivedStatus {
  // Axis 1 overrides: DRAFT and DEPRECATED have fixed derivedStatus
  if (definitionStatus === "DRAFT") return "DRAFT";
  if (definitionStatus === "DEPRECATED") return "DEPRECATED";

  // Axis 2: READY + lastOutcome combination
  switch (lastOutcome) {
    case "NOT_RUN":  return "READY";     // READY + never executed
    case "PASSED":   return "PASSED";
    case "FAILED":   return "FAILED";
    case "BLOCKED":  return "BLOCKED";
    case "SKIPPED":  return "SKIPPED";
  }
}

/**
 * v2.0: When a TestRun is recorded, update lastOutcome.
 * definitionStatus must be READY -- otherwise reject with structured error.
 */
function onTestRunRecorded(
  tc: TestCase,
  run: TestRunSnapshot
): TestCase {
  if (tc.definitionStatus !== "READY") {
    throw new ValidationError({
      error: "INVALID_STATE",
      message: `Cannot execute ${tc.definitionStatus} test case`,
      violations: [
        { field: "definitionStatus", reason: "MUST_BE_READY", actual: tc.definitionStatus },
      ],
    });
  }

  return {
    ...tc,
    lastOutcome: run.result,                    // Axis 2 updated
    derivedStatus: deriveTestCaseStatus("READY", run.result),
    lastRunId: run.id,
    lastRunAt: run.executedAt,
    lastRunBy: run.executedBy,
    totalRuns: tc.totalRuns + 1,
  };
}
```

> **v2.0 구조화된 검증 오류**: DRAFT/DEPRECATED TC에 Run 기록 요청이 들어오면
> 단순 `400 Bad Request`가 아닌 `violations[]` 배열을 포함한 응답을 반환한다.
> 프론트는 이 정보로 "이 TC는 아직 작성 중입니다. READY로 전환하세요." 같은 안내를 즉시 보여줄 수 있다.

### 5.6 Defect Linking (TC Failure -> Issue)

```
Test Execution Flow:
  1. QA executes TC-012, step 2 fails
  2. QA records TestRun with result=FAILED
  3. System prompts: "Create defect issue?"
  4. QA confirms -> Issue ISS-045 created with:
     - type: DEFECT
     - sourceTestCaseId: TC-012
     - sourceTestRunId: TRUN-005
     - failedStepNumber: 2
     - severity: derived from TC priority
  5. ISS-045 linked to TestRun TRUN-005
  6. TC-012 defects list updated

Defect -> Fix -> Re-test:
  1. Developer fixes ISS-045, marks RESOLVED
  2. QA re-executes TC-012, creates TestRun TRUN-006
  3. TRUN-006 result=PASSED
  4. TC-012 lastOutcome: FAILED -> PASSED, derivedStatus: FAILED -> PASSED
  5. ISS-045 can be marked CLOSED

v2.0 Defect creation failure recovery:
  1. TestRun TRUN-005 saved with defectCreateStatus="FAILED"
  2. UI shows warning: "TestRun saved, but defect creation failed"
  3. QA clicks [Retry Create Defect] on TRUN-005
  4. POST /api/tests/TC-012/runs/TRUN-005/retry-defect
     - Idempotency key: runId + failedStepNumber (prevents duplicates)
     - On success: defectCreateStatus -> "CREATED", linkedIssueIds updated
     - On duplicate: returns existing Issue ID (idempotent)
  5. If retry also fails: manual Issue creation via Issues screen
```

---

## 6. 데이터 구조 / API

### 6.1 TestSuite Entity

```typescript
interface TestSuite {
  id: string;                          // TS-001
  projectId: string;
  name: string;                        // "Claim Processing Suite"
  description?: string;
  type: "FUNCTIONAL" | "INTEGRATION" | "REGRESSION" | "UAT" | "PERFORMANCE" | "SECURITY";

  // Lifecycle (v2.0: COMPLETED removed -- completion is stats-derived)
  status: "DRAFT" | "ACTIVE" | "ARCHIVED";

  // Ownership
  ownerId: string;                     // QA Lead / PM
  assigneeIds: string[];               // QA engineers assigned to this suite

  // Scope
  phaseId?: string;                    // Linked phase
  sprintId?: string;                   // Linked sprint (if sprint-scoped)

  // Stats (server-computed, read-only)
  totalTestCases: number;
  passedCount: number;
  failedCount: number;
  blockedCount: number;
  skippedCount: number;
  notRunCount: number;
  passRate: number;                    // 0~100

  // Metadata
  createdAt: string;
  updatedAt: string;
  createdBy: string;
}
```

### 6.2 TestCase Entity

```typescript
interface TestCase {
  id: string;                          // TC-012
  projectId: string;
  suiteId: string;                     // TS-001

  // Basic info
  name: string;                        // "Claim validation test"
  description?: string;
  type: "UNIT" | "INTEGRATION" | "ACCEPTANCE" | "REGRESSION" | "SMOKE" | "EXPLORATORY";
  priority: "CRITICAL" | "HIGH" | "MEDIUM" | "LOW";

  // v2.0: 2-axis status model
  /** Axis 1: Definition lifecycle (explicit transition by PM/QA) */
  definitionStatus: "DRAFT" | "READY" | "DEPRECATED";
  /** Axis 2: Last execution outcome (auto-derived from latest TestRun) */
  lastOutcome: "NOT_RUN" | "PASSED" | "FAILED" | "BLOCKED" | "SKIPPED";
  /** Combined display status (server-computed, READ-ONLY) */
  derivedStatus: "DRAFT" | "READY" | "PASSED" | "FAILED" | "BLOCKED" | "SKIPPED" | "DEPRECATED";

  // Test definition
  preconditions: string[];
  testSteps: {
    stepNumber: number;
    action: string;
    expectedResult: string;
  }[];
  postconditions?: string[];

  // Trace links
  linkedRequirementIds: string[];      // REQ-034, REQ-041
  linkedStoryIds: string[];            // S-88, S-92

  // Assignment
  assigneeId?: string;                 // QA engineer

  // Execution summary (server-computed)
  totalRuns: number;
  lastRunId?: string;                  // Latest TestRun ID
  lastRunResult?: "PASSED" | "FAILED" | "BLOCKED" | "SKIPPED";
  lastRunAt?: string;                  // ISO 8601
  lastRunBy?: string;                  // Executor user ID

  // Defect links (server-computed)
  linkedIssueIds: string[];            // ISS-045, ISS-031
  openDefectCount: number;

  // Tags
  tags?: string[];                     // "regression", "smoke", "p1"

  // Metadata
  createdAt: string;
  updatedAt: string;
  createdBy: string;
}
```

### 6.3 TestRun Entity

```typescript
// See Section 5.4 TestRunSnapshot for full definition
// TestRun is immutable after creation
```

### 6.4 Coverage Calculation

#### 6.4.1 Requirement Coverage

```typescript
interface RequirementCoverage {
  /** Total requirements in scope */
  totalRequirements: number;
  /** Requirements with at least 1 linked TC */
  coveredRequirements: number;
  /** Requirements with all linked TCs passed */
  passedRequirements: number;
  /**
   * v2.0: Coverage 2단계 분리
   * linkCoverageRate: 링크 존재 여부 기반 (coveredRequirements / totalRequirements * 100)
   * passCoverageRate: 해당 요구사항에 연결된 TC가 모두 PASS인 비율
   * UI에서 반드시 두 값을 동시 표시: "링크 커버리지 85% / 통과 커버리지 62%"
   */
  linkCoverageRate: number;            // 0~100
  passCoverageRate: number;            // 0~100
  /** Uncovered requirement IDs */
  uncoveredRequirementIds: string[];
}
```

#### 6.4.2 Story Coverage

```typescript
interface StoryCoverage {
  /** Total stories in scope */
  totalStories: number;
  /** Stories with at least 1 linked TC */
  coveredStories: number;
  /** Stories with all linked TCs passed */
  passedStories: number;
  /** v2.0: 2단계 분리 (RequirementCoverage와 동일 패턴) */
  linkCoverageRate: number;            // 0~100
  passCoverageRate: number;            // 0~100
  /** Uncovered story IDs */
  uncoveredStoryIds: string[];
}
```

#### 6.4.3 Combined Coverage Metric

```typescript
/**
 * v2.0: Coverage 2단계 -- link와 pass를 각각 가중 평균
 * UI에서는 두 값을 동시 표시해야 함:
 *   "링크 커버리지 85% / 통과 커버리지 62%"
 */
function calculateOverallCoverage(
  reqCoverage: RequirementCoverage,
  storyCoverage: StoryCoverage
): { linkCoverage: number; passCoverage: number } {
  // Weighted average: Requirements 60%, Stories 40%
  const reqWeight = 0.6;
  const storyWeight = 0.4;

  return {
    linkCoverage: (
      reqCoverage.linkCoverageRate * reqWeight +
      storyCoverage.linkCoverageRate * storyWeight
    ),
    passCoverage: (
      reqCoverage.passCoverageRate * reqWeight +
      storyCoverage.passCoverageRate * storyWeight
    ),
  };
}

/**
 * v2.0: Coverage scope definition -- API 응답에 포함하여 분모 정의 투명화
 * PM/QA/고객마다 "active requirement"가 다르게 해석되는 분쟁을 방지
 */
interface CoverageScope {
  requirementFilter: string;           // e.g., "status in (APPROVED, IN_PROGRESS)"
  storyFilter: string;                 // e.g., "status != DROPPED"
  asOf: string;                        // ISO 8601 timestamp
  projectId: string;
  phaseId?: string;
  sprintId?: string;
}
```

### 6.5 Test List API

```
GET /api/tests?projectId={projectId}
    &suiteId={suiteId}
    &definitionStatus={DRAFT|READY|DEPRECATED}
    &lastOutcome={PASSED|FAILED|BLOCKED|SKIPPED|NOT_RUN}
    &priority={CRITICAL|HIGH|MEDIUM|LOW}
    &assigneeId={assigneeId}
    &requirementId={requirementId}
    &storyId={storyId}
    &phaseId={phaseId}
    &view={coverage-gaps|default}
    &dateRange.from={ISO8601}
    &dateRange.to={ISO8601}
    &q={searchText}
    &page={page}&size={size}
```

> **Note**: Query parameters are **1:1 mapped** to Section 2.2 FilterSpec keys.
> v2.0: `status` → `definitionStatus` + `lastOutcome` 2축 분리.
> `view=coverage-gaps` 사용 시 Coverage gap 전용 뷰 데이터 반환.

```typescript
interface TestListResponse {
  items: TestCase[];
  pagination: { page: number; size: number; total: number };
  stats: {
    totalTestCases: number;
    // v2.0: 2축 분리 통계
    byDefinitionStatus: {
      draft: number;
      ready: number;
      deprecated: number;
    };
    byLastOutcome: {
      passed: number;
      failed: number;
      blocked: number;
      skipped: number;
      notRun: number;
    };
    passRate: number;                  // 0~100
    failCount: number;
    blockedCount: number;
    // v2.0: coverage 2단계 (link + pass)
    linkCoverageRate: number;          // 0~100 (linked Req/Story)
    passCoverageRate: number;          // 0~100 (all linked TCs passed)
    requirementLinkCoverage: number;   // 0~100
    requirementPassCoverage: number;   // 0~100
    storyLinkCoverage: number;         // 0~100
    storyPassCoverage: number;         // 0~100
    executionRate: number;             // 0~100 (executed / total)
    regressionPassRate: number;        // 0~100 (regression suite only)
  };

  // Suites reference (for filter dropdown)
  availableSuites: {
    id: string;
    name: string;
    testCaseCount: number;
  }[];

  // v2.0: Reliability 3-tuple (standardized)
  asOf: string;
  completeness: {
    overall: number;
    breakdown?: Record<string, number>;
  };
  warnings: { code: string; message: string; severity: "info" | "warn" | "critical" }[];

  // v2.0: Scope echo
  scope: { projectId: string };
}
```

### 6.6 Test Detail API

```
GET /api/tests/:testCaseId
```

```typescript
interface TestDetailResponse {
  testCase: TestCase;

  // Suite info
  suite: {
    id: string;
    name: string;
    type: string;
    status: string;
  };

  // Linked entities (enriched)
  linkedRequirements: {
    id: string;
    title: string;
    acceptance: "Y" | "X" | "pending";
  }[];
  linkedStories: {
    id: string;
    title: string;
    status: string;
    epicId: string;
    epicTitle: string;
  }[];
  linkedIssues: {
    id: string;
    title: string;
    status: string;
    severity: string;
    createdAt: string;
  }[];

  // Recent runs (last 10)
  recentRuns: TestRunSnapshot[];

  // Pass rate trend (last 10 runs)
  passRateTrend: {
    runNumber: number;
    result: "PASSED" | "FAILED" | "BLOCKED" | "SKIPPED";
    executedAt: string;
  }[];

  // v2.0: Reliability 3-tuple (standardized)
  asOf: string;
  completeness: {
    overall: number;
    breakdown?: Record<string, number>;
  };
  warnings: { code: string; message: string; severity: "info" | "warn" | "critical" }[];

  // v2.0: Scope echo
  scope: { projectId: string };
}
```

### 6.7 Test Run History API

```
GET /api/tests/:testCaseId/runs?page={page}&size={size}
```

```typescript
interface TestRunListResponse {
  items: TestRunSnapshot[];
  pagination: { page: number; size: number; total: number };
  stats: {
    totalRuns: number;
    passedRuns: number;
    failedRuns: number;
    averageDuration: number;           // Seconds
    passRateLast5: number;             // Pass rate of last 5 runs
    passRateLast10: number;            // Pass rate of last 10 runs
    // v2.0: mode-based breakdown
    byMode: {
      manualDetailed: number;
      manualQuick: number;
      automated: number;
    };
  };

  // v2.0: Reliability 3-tuple (standardized)
  asOf: string;
  completeness: {
    overall: number;
    breakdown?: Record<string, number>;
  };
  warnings: { code: string; message: string; severity: "info" | "warn" | "critical" }[];

  // v2.0: Scope echo
  scope: { projectId: string };
}
```

### 6.8 Test Execution API (Record TestRun)

```
POST /api/tests/:testCaseId/runs
```

```typescript
interface RecordTestRunRequest {
  /** v2.0: Execution mode -- determines evidence quality level */
  mode: "MANUAL_DETAILED" | "MANUAL_QUICK" | "AUTOMATED";
  result: "PASSED" | "FAILED" | "BLOCKED" | "SKIPPED";
  environment: TestEnvironment;
  duration?: number;                   // Seconds
  /** Required for MANUAL_DETAILED, empty for MANUAL_QUICK/AUTOMATED */
  stepResults: {
    stepNumber: number;
    actualResult: string;
    status: "PASS" | "FAIL" | "SKIP" | "BLOCKED";
    screenshot?: string;
    note?: string;
  }[];
  notes?: string;
  attachments?: string[];
  linkedIssueIds?: string[];           // Existing issues to link
  createDefect?: {                     // Auto-create defect issue
    title: string;
    description: string;
    severity: "CRITICAL" | "HIGH" | "MEDIUM" | "LOW";
    failedStepNumber: number;
  };
}

interface RecordTestRunResponse {
  run: TestRunSnapshot;
  testCaseTransition: {
    /** v2.0: 2-axis transition tracking */
    previousDefinitionStatus: DefinitionStatus;
    previousLastOutcome: LastOutcome;
    previousDerivedStatus: DerivedStatus;
    newLastOutcome: LastOutcome;
    newDerivedStatus: DerivedStatus;
  };
  createdIssue?: {                     // If createDefect was provided
    id: string;
    title: string;
  };
  /** v2.0: defect creation result tracking */
  defectCreateStatus: "NONE" | "CREATED" | "FAILED";
  defectCreateError?: string;

  // v2.0: Scope echo
  scope: { projectId: string };
}

/**
 * v2.0: Structured validation error response (400)
 * Returned when TC is not in READY state, or other validation failures.
 */
interface TestExecutionValidationError {
  error: "INVALID_STATE" | "VALIDATION_FAILED";
  message: string;
  violations: {
    field: string;
    reason: string;
    expected?: string | number;
    actual?: string | number;
  }[];
}
```

### 6.9 Bulk Quick Run API (v2.0: QuickRun 분리)

> **v2.0 변경**: "Bulk Execute"를 "Bulk Quick Run"으로 명칭 변경.
> 이 API는 `mode: "MANUAL_QUICK"`으로 고정되며, stepResults 없이 결과만 일괄 기록한다.
> Step-by-step 실행(MANUAL_DETAILED)과 구분하여 품질 보고서에서 근거 수준을 식별할 수 있다.

```
POST /api/tests/bulk-quick-run
```

```typescript
interface BulkQuickRunRequest {
  testCaseIds: string[];
  result: "PASSED" | "FAILED" | "BLOCKED" | "SKIPPED";
  environment: TestEnvironment;
  notes?: string;
  // mode is implicitly "MANUAL_QUICK" -- not user-settable
}

interface BulkQuickRunResponse {
  results: {
    testCaseId: string;
    runId: string;
    /** v2.0: 2-axis transition */
    previousDerivedStatus: DerivedStatus;
    newDerivedStatus: DerivedStatus;
    success: boolean;
    error?: string;
  }[];
  summary: {
    total: number;
    succeeded: number;
    failed: number;
  };

  // v2.0: Scope echo
  scope: { projectId: string };
}
```

### 6.10 Coverage API

```
GET /api/tests/coverage?projectId={projectId}&phaseId={phaseId}
```

```typescript
interface CoverageResponse {
  requirementCoverage: RequirementCoverage;
  storyCoverage: StoryCoverage;
  /** v2.0: 2단계 overall coverage */
  overallLinkCoverage: number;         // weighted link coverage
  overallPassCoverage: number;         // weighted pass coverage

  /**
   * v2.0: Coverage scope definition -- 분모 정의 투명화
   * 이 필드가 없으면 PM/QA/고객마다 "active requirement"를 다르게 해석하여 분쟁 발생
   */
  coverageScope: CoverageScope;

  // Gap analysis
  coverageGaps: {
    uncoveredRequirements: {
      id: string;
      title: string;
      priority: string;
    }[];
    uncoveredStories: {
      id: string;
      title: string;
      epicId: string;
      epicTitle: string;
    }[];
    partiallyTestedRequirements: {
      id: string;
      title: string;
      totalTCs: number;
      passedTCs: number;
      failedTCs: number;
    }[];
  };

  // Coverage by suite
  coverageBySuite: {
    suiteId: string;
    suiteName: string;
    reqLinkCovered: number;
    reqPassCovered: number;
    storyLinkCovered: number;
    storyPassCovered: number;
  }[];

  // v2.0: Reliability 3-tuple (standardized)
  asOf: string;
  completeness: {
    overall: number;
    breakdown?: Record<string, number>;
  };
  warnings: { code: string; message: string; severity: "info" | "warn" | "critical" }[];

  // v2.0: Scope echo
  scope: { projectId: string };
}
```

### 6.11 Test Suite CRUD API

```
POST   /api/test-suites                       // Suite creation (cap: manage_tests)
GET    /api/test-suites?projectId={projectId} // Suite list (cap: view_tests)
GET    /api/test-suites/:suiteId              // Suite detail (cap: view_tests)
PATCH  /api/test-suites/:suiteId              // Suite update (cap: manage_tests)
DELETE /api/test-suites/:suiteId              // Suite delete (cap: manage_tests)
```

### 6.12 Test Case CRUD API

```
POST   /api/tests                             // TC creation (cap: manage_tests)
GET    /api/tests/:testCaseId                 // TC detail (cap: view_tests)
PATCH  /api/tests/:testCaseId                 // TC update (cap: manage_tests)
DELETE /api/tests/:testCaseId                 // TC delete (cap: manage_tests)
```

### 6.13 Test Stats API

```
GET /api/tests/stats?projectId={projectId}&phaseId={phaseId}
```

```typescript
interface TestStatsResponse {
  stats: {
    totalTestCases: number;
    passRate: number;
    failCount: number;
    blockedCount: number;
    /** v2.0: coverage 2단계 */
    linkCoverageRate: number;
    passCoverageRate: number;
    executionRate: number;
    regressionPassRate: number;

    // Trend (last 7 days)
    trend: {
      date: string;
      passRate: number;
      executedCount: number;
      failedCount: number;
    }[];

    // By priority
    byPriority: {
      priority: "CRITICAL" | "HIGH" | "MEDIUM" | "LOW";
      total: number;
      passed: number;
      failed: number;
      blocked: number;
      notRun: number;
    }[];

    // By suite
    bySuite: {
      suiteId: string;
      suiteName: string;
      total: number;
      passRate: number;
      executionRate: number;
    }[];

    /** v2.0: mode-based execution breakdown */
    byMode: {
      manualDetailed: number;
      manualQuick: number;
      automated: number;
    };
  };

  // v2.0: Reliability 3-tuple (standardized)
  asOf: string;
  completeness: {
    overall: number;
    breakdown?: Record<string, number>;
  };
  warnings: { code: string; message: string; severity: "info" | "warn" | "critical" }[];

  // v2.0: Scope echo
  scope: { projectId: string };
}
```

### 6.14 Defect Retry API (v2.0)

> **v2.0 신규**: TestRun 기록 시 결함 생성이 실패(`defectCreateStatus=FAILED`)한 경우 재시도 API.
> 멱등키(idempotency key) = `runId + failedStepNumber` → 중복 생성 방지.

```
POST /api/tests/:testCaseId/runs/:runId/retry-defect
```

```typescript
interface RetryDefectRequest {
  title: string;
  description: string;
  severity: "CRITICAL" | "HIGH" | "MEDIUM" | "LOW";
  failedStepNumber: number;
}

interface RetryDefectResponse {
  /** Created or already-existing Issue (idempotent) */
  issue: {
    id: string;
    title: string;
    isNew: boolean;                    // false if duplicate detected
  };
  /** Updated TestRun defect status */
  updatedDefectCreateStatus: "CREATED";

  // v2.0: Scope echo
  scope: { projectId: string };
}
```

> **멱등성 보장**: 동일 `runId + failedStepNumber` 조합으로 재요청 시,
> 기존 Issue를 반환하고 `isNew: false`로 표시. 새 Issue를 중복 생성하지 않음.

---

## 7. 컴포넌트 분해

### 7.1 폴더 구조

```
features/
  tests/
    pages/
      TestsPage.tsx                    <- List (ViewMode branch, table + filters)
      TestDetailPage.tsx               <- Detail (TC info + runs + trace)
    components/
      // List
      TestCaseTable.tsx                <- Main table with sortable/filterable columns
      TestFilters.tsx                  <- Filter bar (FilterSpec-based)
      TestKpiRow.tsx                   <- Top KPI card row
      TestSuiteSelector.tsx            <- Suite dropdown filter (enriched)
      CoverageChart.tsx                <- Coverage mini-chart (Req + Story)
      ExecutionProgressBar.tsx         <- Execution progress visualization

      // Detail
      TestCaseBasicInfo.tsx            <- Basic info card (name, priority, assignee, etc.)
      TestStepsList.tsx                <- Test steps display with step-level results
      TestLinkedItems.tsx              <- Linked Requirements, Stories, Issues
      PassRateTrendChart.tsx           <- Mini trend chart (last 10 runs sparkline)

      // Execution
      TestExecutionForm.tsx            <- Test execution form (step-by-step recording)
      TestStepExecutionRow.tsx         <- Individual step execution input
      TestResultRecorder.tsx           <- Final result + notes + attachments
      DefectCreateDialog.tsx           <- Quick defect issue creation from failed step
      BulkExecutionDialog.tsx          <- Bulk test execution modal

      // Right Panel
      TestPreviewPanel.tsx             <- panelMode: "preview" (quick TC info)
      TestHistoryPanel.tsx             <- panelMode: "history" (TestRun timeline)
      TestCoveragePanel.tsx            <- panelMode: "coverage" (linked Req/Story)
      TestExecutionPanel.tsx           <- panelMode: "execution" (execution form)
      TestRightPanel.tsx               <- panelMode branch rendering

      // TestRun
      TestRunCard.tsx                  <- Individual TestRun display card
      TestRunTimeline.tsx              <- Chronological TestRun timeline
      TestRunDiff.tsx                  <- Compare two TestRuns (step results diff)
      TestRunStepResult.tsx            <- Step-level result display

      // Coverage
      CoverageGapsList.tsx             <- Uncovered Req/Story list
      CoverageSummaryCard.tsx          <- Coverage summary (Req + Story rates)
      CoverageByModeChart.tsx          <- Coverage breakdown by suite/phase

      // Suite management
      TestSuiteList.tsx                <- Suite list (in Settings/sidebar)
      TestSuiteForm.tsx                <- Suite create/edit form
      TestSuiteStatusBadge.tsx         <- Suite lifecycle badge

      // Status badges
      TestCaseStatusBadge.tsx          <- TC status badge (6-value)
      TestRunResultBadge.tsx           <- TestRun result badge (4-value)
      TestPriorityBadge.tsx            <- Priority badge (shared)
      TestEnvironmentBadge.tsx         <- Environment badge (DEV/STAGING/PROD/UAT)

      // Modals
      TestCaseCreateModal.tsx          <- TC creation modal (steps editor)
      TestCaseEditModal.tsx            <- TC editing modal
      TestLinkRequirementDialog.tsx    <- Link TC to Requirement dialog
      TestLinkStoryDialog.tsx          <- Link TC to Story dialog

    api/
      testsApi.ts                      <- Test CRUD + execution API calls
      testSuitesApi.ts                 <- Suite CRUD API calls
      testCoverageApi.ts               <- Coverage API calls
    hooks/
      useTestList.ts                   <- List TanStack Query (filters + pagination)
      useTestDetail.ts                 <- Detail TanStack Query
      useTestRuns.ts                   <- TestRun history Query
      useTestStats.ts                  <- Stats Query (reliability included)
      useTestCoverage.ts               <- Coverage Query
      useTestSuites.ts                 <- Suite list Query
      useTestExecution.ts              <- Execution mutation (record TestRun)
      useBulkExecution.ts              <- Bulk execution mutation
      useTestPanelMode.ts              <- Right Panel mode state management
```

### 7.2 TestsPage.tsx ViewMode Branch

```typescript
function TestsPage() {
  const { viewMode } = useAccessContext();
  const { panelMode, setPanelMode } = useTestPanelMode(viewMode);
  const { userCaps } = useCapabilities();
  const isQA = userCaps.includes("manage_tests");

  // panelMode-based Right Panel component
  const rightPanelContent = useMemo(() => {
    switch (panelMode) {
      case "none":       return undefined;
      case "preview":    return <TestPreviewPanel />;
      case "history":    return <TestHistoryPanel />;
      case "coverage":   return <TestCoveragePanel />;
      case "execution":  return <TestExecutionPanel />;
      default:           return <TestPreviewPanel />;
    }
  }, [panelMode]);

  return (
    <PageLayout
      header={<TestPageHeader viewMode={viewMode} isQA={isQA} />}
      rightPanel={rightPanelContent}
      rightPanelDefault={PRESET_POLICIES[viewMode].ui.defaultRightPanel}
    >
      <TestKpiRow viewMode={viewMode} />
      <TestFilters
        viewMode={viewMode}
        filterSpec={testsNode.filterSpec}
      />
      <TestCaseTable
        viewMode={viewMode}
        columns={getColumnsForPreset(viewMode)}
        onRowSelect={(tc) => {
          if (viewMode === "EXEC_SUMMARY") return; // no panel
          setPanelMode("preview");
        }}
        onRowDoubleClick={(tc) => {
          navigate(`/tests/${tc.id}`);
        }}
        selectable={isQA}    // QA can select for bulk execution
      />
    </PageLayout>
  );
}
```

### 7.3 TestRightPanel.tsx -- panelMode Branch

```typescript
interface TestRightPanelProps {
  panelMode: TestPanelMode;
  selectedTestCase?: TestCase;
}

function TestRightPanel({
  panelMode,
  selectedTestCase,
}: TestRightPanelProps) {
  switch (panelMode) {
    case "none":
      return null;
    case "preview":
      return (
        <TestPreviewPanel testCaseId={selectedTestCase?.id} />
      );
    case "history":
      return (
        <TestHistoryPanel testCaseId={selectedTestCase?.id} />
      );
    case "coverage":
      return (
        <TestCoveragePanel testCaseId={selectedTestCase?.id} />
      );
    case "execution":
      return (
        <TestExecutionPanel testCaseId={selectedTestCase?.id} />
      );
  }
}
```

### 7.4 TestExecutionForm.tsx -- Core Execution UI

```typescript
interface TestExecutionFormProps {
  testCase: TestCase;
  onComplete: (result: RecordTestRunRequest) => void;
  onCancel: () => void;
}

/**
 * Step-by-step test execution form.
 * QA engineer walks through each test step, records actual results,
 * and submits final result with notes.
 *
 * Key features:
 * 1. Step-by-step navigation (Previous/Next/Skip)
 * 2. Inline actual result input per step
 * 3. Screenshot attachment per step
 * 4. Auto-derive overall result from step results
 * 5. Quick defect creation on step failure
 * 6. Environment selection
 * 7. Timer for duration tracking
 */
function TestExecutionForm({
  testCase,
  onComplete,
  onCancel,
}: TestExecutionFormProps) {
  const [currentStep, setCurrentStep] = useState(0);
  const [stepResults, setStepResults] = useState<StepResult[]>(
    testCase.testSteps.map(s => ({
      stepNumber: s.stepNumber,
      actualResult: "",
      status: "SKIP" as const,
    }))
  );
  const [environment, setEnvironment] = useState<TestEnvironment>("STAGING");
  const { elapsed, start, stop } = useTimer();

  useEffect(() => { start(); }, []);

  const handleStepComplete = (stepResult: StepResult) => {
    setStepResults(prev =>
      prev.map(s => s.stepNumber === stepResult.stepNumber ? stepResult : s)
    );
    if (currentStep < testCase.testSteps.length - 1) {
      setCurrentStep(prev => prev + 1);
    }
  };

  const handleSubmit = () => {
    stop();
    const hasFailure = stepResults.some(s => s.status === "FAIL");
    const hasBlocked = stepResults.some(s => s.status === "BLOCKED");

    const result = hasBlocked ? "BLOCKED"
      : hasFailure ? "FAILED"
      : "PASSED";

    onComplete({
      result,
      environment,
      duration: elapsed,
      stepResults,
      // ... notes, attachments
    });
  };

  // ... render step-by-step UI
}
```

---

## 8. AI Navigation 연동

### 8.1 virtualNode Priority Return Policy

> AI returns **virtualId first** when possible.
> virtualId-based deep links have lower parameter error risk and provide
> "meaningful business concept" navigation to users.

```typescript
/** AI virtualNode matching priority */
const TEST_VIRTUAL_NODE_PRIORITY: {
  virtualId: string;
  matchFilter: Partial<TestFilterSpec>;
}[] = [
  { virtualId: "tests.failed",       matchFilter: { lastOutcome: "FAILED" } },
  { virtualId: "tests.blocked",      matchFilter: { lastOutcome: "BLOCKED" } },
  { virtualId: "tests.not-run",      matchFilter: { lastOutcome: "NOT_RUN" } },
  { virtualId: "tests.regression",   matchFilter: { suiteId: "regression" } },
  { virtualId: "tests.low-coverage", matchFilter: { view: "coverage-gaps" } },  // v2.0: view key
];

function resolveTestNavigation(
  filter: TestFilterSpec
): AiTestNavigation {
  // 1. virtualNode match attempt (priority)
  for (const vn of TEST_VIRTUAL_NODE_PRIORITY) {
    if (isSubsetMatch(vn.matchFilter, filter)) {
      return {
        targetNodeId: "tests",
        virtualId: vn.virtualId,
        filter,
        reason: "...",
      };
    }
  }
  // 2. No match -> raw filter return
  return { targetNodeId: "tests", filter, reason: "..." };
}
```

### 8.2 AI Questions -> Navigation (FilterSpec + virtualId)

```typescript
/** AI navigation recommendation */
interface AiTestNavigation {
  targetNodeId: "tests";
  /** virtualNode priority return */
  virtualId?: string;
  /** FilterSpec-based filter object */
  filter: TestFilterSpec;
  /** Direct entity navigation */
  entityId?: string;                   // "TC-012"
  reason: string;                      // "12 failed TCs require triage"
}
```

| Question | AI Return filter | virtualId? | Description |
|----------|-----------------|-----------|-------------|
| "Failed tests?" | `{ lastOutcome: "FAILED" }` | `tests.failed` | virtualId priority |
| "Blocked tests?" | `{ lastOutcome: "BLOCKED" }` | `tests.blocked` | virtualId priority |
| "Not-run tests?" | `{ lastOutcome: "NOT_RUN" }` | `tests.not-run` | virtualId priority |
| "Regression results?" | `{ suiteId: "regression" }` | `tests.regression` | virtualId priority |
| "Coverage gaps?" | `{ view: "coverage-gaps" }` | `tests.low-coverage` | v2.0: view key in FilterSpec |
| "TC-012 details?" | `entityId: "TC-012"` | -- | Direct navigation |
| "CRITICAL tests?" | `{ priority: "CRITICAL" }` | -- | raw filter |
| "QA Kim's tests?" | `{ assigneeId: "qa-kim" }` | -- | raw filter |
| "REQ-034 TCs?" | `{ requirementId: "REQ-034" }` | -- | raw filter |
| "Sprint-5 tests?" | `{ phaseId: "..." }` | -- | raw filter |

### 8.3 FilterSpec -> URL Conversion Utility

```typescript
function testFilterSpecToUrl(
  filter: TestFilterSpec,
  entityId?: string
): string {
  if (entityId) return `/tests/${entityId}`;

  const params = new URLSearchParams();
  for (const [key, value] of Object.entries(filter)) {
    if (value === undefined || value === null) continue;
    if (key === "dateRange" && typeof value === "object") {
      if (value.from) params.set("dateRange.from", value.from);
      if (value.to) params.set("dateRange.to", value.to);
    } else {
      params.set(key, String(value));
    }
  }
  return `/tests?${params.toString()}`;
}
```

### 8.4 Trace Chain Integration

The test management screen is a key node in the Trace Chain:

```
Requirement (REQ-034)
    |
    +-> Epic (E-12) -> Story (S-88)
                           |
                           +-> TestCase (TC-012) <-- THIS SCREEN
                                   |
                                   +-> TestRun (TRUN-005)
                                          |
                                          +-> Issue (ISS-045) -- Defect
```

**Cross-screen navigation from Trace Panel**:

```
-- Recommended Actions from Test Detail -----
!! TC-012 latest run FAILED (TRUN-005)
  -> [View Defect ISS-045]     <- targetNodeId: "issues", entityId: "ISS-045"

!! REQ-034 partially covered (1/2 TC failed)
  -> [View Requirement]        <- targetNodeId: "requirements", entityId: "REQ-034"

(i) S-88 linked to this TC
  -> [View in Backlog]         <- targetNodeId: "backlog", entityId: "S-88"

!! Coverage gap: REQ-041 has no linked TC
  -> [Create TC for REQ-041]   <- targetNodeId: "tests", action: "create", linkedReqId: "REQ-041"
```

### 8.5 Preset-specific do intent routing

```typescript
/** Preset-specific do intent routing for test actions */
export const TEST_DO_INTENT_ROUTING: Record<ViewModePreset, Record<string, string>> = {
  PM_WORK: {
    do_create_test_case:   "tests",
    do_execute_test:       "tests",
    do_link_defect:        "issues",
    do_export_test_report: "reports",
  },
  PMO_CONTROL: {
    do_create_test_case:   "tests",
    do_execute_test:       "tests",
    do_link_defect:        "issues",
    do_export_test_report: "reports",
  },
  DEV_EXECUTION: {
    do_create_test_case:   "tests",
    do_execute_test:       "tests",
    do_link_defect:        "issues",
    do_export_test_report: "tests",     // QA stays on tests
  },
  EXEC_SUMMARY: {
    do_create_test_case:   "tests",
    do_export_test_report: "reports",
  },
  CUSTOMER_APPROVAL: {
    do_export_test_report: "reports",
  },
};
```

---

## 9. 인터랙션 상세

### 9.1 테이블 행 클릭

```
Row single click -> panelMode-based Right Panel content change
  EXEC_SUMMARY:            panelMode="none" -> no change
  PM_WORK / PMO_CONTROL:   panelMode="preview" -> TC Quick Preview
  DEV_EXECUTION (QA):      panelMode="preview" -> TC Quick Preview
  DEV_EXECUTION (DEV):     panelMode="preview" -> TC Quick Preview (read-only)
  CUSTOMER_APPROVAL:       panelMode="preview" -> TC Quick Preview (read-only)

Row double click -> /tests/:testCaseId detail page
```

### 9.2 Test Execution Flow (QA)

```
1. QA selects TC in list (or navigates to detail page)
2. QA clicks [Execute] button (cap: manage_tests)
3. panelMode switches to "execution"
   -> TestExecutionForm loads in Right Panel (or full detail page)
4. QA walks through each test step:
   a. Read action description
   b. Perform the action
   c. Record actual result
   d. Mark step as PASS/FAIL/SKIP/BLOCKED
   e. Optionally attach screenshot
   f. If FAIL: option to [Create Defect] inline
5. After all steps, QA selects environment and adds notes
6. QA clicks [Submit Result]
7. Server transaction:
   a. Creates TestRun (immutable)
   b. Updates TC status based on result
   c. If defect created: creates Issue, links to TestRun
8. panelMode switches to "history"
   -> Shows updated TestRun timeline
```

### 9.3 Bulk Quick Run (v2.0: QuickRun 분리)

> **v2.0**: "Bulk Execute" → "Bulk Quick Run"으로 명칭 변경.
> `mode: "MANUAL_QUICK"` 고정, stepResults 없이 결과만 일괄 기록.

```
1. QA selects multiple TCs via checkboxes (cap: manage_tests)
2. QA clicks [Quick Run] in toolbar
3. BulkQuickRunDialog opens:
   - Shows selected TC list
   - Environment selector
   - Result selector (PASSED/FAILED/BLOCKED/SKIPPED)
   - Notes (shared across all)
   - (!) "Quick Run: step-level results not recorded" notice
4. QA clicks [Record All]
5. Server processes each TC:
   - Creates TestRun with mode="MANUAL_QUICK" for each
   - Updates each TC lastOutcome + derivedStatus
   - Returns per-TC results
6. Dialog shows results summary:
   - X succeeded, Y failed
   - Failed items with error messages
   - (!) Quick Run badge on each recorded TestRun
```

### 9.4 Defect Linking from Failed Test

```
1. TC-012 Step 2 marked as FAIL
2. [Create Defect] button appears next to failed step
3. QA clicks -> DefectCreateDialog opens:
   - Pre-filled title: "TC-012 Step 2: [expected] -> [actual]"
   - Pre-filled description from step details
   - Severity: derived from TC priority
   - Source: TC-012, TRUN-005, Step 2
4. QA adjusts and confirms
5. Server creates Issue (type: DEFECT)
   - Links to TC-012 and TRUN-005
   - Auto-assigns based on Story's developer
6. Issue ID shown in TestRun and TC detail
```

### 9.5 KPI Card Click -> Filter Activation

```typescript
/** KPI card click -> filter activation mapping */
const TEST_KPI_CARD_FILTER_MAP: Record<string, {
  filter: Partial<TestFilterSpec>;
  virtualId?: string;
}> = {
  KPI_TOTAL:      { filter: {} },
  KPI_PASS_RATE:  { filter: { lastOutcome: "PASSED" } },
  KPI_FAIL:       { filter: { lastOutcome: "FAILED" }, virtualId: "tests.failed" },
  KPI_BLOCKED:    { filter: { lastOutcome: "BLOCKED" }, virtualId: "tests.blocked" },
  KPI_COVERAGE:   { filter: { view: "coverage-gaps" }, virtualId: "tests.low-coverage" },
  KPI_EXECUTION:  { filter: { lastOutcome: "NOT_RUN" }, virtualId: "tests.not-run" },
  KPI_REGRESSION: { filter: { suiteId: "regression" }, virtualId: "tests.regression" },
};
```

**Interaction flow**:

```
1. KPI card click
2. Look up filter from TEST_KPI_CARD_FILTER_MAP
3. Reset existing filters -> apply new filter
4. URL update (testFilterSpecToUrl)
5. Same card re-click -> filter deactivation (toggle behavior)
6. Active card highlighted with border + filter active icon
```

### 9.6 Trace Node Click (from Test Detail)

All navigation is **targetNodeId-based**.

```
Requirement node click -> targetNodeId: "requirements", entityId: reqId
Story node click -> targetNodeId: "backlog", entityId: storyId
Issue node click -> targetNodeId: "issues", entityId: issueId
TestRun node click -> scroll to TestRun timeline in current page
```

### 9.7 Data Refresh Policy (v2.0: Event-Based Refetch)

**Baseline refresh triggers**:

| Item | Trigger |
|------|---------|
| List | Page entry + filter change |
| TC Detail | Page entry |
| TestRun History | panelMode="history" entry (real-time, asOf included) |
| Coverage | Page entry (cache 5min) |
| Stats | Page entry (cache 5min) |
| Execution Form | On demand (no cache) |

**v2.0: Event-based forced refetch** (polling is supplementary only):

| Event | Refetch Target | Strategy |
|-------|---------------|----------|
| TestRun recorded (self) | TC detail + list row + stats + coverage | Optimistic update + 1x forced refetch |
| TestRun recorded (other QA) | List + stats | WebSocket event → 1x forced refetch |
| TC definitionStatus change | TC detail + list row | Optimistic update + 1x forced refetch |
| Defect created from TestRun | TC detail (defect links) + issues count | 1x forced refetch |
| Defect retry success | TC detail (defect links) | 1x forced refetch |
| Bulk QuickRun completed | List + stats + coverage | 1x forced refetch (batch) |

> **Optimistic update rule**: TestRun 기록 성공 시 프론트에서 즉시 `lastOutcome`/`derivedStatus`를
> 업데이트하고 (optimistic), 서버 응답으로 확정(confirm). 실패 시 rollback.

---

## 10. 반응형 대응

| Width | Table | Right Panel | Filter |
|-------|-------|-------------|--------|
| >=1440px | Full columns + inline priority/assignee | Right Panel (30%) | Inline |
| 1280px | Reduced columns (-3) | Drawer (toggle) | Inline |
| <=1024px | Card view conversion | Drawer (overlay) | Collapsible |
| <=768px | Card view (1 column) | Full Modal | Collapsible |

**Responsive column visibility**:

| Column | >=1440px | 1280px | <=1024px |
|--------|----------|--------|----------|
| ID | O | O | O |
| Name | O | O | O |
| Suite | O | O | - (in card) |
| Priority | O | O | badge |
| Status | O | O | badge |
| Result | O | O | badge |
| Assignee | O | - | - |
| Linked Req | O | - | - |
| Linked Story | O | - | - |
| Last Run Date | O | O | - |

---

## 11. 깨지기 쉬운 곳 체크리스트

> These 10 fragile points, if addressed, accelerate stabilization.

| # | Risk Point | Solution | Validation Method |
|---|-----------|----------|-------------------|
| 1 | **TC lastOutcome vs TestRun result desync** | lastOutcome is ALWAYS derived from latest TestRun via server transaction. Front-end cannot directly change lastOutcome. Server re-validates on every TestRun creation. | Record TestRun -> verify lastOutcome matches. Attempt direct lastOutcome PATCH -> verify server rejection (400). Check lastOutcome after TestRun rollback. |
| 2 | **Immutable TestRun enforcement** | TestRun has no PATCH/DELETE endpoint. Database uses INSERT-only pattern with no UPDATE trigger. All corrections create new TestRun records. | Attempt PATCH/DELETE on TestRun endpoint -> verify 405. Check database constraints prevent UPDATE on test_runs table. |
| 3 | **Coverage calculation accuracy** | Coverage rate uses `requirement_trace_links` table (same source as Requirements Trace Chain). Denominator is "total active requirements" (not all requirements). Zero denominator returns 0% with warning. | Create Requirement without TC -> verify uncovered. Link TC to Requirement -> verify coverage increases. Delete Requirement -> verify coverage recalculates. Test with 0 total requirements -> verify 0% + warning. |
| 4 | **Bulk QuickRun atomicity** | Bulk QuickRun is NOT a single transaction (each TC is independent). Response includes per-TC success/failure. Front-end shows partial success state. Failed items can be retried. | Execute bulk with 10 TCs where 1 has DRAFT state -> verify 9 succeed + 1 fails with structured error. |
| 5 | **Defect linking consistency** | When TestRun creates a defect, Issue and TestRun link are created in same server transaction. If Issue creation fails, TestRun is saved with `defectCreateStatus=FAILED` + warning returned. Retry API available. | Create TestRun with defect -> verify both created. Simulate Issue service failure -> verify TestRun saved + defectCreateStatus=FAILED. Retry -> verify idempotent creation. |
| 6 | **definitionStatus vs lastOutcome 2축 정합성** | derivedStatus는 서버에서만 계산. 프론트는 derivedStatus를 표시만 하고 직접 변경 불가. definitionStatus 전환 시 lastOutcome은 변하지 않음(보존). | READY→DEPRECATED 전환 -> lastOutcome 유지 확인. DEPRECATED TC에 Run 기록 -> 400 + violations[] 확인. |
| 7 | **runNumber 동시성 충돌** | DB-level serialization (`SELECT max+1 FOR UPDATE` 또는 per-TC sequence). 표시용으로만 사용, 정렬은 `executedAt + id`로 보장. | 2명 QA가 같은 TC에 동시 Run 기록 -> runNumber 중복 없음 확인. |
| 8 | **Coverage linkCoverage vs passCoverage 혼동** | UI에서 반드시 두 값을 동시 표시. KPI는 linkCoverage 기준, 상세는 passCoverage 병행. 0건 분모 시 0% + warning. | TC 연결만 하고 실행 안 함 -> linkCoverage 증가, passCoverage 0% 확인. 전부 PASS -> 두 값 동일 확인. |
| 9 | **QuickRun mode 남용 방지** | mode별 통계 분리(byMode). 품질 보고서에서 mode 비율 표시. PM/PMO 프리셋에서 QuickRun 비율 경고 표시 가능. | Stats API에서 byMode 비율 확인. QuickRun 80% 이상 -> warning 반환 확인. |
| 10 | **ScopeEcho 불일치** | 모든 API 응답에 `scope: { projectId }` 포함. 프론트에서 요청 projectId와 응답 scope.projectId 일치 여부 검증. | API 응답의 scope.projectId가 요청 파라미터와 다를 경우 에러 처리 확인. |

---

## 12. Capability 매핑

### 12.1 Capability Summary

| Capability | Actions | Representative Roles |
|-----------|---------|---------------------|
| `view_tests` | View test list, TC detail, TestRun history, coverage, stats | ALL roles (scope varies by role) |
| `manage_tests` | Create/edit/delete TC, record TestRun, bulk execute, create test suite | PM, QA (DEV_EXECUTION preset with QA discipline) |
| `view_issues` | View linked defect issues | ALL (used for cross-navigation) |
| `manage_issues` | Create defect issue from failed test | PM, QA, DEV |
| `export_reports` | Export test report | PMO |
| `view_requirements` | View linked requirements | ALL (used for coverage analysis) |

### 12.2 Role-Capability Mapping

| Role | view_tests | manage_tests | Key Behavior | v2.0 비고 |
|------|-----------|-------------|-------------|----------|
| **Sponsor** | O (summary) | - | KPI only, no detail interaction | linkCoverage/passCoverage 요약만 표시 |
| **PMO** | O (full) | - | Quality metrics, reports, coverage oversight | byMode 통계 포함, QuickRun 비율 경고 |
| **PM** | O (full) | O | TC planning, coverage gap analysis, defect triage | definitionStatus 전환 권한 포함 |
| **DevReader** | O (team scope) | - | Team's test results read-only | view_tests only (read-only, no manage) |
| **DEV (non-QA)** | O (full) | - | Test results read-only, understand quality of own code | derivedStatus 배지만 표시 |
| **DEV (QA)** | O (full) | **O** | Full test execution, result recording, defect creation | QuickRun + DetailedRun 모두 가능 |
| **Customer PM** | O (summary) | - | Acceptance test results read-only | coverage 2단계 표시 (link + pass) |
| **External Auditor** | - | - | No access (uses Evidence Export) | - |

> **QA differentiation**: `manage_tests` is granted based on `discipline: "QA"`,
> not project role. A Developer with QA discipline gets full execution rights.
> This mirrors the menu matrix: "DEV (QA=RW)".

### 12.3 Preset-Capability-Action Matrix

```
+--------------------+------------------+----------------------------------+
| Preset             | Cap Required     | Available Actions                |
+--------------------+------------------+----------------------------------+
| PM_WORK            | manage_tests     | Create TC, Edit TC, Delete TC    |
|                    |                  | View Coverage Gaps               |
|                    |                  | Link Req/Story to TC             |
+--------------------+------------------+----------------------------------+
| PMO_CONTROL        | export_reports   | Export Test Report                |
|                    | view_issues      | View Defect Issues               |
+--------------------+------------------+----------------------------------+
| DEV_EXECUTION (QA) | manage_tests     | Execute Test, Record Result      |
|                    |                  | Bulk Execute, Create Defect      |
|                    |                  | Create TC, Edit TC               |
+--------------------+------------------+----------------------------------+
| DEV_EXECUTION(DEV) | (view only)      | (no write actions)               |
+--------------------+------------------+----------------------------------+
| EXEC_SUMMARY       | (view only)      | (no actions, KPI only)           |
+--------------------+------------------+----------------------------------+
| CUSTOMER_APPROVAL  | (view only)      | (read-only test results)         |
+--------------------+------------------+----------------------------------+
```

---

## 13. 테이블 컬럼 정의

### 13.1 전체 컬럼 (PM_WORK 기준)

| # | Column | Field | Width | Sort | Filter |
|---|--------|-------|-------|------|--------|
| 1 | TC ID | id | 100px | Y | - |
| 2 | Name | name | 200px | Y | Y (q) |
| 3 | Suite | suite.name | 120px | Y | Y (suiteId) |
| 4 | Type | type | 100px | - | - |
| 5 | Priority | priority | 80px | Y | Y |
| 6 | Status | derivedStatus | 90px | Y | Y (definitionStatus + lastOutcome) |
| 7 | Last Outcome | lastOutcome | 90px | Y | Y (lastOutcome) |
| 8 | Assignee | assigneeId | 100px | - | Y |
| 9 | Linked Req | linkedRequirementIds.length | 70px | Y | - |
| 10 | Linked Story | linkedStoryIds.length | 70px | Y | - |
| 11 | Last Run | lastRunAt | 100px | Y | Y (dateRange) |
| 12 | Run Count | totalRuns | 60px | Y | - |
| 13 | Open Defects | openDefectCount | 70px | Y | - |

### 13.2 Preset별 숨김 컬럼

| Preset | Hidden Columns |
|--------|---------------|
| EXEC_SUMMARY | #3, #4, #8, #9, #10, #12, #13 |
| PMO_CONTROL | #4, #8 |
| PM_WORK | (all visible) |
| DEV_EXECUTION | #4 |
| CUSTOMER_APPROVAL | #3, #4, #8, #10, #12 |

---

## 14. Test Execution Form Detail (Right Panel / Full Page)

### 14.1 Execution Form Layout

```
+--------------------------------------------------------------+
|  Test Execution: TC-012 Claim validation test                 |
|  Suite: Claim Suite  |  Priority: CRITICAL                   |
|  Environment: [ STAGING v ]                                   |
|  Timer: 04:32  (running...)                                  |
+--------------------------------------------------------------+
|                                                               |
|  +-- Preconditions (read-only) --+                            |
|  | [v] User logged in            |                            |
|  | [v] Claim form loaded         |                            |
|  +-------------------------------+                            |
|                                                               |
|  +-- Step 1 of 3 --------------------+                        |
|  | Action: Navigate to claim form     |                        |
|  | Expected: Form loads with fields   |                        |
|  |                                    |                        |
|  | Actual Result:                     |                        |
|  | [ Form loaded correctly________ ]  |                        |
|  |                                    |                        |
|  | Result: (o) PASS  ( ) FAIL         |                        |
|  |         ( ) SKIP  ( ) BLOCKED      |                        |
|  |                                    |                        |
|  | [+ Screenshot]  [+ Note]           |                        |
|  +------------------------------------+                        |
|                                                               |
|  +-- Step 2 of 3 (current) ----------+                        |
|  | Action: Enter invalid amount       |                        |
|  | Expected: Validation error shown   |                        |
|  |                                    |                        |
|  | Actual Result:                     |                        |
|  | [ No error displayed. Form allows  |                        |
|  |   submission with negative amt___ ]|                        |
|  |                                    |                        |
|  | Result: ( ) PASS  (o) FAIL  !!     |                        |
|  |         ( ) SKIP  ( ) BLOCKED      |                        |
|  |                                    |                        |
|  | [+ Screenshot]  [+ Note]           |                        |
|  | [!! Create Defect]  <- auto-create |                        |
|  +------------------------------------+                        |
|                                                               |
|  +-- Step 3 of 3 (pending) ----------+                        |
|  | Action: Submit form                |                        |
|  | Expected: Error prevents submit    |                        |
|  | (not yet executed)                 |                        |
|  +------------------------------------+                        |
|                                                               |
|  +-- Notes ---+                                               |
|  | [                                ]                         |
|  +-------------+                                              |
|                                                               |
|  [< Previous]  [Next >]  [Skip All]  [Submit Result]         |
|                                                               |
+---------------------------------------------------------------+
```

### 14.2 Auto-Result Derivation

```typescript
function deriveOverallResult(
  stepResults: { status: "PASS" | "FAIL" | "SKIP" | "BLOCKED" }[]
): "PASSED" | "FAILED" | "BLOCKED" | "SKIPPED" {
  if (stepResults.some(s => s.status === "BLOCKED")) return "BLOCKED";
  if (stepResults.some(s => s.status === "FAIL")) return "FAILED";
  if (stepResults.every(s => s.status === "SKIP")) return "SKIPPED";
  if (stepResults.every(s => s.status === "PASS" || s.status === "SKIP")) return "PASSED";
  return "FAILED"; // fallback
}
```

---

## 15. Coverage Analysis View

### 15.1 Coverage Gap Wireframe

```
+--------------------------------------------------------------+
|  Coverage Analysis                                            |
|                                                               |
|  +-- Overall Coverage (v2.0: 2-level) ---+  +-- By Type --+   |
|  |                                        |  |              |   |
|  | Requirements:                          |  | Functional:  |   |
|  |   Link:  85.3%  [=========>  ]         |  |  Link: 88%   |   |
|  |   Pass:  62.1%  [======>     ]         |  |  Pass: 71%   |   |
|  |                                        |  | Integration: |   |
|  | Stories:                               |  |  Link: 72%   |   |
|  |   Link:  83.1%  [========>   ]         |  |  Pass: 58%   |   |
|  |   Pass:  58.4%  [=====>      ]         |  | Regression:  |   |
|  |                                        |  |  Link: 94%   |   |
|  | Overall (weighted):                    |  |  Pass: 91%   |   |
|  |   Link:  84.4%  [=========> ]          |  |              |   |
|  |   Pass:  60.6%  [======>    ]          |  |              |   |
|  +----------------------------------------+  +--------------+   |
|                                                               |
|  +-- Uncovered Requirements (12) -----+                       |
|  |                                     |                       |
|  | REQ-041  Validation rules     HIGH  |                       |
|  |   -> [Create TC]                    |                       |
|  | REQ-055  Batch processing     MED   |                       |
|  |   -> [Create TC]                    |                       |
|  | REQ-072  Error handling       HIGH  |                       |
|  |   -> [Create TC]                    |                       |
|  | ...                                 |                       |
|  +-------------------------------------+                       |
|                                                               |
|  +-- Uncovered Stories (8) -----------+                        |
|  |                                     |                       |
|  | S-95  Batch claim processing  E-15  |                       |
|  |   -> [Create TC]                    |                       |
|  | S-103 Error notification      E-18  |                       |
|  |   -> [Create TC]                    |                       |
|  | ...                                 |                       |
|  +-------------------------------------+                       |
|                                                               |
|  +-- Partially Tested (5) ------------+                       |
|  |                                     |                       |
|  | REQ-034  Claim processing           |                       |
|  |   TCs: 2 total, 1 passed, 1 failed |                       |
|  |   -> [View TCs]                     |                       |
|  | ...                                 |                       |
|  +-------------------------------------+                       |
|                                                               |
+---------------------------------------------------------------+
```

---

## 16. DoD (본 화면 완료 기준)

- [ ] `/tests` list with Preset-specific column branching
- [ ] FilterSpec-based multi-dimensional filter (suiteId/status/priority/assigneeId/requirementId/storyId/phaseId/executionResult/dateRange/q)
- [ ] KPI Row: Total TC, Pass Rate, Fail Count, Blocked Count, Coverage Rate, Execution Rate, Regression Pass Rate
- [ ] panelMode-based Right Panel branching (none/preview/detail/execution/history/coverage)
- [ ] Row click -> panelMode-based Right Panel content change
- [ ] Row double click -> `/tests/:testCaseId` detail page navigation
- [ ] `/tests/:testCaseId` detail page with TC info + test steps + linked items
- [ ] TestCase derivedStatus badge (7-value: DRAFT/READY/PASSED/FAILED/BLOCKED/SKIPPED/DEPRECATED)
- [ ] derivedStatus = server-computed from (definitionStatus, lastOutcome) 2축 (front-end cannot override)
- [ ] **TestSuite lifecycle**: DRAFT -> ACTIVE -> ARCHIVED (COMPLETED 제거, stats 기반)
- [ ] **TestCase 2축 lifecycle**: definitionStatus(DRAFT→READY→DEPRECATED) + lastOutcome(NOT_RUN→PASSED/FAILED/BLOCKED/SKIPPED) → derivedStatus
- [ ] **TestRun immutability**: No PATCH/DELETE endpoints, INSERT-only database pattern
- [ ] **Test Execution Form**: Step-by-step recording with actual result, screenshot, note per step
- [ ] **Auto-result derivation**: Overall result derived from step-level results
- [ ] **Execution timer**: Duration tracking during test execution
- [ ] **Defect linking**: Failed step -> Create Defect inline -> Issue auto-linked to TestRun and TC
- [ ] **Bulk QuickRun**: Multi-select TCs -> bulk quick run (mode=MANUAL_QUICK) with shared result/environment
- [ ] **Bulk QuickRun partial success**: Per-TC results displayed, failed items retried
- [ ] **Coverage calculation**: Requirement coverage (60%) + Story coverage (40%) weighted
- [ ] **Coverage gap analysis**: Uncovered Requirements, uncovered Stories, partially tested Requirements
- [ ] **TestRun history timeline**: Chronological list of all executions per TC
- [ ] **Pass rate trend**: Sparkline chart of last 10 runs per TC
- [ ] **Trace Chain integration**: TC linked to Requirement -> Story, cross-navigation via targetNodeId
- [ ] **QA vs DEV differentiation**: QA (manage_tests) gets execution rights, DEV gets read-only
- [ ] PM_WORK: Create TC, link Req/Story, coverage gap analysis
- [ ] PMO_CONTROL: Quality metrics overview, test report export
- [ ] DEV_EXECUTION (QA): Full execution, result recording, defect creation
- [ ] DEV_EXECUTION (DEV): Read-only test results
- [ ] EXEC_SUMMARY: KPI only, no detail interaction
- [ ] CUSTOMER_APPROVAL: Read-only test results, acceptance test focus
- [ ] **virtualNode priority return**: failed/blocked/not-run/low-coverage/regression 5 virtualIds
- [ ] **KPI card click -> filter activation**: toggle behavior with queryMode transition
- [ ] **AI recommended actions**: FilterSpec + virtualId deep links + failed TC/coverage gap alerts
- [ ] **Preset-specific do intent routing**: PM->tests, PMO->reports, QA->tests
- [ ] **Responsive layout** (>=1440 / 1280 / <=1024 / <=768)

**v2.0 추가 DoD**

- [ ] TC 상태 2축 분리: `definitionStatus` + `lastOutcome` → `derivedStatus` 서버 계산
- [ ] FilterSpec `view` 키 추가: `coverage-gaps` 뷰가 FilterSpec 타입으로 포함
- [ ] FilterSpec 2축 반영: `definitionStatus` + `lastOutcome` 필터 (기존 `status`/`executionResult` 제거)
- [ ] Scope 2-tier: `securityKeys: ["projectId"]` (JWT) + `explorationKeys: [all filters]` (drill-down)
- [ ] ScopeEcho: 모든 API 응답에 `scope: { projectId }` 포함
- [ ] Reliability 3-tuple 표준화: `asOf` + `completeness: { overall, breakdown? }` + `warnings: { code, message, severity }[]`
- [ ] TestRun `mode` 필드: `MANUAL_DETAILED` / `MANUAL_QUICK` / `AUTOMATED` 구분
- [ ] Bulk QuickRun 분리: `POST /api/tests/bulk-quick-run` (mode=MANUAL_QUICK 고정)
- [ ] byMode 통계: Stats/RunHistory에서 mode별 실행 건수 분리 표시
- [ ] Coverage 2단계: `linkCoverageRate` + `passCoverageRate` 동시 표시
- [ ] CoverageScope: Coverage API에 분모 정의(`requirementFilter`, `storyFilter`) 포함
- [ ] Defect Retry API: `POST /api/tests/:tcId/runs/:runId/retry-defect` (멱등키: runId+stepNumber)
- [ ] `defectCreateStatus` 메타: TestRun에 `NONE`/`CREATED`/`FAILED` 상태 추적
- [ ] 구조화된 검증 오류: DRAFT/DEPRECATED TC 실행 시 `violations[]` 배열 반환
- [ ] Suite 상태 단순화: COMPLETED 제거, 완료율은 Stats에서 계산
- [ ] runNumber 동시성: DB-level serialization (per-TC sequence 또는 FOR UPDATE)
- [ ] Event-based refetch: TestRun 기록/결함 생성 등 이벤트 시 forced refetch + optimistic update
- [ ] 깨지기 쉬운 곳: 5→10개 확장 (2축 정합성, runNumber, coverage 2단계, QuickRun 남용, scopeEcho)

---

## 부록 A. 변경이력

| Version | Date | Changes |
|---------|------|---------|
| v1.0 | 2026-02-08 | Initial draft: 3-tier test lifecycle (Suite -> Case -> Run), TestCase 6-state model, TestRun immutable snapshot, Defect Linking workflow, Coverage calculation (Req 60% + Story 40%), FilterSpec with 10 keys, 5 virtualNodes, Preset-specific UI policies, Test Execution Form (step-by-step), Bulk Execution, AI Navigation with virtualId priority, 5 fragile spots checklist, Capability mapping (view_tests + manage_tests with QA discipline), Component decomposition, API specifications |
| v2.0 | 2026-02-08 | Cross-review: (1) TC 상태 2축 분리 (definitionStatus+lastOutcome→derivedStatus), (2) FilterSpec view 키 추가 (coverage-gaps 타입 불일치 해소), (3) ScopeEcho + Reliability 3-tuple 전 API 표준화, (4) runNumber 동시성 안전화, (5) 결함 생성 멱등/재시도 API (defectCreateStatus + retry endpoint), (6) Bulk→QuickRun 분리 + TestRun.mode, (7) Coverage 2단계 (linkCoverage/passCoverage), (8) Suite COMPLETED 제거 (stats 기반), (9) 구조화된 검증 오류 (violations[]), (10) 깨지기 쉬운 곳 5→10, (11) DoD v2.0 18항목 추가 |
