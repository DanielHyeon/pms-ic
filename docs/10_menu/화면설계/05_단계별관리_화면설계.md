# 05. 단계별관리(Phase Management) 화면설계

> 작성일: 2026-02-08
> 버전: v2.1
> 라우트: `/phases`, `/phases/:phaseId`
> 필요 Capability: `view_phases` (조회), `manage_phases` (편집/설정)
> 기본 Preset: 역할에 따라 자동 결정
> 노드 역할: **Detail** (상세 노드 -- 필터/조회/편차 분석 전용)

> **v2.0 변경**: Phase 상태 모델 확장 (PLANNED/ACTIVE/COMPLETED/CLOSED),
> TrackType 기반 AI/SI 분리 뷰, 조정 테이블(상태->원인->조치) 도입,
> 편차 분석 엔진(deviationThreshold), Phase hierarchy(parent_id self-FK) 집계,
> Health Summary Strip, Gantt 타임라인 뷰, Preset별 AI 라우팅 정책,
> FilterSpec 온톨로지 내장, Dependency Mini-Graph, Phase Settings 분리 라우트.

> **v2.1 변경**: HealthStatus(행동 트리거) vs DeviationGrade(원인 분석) 역할 분리,
> Preset Overlay(스택 가능한 컨텍스트) 설계 노트, Decision Record Lineage
> (Adjustment + GateReview + Decision 감사 계보 통합), Reliability 3-tuple 표준화
> (`warnings: {code, message, severity}[]`), ScopeEcho 보안 경계 세분화
> (`role_restricted_assignee` / `role_restricted_part`), Scope 2-tier
> (securityKeys + explorationKeys) 패턴 적용, AI do-intent 트리거 규칙
> (healthStatus 기준 전용).

---

## 1. 화면 개요

### 1.1 목적

단계별관리는 **"프로젝트 단계(Phase)가 지금 어떤 상태이고, 편차가 있다면 왜 생겼으며, 어떻게 조치할 것인가?"**에 대한 답을 제공한다.
기존 스프레드시트 기반의 단계별 현황 표를 **"상태->원인->조치" 3단 구조**로 전환하여, PM이 단계별 편차를 실시간으로 감지하고 즉시 조치할 수 있는 환경을 구축한다.

> **핵심 분리 원칙**: WBS는 **"작업을 어떻게 분해할 것인가"**(작업 분해 구조),
> Phase는 **"프로젝트가 시간 축 위에서 어디까지 왔는가"**(시간 기반 진행 관리).
> 두 엔티티는 Phase -> WbsGroup -> WbsItem -> WbsTask로 연결되며,
> 단계별관리 화면에서는 **시간 축 기반 진행 상태와 편차 분석**에 집중한다.

### 1.2 설계 원칙

| 원칙 | 설명 |
|------|------|
| **상태->원인->조치 3단 구조** | 단계 상태 파악, 편차 원인 확인, 조치 실행을 한 흐름으로 연결 |
| **Phase hierarchy** | `parent_id` self-FK로 상위 단계(AI부문/SI부문)가 하위 단계(분석/설계/개발...)를 포함 |
| **Track(트랙) = Layer** | ALL/AI/SI는 같은 Phase 위에서 수치/원인만 달라지는 레이어 |
| **Gantt 타임라인** | Phase를 시간 축 위에서 시각적으로 표현 (계획 vs 실적 비교) |
| **Health Summary 우선** | 테이블 앞에 상태 칩을 배치하여 위험 단계를 먼저 감지 |
| **편차 = 자동 계산** | 편차(Delta) = 실적% - 계획%, 임계값 초과 시 자동 경고 |
| **조정 테이블** | 편차 발생 시 원인/조치/담당/기한을 기록하는 감사 추적 가능 구조 |
| **FilterSpec = 온톨로지** | 필터 키가 AI/URL/백엔드 공통 스키마로 통합 |
| **Phase Settings = 분리 라우트** | 단계 정의/매핑은 `/phases/settings`에서 관리 (manage_phases Capability) |
| **HealthStatus = 행동 트리거** | Health 상태는 AI do-intent / Drawer 오픈 / 경고 알림의 유일한 기준. DeviationGrade는 원인 분석 보조 지표 |
| **Decision Lineage** | Adjustment + GateReview + StatusTransition이 동일한 감사 계보(lineage)에 속함 |

### 1.3 행동 무게중심 -- 3개 화면의 역할 분담

| 화면 | 역할 | 핵심 행동 |
|------|------|---------|
| **단계별관리** (본 화면) | **진행 상태 / 편차 분석 홈** | 단계 상태 확인, 편차 원인 분석, 조치 기록 |
| **WBS** | **작업 분해 / 일정 관리 홈** | WBS 트리 관리, 작업 기간/담당 설정 |
| **대시보드** | **전체 현황 허브** | Phase Timeline 위젯으로 요약 진입 |

**Preset별 AI 라우팅 정책 (ask_phase_status 예시)**:

| Preset | "단계 진행 상태 알려줘" -> AI 라우팅 | 이유 |
|--------|-------------------------------|------|
| PM_WORK | -> `targetNodeId: "phases"` | PM은 편차 분석 + 조치 실행 |
| PMO_CONTROL | -> `targetNodeId: "phases"` | PMO는 크로스 프로젝트 편차 모니터링 |
| DEV_EXECUTION | -> `targetNodeId: "phases"` | DEV는 현재 단계 확인 (읽기 전용) |
| EXEC_SUMMARY | -> `targetNodeId: "dashboard"` | Sponsor는 대시보드 Phase Timeline |
| CUSTOMER_APPROVAL | -> `targetNodeId: "phases"` | 고객 PM은 마일스톤 확인 |

```typescript
/** Preset별 do intent 라우팅 정책 */
export const PHASE_DO_INTENT_ROUTING: Record<ViewModePreset, Record<string, string>> = {
  PM_WORK: {
    do_update_phase:    "phases",      // 편차 조치 실행
    do_create_issue:    "issues",      // 이슈 에스컬레이션
    do_export_report:   "reports",     // 단계별 리포트 Export
  },
  PMO_CONTROL: {
    do_update_phase:    "phases",      // 크로스 프로젝트 조치
    do_create_issue:    "issues",
    do_export_report:   "reports",
  },
  DEV_EXECUTION: {
    do_update_phase:    "phases",      // 읽기 전용 (서버에서 cap 체크)
    do_create_issue:    "issues",
    do_export_report:   "reports",
  },
  EXEC_SUMMARY: {
    do_update_phase:    "phases",
    do_create_issue:    "issues",
    do_export_report:   "reports",
  },
  CUSTOMER_APPROVAL: {
    do_update_phase:    "phases",
    do_create_issue:    "issues",
    do_export_report:   "reports",
  },
};
```

### 1.4 핵심 질문 -> 위젯 매핑

| 사용자 질문 | 화면 영역 | 설명 |
|-----------|---------|------|
| "지금 어느 단계야?" | Health Summary Strip | 현재 ACTIVE 단계 강조 |
| "단계별 진행률이 어떻게 되지?" | Phase Table + Gantt | 계획%/실적%/편차 비교 |
| "편차가 심한 단계가 있어?" | KPI + Phase Table | deviationThreshold 초과 항목 경고 |
| "AI부문 진행 상태는?" | Track Toggle -> AI 필터 | AI 트랙 기준 수치 표시 |
| "설계 단계 상세 보여줘" | Drill-down Drawer | 원인/지연 Task/이슈/조치 기록 |
| "지연 원인이 뭐야?" | Drawer: 원인 탭 | CauseCards (Top 3 원인) |
| "편차 조치 기록 보여줘" | Drawer: 조치 기록 탭 | Timeline 스타일 조치 이력 |
| "단계 설정 변경해야 돼" | Phase Settings | `/phases/settings` (manage_phases) |
| "위험 단계가 몇 개야?" | 상단 KPI | critical_deviations 건수 |
| "단계간 의존성 관계는?" | Dependency Mini-Graph | 지연 전파 시각화 |

---

## 2. MenuOntology 노드

### 2.1 타입 확정 (v2.0 변경사항)

01_대시보드 / 02_요구사항 / 03_백로그 v2.0 패턴을 동일하게 적용한다.

| 항목 | v1.0 | v2.0 | v2.1 (확정) | 변경 사유 |
| ------ | ------ | ------ | ------------ | ---------- |
| `entities` | PascalCase | 동일 | 동일 | -- |
| `intents` | 5개 | **14개** 확장 | 동일 | 편차/트랙/조치/설정 질문 추가 |
| Capability | 2개 | **2개** | 동일 | 조회/편집 분리 충분 |
| `filterSpec` | 4키 | **7키** | 동일 | deviationThreshold/phaseType/dateRange 추가 |
| `virtualNodes` | 없음 | **4개** | 동일 | 위험단계/AI트랙/SI트랙/지연단계 |
| `metrics` | 4개 | **7개** | 동일 | 운영 KPI 3종 추가 |
| AI 라우팅 | 단일 | Preset별 분기 | + **do-intent healthStatus 전용 규칙** | DO_INTENT_ROUTING + 트리거 기준 명확화 |
| `nodeRole` | 없음 | `"detail"` | 동일 | AI 스코어링 기준 |
| `scope` | flat | 2키 | **securityKeys + explorationKeys** 분리 | WBS v1.1 Scope 2-tier 패턴 적용 |
| Reliability | 없음 | `warnings: string[]` | **`warnings: {code, message, severity}[]`** | 3-tuple 표준화 |
| ScopeEcho | 없음 | 3종 scopeReason | **4종** (assignee/part 분리) | 보안 경계 세분화 |
| Decision Lineage | 없음 | 없음 | **Adjustment + GateReview + Transition** | 감사 계보 통합 |

### 2.2 FilterSpec 정의

FilterSpec은 **이 화면이 지원하는 필터 스키마**를 온톨로지 내부에 선언한다.
AI가 딥링크를 생성할 때, URL 파라미터 문자열이 아니라 **FilterSpec 키 기반 필터 객체**를 반환한다.

```typescript
/** 단계별관리 필터 스키마 -- 온톨로지 내장 (v2.0) */
export interface PhaseFilterSpec {
  /** Phase 상태 */
  status?: "PLANNED" | "ACTIVE" | "COMPLETED" | "CLOSED";
  /** 트랙 유형 (AI/SI/COMMON) */
  phaseType?: "AI" | "SI" | "COMMON";
  /** Part(파트) 범위 */
  partId?: string;
  /** 기간 범위 (ISO 날짜) */
  dateRange?: {
    from?: string;  // ISO date string
    to?: string;    // ISO date string
  };
  /** 편차 임계값 -- 이 값 이상의 음수 편차만 표시 (e.g., -10) */
  deviationThreshold?: number;
  /** Health 상태 필터 */
  healthStatus?: "NORMAL" | "WARNING" | "CRITICAL" | "PAUSED";
  /** 자유 검색어 */
  q?: string;
}
```

> **Track(트랙)은 레이어**: `phaseType` 필터는 같은 Phase 목록 위에서
> AI/SI/COMMON 트랙 기준의 수치(계획%/실적%/편차)로 전환된다.
> Phase 목록 자체가 바뀌는 것이 아니라, **수치의 관점**이 바뀐다.

### 2.3 FilterSpec URL 직렬화 규칙

**직렬화 방향**: `PhaseFilterSpec -> URL query string -> PhaseFilterSpec` (왕복 보장)

```typescript
/** FilterSpec -> URL 직렬화 */
function serializePhaseFilter(filter: PhaseFilterSpec): URLSearchParams {
  const params = new URLSearchParams();
  for (const [key, value] of Object.entries(filter)) {
    if (value === undefined || value === null) continue;
    // dateRange 객체는 from/to로 분리
    if (key === "dateRange" && typeof value === "object") {
      if (value.from) params.set("from", value.from);
      if (value.to) params.set("to", value.to);
      continue;
    }
    // number: 문자열 변환
    if (typeof value === "number") {
      params.set(key, String(value));
      continue;
    }
    params.set(key, String(value));
  }
  return params;
}

/** URL -> FilterSpec 역직렬화 */
function deserializePhaseFilter(params: URLSearchParams): PhaseFilterSpec {
  const filter: PhaseFilterSpec = {};
  const enumKeys = {
    status: ["PLANNED", "ACTIVE", "COMPLETED", "CLOSED"],
    phaseType: ["AI", "SI", "COMMON"],
    healthStatus: ["NORMAL", "WARNING", "CRITICAL", "PAUSED"],
  } as const;

  for (const [key, value] of params.entries()) {
    // enum validation -- invalid value -> skip (silent drop)
    if (key in enumKeys) {
      if ((enumKeys as any)[key].includes(value)) {
        (filter as any)[key] = value;
      }
      continue;
    }
    // dateRange reconstruction
    if (key === "from" || key === "to") {
      if (!filter.dateRange) filter.dateRange = {};
      filter.dateRange[key] = value;
      continue;
    }
    // number keys
    if (key === "deviationThreshold") {
      const num = Number(value);
      if (!isNaN(num)) filter.deviationThreshold = num;
      continue;
    }
    // string keys (partId, q)
    if (["partId", "q"].includes(key)) {
      (filter as any)[key] = value;
    }
    // unknown keys -> silent drop (forward compatibility)
  }
  return filter;
}
```

**직렬화 규칙 요약**:

| 규칙 | 예시 | 설명 |
|------|------|------|
| enum은 화이트리스트 검증 | `?status=ACTIVE` | 유효하지 않은 값은 silent drop |
| dateRange는 from/to 분리 | `?from=2026-01-01&to=2026-06-30` | 중첩 객체 -> 플랫 파라미터 |
| number는 문자열 변환 | `?deviationThreshold=-10` | 역직렬화 시 Number() 파싱 |
| 미지 키는 무시 | `?futureKey=x` -> 무시 | 하위 호환성 보장 |

### 2.4 Phases 노드 (확정본 v2.1)

```typescript
const phasesNode: MenuOntologyNodeV2 = {
  nodeId: "phases",
  label: "단계(Phase)",
  route: "/phases",
  icon: "TimelineRounded",
  domain: "plan",
  nodeRole: "detail",              // detail node -- action/filter questions get +10 bonus

  requiredCaps: ["view_phases"],

  // --- intents: 14 ---
  intents: [
    // Ask category -- query/question
    "ask_phase_status",             // "단계 진행 상태 알려줘"
    "ask_progress",                 // "전체 진행률은?"
    "ask_phase_deviation",          // "편차가 심한 단계 있어?"
    "ask_phase_detail",             // "설계 단계 상세 보여줘"
    "ask_phase_cause",              // "지연 원인이 뭐야?"
    "ask_phase_action",             // "조치 기록 보여줘"
    "ask_phase_track",              // "AI부문 진행 상태는?"
    "ask_phase_dependency",         // "단계간 의존성 관계는?"
    "ask_phase_timeline",           // "전체 타임라인 보여줘"
    "ask_overdue_phases",           // "기한 초과 단계 있어?"
    // Do category -- action/change
    "do_update_phase",              // "단계 상태 업데이트해줘"
    "do_create_phase_action",       // "조치 사항 등록해줘"
    "do_create_issue",              // "이슈 등록해줘"
    "do_export_report",             // "단계별 리포트 Export 해줘"
  ],
  canonicalQuestions: [
    "지금 어느 단계까지 진행됐어?",
    "단계별 진행률 보여줘",
    "편차가 심한 단계가 있어?",
    "AI부문 설계 단계 현황은?",
    "지연 원인이 뭐야?",
    "단계별 편차 조치 기록 보여줘",
    "위험 단계가 몇 개야?",
    "단계간 의존성 관계 알려줘",
    "이번 분기 마일스톤 보여줘",
    "기한 초과된 단계 있어?",
    "Phase 타임라인 보여줘",
    "단계 설정 변경하고 싶어",
  ],
  entities: ["Phase", "Project", "Task", "Issue", "Part"],
  keywords: [
    "단계", "페이즈", "진행", "편차", "조치", "설계", "개발", "테스트",
    "이행", "안정화", "분석", "마일스톤", "타임라인", "진행률",
    "phase", "milestone", "timeline", "deviation", "progress",
    "AI부문", "SI부문", "트랙", "track", "gantt", "간트",
    "위험", "지연", "원인", "조정", "편차조치",
  ],
  metrics: [
    "phase_count",                   // 전체 단계 수
    "active_phases",                 // 현재 ACTIVE 단계 수
    "completion_rate",               // 완료 단계 비율
    "avg_deviation",                 // 평균 편차
    "overdue_phases",                // 기한 초과 단계 수
    "critical_deviations",           // 위험 편차 단계 수
    "health_score",                  // Phase 전체 건강도 점수
  ],

  // --- FilterSpec ontology embedded (v2.0) ---
  filterSpec: {
    keys: [
      "status", "phaseType", "partId", "dateRange",
      "deviationThreshold", "healthStatus", "q",
    ],
    defaults: {},  // Preset-overridable
  },

  defaultPreset: "PM_WORK",
  presetPolicies: [
    {
      preset: "EXEC_SUMMARY",
      ui: {
        density: "compact",
        defaultRightPanel: "closed",
        highlight: {
          metricKeys: ["completion_rate", "critical_deviations", "health_score"],
          widgetKeys: ["KPI_COMPLETION", "KPI_CRITICAL", "GANTT_COMPACT"],
        },
        hiddenColumns: ["partId", "primaryCause", "actionCount"],
      },
    },
    {
      preset: "PMO_CONTROL",
      ui: {
        density: "standard",
        defaultRightPanel: "open",
        highlight: {
          metricKeys: [
            "phase_count", "active_phases", "avg_deviation",
            "critical_deviations", "overdue_phases",
          ],
          widgetKeys: [
            "KPI_PHASES", "KPI_DEVIATION", "KPI_OVERDUE",
            "PHASE_TABLE", "GANTT_FULL", "DEPENDENCY_GRAPH",
          ],
        },
      },
      suggestedActions: [
        {
          key: "export_phase_report",
          label: "단계별 리포트 Export",
          requiredCaps: ["export_reports"],
          targetNodeId: "reports",
        },
        {
          key: "view_health_matrix",
          label: "Health Matrix",
          requiredCaps: ["view_pmo"],
          targetNodeId: "pmo-health",
        },
      ],
    },
    {
      preset: "PM_WORK",
      ui: {
        density: "detailed",
        defaultRightPanel: "open",
        highlight: {
          metricKeys: [
            "active_phases", "avg_deviation", "critical_deviations",
            "overdue_phases", "health_score",
          ],
          widgetKeys: [
            "KPI_ACTIVE", "KPI_DEVIATION", "KPI_CRITICAL",
            "KPI_OVERDUE", "HEALTH_STRIP", "PHASE_TABLE",
            "GANTT_FULL", "ADJUSTMENT_TABLE", "DEPENDENCY_GRAPH",
          ],
        },
      },
      suggestedActions: [
        {
          key: "update_phase",
          label: "단계 상태 변경",
          requiredCaps: ["manage_phases"],
          targetNodeId: "phases",
        },
        {
          key: "create_action",
          label: "조치 사항 등록",
          requiredCaps: ["manage_phases"],
          targetNodeId: "phases",
        },
        {
          key: "create_issue",
          label: "이슈 에스컬레이션",
          requiredCaps: ["manage_issues"],
          targetNodeId: "issues",
        },
        {
          key: "view_wbs",
          label: "WBS에서 확인",
          requiredCaps: ["view_wbs"],
          targetNodeId: "wbs",
        },
      ],
    },
    {
      preset: "DEV_EXECUTION",
      ui: {
        density: "standard",
        defaultRightPanel: "closed",
        highlight: {
          metricKeys: ["active_phases", "completion_rate"],
          widgetKeys: ["KPI_ACTIVE", "GANTT_COMPACT", "PHASE_TABLE"],
        },
        hiddenColumns: ["actionCount", "adjustmentSummary"],
      },
      suggestedActions: [
        {
          key: "go_kanban",
          label: "칸반 보드",
          requiredCaps: ["view_kanban"],
          targetNodeId: "kanban",
        },
        {
          key: "go_my_work",
          label: "내 작업",
          requiredCaps: ["view_my_work"],
          targetNodeId: "my-work",
        },
      ],
    },
    {
      preset: "CUSTOMER_APPROVAL",
      ui: {
        density: "compact",
        defaultRightPanel: "closed",
        highlight: {
          metricKeys: ["phase_count", "completion_rate", "active_phases"],
          widgetKeys: ["KPI_PHASES", "KPI_COMPLETION", "GANTT_MILESTONE"],
        },
        hiddenColumns: ["primaryCause", "actionCount", "adjustmentSummary", "partId"],
      },
    },
    // AUDIT_EVIDENCE removed -- auditors do not access Phase screen
  ],

  // --- DeepLink: routeTemplate standard (:param format) ---
  deepLinks: [
    {
      pattern: "/phases?status=:status",
      description: "상태별 Phase 필터",
      requiredParams: ["status"],
    },
    {
      pattern: "/phases?phaseType=:phaseType",
      description: "트랙별(AI/SI) Phase 필터",
      requiredParams: ["phaseType"],
    },
    {
      pattern: "/phases?healthStatus=:healthStatus",
      description: "Health 상태별 필터",
      requiredParams: ["healthStatus"],
    },
    {
      pattern: "/phases?deviationThreshold=:threshold",
      description: "편차 임계값 이상 필터",
      requiredParams: ["threshold"],
    },
    {
      pattern: "/phases/:phaseId",
      description: "Phase 상세 + Drill-down Drawer",
      requiredParams: ["phaseId"],
    },
  ],

  // --- Virtual nodes: deeplink promoted to ontology 2nd-tier nodes ---
  virtualNodes: [
    {
      virtualId: "phases.critical",
      label: "위험 단계",
      routeTemplate: "/phases?healthStatus=CRITICAL",
      requiredParams: [],
      intents: ["ask_phase_deviation", "ask_phase_status"],
      description: "CRITICAL 상태 단계 목록 -- 즉시 조치 필요 진입점",
    },
    {
      virtualId: "phases.ai-track",
      label: "AI부문 단계",
      routeTemplate: "/phases?phaseType=AI",
      requiredParams: [],
      intents: ["ask_phase_track", "ask_phase_status"],
      description: "AI 트랙 기준 단계 현황 진입점",
    },
    {
      virtualId: "phases.si-track",
      label: "SI부문 단계",
      routeTemplate: "/phases?phaseType=SI",
      requiredParams: [],
      intents: ["ask_phase_track", "ask_phase_status"],
      description: "SI 트랙 기준 단계 현황 진입점",
    },
    {
      virtualId: "phases.overdue",
      label: "기한 초과 단계",
      routeTemplate: "/phases?healthStatus=WARNING",
      requiredParams: [],
      intents: ["ask_overdue_phases"],
      description: "기한 초과 또는 편차 경고 단계 진입점",
    },
  ],

  // --- Scope 2-tier separation (v2.1: securityKeys + explorationKeys) ---
  scope: {
    securityKeys: ["project"],          // tenant boundary -- always enforced
    explorationKeys: ["part", "trackType"],  // user-driven drill-down axes
    params: ["projectId", "partId"],
  },

  priority: 2,
};
```

---

## 3. 화면 구조

### 3.1 Right Panel panelMode 정의

Right Panel은 항상 동일한 영역이지만, **panelMode**에 따라 표시 내용이 달라진다.
조건 분기 대신 명시적 모드 enum으로 관리한다.

```typescript
/** Right Panel 모드 -- 명시적 enum */
export type PhasePanelMode =
  | "none"           // Right Panel 숨김 (EXEC_SUMMARY, CUSTOMER_APPROVAL)
  | "causes"         // 원인 분석 (Phase 행 선택 -> Drawer)
  | "tasks"          // 지연 Task 목록 (Drawer: 지연 Task 탭)
  | "issues"         // 관련 이슈 (Drawer: 이슈 탭)
  | "actions"        // 조치 기록 (Drawer: 조치 기록 탭)
  | "adjustment"     // 조정 테이블 (상태->원인->조치 요약)
  | "detail";        // Phase 상세 정보 (상세 페이지 내)
```

**panelMode 결정 규칙**:

| 컨텍스트 | Preset | 기본 panelMode |
|---------|--------|---------------|
| 목록 + 행 미선택 | ALL | `"none"` |
| 목록 + 행 선택 | EXEC_SUMMARY / CUSTOMER_APPROVAL | `"none"` (Right Panel 숨김) |
| 목록 + 행 선택 | PM_WORK | `"causes"` (원인 분석 Drawer) |
| 목록 + 행 선택 | PMO_CONTROL | `"causes"` (원인 분석 Drawer) |
| 목록 + 행 선택 | DEV_EXECUTION | `"tasks"` (지연 Task 읽기 전용) |
| Drawer: 탭 전환 | PM_WORK / PMO_CONTROL | `"causes"` / `"tasks"` / `"issues"` / `"actions"` |
| `/phases/:phaseId` | ALL | `"detail"` (Drawer auto-open) |

### 3.2 단계별관리 목록 (`/phases`)

```
+--------------------------------------------------------------+
|  Page Header                                                  |
|  단계(Phase)  [ AI 보험금지급심사 구축 ]                        |
|  [ Track: ALL / AI / SI ]  [ 필터 ]  [ 검색 ]   [ + 단계 ]  |
+--------------------------------------------------------------+
|                                                              |
|  +---- Health Summary Strip --------------------------------+|
|  |                                                          ||
|  | [분석]  [설계]  [개발]  [테스트]  [이행]  [안정화]         ||
|  |   OK     OK    WARN    CRIT      --      --              ||
|  |                                                          ||
|  +----------------------------------------------------------+|
|                                                              |
|  +---------+  +---------+  +---------+  +---------+          |
|  | 전체    |  | 활성    |  | 평균    |  | 위험    |          |
|  | Phase   |  | Phase   |  | 편차    |  | 편차    |          |
|  |  6개    |  |  2개    |  | -3.2%   |  |  1건    |          |
|  +---------+  +---------+  +---------+  +---------+          |
|                                                              |
|  +---------+  +---------+  +---------+                       |
|  | 완료율  |  | 초과    |  | 건강도  |                       |
|  |         |  | 단계    |  |         |                       |
|  |  33%    |  |  0건    |  |  78/100 |                       |
|  +---------+  +---------+  +---------+                       |
|                                                              |
|  +- Filter Bar -----------------------------------------+    |
|  | 상태: [전체v] 트랙: [전체v] Part: [전체v]             |    |
|  | 편차 임계: [-  v] Health: [전체v]  검색: [           ] |    |
|  |                       <- FilterSpec keys 1:1 mapping  |    |
|  +-------------------------------------------------------+    |
|                                                              |
|  +- Phase Table --------------------------------+---------+ |
|  |                                              | panel:  | |
|  | #  | Phase  | Plan | Act  | Delta | Health | "causes"| |
|  |    |        |  %   |  %   |   %   | Status |         | |
|  | ---+--------+------+------+-------+--------+         | |
|  | 1  | 분석   |  100 |  100 |   0   |   OK   | Cause   | |
|  |    |  AI    |  100 |  100 |   0   |   OK   | Cards   | |
|  |    |  SI    |  100 |   98 |  -2   |   OK   |         | |
|  | ---+--------+------+------+-------+--------+ ------  | |
|  | 2  | 설계   |   80 |   75 |  -5   |  WARN  | Top 3   | |
|  |    |  AI    |   85 |   82 |  -3   |   OK   | Causes: | |
|  |    |  SI    |   75 |   68 |  -7   |  WARN  |         | |
|  | ---+--------+------+------+-------+--------+ 1. Test | |
|  | 3  | 개발   |   60 |   52 |  -8   |  WARN  |    Fail | |
|  |    |  AI    |   65 |   60 |  -5   |  WARN  |         | |
|  |    |  SI    |   55 |   44 | -11   |  CRIT  | 2. Res  | |
|  | ---+--------+------+------+-------+--------+   Delay | |
|  | 4  | 테스트 |   30 |   18 | -12   |  CRIT  |         | |
|  |    |  AI    |   35 |   22 | -13   |  CRIT  | 3. Scope| |
|  |    |  SI    |   25 |   14 | -11   |  CRIT  |   Change| |
|  | ---+--------+------+------+-------+--------+         | |
|  | 5  | 이행   |    0 |    0 |   0   | PLANNED| ------  | |
|  | 6  | 안정화 |    0 |    0 |   0   | PLANNED| Actions:| |
|  |    |        |      |      |       |        | [Issue] | |
|  |    |        |      |      |       |        | [Assign]| |
|  +----------------------------------------------+---------+ |
|                                                              |
|  +- Gantt Timeline -----------------------------------------+|
|  |                                                          ||
|  | Phase   | Jan | Feb | Mar | Apr | May | Jun | Jul | Aug  ||
|  | --------+-----+-----+-----+-----+-----+-----+-----+-----||
|  | 분석    | ====plan====>                                   ||
|  |         | ===actual===>                                   ||
|  | 설계    |       ======plan========>                       ||
|  |         |       ====actual====>  <-gap                    ||
|  | 개발    |             =========plan============>          ||
|  |         |             ======actual======>                 ||
|  | 테스트  |                         ======plan========>     ||
|  |         |                         ===act=>                ||
|  | 이행    |                                   ===plan===>   ||
|  | 안정화  |                                         ==plan=>||
|  |                                                          ||
|  +----------------------------------------------------------+|
|                                                              |
|  +- Dependency Mini-Graph ----------------------------------+|
|  |                                                          ||
|  |  [설계] --delay(-5d)--> [개발] --delay(-8d)--> [테스트]  ||
|  |    |                                              |       ||
|  |    +--------- critical path (SI track) -----------+       ||
|  |                                                          ||
|  +----------------------------------------------------------+|
|                                                              |
+--------------------------------------------------------------+
```

### 3.3 Phase 상세 (`/phases/:phaseId`) -- Drawer 오픈 상태

```
+--------------------------------------------------------------+
|  Page Header                                                  |
|  <- 단계  개발 (Step 3)                                       |
|                                    [ 편집 ] [ 변경이력 ]       |
+--------------------------------------------------------------+
|                                                              |
|  +- Phase 기본 정보 -----------+----- Drawer (420px) -------+|
|  |                             |                             ||
|  |  Phase ID: PH-003          |  개발 (Step 3)  CRITICAL    ||
|  |  단계명: 개발              |  Track: ALL                  ||
|  |  순서: 3                    |                             ||
|  |  상태: ACTIVE              |  [원인]  [지연Task]  [이슈]  ||
|  |  Track: AI + SI            |  [조치기록]                  ||
|  |                             |                             ||
|  |  기간                       |  --- 원인 탭 (기본) ------  ||
|  |    시작: 2026-03-01        |                             ||
|  |    종료: 2026-06-30        |  Cause Card #1              ||
|  |    경과: 120 / 122일       |  "인프라 승인 지연"          ||
|  |                             |  영향: Task 5건 지연         ||
|  |  진행률                     |  -> [관련 Task 보기]         ||
|  |    계획: 60%               |                             ||
|  |    실적: 52%               |  Cause Card #2              ||
|  |    편차: -8%  CRITICAL     |  "QA 리소스 부족"            ||
|  |    ██████████░░░ 52%       |  영향: TC 실행 지연           ||
|  |                             |  -> [이슈 등록]              ||
|  |  트랙별 분류                |                             ||
|  |    AI: Plan 65% / Act 60%  |  Cause Card #3              ||
|  |         Delta: -5%  WARN   |  "외부 API 스펙 변경"        ||
|  |    SI: Plan 55% / Act 44%  |  영향: 설계 변경 3건          ||
|  |         Delta: -11% CRIT   |  -> [산출물 관리]             ||
|  |                             |                             ||
|  |  관련 Part                  |  --- 조정 테이블 요약 -----  ||
|  |    AI모델구축 (4 Task)     |                             ||
|  |    SI개발 (8 Task)         |  상태  | 원인    | 조치       ||
|  |    인프라 (2 Task)         |  ------+---------+---------  ||
|  |                             |  CRIT  | 인프라   | PM 에스   ||
|  |  관련 Task 현황             |        | 승인지연 | 컬레이션  ||
|  |    전체: 14건              |  WARN  | QA 부족 | 외부 QA   ||
|  |    완료: 5건               |        |         | 투입      ||
|  |    진행: 4건               |  WARN  | API 변경| 설계 변경  ||
|  |    지연: 3건               |        |         | 추가 배포  ||
|  |    미시작: 2건             |                             ||
|  |                             |  [+ 조치 등록]              ||
|  |  KPI                       |  [전체 조치 기록 보기]       ||
|  |    코드 품질: 85/90 onTrack|                             ||
|  |    테스트 커버리지: 62/80  |                             ||
|  |                    atRisk  |                             ||
|  |                             |                             ||
|  +-----------------------------+-----------------------------+|
|                                                              |
+--------------------------------------------------------------+
```

### 3.4 조정 테이블 (Adjustment Table) 상세

조정 테이블은 **"편차가 왜 생겼고, 어떻게 해결할 것인가"**를 체계적으로 기록하는 감사 추적 가능 구조이다.

```
+- 조정 테이블 ---------------------------------------------------+
|                                                                  |
| #  | 상태    | 편차  | 원인 분류    | 원인 상세        | 조치      |
|    |         |       |             |                  |           |
| ---+---------+-------+-------------+------------------+-----------+
| 1  | CRITICAL| -11%  | TASK_DELAY  | SI 인프라 승인   | PM 에스컬 |
|    |         |       |             | 3주 지연          | 레이션    |
|    |         |       |             |                  | 기한:3/15 |
| ---+---------+-------+-------------+------------------+-----------+
| 2  | WARNING | -5%   | RESOURCE    | QA 인력 부족     | 외부 QA   |
|    |         |       |             | (1명 -> 필요 3명) | 2명 투입  |
|    |         |       |             |                  | 기한:3/20 |
| ---+---------+-------+-------------+------------------+-----------+
| 3  | WARNING | -3%   | SCOPE_CHANGE| 외부 API 스펙    | 설계 변경 |
|    |         |       |             | v2.0 변경        | + 추가    |
|    |         |       |             |                  | 스프린트  |
| ---+---------+-------+-------------+------------------+-----------+
|                                                                  |
| 원인 분류:                                                        |
|   TASK_DELAY | RESOURCE | SCOPE_CHANGE | TEST_FAIL |             |
|   DELIVERABLE | DEPENDENCY | EXTERNAL | OTHER                    |
|                                                                  |
| [ + 조치 추가 ]  (cap: manage_phases)                             |
|                                                                  |
+------------------------------------------------------------------+
```

---

## 4. Preset별 차이

### 4.1 EXEC_SUMMARY (Sponsor)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | 전체 Phase 수, 완료율, 위험 편차 건수만 표시 |
| Health Strip | 표시 (축약 -- 아이콘 + 상태만) |
| Phase Table | 단계명, 계획%, 실적%, 편차%, Health만 표시 (원인/조치 숨김) |
| Gantt | compact 모드 (마일스톤 포인트만 표시) |
| Right Panel | panelMode: `"none"` (숨김) |
| Dependency | 숨김 |
| CTA | 없음 (읽기 전용) |

### 4.2 PMO_CONTROL (PMO)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | 전체 Phase 수, 활성 Phase, 평균 편차, 위험 편차, 초과 단계, 건강도 |
| Health Strip | 표시 (전체) |
| Phase Table | 전체 컬럼 (트랙별 분류 포함) |
| Gantt | full 모드 (계획 vs 실적 비교) |
| Right Panel | panelMode: `"causes"` (Drawer 원인 분석) |
| Dependency | 표시 (지연 전파 시각화) |
| CTA | `단계별 리포트 Export` -> targetNodeId: `reports`, `Health Matrix` -> targetNodeId: `pmo-health` |

### 4.3 PM_WORK (PM)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | 활성 Phase, 평균 편차, 위험 편차, 초과 단계, 건강도 |
| Health Strip | 표시 (전체 + 클릭 시 Drawer 오픈) |
| Phase Table | **전체 컬럼** + 조정 테이블 요약 + 원인 분류 |
| Gantt | full 모드 (계획 vs 실적 비교 + gap 표시) |
| Right Panel | panelMode: `"causes"` + 4탭 전환 (원인/지연Task/이슈/조치기록) |
| Dependency | 표시 (지연 전파 + 조치 가능) |
| Adjustment Table | **핵심 기능** -- 편차 원인/조치 등록 가능 |
| CTA | `단계 상태 변경` (cap: `manage_phases`), `조치 등록` (cap: `manage_phases`), `이슈 에스컬레이션` (cap: `manage_issues`), `WBS에서 확인` -> targetNodeId: `wbs` |

**PM_WORK Drawer 탭별 CTA**:

| 탭 | CTA | Capability |
|-----|-----|-----------|
| 원인 | `[관련 Task 보기]` | `view_phases` (읽기) |
| 원인 | `[이슈 등록]` | `manage_issues` |
| 지연 Task | `[담당 변경]` | `manage_phases` |
| 지연 Task | `[기한 조정]` | `manage_phases` |
| 이슈 | `[이슈 생성]` | `manage_issues` |
| 조치 기록 | `[조치 등록]` | `manage_phases` |

### 4.4 DEV_EXECUTION (DEV / DevReader)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | 활성 Phase, 완료율 |
| Health Strip | 표시 (읽기 전용) |
| Phase Table | 기본 컬럼 (단계명, 계획%, 실적%, 편차%, Health) |
| Gantt | compact 모드 |
| Right Panel | panelMode: `"tasks"` (지연 Task 읽기 전용) |
| Dependency | 숨김 |
| Adjustment Table | 숨김 |
| CTA | `칸반 보드` -> targetNodeId: `kanban`, `내 작업` -> targetNodeId: `my-work` |

### 4.5 CUSTOMER_APPROVAL (Customer PM)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | 전체 Phase 수, 완료율, 활성 Phase |
| Health Strip | 표시 (마일스톤 아이콘만) |
| Phase Table | 기본 컬럼 (단계명, 계획%, 실적%, 편차%) -- 내부 원인 마스킹 |
| Gantt | milestone 모드 (마일스톤 포인트 + 완료 여부만) |
| Right Panel | panelMode: `"none"` (숨김) |
| Dependency | 숨김 |
| CTA | 없음 (읽기 전용, 마일스톤 확인 목적) |

**CUSTOMER_APPROVAL 마스킹 규칙**:

### 4.6 Preset Overlay -- 스택 가능한 컨텍스트 (v2.1 설계 노트)

> **현재**: Preset은 단일 고정값 (`viewMode = "PM_WORK"`).
> **미래 확장**: Preset을 **상태 머신이 아닌 스택 가능한 레이어**로 진화시킬 수 있다.

```typescript
/**
 * v2.1 Design Note -- Preset Overlay (future-ready structure)
 *
 * PM이 PM_WORK로 일하다가 잠깐 Sponsor 관점 요약을 보고 싶을 때:
 *   basePreset = "PM_WORK"
 *   overlay = ["EXEC_SUMMARY_TEMP"]
 *
 * Overlay 적용 규칙:
 *   1. overlay는 UI density / hiddenColumns만 오버라이드
 *   2. Capability는 basePreset 기준 유지 (보안 경계 불변)
 *   3. overlay 해제 시 basePreset으로 즉시 복원
 *   4. AI viewMode.suggested는 basePreset만 제안 (overlay 제안 불가)
 *
 * 이 구조 덕분에:
 *   - "지금은 EXEC_SUMMARY로 보시겠습니까?" 같은 AI-주도 컨텍스트 전환 가능
 *   - Preset이 "역할 고정"이 아니라 "시점(ViewMode)" 개념으로 동작
 *   - 동일 사용자가 하루에 여러 시점을 오갈 수 있음
 */
interface PresetOverlayContext {
  basePreset: ViewModePreset;
  overlay?: ViewModePreset[];       // stack -- last wins for conflicting keys
  overlayAppliedAt?: string;        // ISO timestamp -- auto-expire after 10min
}

/** Overlay merge rule: overlay overrides UI-only properties */
type OverlayMergeableKeys =
  | "density"
  | "defaultRightPanel"
  | "hiddenColumns"
  | "ganttMode";

// NOT overridable by overlay (security boundary):
// - requiredCaps
// - suggestedActions
// - maskInternalCauseDetails
```

> **구현 시점**: v2.1에서는 설계 노트로만 기록.
> 실제 overlay 기능은 다중 Preset 전환 UX가 확정된 후 구현한다.
> 핵심은 **Capability는 basePreset 고정, UI만 overlay** 원칙.

```typescript
interface PhaseViewPolicy {
  canExport: boolean;
  canEditSettings: boolean;
  canCreateIssue: boolean;
  showActionLog: boolean;
  showAdjustmentTable: boolean;
  showDependencyGraph: boolean;
  maskInternalCauseDetails: boolean;   // customer preset -> true
  defaultDrawerTab: "causes" | "tasks" | "issues" | "actions";
  ganttMode: "full" | "compact" | "milestone";
}
```

---

## 5. Phase 도메인 상세

### 5.1 Phase 상태 모델

```
PLANNED ---> ACTIVE ---> COMPLETED ---> CLOSED
   |                         |
   +---- (manual) ---------->+
                             |
                        (reopen)
                             |
                  COMPLETED -+-> ACTIVE (PM manual reopen)
```

| 상태 | 의미 | 색상 | 전이 조건 |
|------|------|------|---------|
| `PLANNED` | 미시작 (예정) | Gray | 초기 상태 |
| `ACTIVE` | 진행 중 | Blue | PM이 수동으로 시작 / 자동(시작일 도래) |
| `COMPLETED` | 완료 | Green | PM이 수동 완료 (게이트 승인 필요 시 gate 검증) |
| `CLOSED` | 종결 (변경 불가) | Dark Gray | PM/PMO 수동 종결 |

### 5.2 Phase hierarchy (parent_id self-FK)

```
Project
  |
  +-- Phase: AI부문 (parent)
  |     |
  |     +-- Phase: 분석 (child, trackType=AI)
  |     +-- Phase: 설계 (child, trackType=AI)
  |     +-- Phase: 개발 (child, trackType=AI)
  |     +-- Phase: 테스트 (child, trackType=AI)
  |     +-- Phase: 이행 (child, trackType=AI)
  |     +-- Phase: 안정화 (child, trackType=AI)
  |
  +-- Phase: SI부문 (parent)
        |
        +-- Phase: 분석 (child, trackType=SI)
        +-- Phase: 설계 (child, trackType=SI)
        +-- Phase: 개발 (child, trackType=SI)
        +-- Phase: 테스트 (child, trackType=SI)
        +-- Phase: 이행 (child, trackType=SI)
        +-- Phase: 안정화 (child, trackType=SI)
```

**집계 규칙**: 부모 Phase의 진행률은 하위 Phase의 가중 평균으로 계산된다.

```typescript
function calculateParentProgress(parent: Phase, children: Phase[]): number {
  if (children.length === 0) return parent.progress;
  const totalWeight = children.length;
  const weightedSum = children.reduce((sum, child) => sum + child.progress, 0);
  return Math.round(weightedSum / totalWeight);
}

/** Phase hierarchy query -- parent + children */
function getPhaseWithChildren(phaseId: string): string {
  return `
    WITH RECURSIVE phase_tree AS (
      SELECT id FROM project.phases WHERE id = :phaseId
      UNION ALL
      SELECT p.id FROM project.phases p
      INNER JOIN phase_tree pt ON p.parent_id = pt.id
    )
    SELECT * FROM project.phases WHERE id IN (SELECT id FROM phase_tree)
  `;
}
```

### 5.3 Health 상태 자동 판정

> **v2.1 역할 분리 원칙**:
>
> | 개념 | 역할 | 소비자 | 사용 목적 |
> | ---------- | ---------- | ---------- | ---------- |
> | **HealthStatus** | **행동 트리거** | AI do-intent, Drawer 오픈, KPI 경고, virtualNode 매칭 | "무엇을 해야 하는가" |
> | **DeviationGrade** | **원인 분석 보조** | Cause Tab, Adjustment Table, 편차 리포트 | "왜 이런 상태인가" |
>
> AI do-intent는 **HealthStatus 기준으로만** 발생한다.
> DeviationGrade는 원인 분석 Drawer 내부에서만 참조되며, AI 라우팅/필터/virtualNode에 사용하지 않는다.
> 이 분리 덕분에 기준이 흔들리지 않고, 사람/AI 판단 충돌이 감소한다.

```typescript
/**
 * Phase Health 상태 판정 알고리즘
 *
 * HealthStatus = action trigger (행동 트리거)
 * - AI do-intent routing: healthStatus === "CRITICAL" -> 조치 유도
 * - virtualNode matching: phases.critical, phases.overdue
 * - KPI card filter: KPI_CRITICAL -> healthStatus filter
 * - Drawer auto-open: CRITICAL/WARNING -> causes tab
 *
 * DeviationGrade (section 5.4) = cause analysis basis (원인 분석 근거)
 * - Cause Tab에서 편차 등급별 원인 카드 정렬
 * - Adjustment Table에서 편차 심각도 표시
 * - 리포트 Export에서 편차 등급 통계
 */
export type PhaseHealthStatus = "NORMAL" | "WARNING" | "CRITICAL" | "PAUSED";

function determineHealthStatus(phase: PhaseRow): PhaseHealthStatus {
  // PAUSED (수동 설정)
  if (phase.status === "PLANNED") return "NORMAL";

  const deviation = phase.actualPct - phase.planPct;

  // CRITICAL: 편차 -10% 이하 또는 기한 초과
  if (deviation <= -10) return "CRITICAL";
  if (isOverdue(phase) && phase.actualPct < 100) return "CRITICAL";

  // WARNING: 편차 -5% 이하
  if (deviation <= -5) return "WARNING";

  // NORMAL
  return "NORMAL";
}

function isOverdue(phase: PhaseRow): boolean {
  if (!phase.endDate) return false;
  const today = new Date();
  const endDate = new Date(phase.endDate);
  return today > endDate && phase.status === "ACTIVE";
}
```

### 5.4 편차(Deviation) 계산

> **DeviationGrade는 원인 분석 전용 지표** (v2.1 명확화):
> DeviationGrade는 Cause Tab / Adjustment Table / 편차 리포트에서만 참조된다.
> AI 라우팅, virtualNode 매칭, KPI 필터에는 **HealthStatus만** 사용한다.
> 두 지표의 관계: `deviationGrade`가 근거를 제공하고, `healthStatus`가 행동을 트리거한다.

```typescript
/**
 * DeviationMetrics -- cause analysis basis (원인 분석 근거)
 *
 * 사용처: Cause Tab, Adjustment Table, deviation report, Drawer detail
 * 사용하지 않는 곳: AI do-intent, virtualNode, KPI filter, navigation
 *
 * cf. HealthStatus (section 5.3) = action trigger
 */
interface DeviationMetrics {
  /** 계획 진행률 */
  planPct: number;
  /** 실적 진행률 */
  actualPct: number;
  /** 편차 = 실적 - 계획 */
  deltaPct: number;
  /**
   * 편차 등급 -- 원인 분석 보조 지표
   * AI do-intent에 사용하지 않음 (HealthStatus 사용)
   */
  deviationGrade: "ON_TRACK" | "SLIGHT_DELAY" | "SIGNIFICANT_DELAY" | "CRITICAL_DELAY";
}

function calculateDeviation(planPct: number, actualPct: number): DeviationMetrics {
  const deltaPct = actualPct - planPct;
  let deviationGrade: DeviationMetrics["deviationGrade"];

  if (deltaPct >= -2) deviationGrade = "ON_TRACK";
  else if (deltaPct >= -5) deviationGrade = "SLIGHT_DELAY";
  else if (deltaPct >= -10) deviationGrade = "SIGNIFICANT_DELAY";
  else deviationGrade = "CRITICAL_DELAY";

  return { planPct, actualPct, deltaPct, deviationGrade };
}
```

### 5.5 Gate Status (게이트 승인)

Phase 완료 시 게이트 승인이 필요한 경우의 워크플로우:

```
Phase ACTIVE
  |
  +-> PM submits gate review
  |     gateStatus: PENDING -> SUBMITTED
  |
  +-> PMO/Sponsor reviews
  |     gateStatus: SUBMITTED -> APPROVED / REJECTED
  |
  +-> APPROVED: Phase -> COMPLETED
  |   REJECTED: Phase stays ACTIVE + rejection reason recorded
```

```typescript
export type GateStatus = "PENDING" | "SUBMITTED" | "APPROVED" | "REJECTED";

interface GateReview {
  phaseId: string;
  gateStatus: GateStatus;
  submittedBy?: string;
  submittedAt?: string;
  reviewedBy?: string;
  reviewedAt?: string;
  rejectionReason?: string;
}
```

### 5.6 Decision Record Lineage (v2.1)

Phase 화면에서 발생하는 세 종류의 의사결정 기록은 **동일한 감사 계보(lineage)**에 속한다.
장기적으로 이 세 가지가 하나의 타임라인으로 합쳐져, "이 Phase에서 무슨 결정이 있었는가"를 추적할 수 있다.

```
Decision Record Lineage
  |
  +-- Adjustment (조치 기록)
  |     "편차 원인을 파악하고 조치를 결정했다"
  |     causeType + causeDetail + actionDescription
  |
  +-- GateReview (게이트 승인)
  |     "이 Phase를 완료해도 되는지 결정했다"
  |     gateStatus + submittedBy + reviewedBy + rejectionReason
  |
  +-- StatusTransition (상태 전이)
        "Phase 상태를 변경하기로 결정했다"
        previousStatus + newStatus + reason + transitionedBy
```

```typescript
/**
 * Decision Record -- Phase 의사결정 감사 계보 (v2.1)
 *
 * 세 가지 의사결정 유형이 동일한 타임라인에 합류:
 * - Adjustment: 편차 원인 -> 조치 결정
 * - GateReview: 단계 완료 승인/거부 결정
 * - StatusTransition: 상태 변경 결정
 *
 * 이 구조의 이점:
 * 1. "이 Phase에서 무슨 결정이 있었는가"를 하나의 뷰로 추적
 * 2. AI가 "최근 결정 기록 보여줘"를 하나의 API로 응답 가능
 * 3. 감사(audit) 시 결정 근거 + 결과를 한 곳에서 확인
 * 4. Risk/Decision 화면으로 자연스럽게 확장 가능
 */
export type DecisionRecordType = "ADJUSTMENT" | "GATE_REVIEW" | "STATUS_TRANSITION";

export interface DecisionRecord {
  id: string;
  phaseId: string;
  type: DecisionRecordType;
  /** who made the decision */
  decidedBy: string;
  decidedAt: string;
  /** decision summary (human-readable) */
  summary: string;
  /** link to source record */
  sourceId: string;                 // adjustmentId | gateReviewId | transitionId
  /** decision context snapshot */
  context: {
    healthStatusAtDecision: PhaseHealthStatus;
    deviationAtDecision: number;
    trackType?: TrackType;
  };
}
```

> **구현 시점**: v2.1에서는 DecisionRecord 타입 정의 + Drawer 조치 기록 탭에서 통합 타임라인으로 표시.
> 별도 Decision API는 Decision/Risk 화면 설계 시 정의한다.
> Phase 화면은 이 감사 계보의 **출발점**이며, 가장 풍부한 결정 데이터를 제공한다.

---

## 6. 데이터 구조 / API

### 6.1 핵심 타입 정의

```typescript
/** Phase 상태 enum */
export type PhaseStatus = "PLANNED" | "ACTIVE" | "COMPLETED" | "CLOSED";

/** 트랙 유형 */
export type TrackType = "AI" | "SI" | "COMMON";

/** Phase Health 상태 */
export type PhaseHealthStatus = "NORMAL" | "WARNING" | "CRITICAL" | "PAUSED";

/** 원인 분류 */
export type CauseType =
  | "TASK_DELAY"
  | "RESOURCE"
  | "SCOPE_CHANGE"
  | "TEST_FAIL"
  | "DELIVERABLE"
  | "DEPENDENCY"
  | "EXTERNAL"
  | "OTHER";

/** Phase Row (테이블 행) */
export interface PhaseRow {
  phaseId: string;
  phaseName: string;
  orderNum: number;
  status: PhaseStatus;
  parentId?: string;
  trackType: TrackType;
  startDate?: string;     // ISO date
  endDate?: string;       // ISO date
  planPct: number;        // 0..100
  actualPct: number;      // 0..100
  deltaPct: number;       // actual - plan
  healthStatus: PhaseHealthStatus;
  primaryCause?: {
    type: CauseType;
    label: string;
    count?: number;
  };
  trackBreakdown?: Record<TrackType, {
    planPct: number;
    actualPct: number;
    deltaPct: number;
    healthStatus: PhaseHealthStatus;
  }>;
  highlights?: {
    delayedTasks: number;
    openIssues: number;
    pendingDeliverables: number;
  };
  gateStatus?: GateStatus;
  relatedPartIds?: string[];
  relatedPartNames?: string[];
  childPhaseIds?: string[];
  adjustmentCount: number;
}

/** Phase 통계 */
export interface PhaseStats {
  totalPhases: number;
  activePhases: number;
  completedPhases: number;
  plannedPhases: number;
  closedPhases: number;
  completionRate: number;         // 0..100
  avgDeviation: number;           // average delta across active phases
  overduePhases: number;
  criticalDeviations: number;     // phases with CRITICAL health
  healthScore: number;            // 0..100 composite score
}

/** Adjustment (조정) 항목 */
export interface AdjustmentItem {
  id: string;
  phaseId: string;
  healthStatus: PhaseHealthStatus;
  deviation: number;
  causeType: CauseType;
  causeDetail: string;
  actionDescription: string;
  assignee?: string;
  dueDate?: string;
  status: "OPEN" | "IN_PROGRESS" | "RESOLVED" | "CLOSED";
  createdAt: string;
  createdBy: string;
  updatedAt?: string;
}

/** Drill-down 상세 */
export interface PhaseDrilldown {
  phaseId: string;
  phaseName: string;
  trackType: TrackType;
  status: PhaseStatus;
  healthStatus: PhaseHealthStatus;
  causes: {
    title: string;
    type: CauseType;
    evidence: string;
    impactCount: number;
    links?: { type: "task" | "issue"; id: string; title: string }[];
  }[];
  delayedTasks: {
    id: string;
    title: string;
    assignee: string;
    dueDate?: string;
    status: string;
    delayDays: number;
  }[];
  issues: {
    id: string;
    title: string;
    owner: string;
    dueDate?: string;
    state: string;
    severity: string;
  }[];
  adjustments: AdjustmentItem[];
  actions: {
    at: string;
    by: string;
    text: string;
    type: "status_change" | "adjustment" | "issue_create" | "assignment" | "comment";
  }[];
}

/** Dependency edge */
export interface PhaseDependency {
  fromPhaseId: string;
  toPhaseId: string;
  lagDays?: number;
  trackType?: TrackType;
  type: "FS" | "FF" | "SS" | "SF";  // Finish-Start, Finish-Finish, etc.
}
```

### 6.2 Phase List API

```
GET /api/phases?projectId={projectId}
    &status={PLANNED|ACTIVE|COMPLETED|CLOSED}
    &phaseType={AI|SI|COMMON}
    &partId={partId}
    &from={date}&to={date}
    &deviationThreshold={number}
    &healthStatus={NORMAL|WARNING|CRITICAL|PAUSED}
    &q={searchText}
```

> **참고**: Query parameters map 1:1 to FilterSpec keys (section 2.2).

```typescript
interface PhaseListResponse {
  /** Phase rows (includes children if hierarchical) */
  phases: PhaseRow[];
  /** Aggregate statistics */
  stats: PhaseStats;
  /** Dependency edges for mini-graph */
  dependencies: PhaseDependency[];
  /** Track weights (for weighted aggregation) */
  weights?: Record<TrackType, number>;

  // --- Reliability 3-tuple (v2.1 standardized) ---
  asOf: string;
  completeness: {
    overall: number;               // 0~1
    breakdown?: {
      phases: number;
      tasks: number;
      issues: number;
    };
  };
  warnings: {
    code: string;                  // e.g., "INCOMPLETE_TASK_DATA"
    message: string;
    severity: "info" | "warn" | "critical";
  }[];

  // --- Scope echo (v2.1 enhanced) ---
  scope: {
    projectId: string;
    appliedPartIds: string[];
    appliedPartNames: string[];
    appliedTrackType?: TrackType;  // v2.1: track layer echo
    scopeReason:
      | "full_access"              // PM/PMO -- no restriction
      | "role_restricted_assignee" // DEV -- own tasks only
      | "role_restricted_part"     // DevReader -- own part only
      | "explicit_filter";         // user-applied filter
  };
}
```

### 6.3 Phase Detail API

```
GET /api/phases/:phaseId
```

```typescript
interface PhaseDetailResponse {
  phase: PhaseRow;
  /** Child phases (if this is a parent) */
  children: PhaseRow[];
  /** Related parts */
  relatedParts: {
    partId: string;
    partName: string;
    taskCount: number;
    completedTasks: number;
  }[];
  /** KPIs */
  kpis: {
    id: string;
    name: string;
    target: string;
    current: string;
    status: "achieved" | "onTrack" | "atRisk";
  }[];
  /** Deliverables */
  deliverables: {
    id: string;
    name: string;
    status: "approved" | "review" | "draft" | "pending" | "rejected";
    uploadDate?: string;
  }[];
  /** Task summary */
  taskSummary: {
    total: number;
    completed: number;
    inProgress: number;
    delayed: number;
    notStarted: number;
  };
  /** Gate review info */
  gateReview?: GateReview;

  // --- Reliability 3-tuple (v2.1 standardized) ---
  asOf: string;
  completeness: {
    overall: number;
    breakdown?: { phases: number; tasks: number; issues: number };
  };
  warnings: { code: string; message: string; severity: "info" | "warn" | "critical" }[];
}
```

### 6.4 Phase Drill-down API

```
GET /api/phases/:phaseId/drilldown?track={all|ai|si}
```

```typescript
interface PhaseDrilldownResponse {
  drilldown: PhaseDrilldown;

  // --- Reliability 3-tuple (v2.1 standardized) ---
  asOf: string;
  completeness: {
    overall: number;
    breakdown?: { phases: number; tasks: number; issues: number };
  };
  warnings: { code: string; message: string; severity: "info" | "warn" | "critical" }[];
}
```

### 6.5 Phase Stats API

```
GET /api/phases/stats?projectId={projectId}&phaseType={AI|SI|COMMON}
```

```typescript
interface PhaseStatsResponse {
  stats: PhaseStats;

  /** Phase status distribution */
  phasesByStatus: {
    status: PhaseStatus;
    count: number;
  }[];

  /** Health status distribution */
  phasesByHealth: {
    healthStatus: PhaseHealthStatus;
    count: number;
  }[];

  /** Track distribution */
  phasesByTrack: {
    trackType: TrackType;
    count: number;
    avgDeviation: number;
  }[];

  // --- Reliability 3-tuple (v2.1 standardized) ---
  asOf: string;
  completeness: {
    overall: number;
    breakdown?: { phases: number; tasks: number };
  };
  warnings: { code: string; message: string; severity: "info" | "warn" | "critical" }[];
}
```

### 6.6 Phase CRUD API

```
POST   /api/phases                              // Phase 생성 (cap: manage_phases)
GET    /api/phases/:phaseId                     // Phase 상세 (cap: view_phases)
PATCH  /api/phases/:phaseId                     // Phase 수정 (cap: manage_phases)
DELETE /api/phases/:phaseId                     // Phase 삭제 (cap: manage_phases)
```

### 6.7 Adjustment CRUD API

```
GET    /api/phases/:phaseId/adjustments         // 조치 목록 (cap: view_phases)
POST   /api/phases/:phaseId/adjustments         // 조치 등록 (cap: manage_phases)
PATCH  /api/phases/:phaseId/adjustments/:adjId  // 조치 수정 (cap: manage_phases)
DELETE /api/phases/:phaseId/adjustments/:adjId  // 조치 삭제 (cap: manage_phases)
```

```typescript
interface CreateAdjustmentRequest {
  causeType: CauseType;
  causeDetail: string;
  actionDescription: string;
  assignee?: string;
  dueDate?: string;
}

interface CreateAdjustmentResponse {
  adjustment: AdjustmentItem;
  /** Phase health recalculated after adjustment */
  updatedPhase: PhaseRow;
  /**
   * v2.1: Decision Record auto-created
   * Adjustment 생성 시 서버가 DecisionRecord를 자동 생성하여 감사 계보에 등록
   */
  decisionRecord: {
    id: string;
    type: "ADJUSTMENT";
    decidedBy: string;
    decidedAt: string;
    summary: string;
    context: {
      healthStatusAtDecision: PhaseHealthStatus;
      deviationAtDecision: number;
      trackType?: TrackType;
    };
  };
}
```

### 6.8 Phase Status Transition API

```
PATCH /api/phases/:phaseId/status
```

```typescript
interface PhaseStatusTransitionRequest {
  targetStatus: PhaseStatus;
  reason?: string;
}

interface PhaseStatusTransitionResponse {
  phase: PhaseRow;
  transition: {
    previousStatus: PhaseStatus;
    newStatus: PhaseStatus;
    transitionedAt: string;
    transitionedBy: string;
    reason?: string;
  };
  /** Gate submission required? */
  gateRequired?: boolean;
  /**
   * v2.1: Decision Record auto-created
   * StatusTransition 실행 시 서버가 DecisionRecord를 자동 생성
   */
  decisionRecord?: {
    id: string;
    type: "STATUS_TRANSITION";
    summary: string;
  };
}

// Server validation rules:
// PLANNED -> ACTIVE:  allowed (PM, manage_phases)
// ACTIVE -> COMPLETED: allowed if gateStatus === "APPROVED" (or gate not required)
// COMPLETED -> CLOSED: allowed (PM/PMO, manage_phases)
// CLOSED -> any: blocked (irreversible)
// COMPLETED -> ACTIVE: allowed (PM manual reopen, manage_phases)
```

**Status Transition Error Contract**:

```typescript
type PhaseTransitionErrorCode =
  | "INVALID_TRANSITION"        // e.g., CLOSED -> ACTIVE
  | "GATE_NOT_APPROVED"         // ACTIVE -> COMPLETED but gate pending
  | "CHILD_PHASES_INCOMPLETE"   // Parent complete but children still ACTIVE
  | "CONCURRENT_MODIFICATION";  // Optimistic lock violation

interface PhaseTransitionErrorResponse {
  error: {
    code: PhaseTransitionErrorCode;
    message: string;
    currentStatus?: PhaseStatus;
    gateStatus?: GateStatus;
  };
}
```

| Error Code | HTTP | Cause | Frontend Action |
|-----------|------|-------|----------------|
| `INVALID_TRANSITION` | 409 | Invalid status path | Show valid transitions |
| `GATE_NOT_APPROVED` | 409 | Gate review pending | "Please submit gate review first" |
| `CHILD_PHASES_INCOMPLETE` | 409 | Children still ACTIVE | Show incomplete children list |
| `CONCURRENT_MODIFICATION` | 409 | Optimistic lock | Refresh data and retry |

### 6.9 Phase Settings API

```
GET    /api/phases/settings?projectId={projectId}   // (cap: manage_phases)
PUT    /api/phases/settings                          // (cap: manage_phases)
```

```typescript
interface PhaseSettingsResponse {
  templates: PhaseTemplate[];
  instances: PhaseInstance[];
}

interface PhaseTemplate {
  id: string;
  name: string;
  orderNum: number;
  defaultDurationDays?: number;
  trackTypes: TrackType[];
  isDefault: boolean;
}

interface PhaseInstance {
  phaseId: string;
  templateId?: string;
  name: string;
  orderNum: number;
  startDate: string;
  endDate: string;
  trackTypes: TrackType[];
  relatedPartIds: string[];
  relatedTaskIds: string[];
}

// Validation rules:
// - Date inversion forbidden (startDate <= endDate)
// - Order duplicates forbidden
// - At least 1 track type required
// - Hybrid requires minimum 2 track types
```

### 6.10 Dependency API

```
GET /api/phases/dependencies?projectId={projectId}
```

```typescript
interface PhaseDependencyResponse {
  dependencies: PhaseDependency[];
  criticalPath: string[];  // ordered phase IDs
  asOf: string;
}
```

---

## 7. 컴포넌트 분해

### 7.1 폴더 구조

```
features/
  phases/
    pages/
      PhaseManagementPage.tsx          <- Main page (ViewMode branch, Phase Table, Gantt)
      PhaseSettingsPage.tsx             <- Admin settings (cap: manage_phases)
    components/
      // Top-level layout
      PhaseTopBar.tsx                   <- Top toolbar (Track toggle, filter, search, CTA)
      HealthSummaryStrip.tsx            <- Health chip strip (status-first overview)
      PhaseKpiRow.tsx                   <- KPI cards row

      // Table
      PhaseTable.tsx                    <- Main phase table (expandable rows)
      PhaseTableRow.tsx                 <- Single phase row (with track breakdown expand)
      TrackBreakdownRow.tsx             <- AI/SI sub-row within phase row
      PhaseStatusBadge.tsx              <- Phase status badge (PLANNED/ACTIVE/COMPLETED/CLOSED)
      HealthStatusBadge.tsx             <- Health status badge (NORMAL/WARNING/CRITICAL/PAUSED)
      DeviationBadge.tsx                <- Deviation percentage badge with color coding

      // Gantt
      PhaseGanttTimeline.tsx            <- Gantt chart container
      GanttBar.tsx                      <- Single phase bar (plan vs actual)
      GanttMilestone.tsx                <- Milestone point marker
      GanttLegend.tsx                   <- Legend (plan/actual/gap colors)

      // Dependency
      DependencyMiniGraph.tsx           <- Dependency visualization (nodes + edges)

      // Adjustment Table
      AdjustmentTable.tsx               <- Status->Cause->Action table
      AdjustmentRow.tsx                 <- Single adjustment row
      AdjustmentCreateForm.tsx          <- Inline adjustment creation form

      // Right Panel / Drawer
      PhaseDrilldownDrawer.tsx          <- Drawer container (4 tabs)
      PhaseRightPanel.tsx               <- panelMode switch renderer
      drawer/
        CauseTab.tsx                    <- Cause analysis (top 3 cards)
        CauseCard.tsx                   <- Individual cause card
        DelayedTasksTab.tsx             <- Delayed tasks list
        IssuesTab.tsx                   <- Related issues list
        ActionsTab.tsx                  <- Action timeline
        InlineIssueCreate.tsx           <- Inline issue creation form

      // Detail
      PhaseBasicInfo.tsx                <- Phase basic info card
      PhaseTrackBreakdown.tsx           <- Track-level progress breakdown
      PhaseRelatedParts.tsx             <- Related parts list
      PhaseKpiList.tsx                  <- KPI list with status
      PhaseDeliverableList.tsx          <- Deliverable list
      PhaseTaskSummary.tsx              <- Task summary (total/completed/delayed)

      // Settings
      PhaseTemplateManager.tsx          <- Template tab (CRUD)
      PhaseInstanceManager.tsx          <- Instance tab (project-specific)
      PhaseSettingsForm.tsx             <- Phase settings form

      // Filter
      PhaseFilters.tsx                  <- Filter bar (FilterSpec-based)
      TrackToggle.tsx                   <- Track segmented control (ALL/AI/SI)

      // Modals
      PhaseCreateModal.tsx              <- Phase creation modal
      PhaseEditModal.tsx                <- Phase edit modal
      PhaseTransitionDialog.tsx         <- Status transition confirmation
      GateSubmitDialog.tsx              <- Gate review submission
      AdjustmentCreateModal.tsx         <- Full adjustment creation modal

      // State displays
      PhaseEmptyState.tsx               <- No phases defined
      PhaseLoadingSkeleton.tsx          <- Loading skeleton
      PhaseNoPermission.tsx             <- Permission denied

    api/
      phasesApi.ts                      <- Phase API calls
    hooks/
      usePhaseList.ts                   <- Phase list TanStack Query
      usePhaseDetail.ts                 <- Phase detail TanStack Query
      usePhaseDrilldown.ts              <- Drill-down TanStack Query
      usePhaseStats.ts                  <- Stats TanStack Query
      usePhaseAdjustments.ts            <- Adjustments TanStack Query
      usePhaseDependencies.ts           <- Dependencies TanStack Query
      usePhaseViewPolicy.ts             <- ViewMode policy hook
      usePhasePanelMode.ts              <- Right Panel mode state
      usePhaseGantt.ts                  <- Gantt data transformation
      usePhaseFilter.ts                 <- Filter state management
      usePhaseTrackToggle.ts            <- Track toggle state
```

### 7.2 PhaseManagementPage.tsx ViewMode 분기

```typescript
function PhaseManagementPage() {
  const { viewMode } = useAccessContext();
  const { panelMode, setPanelMode } = usePhasePanelMode(viewMode);
  const [selectedPhaseId, setSelectedPhaseId] = useState<string | null>(null);
  const [track, setTrack] = useState<TrackType | "ALL">("ALL");
  const policy = usePhaseViewPolicy(viewMode);

  const { data, isLoading } = usePhaseList({
    projectId,
    track: track === "ALL" ? undefined : track,
    ...currentFilter,
  });

  // Drawer: route param -> auto-open
  const { phaseId: routePhaseId } = useParams();
  useEffect(() => {
    if (routePhaseId) {
      setSelectedPhaseId(routePhaseId);
      setPanelMode("causes");
    }
  }, [routePhaseId]);

  // panelMode-based Right Panel rendering
  const rightPanelContent = useMemo(() => {
    if (!selectedPhaseId) return undefined;
    switch (panelMode) {
      case "none":          return undefined;
      case "causes":
      case "tasks":
      case "issues":
      case "actions":
        return (
          <PhaseDrilldownDrawer
            phaseId={selectedPhaseId}
            track={track}
            defaultTab={panelMode}
            viewPolicy={policy}
            onClose={() => {
              setSelectedPhaseId(null);
              setPanelMode("none");
              navigate("/phases");
            }}
          />
        );
      case "adjustment":
        return <AdjustmentTable phaseId={selectedPhaseId} />;
      case "detail":
        return <PhaseBasicInfo phaseId={selectedPhaseId} />;
      default:
        return undefined;
    }
  }, [panelMode, selectedPhaseId, track, policy]);

  return (
    <PageLayout
      header={
        <PhaseTopBar
          viewMode={viewMode}
          track={track}
          onTrackChange={setTrack}
        />
      }
      rightPanel={rightPanelContent}
      rightPanelDefault={
        PRESET_POLICIES[viewMode].ui.defaultRightPanel
      }
    >
      <HealthSummaryStrip
        phases={data?.phases ?? []}
        onChipClick={(phaseId) => {
          setSelectedPhaseId(phaseId);
          setPanelMode(policy.defaultDrawerTab);
          navigate(`/phases/${phaseId}`);
        }}
      />

      <PhaseKpiRow viewMode={viewMode} stats={data?.stats} />

      <PhaseFilters
        viewMode={viewMode}
        filterSpec={phasesNode.filterSpec}
      />

      <PhaseTable
        phases={data?.phases ?? []}
        viewMode={viewMode}
        track={track}
        onRowClick={(phase) => {
          setSelectedPhaseId(phase.phaseId);
          if (["PM_WORK", "PMO_CONTROL"].includes(viewMode)) {
            setPanelMode("causes");
          } else if (viewMode === "DEV_EXECUTION") {
            setPanelMode("tasks");
          }
        }}
        onRowDoubleClick={(phase) => {
          navigate(`/phases/${phase.phaseId}`);
        }}
      />

      {/* Gantt Timeline */}
      <PhaseGanttTimeline
        phases={data?.phases ?? []}
        mode={policy.ganttMode}
        track={track}
      />

      {/* Dependency Graph (PM_WORK / PMO_CONTROL only) */}
      {policy.showDependencyGraph && (
        <DependencyMiniGraph
          dependencies={data?.dependencies ?? []}
          phases={data?.phases ?? []}
          onEdgeClick={(dep) => {
            setSelectedPhaseId(dep.toPhaseId);
            setPanelMode("causes");
          }}
        />
      )}
    </PageLayout>
  );
}
```

### 7.3 PhaseTable.tsx -- Track Breakdown

```typescript
interface PhaseTableProps {
  phases: PhaseRow[];
  viewMode: ViewModePreset;
  track: TrackType | "ALL";
  onRowClick: (phase: PhaseRow) => void;
  onRowDoubleClick: (phase: PhaseRow) => void;
}

/**
 * Phase Table rendering strategy:
 * 1. Top-level: parent phases (parentId = null)
 * 2. Expand: child phases (parentId = parent.phaseId)
 * 3. Track breakdown: AI/SI sub-rows within each phase
 * 4. Preset determines visible columns
 */
function PhaseTable(props: PhaseTableProps) {
  const parentPhases = props.phases.filter(p => !p.parentId);
  const childMap = groupBy(props.phases.filter(p => p.parentId), "parentId");

  return (
    <ExpandableTable>
      {parentPhases.map(parent => (
        <PhaseTableRow
          key={parent.phaseId}
          phase={parent}
          children={childMap[parent.phaseId] ?? []}
          viewMode={props.viewMode}
          track={props.track}
          onClick={() => props.onRowClick(parent)}
          onDoubleClick={() => props.onRowDoubleClick(parent)}
        />
      ))}
    </ExpandableTable>
  );
}
```

### 7.4 HealthSummaryStrip.tsx

```typescript
interface HealthSummaryStripProps {
  phases: PhaseRow[];
  onChipClick: (phaseId: string) => void;
}

/**
 * Health Summary Strip:
 * - Shows HealthChip for each leaf phase
 * - CRITICAL phases auto-highlighted (red dot)
 * - Click chip -> scroll to phase row + open Drawer
 */
function HealthSummaryStrip(props: HealthSummaryStripProps) {
  const leafPhases = props.phases
    .filter(p => !p.childPhaseIds?.length)
    .sort((a, b) => a.orderNum - b.orderNum);

  return (
    <div className="flex gap-2 overflow-x-auto py-2">
      {leafPhases.map(phase => (
        <HealthChip
          key={phase.phaseId}
          label={phase.phaseName}
          healthStatus={phase.healthStatus}
          deltaPct={phase.deltaPct}
          onClick={() => props.onChipClick(phase.phaseId)}
        />
      ))}
    </div>
  );
}
```

### 7.5 PhaseDrilldownDrawer.tsx

```typescript
interface PhaseDrilldownDrawerProps {
  phaseId: string;
  track: TrackType | "ALL";
  defaultTab: PhasePanelMode;
  viewPolicy: PhaseViewPolicy;
  onClose: () => void;
}

function PhaseDrilldownDrawer(props: PhaseDrilldownDrawerProps) {
  const [activeTab, setActiveTab] = useState(props.defaultTab);
  const { data } = usePhaseDrilldown(props.phaseId, props.track);

  const tabs = [
    { key: "causes", label: "원인", show: true },
    { key: "tasks", label: "지연 Task", show: true },
    { key: "issues", label: "이슈", show: true },
    { key: "actions", label: "조치 기록", show: props.viewPolicy.showActionLog },
  ].filter(t => t.show);

  return (
    <RightDrawer width={420} onClose={props.onClose}>
      <DrawerHeader>
        <h3>{data?.phaseName}</h3>
        <HealthStatusBadge status={data?.healthStatus} />
        <TrackBadge track={props.track} />
      </DrawerHeader>

      <TabBar tabs={tabs} active={activeTab} onChange={setActiveTab} />

      {activeTab === "causes" && (
        <CauseTab
          causes={data?.causes ?? []}
          maskDetails={props.viewPolicy.maskInternalCauseDetails}
        />
      )}
      {activeTab === "tasks" && (
        <DelayedTasksTab
          tasks={data?.delayedTasks ?? []}
          canEdit={props.viewPolicy.canCreateIssue}
        />
      )}
      {activeTab === "issues" && (
        <IssuesTab
          issues={data?.issues ?? []}
          phaseId={props.phaseId}
          canCreate={props.viewPolicy.canCreateIssue}
        />
      )}
      {activeTab === "actions" && (
        <ActionsTab actions={data?.actions ?? []} />
      )}
    </RightDrawer>
  );
}
```

---

## 8. AI Navigation 연동

### 8.1 virtualNode 우선 반환 정책

AI는 가능한 경우 raw filter 대신 **virtualId를 우선 반환**한다.
virtualId 기반 딥링크는 파라미터 오류 가능성이 낮고, 사용자에게 "의미있는 업무 개념"으로 안내된다.

```typescript
/** AI virtualNode matching priority */
const PHASE_VIRTUAL_NODE_PRIORITY: {
  virtualId: string;
  matchFilter: Partial<PhaseFilterSpec>;
}[] = [
  { virtualId: "phases.critical",  matchFilter: { healthStatus: "CRITICAL" } },
  { virtualId: "phases.ai-track",  matchFilter: { phaseType: "AI" } },
  { virtualId: "phases.si-track",  matchFilter: { phaseType: "SI" } },
  { virtualId: "phases.overdue",   matchFilter: { healthStatus: "WARNING" } },
];

function resolvePhaseNavigation(filter: PhaseFilterSpec): AiPhaseNavigation {
  // 1. virtualNode match attempt (priority)
  for (const vn of PHASE_VIRTUAL_NODE_PRIORITY) {
    if (isSubsetMatch(vn.matchFilter, filter)) {
      return { targetNodeId: "phases", virtualId: vn.virtualId, filter, reason: "..." };
    }
  }
  // 2. No match -> return raw filter
  return { targetNodeId: "phases", filter, reason: "..." };
}
```

### 8.2 AI 질문 -> 화면 이동 (FilterSpec + virtualId)

```typescript
/** AI navigation recommendation for phases (v2.0) */
interface AiPhaseNavigation {
  targetNodeId: "phases";
  /** virtualNode preferred return */
  virtualId?: string;
  /** FilterSpec-based filter object */
  filter: PhaseFilterSpec;
  /** Direct phase navigation */
  entityId?: string;                 // "PH-003"
  reason: string;
}
```

| 질문 | AI 반환 | virtualId? | 설명 |
|------|--------|-----------|------|
| "위험 단계 있어?" | `{ healthStatus: "CRITICAL" }` | `phases.critical` | virtualId 우선 |
| "AI부문 진행 상태는?" | `{ phaseType: "AI" }` | `phases.ai-track` | virtualId 우선 |
| "SI부문 보여줘" | `{ phaseType: "SI" }` | `phases.si-track` | virtualId 우선 |
| "기한 초과 단계 있어?" | `{ healthStatus: "WARNING" }` | `phases.overdue` | virtualId 우선 |
| "개발 단계 상세 보여줘" | `entityId: "PH-003"` | -- | 직접 이동 |
| "ACTIVE 단계만 보여줘" | `{ status: "ACTIVE" }` | -- | raw filter |
| "편차 -10% 이상 단계" | `{ deviationThreshold: -10 }` | -- | raw filter |

### 8.3 Preset별 do intent AI 라우팅

AI는 조치(do) 질문 시 section 1.3의 `PHASE_DO_INTENT_ROUTING`에 따라 targetNodeId를 결정한다.

> **v2.1 do-intent 트리거 규칙**:
> AI do-intent는 **HealthStatus 기준으로만** 발동한다.
> DeviationGrade는 do-intent 판단에 사용하지 않는다.
>
> | 조건 | AI 행동 | 근거 |
> | ---------- | ---------- | ---------- |
> | `healthStatus === "CRITICAL"` | 조치 유도 (`do_update_phase`, `do_create_phase_action`) | 즉시 행동 필요 |
> | `healthStatus === "WARNING"` | 주의 안내 (ask → 조치 제안) | 예방적 모니터링 |
> | `healthStatus === "NORMAL"` | do-intent 미발동 | 정상 상태 |
> | `deviationGrade === "CRITICAL_DELAY"` | 단독으로는 do-intent 미발동 | 원인 분석 보조만 |
>
> 이 규칙이 중요한 이유: HealthStatus에만 의존하면 기준이 흔들리지 않고,
> DeviationGrade 임계값 변경이 AI 행동에 영향을 주지 않는다.

```text
PM이 "편차 조치 등록해줘" -> targetNodeId: "phases" (조정 테이블)
PMO가 "편차 리포트 보여줘" -> targetNodeId: "reports" (리포트 Export)
DEV가 "현재 단계 알려줘" -> targetNodeId: "phases" (읽기 전용)
```

### 8.4 Context Panel에서의 AI 추천

```
-- 추천 액션 ----------------------
(!) 개발 단계 편차 -8% (CRITICAL)
  -> [원인 분석]             <- panelMode: "causes"

(!) SI 트랙 편차 -11% (CRITICAL)
  -> [조치 등록]             <- AdjustmentCreateModal open

(i) 테스트 단계 시작 예정 (2주 후)
  -> [WBS에서 확인]          <- targetNodeId: "wbs"

(i) 지연 Task 3건 미해결
  -> [이슈 관리에서 확인]    <- targetNodeId: "issues"
```

### 8.5 AI Navigation Contract 예시 (JSON)

```json
{
  "answer": {
    "summary": "현재 '개발' 단계에서 SI 트랙 편차가 -11%로 위험 수준입니다.",
    "highlights": [
      "SI 개발 단계 편차: -11% (CRITICAL)",
      "주요 원인: 인프라 승인 지연 (3주)",
      "지연 Task: 5건, 미해결 이슈: 2건"
    ],
    "warnings": [
      "테스트 단계 시작이 2주 후로 예정되어 있어, 개발 지연이 전파될 수 있습니다"
    ]
  },
  "navigation": {
    "primary": {
      "route": "/phases/PH-003",
      "label": "개발 단계 상세",
      "reason": "편차 원인 분석 및 조치 실행"
    },
    "secondary": [
      {
        "route": "/issues",
        "label": "이슈 관리",
        "reason": "미해결 이슈 2건 에스컬레이션"
      },
      {
        "route": "/wbs",
        "label": "WBS",
        "reason": "지연 Task 일정 재조정"
      }
    ]
  },
  "viewMode": {
    "suggested": "PM_WORK",
    "confidence": 0.85,
    "why": [
      "편차 조치 필요 -> PM 시점",
      "조정 테이블 접근 필요"
    ]
  },
  "requiredCaps": ["view_phases", "manage_phases"],
  "scopeHints": {
    "projectId": "p-001",
    "phaseId": "PH-003"
  }
}
```

---

## 9. 인터랙션 상세

### 9.1 Health Summary Strip 인터랙션

```
HealthChip 클릭:
  1. 해당 Phase row로 스크롤
  2. Phase row 하이라이트 (2초)
  3. Drawer 오픈 (PM_WORK/PMO_CONTROL)
  4. URL 업데이트: /phases/:phaseId
```

### 9.2 Track Toggle 전환

```
Track Toggle (ALL / AI / SI):
  1. 동일한 Phase 목록 유지
  2. 수치(Plan/Actual/Delta)가 트랙 기준으로 변경
  3. Health Status 재계산 (트랙 기준)
  4. Gantt 바에 트랙별 강조 표시
  5. URL query: ?phaseType=AI (or SI)
  6. API 재요청 (track parameter)
```

### 9.3 Phase Table Row 클릭

```
단일 클릭:
  PM_WORK / PMO_CONTROL: Drawer 오픈 (panelMode: "causes")
  DEV_EXECUTION: Drawer 오픈 (panelMode: "tasks", read-only)
  EXEC_SUMMARY / CUSTOMER_APPROVAL: 변화 없음

더블 클릭:
  /phases/:phaseId 상세 페이지로 이동

Row Expand (chevron 클릭):
  트랙별 분류(AI/SI) sub-row 표시
  자식 Phase 표시 (hierarchy)
```

### 9.4 Gantt 인터랙션

```
Gantt Bar 호버:
  Tooltip: Phase명, 기간, Plan/Actual/Delta

Gantt Bar 클릭:
  해당 Phase row 하이라이트 + Drawer 오픈

Gap 영역 (plan vs actual 차이):
  빨간 점선으로 표시
  호버 시 "N일 지연" 표시
```

### 9.5 조정 테이블 인터랙션

```
[+ 조치 추가] 클릭:
  PM_WORK: AdjustmentCreateModal 오픈
  Other presets: 비활성 (cap: manage_phases 없음)

조치 행 클릭:
  조치 상세 편집 (inline 또는 모달)

조치 상태 변경:
  OPEN -> IN_PROGRESS -> RESOLVED -> CLOSED
  드롭다운으로 직접 변경 (cap: manage_phases)
```

### 9.6 Dependency Graph 인터랙션

```
Node 클릭:
  해당 Phase row로 스크롤 + 하이라이트

Edge 클릭:
  Drawer 열기 (영향받는 Phase의 원인 탭)
  원인에 "의존성 지연" 카드 포함

Edge 호버:
  Tooltip: "N일 지연 전파 예상"
```

### 9.7 KPI 카드 클릭 -> 필터 활성화

```typescript
/** KPI card click -> filter mapping */
const PHASE_KPI_CARD_FILTER_MAP: Record<string, {
  filter: Partial<PhaseFilterSpec>;
  virtualId?: string;
}> = {
  KPI_PHASES:    { filter: {} },                                    // total (no filter)
  KPI_ACTIVE:    { filter: { status: "ACTIVE" } },                 // active phases
  KPI_DEVIATION: { filter: { deviationThreshold: -5 } },           // deviation >= 5%
  KPI_CRITICAL:  { filter: { healthStatus: "CRITICAL" }, virtualId: "phases.critical" },
  KPI_COMPLETION:{ filter: { status: "COMPLETED" } },              // completed phases
  KPI_OVERDUE:   { filter: { healthStatus: "WARNING" }, virtualId: "phases.overdue" },
  KPI_HEALTH:    { filter: {} },                                    // health (info only)
};
```

**인터랙션 흐름**:

```
1. KPI 카드 클릭
2. PHASE_KPI_CARD_FILTER_MAP에서 filter 객체 조회
3. 현재 필터 바 상태에 merge
4. URL 업데이트 (serializePhaseFilter)
5. 동일 카드 재클릭 시 필터 해제 (toggle)
6. 활성 카드는 테두리 강조 + 필터 활성 아이콘
```

### 9.8 데이터 새로고침

| 항목 | 주기 |
|------|------|
| Phase 목록 | 페이지 진입 시 + Track 전환 시 + 필터 변경 시 |
| Phase 통계 | 페이지 진입 시 (캐시 5분) |
| Drill-down | Drawer 오픈 시 (실시간) |
| Gantt | Phase 목록과 동기 (동일 데이터 변환) |
| Dependency | 페이지 진입 시 (캐시 10분) |
| 조정 테이블 | Drawer 탭 전환 시 + 조치 CRUD 후 |

### 9.9 동시 편집 충돌 대응

```text
낙관적 잠금 (Optimistic Locking):
  +-- 모든 PATCH 요청에 If-Match: {version} 헤더 포함
  +-- 서버는 현재 version과 비교
  +-- 불일치 시 409 Conflict + 현재 데이터 반환
  +-- 프론트는 "다른 사용자가 수정했습니다" 안내 + 새로고침 옵션

적용 범위:
  +-- Phase PATCH (상태/진행률 변경) -> 낙관적 잠금 적용
  +-- Adjustment CRUD -> 낙관적 잠금 적용
  +-- Phase Settings -> 낙관적 잠금 적용
```

---

## 10. 반응형 대응

| 너비 | Phase Table | Gantt | Drawer | Dependency |
|------|------------|-------|--------|------------|
| >=1440px | 전체 컬럼 + 트랙 sub-row | Full 모드 (12-month view) | Right Panel (420px, 공존) | 표시 |
| 1280px | 전체 컬럼 (원인 축약 -> 아이콘/툴팁) | Full 모드 (축약) | Right Panel (380px, 공존) | 표시 |
| <=1024px | 기본 컬럼 (단계/Plan/Act/Delta/Health) | Compact 모드 | Drawer -> Full-screen modal | 숨김 |
| <=768px | 카드 뷰 (Phase 카드) | 숨김 (KPI로 대체) | Full-screen modal | 숨김 |

**반응형 전환 시 보존 규칙**:

| 항목 | 보존 여부 |
|------|---------|
| Track 선택 | 보존 |
| 필터 상태 | 보존 |
| 선택된 Phase | 보존 (모달로 전환) |
| Gantt 줌 레벨 | 리셋 (compact로) |
| Drawer 탭 | 보존 |

---

## 11. 깨지기 쉬운 곳 체크리스트

| # | 위험 지점 | 해결책 | 검증 방법 |
|---|----------|--------|---------|
| 1 | **Phase hierarchy 집계 오류** | `parent_id` self-FK recursive CTE 쿼리로 하위 Phase 전체를 포함하여 진행률 집계. 부모 Phase 진행률 = 자식 가중 평균. 서버에서만 계산 | 부모 Phase 진행률이 자식 Phase 변경 시 자동 업데이트되는지 확인. 재귀 CTE가 깊은 중첩(3+레벨)에서 정상 동작하는지 확인 |
| 2 | **Track 전환 시 수치 불일치** | Track은 필터가 아닌 Layer. 동일 Phase 목록 유지, 수치만 trackBreakdown에서 추출. ALL은 가중 평균 | Track ALL->AI->SI 전환 시 Phase 행 수가 동일한지 확인. 수치가 트랙 기준으로 변경되는지 확인 |
| 3 | **Health 상태 판정 프론트/백엔드 불일치** | Health 상태 판정은 서버에서만 수행. 프론트는 서버 반환값 표시만. 프론트 로컬 계산 금지 | 서버 반환 healthStatus와 프론트 표시 값 일치 확인. 프론트에서 임의 Health 계산 코드 없는지 확인 |
| 4 | **Gantt 타임라인 날짜 범위 초과** | Phase 기간이 프로젝트 기간을 초과할 수 있음. Gantt는 전체 Phase의 min(startDate)~max(endDate) 범위로 자동 조정 | 극단적 날짜 범위(1년+)에서 Gantt 렌더링 정상 동작 확인. 빈 날짜(null) 처리 확인 |
| 5 | **동시 편집 + 상태 전이 충돌** | Phase 상태 전이는 서버 트랜잭션. 낙관적 잠금(If-Match + version). CLOSED 상태는 비가역적 -- 서버에서 차단 | 두 브라우저에서 같은 Phase ACTIVE->COMPLETED 동시 시도 시 하나만 성공 확인. CLOSED Phase 편집 시도 시 서버 거부 확인 |
| 6 | **HealthStatus vs DeviationGrade 혼용** | HealthStatus는 행동 트리거 전용, DeviationGrade는 원인 분석 전용. AI do-intent/virtualNode/KPI 필터는 HealthStatus만 참조. Cause Tab/Adjustment Table만 DeviationGrade 참조 | AI 라우팅 코드에서 deviationGrade 참조가 없는지 확인. KPI 필터에서 healthStatus만 사용하는지 확인. Cause Tab에서 deviationGrade가 표시되는지 확인 |
| 7 | **Decision Record 타임스탬프 정합성** | Adjustment/GateReview/StatusTransition 생성 시 서버가 DecisionRecord를 동일 트랜잭션 내에서 자동 생성. decidedAt = 소스 레코드의 createdAt/transitionedAt과 동일해야 함 | DecisionRecord 타임라인에서 소스 레코드와 시간 순서가 일치하는지 확인. 트랜잭션 롤백 시 DecisionRecord도 함께 롤백되는지 확인 |

---

## 12. Capability 매핑 총괄

| Capability | 행위 | 대표 역할 |
|-----------|------|---------|
| `view_phases` | Phase 조회, 목록/상세/Gantt/Dependency 열람, Drawer 읽기 | ALL (역할별 Preset 분기) |
| `manage_phases` | Phase 생성/편집/삭제, 상태 변경, 조치 등록, Phase Settings 편집 | PM, PMO |
| `manage_issues` | Phase Drawer에서 이슈 생성/에스컬레이션 | PM, PMO |
| `export_reports` | 단계별 리포트 Export | PMO |

> **Phase Settings 접근**: `/phases/settings` 라우트는 `manage_phases` Capability 필수.
> `view_phases`만 있으면 Settings 메뉴 자체가 숨김 처리된다.

**권한 4중 방어 적용**:

| Layer | Phase 적용 |
|-------|---------|
| Layer 1: Menu | `view_phases` 없으면 사이드바에서 "단계(Phase)" 메뉴 숨김 |
| Layer 2: Route Guard | `/phases` -> `view_phases`, `/phases/settings` -> `manage_phases` |
| Layer 3: Action Guard | `[+ 단계]`, `[조치 등록]`, `[상태 변경]` 버튼은 `manage_phases` 필요 |
| Layer 4: Backend | API 레벨에서 `@PreAuthorize` 강제 |

---

## 13. 기존 화면 vs 개선 화면 비교

| 항목 | 기존 (엑셀 기반) | 개선 (본 설계) |
|------|----------------|-------------|
| **구조** | 플랫 테이블 (나열) | **상태->원인->조치 3단 구조** + Gantt + Dependency |
| **상태 판단** | 수동 입력 (색상 레이블) | **자동 Health 판정** (NORMAL/WARNING/CRITICAL) |
| **편차 관리** | 계산기로 수동 | **자동 편차 계산** + 임계값 경고 |
| **AI/SI 분리** | 별도 시트 | **Track Layer** (ALL/AI/SI 동일 화면 전환) |
| **조치 추적** | 회의록에 기록 | **조정 테이블** (감사 추적 가능) |
| **시각화** | 표 나열 | **Gantt 타임라인** + Dependency Graph + Health Strip |
| **AI 연동** | 없음 | **virtualNode 딥링크** + Preset별 AI 라우팅 |
| **Phase hierarchy** | 플랫 | **parent_id self-FK** 재귀 집계 |
| **Gate 승인** | 구두 확인 | **GateStatus 워크플로우** (PENDING->SUBMITTED->APPROVED/REJECTED) |
| **설정** | 동일 화면 | **분리 라우트** (`/phases/settings`) |
| **권한** | 전체 열기/닫기 | **2 Capability** (view_phases / manage_phases) + Preset 분기 |

---

## 14. Integration (타 화면 연동)

### 14.1 대시보드 연동

```
Dashboard
  +-- Phase Timeline Widget
        +-- compact Gantt (읽기 전용)
        +-- 클릭 시 /phases 이동
        +-- activePhase 강조
```

### 14.2 WBS 연동

```
WBS
  +-- Phase 필터 (WBS 항목을 Phase 기준으로 필터링)
  +-- Phase 선택 시 해당 Phase의 WbsGroup/WbsItem만 표시
  +-- Phase <- WbsGroup <- WbsItem <- WbsTask 계층 관계
```

### 14.3 백로그 연동

```
Backlog
  +-- Phase 필터 (Epic/Story를 Phase 기준으로 필터링)
  +-- Phase 진행률에 백로그 완료율 반영 가능
```

### 14.4 이슈 관리 연동

```
Issues
  +-- Phase Drawer에서 이슈 생성 시 phaseId 자동 매핑
  +-- Phase의 openIssues count는 이슈 관리 데이터 참조
```

### 14.5 리포트 연동

```
Reports
  +-- Phase 단위 리포트 생성
  +-- 편차 분석 리포트 (조정 테이블 기반)
  +-- Phase 진행률 추이 차트
```

---

## 15. DoD (본 화면 완료 기준)

- [ ] `/phases` 목록에서 Preset별 컬럼/위젯 분기 동작
- [ ] Health Summary Strip: 단계별 HealthChip 표시, CRITICAL 자동 강조
- [ ] KPI Row: 전체/활성/평균편차/위험편차/완료율/초과/건강도 7종 표시
- [ ] FilterSpec 기반 다차원 필터 (status/phaseType/partId/dateRange/deviationThreshold/healthStatus/q) 동작
- [ ] **FilterSpec URL 직렬화**: serialize/deserialize 왕복 보장, enum 화이트리스트, dateRange from/to 분리
- [ ] Phase Table: 단계별 Plan/Actual/Delta/Health 표시, row expand (트랙/자식 Phase)
- [ ] **Phase hierarchy**: parent_id self-FK 재귀 집계, 부모 진행률 = 자식 가중 평균
- [ ] **Track Toggle**: ALL/AI/SI 전환 시 동일 Phase 목록 + 트랙별 수치 변경
- [ ] Gantt Timeline: 계획 vs 실적 비교 바, gap 표시, 모드별 (full/compact/milestone) 분기
- [ ] Dependency Mini-Graph: 지연 전파 시각화, edge 클릭 시 Drawer 연동
- [ ] **조정 테이블**: 상태->원인->조치 구조, CRUD 동작 (cap: manage_phases)
- [ ] panelMode 기반 Right Panel 분기 (none/causes/tasks/issues/actions/adjustment/detail)
- [ ] **Drill-down Drawer**: 4탭 (원인/지연Task/이슈/조치기록) 전환 동작
- [ ] `/phases/:phaseId` 딥링크 시 Drawer auto-open
- [ ] Health 상태 자동 판정: 편차 기반 NORMAL/WARNING/CRITICAL 서버 계산
- [ ] **Phase 상태 전이**: PLANNED->ACTIVE->COMPLETED->CLOSED 서버 트랜잭션
- [ ] **Gate Status 워크플로우**: PENDING->SUBMITTED->APPROVED/REJECTED
- [ ] Phase CRUD (cap: manage_phases): 생성/편집/삭제 동작
- [ ] Adjustment CRUD (cap: manage_phases): 조치 등록/수정/삭제 동작
- [ ] **Phase Settings**: `/phases/settings` 분리 라우트 (Template + Instance)
- [ ] Phase Status Transition Error Contract: 4종 에러 코드별 프론트 대응
- [ ] KPI 카드 클릭 -> 필터 활성화 (toggle 동작)
- [ ] **CUSTOMER_APPROVAL 마스킹**: 내부 원인 상세 마스킹
- [ ] **DEV_EXECUTION 읽기 전용**: Task 탭 기본, 편집 CTA 숨김
- [ ] virtualNode 4종: critical/ai-track/si-track/overdue AI 우선 반환
- [ ] **Preset별 AI 라우팅**: PM/PMO/DEV/EXEC/CUSTOMER 별 targetNodeId 분기
- [ ] AI Navigation Contract: answer + navigation + viewMode + requiredCaps + scopeHints
- [ ] Health Summary Strip 클릭 -> Phase row 스크롤 + Drawer 오픈
- [ ] Track Toggle 전환 시 수치 변경 + API 재요청
- [ ] Gantt 인터랙션: hover tooltip, click -> row highlight + Drawer
- [ ] Dependency Graph 인터랙션: node/edge click -> scroll/Drawer
- [ ] 동시 편집 충돌: 낙관적 잠금 (If-Match + version) + 409 병합 안내
- [ ] 반응형 레이아웃 (>=1440 / 1280 / <=1024 / <=768)
- [ ] Empty/Loading/Error/NoPermission 상태 표시
- [ ] 타 화면 연동: Dashboard Phase Timeline, WBS Phase filter, Backlog Phase filter, Issues Phase link

**v2.1 추가 DoD**:

- [ ] **HealthStatus vs DeviationGrade 역할 분리**: AI do-intent/virtualNode/KPI 필터는 HealthStatus만 참조, DeviationGrade는 Cause Tab/Adjustment Table 전용
- [ ] **Reliability 3-tuple 표준화**: 모든 API 응답에서 `warnings: {code, message, severity}[]` 형식 사용, `completeness.breakdown` 옵셔널 구조
- [ ] **ScopeEcho 보안 경계 세분화**: `scopeReason` 4종 (`full_access` / `role_restricted_assignee` / `role_restricted_part` / `explicit_filter`) 정상 반환
- [ ] **Scope 2-tier**: `securityKeys` (project) + `explorationKeys` (part, trackType) 분리 적용
- [ ] **Decision Record Lineage**: Adjustment/GateReview/StatusTransition 생성 시 DecisionRecord 자동 생성, Drawer 조치 기록 탭에서 통합 타임라인 표시
- [ ] **AI do-intent healthStatus 전용 규칙**: do-intent가 deviationGrade 기준으로 발동하지 않는지 검증
- [ ] **깨지기 쉬운 곳 7항**: HealthStatus/DeviationGrade 혼용 방지 + Decision Record 타임스탬프 정합성 검증

---

## 부록 A. 변경이력

| 버전 | 날짜 | 변경 내용 |
| ------ | ------ | --------- |
| v1.0 | 2026-02-08 | 초안 작성 -- Phase 상태 모델, FilterSpec, Preset별 분기, Health Summary Strip, Phase Table, Gantt Timeline, Dependency Graph, 조정 테이블, Drill-down Drawer (4탭), Phase Settings 분리 라우트, AI Navigation 연동, 컴포넌트 분해, 데이터 모델/API, Phase hierarchy 재귀 집계, Gate Status 워크플로우 |
| v2.0 | 2026-02-08 | 11개 영역 통합: (1) Phase 상태 확장 (PLANNED/ACTIVE/COMPLETED/CLOSED), (2) Track Layer 모델 (ALL/AI/SI), (3) 조정 테이블 (상태->원인->조치) 감사 추적 구조, (4) Health 자동 판정 (서버 전용), (5) 편차 분석 엔진 (deviationThreshold + 4단계 등급), (6) Phase hierarchy parent_id self-FK 재귀 CTE, (7) Gate Status 워크플로우, (8) Phase Status Transition Error Contract 4종, (9) virtualNode 4종 (critical/ai-track/si-track/overdue), (10) Preset별 AI 라우팅 정책 + CUSTOMER_APPROVAL 마스킹, (11) 깨지기 쉬운 5곳 체크리스트, (12) 타 화면 연동 (Dashboard/WBS/Backlog/Issues/Reports) |
| v2.1 | 2026-02-08 | 7개 영역 보강: (1) HealthStatus(행동 트리거) vs DeviationGrade(원인 분석) 역할 분리 -- AI do-intent는 healthStatus 기준 전용, (2) Preset Overlay 스택 가능한 컨텍스트 설계 노트 (basePreset + overlay, Capability는 base 고정), (3) Decision Record Lineage -- Adjustment/GateReview/StatusTransition 감사 계보 통합, DecisionRecord 자동 생성, (4) Reliability 3-tuple 표준화 -- `warnings: {code, message, severity}[]` + `completeness.breakdown` 옵셔널 구조 (WBS v1.1 패턴), (5) ScopeEcho 보안 경계 세분화 -- scopeReason 4종 (full_access/role_restricted_assignee/role_restricted_part/explicit_filter), (6) Scope 2-tier -- securityKeys + explorationKeys 분리 (WBS v1.1 패턴), (7) 깨지기 쉬운 곳 5->7항 확장 (HealthStatus/DeviationGrade 혼용 방지, Decision Record 타임스탬프 정합성) |
