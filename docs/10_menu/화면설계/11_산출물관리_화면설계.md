# 11. 산출물관리 화면설계

> 작성일: 2026-02-08
> 버전: v2.1
> 라우트: `/deliverables`, `/deliverables/:deliverableId`
> 필요 Capability: `view_deliverables` (조회), `manage_deliverables` (업로드/편집), `approve_deliverable` (승인)
> 기본 Preset: 역할에 따라 자동 결정
> 노드 역할: **Detail** (상세 노드 -- 필터/조회/승인흐름 전용)

---

## 1. 화면 개요

### 1.1 목적

산출물관리는 **"이 프로젝트의 산출물이 지금 어떤 상태인가? 누가 승인해야 하는가?"**에 대한 답을 제공한다.
기존 파일서버+엑셀 기반 산출물 목록을 **"생명주기를 가진 객체"**로 전환하여, 산출물의 업로드 -> 검토 -> 승인 -> 확정(Locked)까지의 **승인 체인(Approval Chain)**을 실시간으로 관리한다.

> **v2.0 변경**: Capability 세분화 (`manage_deliverables` + `approve_deliverable` 분리),
> FilterSpec 온톨로지 내장, 승인 워크플로우 3단계 확정 (Submitter -> Reviewer -> Approver),
> 버전 관리(auto-increment) 확정, Phase-based 산출물 템플릿 연동,
> Requirement Trace 역연결, Right Panel panelMode 정의,
> AI 딥링크 FilterSpec 기반 전환.

> **v2.1 변경**: (1) Deliverable.status = currentVersion 파생(Derived Status) 확정,
> (2) LOCKED 정책 Option B 채택 -- 기존 LOCKED 버전 불변 + 신규 버전 생성 허용,
> (3) FilterSpec `view` 키 정식 등록 + `allowedViews` 화이트리스트,
> (4) `visibility` 필드 추가 (Customer 스코프 데이터 레벨 강제),
> (5) Reviewer/Approver 자동 할당 정책 (Phase Template + Part 기반),
> (6) Approval API: Idempotency-Key 헤더 + concurrency token(If-Match) + 응답에 currentVersion 포함,
> (7) Reliability 3-tuple 구조화 + ScopeEcho 표준화,
> (8) Trace link 유일성 제약 (active 중복 방지),
> (9) Upload MIME 검증 강화 (magic number + Content sniffing),
> (10) Fragile Checklist 5항 → 10항 확장,
> (11) Audit Evidence Export 입력 필터 강제 규칙.

### 1.2 설계 원칙

| 원칙 | 설명 |
|------|------|
| **산출물 = 살아있는 객체** | 단순 파일이 아니라 ID 기반 승인 흐름을 가진 엔티티 |
| **승인 체인 필수** | 산출물 상세 화면 우측에 항상 Approval Chain 표시 |
| **버전 = 불변 스냅샷** | 새 버전 업로드 시 기존 버전은 읽기 전용, 자동 increment (v1, v2, v3...) |
| **Phase-based 템플릿** | 각 Phase에 필수 산출물 템플릿이 정의되어 있고, 미제출 항목을 자동 추적 |
| **카테고리 분류** | 설계서, 소스코드, 테스트결과, 매뉴얼, 회의록 등 표준 카테고리 |
| **FilterSpec = 온톨로지** | 필터 키가 AI/URL/백엔드 공통 스키마로 통합 |
| **Trace 역연결** | 요구사항 -> 산출물 추적 연결로 증빙 관리 (Requirement Trace Chain 최하위) |
| **Drag & Drop 업로드** | 다중 파일 업로드, 버전 자동 증가, 파일 유형 검증 |
| **Status = Derived** | Deliverable.status는 currentVersion.status에서 서버가 파생 (READ-ONLY) -- 10번(TC) derivedStatus와 동일 철학 |
| **LOCKED = 버전 불변** | LOCKED 버전은 영구 불변(감사 증빙), 단 deliverable에 신규 버전(v+1) 생성은 허용 (Option B) |
| **visibility 스코프** | 산출물에 `visibility` 필드 추가 (`internal` / `customer`) -- Customer 접근 범위를 데이터 레벨에서 강제 |
| **view 키 표준** | FilterSpec에 `view` 키를 정식 등록하고 `allowedViews`로 허용 값 화이트리스트 운영 |
| **Reviewer/Approver 자동 할당** | submit 시 서버가 Phase Template + Part 기반으로 reviewer/approver 자동 확정 |
| **Idempotency-Key** | 모든 mutation API에 `Idempotency-Key` 헤더 지원 -- 중복 클릭/네트워크 재시도 안전 |
| **ScopeEcho 필수** | 모든 API 응답에 `scope: { projectId }` 포함 -- 프론트 크로스체크 |

### 1.3 핵심 질문 -> 위젯 매핑

| 사용자 질문 | 화면 영역 | 설명 |
|-----------|---------|------|
| "산출물이 총 몇 건이야?" | 상단 KPI | 전체/승인완료/대기 건수 통계 |
| "검토 대기 중인 산출물은?" | 필터 + 배지 | status=SUBMITTED 필터 |
| "승인 대기 건이 있어?" | 필터 + 배지 | status=IN_REVIEW 필터 |
| "이 산출물의 버전 이력은?" | Right Panel | 버전 히스토리 타임라인 |
| "이번 단계에 제출해야 할 산출물은?" | Phase 필터 + KPI | Phase 기반 필수 산출물 체크리스트 |
| "반려된 산출물 있어?" | 필터 + 배지 | status=REJECTED 필터 |
| "기한 초과 산출물은?" | KPI + 필터 | overdue 필터 |
| "이 산출물이 어떤 요구사항의 증빙이야?" | Right Panel Trace | Deliverable -> Requirement 역추적 |
| "설계서 카테고리만 보여줘" | 필터 | category=DESIGN_DOC 필터 |
| "내가 올린 산출물 목록" | 필터 | submitterId=me 필터 |

---

## 2. MenuOntology 노드

### 2.1 타입 확정 (v2.0 변경사항)

v1.0 대비 변경된 필드 규격:

| 항목 | v1.0 | v2.0 (확정) | 변경 사유 |
|------|------|------------|----------|
| `entities` | 소문자 `"deliverable"` | PascalCase `"Deliverable"` | EntityType enum 정규화 (01_대시보드 2.1과 동일) |
| `intents` | 4개 | 14개로 확장 | 필터/액션/승인/버전 질문 커버리지 확보 |
| `manage_deliverables` | 업로드+승인 통합 | `manage_deliverables` (업로드/편집) + `approve_deliverable` (승인) 분리 | 업로드 권한과 승인 권한은 별개 행위 |
| `suggestedActions.capability` | 단일 | `requiredCaps?: Capability[]` + `targetNodeId?: string` | 복수 권한 + nodeId 기반 이동 |
| `deepLinks.pattern` | `{category}` 형태 | `:category` 형태 | 라우트 템플릿 표준 통일 |
| `scopeHints` | 추상 단일 | `scope: { keys, params }` 2계층 분리 | 스코프 해석 안정성 |
| `ui.highlightMetrics` | 단일 배열 | `ui.highlight.metricKeys` + `ui.highlight.widgetKeys` | 데이터 키 vs UI 위젯 키 분리 |
| `nodeRole` | 없음 | `"detail"` 신규 | AI 스코어링 기준 (행동 질문에 +10 가산) |
| `filterSpec` | 없음 | 온톨로지 내장 FilterSpec | AI/URL/백엔드 통합 필터 키 |

### 2.2 FilterSpec 정의

FilterSpec은 **이 화면이 지원하는 필터 스키마**를 온톨로지 내부에 선언한다.
AI가 딥링크를 생성할 때, URL 파라미터 문자열이 아니라 **FilterSpec 키 기반 필터 객체**를 반환한다.

```typescript
/** 산출물 필터 스키마 -- 온톨로지 내장 */
export interface DeliverableFilterSpec {
  /** Phase 연결 */
  phaseId?: string;
  /** Part(파트) 범위 */
  partId?: string;
  /** 산출물 카테고리 */
  category?: DeliverableCategory;
  /** 승인 상태 */
  status?: DeliverableStatus;
  /** 제출자 필터 */
  submitterId?: string;
  /** 승인자 필터 */
  approverId?: string;
  /** 기한 기반 필터 */
  dateRange?: {
    from?: string;   // ISO 8601
    to?: string;     // ISO 8601
  };
  /** 기한 초과 여부 */
  overdue?: boolean;
  /** 요구사항 연결 여부 */
  traceLinked?: boolean;
  /** 공개 범위 (v2.1) */
  visibility?: DeliverableVisibility;
  /** 뷰 모드 (v2.1) -- allowedViews 화이트리스트로 제한 */
  view?: "list" | "checklist";
  /** 자유 검색어 */
  q?: string;
}

/** 산출물 공개 범위 enum (v2.1) */
export type DeliverableVisibility =
  | "internal"          // 내부 전용 (Customer 접근 불가)
  | "customer";         // 고객 공개 (Customer PM 접근 가능)

/** 산출물 카테고리 enum */
export type DeliverableCategory =
  | "DESIGN_DOC"        // 설계서
  | "SOURCE_CODE"       // 소스코드
  | "TEST_RESULT"       // 테스트결과
  | "MANUAL"            // 매뉴얼
  | "MEETING_MINUTES"   // 회의록
  | "PROPOSAL"          // 제안서
  | "REPORT"            // 보고서
  | "CONTRACT"          // 계약서
  | "INSPECTION"        // 검수서
  | "OTHER";            // 기타

/** 산출물 상태 enum */
export type DeliverableStatus =
  | "DRAFT"             // 초안 (업로드 후 미제출)
  | "SUBMITTED"         // 제출 완료 (검토 대기)
  | "IN_REVIEW"         // 검토 중 (승인 대기)
  | "APPROVED"          // 승인 완료
  | "LOCKED"            // 확정 (변경 불가)
  | "REJECTED";         // 반려
```

> **LOCKED vs APPROVED**: APPROVED는 승인 완료 상태이지만 재업로드(새 버전)가 가능하다.
> LOCKED는 **해당 버전**의 최종 확정 상태로, LOCKED 버전 자체는 어떠한 변경도 불가능하며 감사 증빙 대상이 된다.
> PM 또는 PMO만 APPROVED -> LOCKED 전환이 가능하다.

> **v2.1 Option B 정책**: LOCKED는 "버전 레벨 불변"이다.
> 기존 LOCKED 버전(예: v2)은 영구 보존되지만, deliverable에 신규 버전(v3)을 생성하여
> 새로운 승인 체인을 시작할 수 있다. 이때 Deliverable.status는 신규 버전(v3)의 DRAFT로 파생된다.
> LOCKED 버전의 파일/메타/승인이력은 절대 변경되지 않으므로 감사 무결성이 유지된다.

### 2.3 Deliverables 노드 (확정본)

```typescript
const deliverablesNode: MenuOntologyNodeV2 = {
  nodeId: "deliverables",
  label: "산출물 관리",
  route: "/deliverables",
  icon: "FolderOpenRounded",
  domain: "control",
  nodeRole: "detail",              // detail node -- +10 bonus for action/filter questions

  requiredCaps: ["view_deliverables"],

  // --- Intents: 14 (v1.0 4 -> v2.0 14) ---
  intents: [
    // Ask -- query/question
    "ask_deliverable_status",       // "산출물 현황 알려줘"
    "ask_deliverable_detail",       // "설계서_v3 상세 보여줘"
    "ask_pending_review",           // "검토 대기 산출물 있어?"
    "ask_pending_approval",         // "승인 대기 건이 있어?"
    "ask_overdue_deliverables",     // "기한 초과 산출물은?"
    "ask_phase_deliverables",       // "이번 단계 제출 산출물은?"
    "ask_deliverable_version",      // "이 산출물 버전 이력은?"
    "ask_deliverable_trace",        // "이 산출물이 어떤 요구사항 증빙이야?"
    "ask_deliverable_by_category",  // "설계서 카테고리만 보여줘"
    "ask_my_deliverables",          // "내가 올린 산출물 목록"
    // Do -- execute/change
    "do_upload_deliverable",        // "산출물 업로드할게"
    "do_submit_deliverable",        // "산출물 제출할게"
    "do_approve_deliverable",       // "산출물 승인 처리해줘"
    "do_reject_deliverable",        // "산출물 반려해줘"
  ],
  canonicalQuestions: [
    "산출물 현황 보여줘",
    "검토 대기 중인 산출물이 있어?",
    "승인 대기 건이 몇 개야?",
    "이번 단계에 제출해야 할 산출물은?",
    "기한 초과 산출물은 몇 건이야?",
    "설계서 카테고리 산출물 목록은?",
    "이 산출물의 버전 이력 보여줘",
    "반려된 산출물 있어?",
    "내가 올린 산출물 목록은?",
    "이 산출물이 어떤 요구사항의 증빙이야?",
  ],
  entities: ["Deliverable", "Requirement", "Phase", "User"],
  keywords: [
    "산출물", "파일", "업로드", "승인", "검토", "버전", "설계서",
    "테스트결과", "매뉴얼", "회의록", "증빙", "반려", "확정",
    "deliverable", "upload", "approval", "review", "version",
    "document", "file", "locked", "rejected", "draft",
  ],
  metrics: [
    "total_deliverables",
    "pending_review",
    "pending_approval",
    "approved_count",
    "locked_count",
    "rejected_count",
    "overdue_submissions",
    "version_count",
    "phase_completion_rate",
    "trace_linked_rate",
  ],

  // --- FilterSpec ontology (v2.1: +view, +visibility = 12 keys) ---
  filterSpec: {
    keys: [
      "phaseId", "partId", "category", "status",
      "submitterId", "approverId", "dateRange",
      "overdue", "traceLinked", "visibility",
      "view", "q",
    ],
    allowedViews: ["list", "checklist"],   // v2.1: view whitelist
    defaults: { view: "list" },            // overridden per Preset
  },

  defaultPreset: "PM_WORK",
  presetPolicies: [
    {
      preset: "EXEC_SUMMARY",
      ui: {
        density: "compact",
        defaultRightPanel: "closed",
        highlight: {
          metricKeys: ["total_deliverables", "approved_count", "phase_completion_rate"],
          widgetKeys: ["KPI_TOTAL", "KPI_APPROVED", "PHASE_COMPLETION"],
        },
        hiddenColumns: [
          "submitterId", "approverId", "fileSize",
          "version", "traceLinked",
        ],
      },
    },
    {
      preset: "PMO_CONTROL",
      ui: {
        density: "standard",
        defaultRightPanel: "open",
        highlight: {
          metricKeys: [
            "pending_approval", "overdue_submissions",
            "phase_completion_rate", "locked_count",
          ],
          widgetKeys: [
            "KPI_PENDING_APPROVAL", "KPI_OVERDUE",
            "PHASE_COMPLETION", "APPROVAL_CHAIN_PREVIEW",
          ],
        },
      },
      suggestedActions: [
        {
          key: "lock_approved",
          label: "승인 산출물 확정(Lock)",
          requiredCaps: ["approve_deliverable"],
          targetNodeId: "deliverables",
        },
        {
          key: "export_evidence",
          label: "감사 증빙 Export",
          requiredCaps: ["export_reports"],
          targetNodeId: "audit-evidence",
        },
      ],
    },
    {
      preset: "PM_WORK",
      ui: {
        density: "detailed",
        defaultRightPanel: "open",
        highlight: {
          metricKeys: [
            "pending_review", "pending_approval",
            "overdue_submissions", "rejected_count",
          ],
          widgetKeys: [
            "KPI_PENDING_REVIEW", "KPI_PENDING_APPROVAL",
            "KPI_OVERDUE", "APPROVAL_CHAIN_PREVIEW",
          ],
        },
      },
      suggestedActions: [
        {
          key: "approve",
          label: "산출물 승인",
          requiredCaps: ["approve_deliverable"],
          targetNodeId: "deliverables",
        },
        {
          key: "reject",
          label: "산출물 반려",
          requiredCaps: ["approve_deliverable"],
          targetNodeId: "deliverables",
        },
        {
          key: "lock",
          label: "확정(Lock)",
          requiredCaps: ["approve_deliverable"],
          targetNodeId: "deliverables",
        },
      ],
    },
    {
      preset: "DEV_EXECUTION",
      ui: {
        density: "standard",
        defaultRightPanel: "open",
        defaultFilters: { submitterId: "me" },
        highlight: {
          metricKeys: ["total_deliverables", "pending_review", "rejected_count"],
          widgetKeys: ["KPI_MY_DELIVERABLES", "KPI_REJECTED"],
        },
      },
      suggestedActions: [
        {
          key: "upload",
          label: "산출물 업로드",
          requiredCaps: ["manage_deliverables"],
          targetNodeId: "deliverables",
        },
        {
          key: "submit",
          label: "산출물 제출",
          requiredCaps: ["manage_deliverables"],
          targetNodeId: "deliverables",
        },
      ],
    },
    {
      preset: "CUSTOMER_APPROVAL",
      ui: {
        density: "compact",
        defaultRightPanel: "open",
        defaultFilters: { status: "IN_REVIEW" },
        highlight: {
          metricKeys: [
            "total_deliverables", "pending_approval",
            "approved_count",
          ],
          widgetKeys: [
            "KPI_TOTAL", "KPI_PENDING_APPROVAL",
            "CUSTOMER_APPROVAL_PANEL",
          ],
        },
      },
      suggestedActions: [
        {
          key: "customer_approve",
          label: "산출물 승인",
          requiredCaps: ["approve_deliverable"],
          targetNodeId: "deliverables",
        },
        {
          key: "customer_download",
          label: "다운로드",
          requiredCaps: ["view_deliverables"],
          targetNodeId: "deliverables",
        },
      ],
    },
  ],

  // --- DeepLink: routeTemplate standard (:param) ---
  deepLinks: [
    {
      pattern: "/deliverables?category=:category",
      description: "카테고리별 산출물 필터",
      requiredParams: ["category"],
    },
    {
      pattern: "/deliverables?status=:status",
      description: "상태별 산출물 필터",
      requiredParams: ["status"],
    },
    {
      pattern: "/deliverables?phaseId=:phaseId",
      description: "단계별 산출물 필터",
      requiredParams: ["phaseId"],
    },
    {
      pattern: "/deliverables?overdue=true",
      description: "기한 초과 산출물",
      requiredParams: [],
    },
    {
      pattern: "/deliverables?submitterId=:submitterId",
      description: "제출자별 산출물",
      requiredParams: ["submitterId"],
    },
    {
      pattern: "/deliverables/:deliverableId",
      description: "산출물 상세 + 버전 이력 + 승인 체인",
      requiredParams: ["deliverableId"],
    },
  ],

  // --- Virtual nodes: deep link promoted to ontology 2nd layer ---
  virtualNodes: [
    {
      virtualId: "deliverables.pending-review",
      label: "검토 대기 산출물",
      routeTemplate: "/deliverables?status=SUBMITTED",
      requiredParams: [],
      intents: ["ask_pending_review", "ask_deliverable_status"],
      description: "검토 대기 상태 산출물 목록 직접 진입",
    },
    {
      virtualId: "deliverables.pending-approval",
      label: "승인 대기 산출물",
      routeTemplate: "/deliverables?status=IN_REVIEW",
      requiredParams: [],
      intents: ["ask_pending_approval", "do_approve_deliverable"],
      description: "승인 대기 상태 산출물 목록 직접 진입",
    },
    {
      virtualId: "deliverables.overdue",
      label: "기한 초과 산출물",
      routeTemplate: "/deliverables?overdue=true",
      requiredParams: [],
      intents: ["ask_overdue_deliverables"],
      description: "제출 기한을 초과한 산출물 목록 직접 진입",
    },
    {
      virtualId: "deliverables.rejected",
      label: "반려 산출물",
      routeTemplate: "/deliverables?status=REJECTED",
      requiredParams: [],
      intents: ["ask_deliverable_status", "do_upload_deliverable"],
      description: "반려된 산출물 목록 -- 재업로드 필요 항목 직접 진입",
    },
    {
      virtualId: "deliverables.phase-checklist",
      label: "단계별 산출물 체크리스트",
      routeTemplate: "/deliverables?phaseId=:phaseId&view=checklist",
      matchFilters: { view: "checklist" },  // v2.1: FilterSpec key 정합
      requiredParams: ["phaseId"],
      intents: ["ask_phase_deliverables"],
      description: "특정 Phase의 필수 산출물 체크리스트 직접 진입",
    },
  ],

  // --- Scope 2-layer separation ---
  scope: {
    keys: ["project", "phase", "part"],
    params: ["projectId", "phaseId", "partId"],
  },

  priority: 5,
};
```

---

## 3. 화면 구조

### 3.1 Right Panel panelMode 정의

Right Panel은 항상 동일한 영역이지만, **panelMode**에 따라 표시 내용이 달라진다.
조건 분기 대신 명시적 모드 enum으로 관리한다.

```typescript
/** Right Panel mode -- explicit enum */
export type DeliverablePanelMode =
  | "none"            // Right Panel hidden (EXEC_SUMMARY)
  | "preview"         // Quick Preview (list row selected)
  | "detail"          // Full detail (detail page main info)
  | "version"         // Version history timeline
  | "approval"        // Approval chain + action buttons
  | "upload";         // Upload progress + file drop zone (inline)
```

**panelMode determination rules**:

| Context | Preset | Default panelMode |
|---------|--------|-------------------|
| List + no row selected | ALL | `"none"` |
| List + row selected | EXEC_SUMMARY | `"none"` (Right Panel hidden) |
| List + row selected | PM_WORK / PMO_CONTROL | `"approval"` |
| List + row selected | DEV_EXECUTION | `"preview"` |
| List + row selected | CUSTOMER_APPROVAL | `"approval"` |
| Detail page | ALL | `"detail"` (default tab) |
| Detail page + version tab | ALL | `"version"` |
| Detail page + approval tab | ALL | `"approval"` |
| Upload in progress | DEV_EXECUTION / PM_WORK | `"upload"` |

### 3.2 산출물 목록 (`/deliverables`)

```
+--------------------------------------------------------------+
|  Page Header                                                  |
|  산출물 관리  [ AI 보험금지급심사 구축 ]                        |
|  [ 필터 v ]  [ 검색 ]                  [ + 산출물 업로드 ]     |
+--------------------------------------------------------------+
|                                                              |
|  +----------+ +----------+ +----------+ +----------+        |
|  | 전체     | | 검토대기 | | 승인대기 | | 승인완료 |        |
|  |  47건    | |   8건    | |   5건    | |  28건    |        |
|  |          | | SUBMITTED| | IN_REVIEW| | APPROVED |        |
|  +----------+ +----------+ +----------+ +----------+        |
|                                                              |
|  +----------+ +----------+ +----------+                      |
|  | 확정     | | 반려     | | 기한초과 |                      |
|  |   3건    | |   2건    | |   1건    |                      |
|  | LOCKED   | | REJECTED | | OVERDUE  |                      |
|  +----------+ +----------+ +----------+                      |
|                                                              |
|  +-- Filter Bar -------------------------------------------+ |
|  | Phase: [전체v] Part: [전체v] 카테고리: [전체v]          | |
|  | 상태: [전체v]  제출자: [전체v]  기한: [전체v]           | |
|  |                        <-- FilterSpec key 1:1 mapping   | |
|  +---------------------------------------------------------+ |
|                                                              |
|  +-- Deliverable Table ---------------------+----------------+
|  |                                          | panelMode:     |
|  | ID     | 산출물명  | 카테  | 버전| 상태 | "approval"     |
|  |        |          | 고리  |     |      |                |
|  | ------+---------+------+-----+------ | Approval Chain |
|  | DLV-01| 요구사항 | 설계  | v3  |APRVD | Preview        |
|  |       | 정의서   | 서    |     |      |                |
|  | DLV-04| 시스템   | 설계  | v2  |SUBMT | +------------+ |
|  |       | 설계서   | 서    |     |      | | Submitter:  | |
|  | DLV-08| 단위테스 | 테스  | v1  |DRAFT | |  김개발     | |
|  |       | 트결과   | 트    |     |      | | Reviewer:   | |
|  | DLV-12| 사용자   | 매뉴  | v1  |IN_RV | |  박파트장   | |
|  |       | 매뉴얼   | 얼    |     |      | | Approver:   | |
|  | DLV-15| 인수테스 | 테스  | v2  |REJCT | |  이PM       | |
|  |       | 트결과   | 트    |     |      | | Status:     | |
|  | ...                                   | |  IN_REVIEW  | |
|  |                                       | |             | |
|  |                                       | | [승인]      | |
|  |                                       | | [반려]      | |
|  |                                       | +------------+ |
|  | < 1 2 3 4 5 >  (20 items/page)       | [상세 보기 ->] |
|  +---------------------------------------+----------------+
|                                                              |
+--------------------------------------------------------------+
```

### 3.3 산출물 상세 (`/deliverables/:deliverableId`)

```
+--------------------------------------------------------------+
|  Page Header                                                  |
|  <- 산출물  DLV-04  시스템 설계서                              |
|                                        [ 새 버전 ] [ 다운로드 ]|
+--------------------------------------------------------------+
|                                                              |
|  +-- Basic Info -----------------------+-- panelMode -------+|
|  |                                     |   "approval"       ||
|  |  산출물 ID: DLV-04                  |                    ||
|  |  산출물명: 시스템 설계서             |  [ Approval Chain ] ||
|  |  카테고리: 설계서 (DESIGN_DOC)      |                    ||
|  |  현재 버전: v2                      |  Submitter          ||
|  |  Phase: 분석/설계                   |   김개발 (DEV)      ||
|  |  Part: 시스템개발팀                  |   2026-02-05       ||
|  |   |                                 |   -> SUBMITTED     ||
|  |  파일 정보                           |                    ||
|  |   원본 파일명: SYS_DESIGN_v2.docx   |  Reviewer           ||
|  |   파일 크기: 2.4 MB                 |   박파트장 (DevRdr) ||
|  |   업로드일: 2026-02-05 14:30        |   2026-02-06       ||
|  |   MIME: application/docx            |   -> IN_REVIEW     ||
|  |                                     |   Comment:          ||
|  |  제출 정보                           |   "3장 시퀀스 다이  ||
|  |   제출자: 김개발                     |    어그램 보완 필요" ||
|  |   제출일: 2026-02-05                |                    ||
|  |   제출 코멘트:                       |  Approver           ||
|  |   "분석/설계 단계 시스템 설계서      |   이PM (PM)         ||
|  |    v2 -- 시퀀스 다이어그램 보완"     |   (대기 중)         ||
|  |                                     |                    ||
|  +-- Trace Info -----------------------+                    ||
|  |                                     |  -- Actions ------  ||
|  |  연결된 요구사항                      |  [승인]  [반려]     ||
|  |   REQ-004 반/출입 신청              |  [확정(Lock)]       ||
|  |   REQ-008 반불가 사유표시            |                    ||
|  |   REQ-010 반출입 통제               |  -- Trace --------  ||
|  |                                     |  Requirements: 3건  ||
|  +-- Version History ------------------+  -> REQ-004       ||
|  |                                     |  -> REQ-008       ||
|  |  v2 (현재)  2026-02-05  김개발      |  -> REQ-010       ||
|  |    "시퀀스 다이어그램 보완"          |                    ||
|  |    상태: IN_REVIEW                  |  -- Comments ----  ||
|  |                                     |  박파트장:          ||
|  |  v1          2026-01-28  김개발      |  "3장 시퀀스 보완   ||
|  |    "초안 작성"                       |   필요"             ||
|  |    상태: REJECTED                   |                    ||
|  |    반려 사유: "시퀀스 다이어그램 누락"|  이PM:              ||
|  |                                     |  (아직 검토 전)     ||
|  +-------------------------------------+--------------------+|
|                                                              |
+--------------------------------------------------------------+
```

### 3.4 Phase-based 산출물 체크리스트 뷰

Phase별 필수 산출물 제출 현황을 체크리스트 형태로 표시한다.
`/deliverables?phaseId=:phaseId&view=checklist` 라우트로 진입한다.

```
+--------------------------------------------------------------+
|  Page Header                                                  |
|  산출물 관리 > 단계별 체크리스트                                |
|  Phase: [ 분석/설계 v ]                                       |
+--------------------------------------------------------------+
|                                                              |
|  Phase: 분석/설계 (3/5 완료)           [=======>      ] 60%  |
|                                                              |
|  +----------------------------------------------------------+|
|  | #  | 필수 산출물        | 카테고리 | 상태     | 제출자    ||
|  +----+-------------------+---------+----------+-----------+|
|  | 1  | 요구사항 정의서    | 설계서   | APPROVED | 김개발   ||
|  | 2  | 시스템 설계서      | 설계서   | IN_REVIEW| 김개발   ||
|  | 3  | 아키텍처 설계서    | 설계서   | DRAFT    | 박개발   ||
|  | 4  | UI/UX 설계서       | 설계서   | (미제출)  | -        ||
|  | 5  | 테스트 계획서      | 테스트   | (미제출)  | -        ||
|  +----+-------------------+---------+----------+-----------+|
|  |                                                          ||
|  |  미제출 2건  --  기한: 2026-02-15 (D-7)                  ||
|  +----------------------------------------------------------+|
|                                                              |
+--------------------------------------------------------------+
```

---

## 4. Preset별 차이

### 4.1 EXEC_SUMMARY (Sponsor)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | 전체 건수, 승인 완료 건수, Phase별 완료율만 표시 |
| 테이블 | 산출물명, 카테고리, 상태만 표시 (축약) |
| Right Panel | panelMode: `"none"` (숨김) |
| CTA | 없음 (읽기 전용) |

### 4.2 PMO_CONTROL (PMO)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | 전체 건수, 승인 대기, 기한 초과, Phase 완료율, 확정 건수 |
| 테이블 | 전체 컬럼 (상태 + Phase + 승인자) |
| Right Panel | panelMode: `"approval"` (행 선택 시 Approval Chain Preview) |
| CTA | `승인 산출물 확정(Lock)` (cap: `approve_deliverable`), `감사 증빙 Export` -> targetNodeId: `audit-evidence` |

### 4.3 PM_WORK (PM)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | 전체 건수, 검토 대기, 승인 대기, 기한 초과, 반려 건수 |
| 테이블 | 전체 컬럼 + 버전 수 + Trace 연결 상태 |
| Right Panel | panelMode: `"approval"` + 추천 액션 |
| CTA | `승인` (cap: `approve_deliverable`), `반려` (cap: `approve_deliverable`), `확정(Lock)` (cap: `approve_deliverable`) |

### 4.4 DEV_EXECUTION (DEV / DevReader)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | 내 산출물 수, 검토 대기 수, 반려 건수 |
| 테이블 | 기본 컬럼 + 자동 필터: submitterId=me |
| Right Panel | panelMode: `"preview"` (읽기 중심 + 업로드 가능) |
| CTA | `업로드` (cap: `manage_deliverables`), `제출` (cap: `manage_deliverables`) |

### 4.5 CUSTOMER_APPROVAL (Customer PM)

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | 전체 건수, 승인 대기 건수, 승인 완료 건수 |
| 테이블 | 산출물명, 상태, 카테고리 (제한된 컬럼) |
| Right Panel | panelMode: `"approval"` (승인/다운로드 패널) |
| CTA | `승인` (cap: `approve_deliverable`), `다운로드` (cap: `view_deliverables`) |

**CUSTOMER_APPROVAL panelMode: "approval" 상세**:

```
+-- Right Panel (panelMode: "approval") --------+
|                                                |
|  -- Customer Review Panel ----------------     |
|  DLV-04  시스템 설계서  v2                     |
|  상태: IN_REVIEW                              |
|  제출자: 김개발                                |
|  제출일: 2026-02-05                           |
|                                                |
|  파일:                                         |
|  SYS_DESIGN_v2.docx (2.4 MB)                  |
|  [ 다운로드 ]  [ 미리보기 ]                     |
|                                                |
|  -- Reviewer Comment ----------------         |
|  박파트장: "시퀀스 다이어그램 보완 완료"        |
|                                                |
|  -- Customer Action ------------------         |
|  코멘트:                                       |
|  [____________________________________]        |
|                                                |
|  [ 승인 ]  [ 반려 ]                            |
|                                                |
+------------------------------------------------+
```

---

## 5. 산출물 생명주기

### 5.1 상태 흐름도

> **v2.1 핵심**: Deliverable.status는 **currentVersion의 상태에서 서버가 파생**한다 (READ-ONLY).
> 소스 오브 트루스는 `deliverable_versions` + `deliverable_approval_events` 이다.
> `deliverables` 테이블의 status는 "검색/필터 최적화용 요약"으로, 서버 트랜잭션에서만 갱신된다.
> 이는 10번(테스트관리) TC의 derivedStatus 패턴과 동일하다.

```
                      +-- re-upload (new version) --+
                      |                             |
                      v                             |
[DRAFT] --> [SUBMITTED] --> [IN_REVIEW] --> [APPROVED] --> [LOCKED]
                                 |                             |
                                 +------> [REJECTED] --+       |
                                                       |       |
                                       re-upload ------+       |
                                       (new version)           |
                                                               |
                              +-- re-upload (new version v+1) -+
                              |   (LOCKED version preserved)
                              v
                           [DRAFT]  (new version, new approval chain)
```

### 5.2 상태 전이 규칙

| From | To | Trigger | Required Capability | Notes |
|------|-----|---------|-------------------|-------|
| (new) | DRAFT | File upload | `manage_deliverables` | Auto-assign version v1, reviewer/approver auto-assigned (v2.1) |
| DRAFT | SUBMITTED | Submit button | `manage_deliverables` | Submitter only, server confirms reviewer/approver (v2.1) |
| SUBMITTED | IN_REVIEW | Auto or reviewer action | `approve_deliverable` | v2.1: submit 시 reviewer 자동 할당 → 즉시 IN_REVIEW 가능 |
| IN_REVIEW | APPROVED | Approver approves | `approve_deliverable` | Approval comment optional |
| IN_REVIEW | REJECTED | Approver rejects | `approve_deliverable` | Rejection reason required |
| APPROVED | LOCKED | PM/PMO locks | `approve_deliverable` | **해당 버전** 불변 -- audit evidence |
| REJECTED | DRAFT | Re-upload new version | `manage_deliverables` | Version auto-increment (v2, v3...) |
| APPROVED | DRAFT | Re-upload new version | `manage_deliverables` | Version auto-increment |
| LOCKED | DRAFT | Re-upload new version (v2.1) | `manage_deliverables` | **v2.1 Option B**: LOCKED 버전 보존 + 신규 v+1 생성 |

> **Immutability Rule (v2.1 Option B)**: LOCKED는 **버전 레벨 불변**이다.
> LOCKED 버전의 파일/메타/승인이력은 절대 변경 불가능하며, 감사 증빙으로 영구 보존된다.
> 단, deliverable에 신규 버전(v+1)을 생성하여 새 승인 체인을 시작할 수 있다.
> Deliverable.status는 항상 **currentVersion(= 최신 버전)의 상태를 미러링**한다.

> **Derived Status Rule (v2.1)**: Deliverable.status = currentVersion.status (서버 파생, READ-ONLY).
> 프론트엔드는 status를 PATCH할 수 없으며, 승인/반려/업로드 등 액션 API 호출 시 서버가 자동 갱신한다.
> 이는 10번(테스트관리) TC의 `derivedStatus = f(definitionStatus, lastOutcome)` 패턴과 동일하다.

### 5.3 상태별 색상/아이콘 규칙

| Status | Color | Icon | Meaning |
|--------|-------|------|---------|
| `DRAFT` | Gray | (pencil) | Draft -- not yet submitted |
| `SUBMITTED` | Blue | (send) | Submitted -- awaiting review |
| `IN_REVIEW` | Amber | (eye) | Under review -- awaiting approval |
| `APPROVED` | Green | (check) | Approved -- can be locked |
| `LOCKED` | Dark Green | (lock) | Locked -- immutable audit evidence |
| `REJECTED` | Red | (x-circle) | Rejected -- re-upload required |

### 5.4 승인 체인 구조 (Multi-level Approval)

```typescript
/** Approval chain for a deliverable */
interface DeliverableApprovalChain {
  deliverableId: string;
  currentVersion: number;

  /** Step 1: Submitter uploads and submits */
  submitter: {
    userId: string;
    name: string;
    role: string;            // e.g., "DEV"
    submittedAt?: string;    // ISO 8601
    comment?: string;
  };

  /** Step 2: Reviewer reviews content quality */
  reviewer?: {
    userId: string;
    name: string;
    role: string;            // e.g., "DevReader" (part lead)
    reviewedAt?: string;
    status: "pending" | "reviewing" | "completed";
    comment?: string;
  };

  /** Step 3: Approver gives final approval */
  approver?: {
    userId: string;
    name: string;
    role: string;            // e.g., "PM"
    approvedAt?: string;
    status: "pending" | "reviewing" | "approved" | "rejected";
    comment?: string;
    rejectionReason?: string;
  };

  /** Optional: Customer approval for customer-facing deliverables */
  customerApprover?: {
    userId: string;
    name: string;
    role: string;            // "Customer PM"
    approvedAt?: string;
    status: "pending" | "approved" | "rejected";
    comment?: string;
  };
}
```

### 5.5 Reviewer/Approver 자동 할당 정책 (v2.1)

submit 호출 시 서버가 reviewer/approver를 자동 확정한다.
`start-review`는 감사 이벤트 기록용 선택 호출이며, 필수 전이 트리거가 아니다.

**할당 우선순위 (Reviewer)**:

| Priority | Source | Rule |
|----------|--------|------|
| 1 | Phase Template | `PhaseDeliverableTemplate.defaultReviewerId` 가 지정된 경우 |
| 2 | Part Leader | 산출물 소속 Part의 DevReader (파트장) |
| 3 | PM Fallback | 프로젝트 PM이 reviewer 겸임 |

**할당 우선순위 (Approver)**:

| Priority | Source | Rule |
|----------|--------|------|
| 1 | Phase Template | `PhaseDeliverableTemplate.defaultApproverId` 가 지정된 경우 |
| 2 | Project PM | 프로젝트 PM 자동 할당 |
| 3 | PMO Fallback | PM이 없으면 PMO_HEAD |

**Customer Approver (customer-facing deliverables only)**:

| Condition | Rule |
|-----------|------|
| `visibility = "customer"` | Customer PM을 customerApprover로 자동 추가 |
| `visibility = "internal"` | customerApprover 없음 |

```typescript
/** v2.1: Assignment policy result */
interface ApprovalAssignment {
  reviewerId: string;
  reviewerSource: "template" | "part_leader" | "pm_fallback";
  approverId: string;
  approverSource: "template" | "project_pm" | "pmo_fallback";
  customerApproverId?: string;   // only if visibility = "customer"
}

/** Server resolves on submit */
function resolveApprovalChain(
  deliverable: Deliverable,
  template?: PhaseDeliverableTemplate,
): ApprovalAssignment {
  // 1. Try template-level defaults
  // 2. Fallback to Part leader / Project PM
  // 3. Validate all assignees have approve_deliverable capability
  // 4. If customer-facing, add customerApprover
}
```

> **SUBMITTED → IN_REVIEW 자동 전이**: reviewer가 할당된 순간 자동으로 IN_REVIEW로 전이 가능.
> 별도 `start-review` 호출 없이도 상태가 진행되므로, 운영 부담이 줄어든다.
> `start-review`는 "reviewer가 검토를 시작했음"을 명시적으로 기록하고 싶을 때 선택 호출한다.

### 5.6 버전 관리 규칙

```typescript
/** Deliverable version record */
interface DeliverableVersion {
  versionNumber: number;      // 1, 2, 3, ...
  deliverableId: string;
  fileId: string;             // storage reference
  fileName: string;           // original file name
  fileSize: number;           // bytes
  mimeType: string;
  uploadedBy: string;
  uploadedAt: string;         // ISO 8601
  comment: string;            // version description
  status: DeliverableStatus;  // status at this version
  approvalChain: DeliverableApprovalChain;

  /** Previous version reference */
  previousVersionId?: string;

  /** SHA-256 hash for integrity verification */
  checksum: string;
}
```

**Version auto-increment rules**:

1. First upload: version = 1
2. Re-upload after REJECTED: version = previous + 1
3. Re-upload after APPROVED: version = previous + 1
4. Re-upload after LOCKED (v2.1 Option B): version = previous + 1 (LOCKED version preserved as-is)
5. Each version preserves its own approval chain independently
6. Older versions become read-only upon new version creation
7. LOCKED versions are permanently immutable (file/meta/approval chain frozen for audit)
8. Version number assignment: `SELECT MAX(version_number) + 1 FOR UPDATE` (DB-level serialization)

---

## 6. 데이터 구조 / API

### 6.1 Deliverable 엔티티

```typescript
interface Deliverable {
  id: string;                            // DLV-001
  projectId: string;
  phaseId: string;                       // linked Phase
  partId?: string;                       // owning Part

  // Basic info
  name: string;                          // e.g., "시스템 설계서"
  description?: string;
  category: DeliverableCategory;

  // Current version
  currentVersion: number;
  currentFileId: string;                 // storage reference
  currentFileName: string;
  currentFileSize: number;               // bytes
  currentMimeType: string;
  currentChecksum: string;               // SHA-256

  // Status (v2.1: derived from currentVersion -- READ-ONLY, server-computed)
  status: DeliverableStatus;             // = currentVersion.status (mirror)

  // Visibility scope (v2.1)
  visibility: DeliverableVisibility;     // "internal" | "customer"

  // Approval chain (current version)
  submitterId: string;
  submittedAt?: string;
  reviewerId?: string;
  reviewedAt?: string;
  approverId?: string;
  approvedAt?: string;
  lockedAt?: string;
  lockedBy?: string;

  // Template reference
  templateId?: string;                   // phase deliverable template
  isRequired: boolean;                   // mandatory for this phase
  dueDate?: string;                      // submission deadline

  // Trace connection
  linkedRequirementIds: string[];        // REQ-004, REQ-008, etc.
  traceLinked: boolean;                  // has any requirement link

  // Version count
  versionCount: number;

  // Metadata
  createdAt: string;
  updatedAt: string;
  createdBy: string;

  // Tags
  tags?: string[];
}
```

### 6.2 Phase Deliverable Template

```typescript
/** Template defining required deliverables per phase */
interface PhaseDeliverableTemplate {
  id: string;                            // template ID
  phaseId: string;
  projectId: string;

  name: string;                          // e.g., "요구사항 정의서"
  category: DeliverableCategory;
  description?: string;
  isRequired: boolean;
  dueDate?: string;                      // default due date

  /** v2.1: Default approval chain assignment */
  defaultReviewerId?: string;            // auto-assign on submit
  defaultApproverId?: string;            // auto-assign on submit
  defaultVisibility?: DeliverableVisibility;  // "internal" | "customer"

  /** Linked deliverable (if submitted) */
  deliverableId?: string;
  deliverableStatus?: DeliverableStatus;

  sortOrder: number;
}
```

### 6.3 데이터 모델 권장사항

#### 6.3.1 산출물 -- 요구사항 연결 테이블

산출물과 요구사항의 연결은 **관계 테이블**로 관리한다.

```sql
-- deliverable_trace_links relation table
CREATE TABLE deliverable_trace_links (
  id              BIGSERIAL PRIMARY KEY,
  deliverable_id  VARCHAR(20) NOT NULL REFERENCES deliverables(id),
  requirement_id  VARCHAR(20) NOT NULL REFERENCES requirements(id),
  linked_by       VARCHAR(36) NOT NULL,    -- user who linked
  linked_at       TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  unlinked_at     TIMESTAMPTZ,             -- NULL = active, non-NULL = unlinked
  project_id      VARCHAR(36) NOT NULL
);

CREATE INDEX idx_dtl_deliv ON deliverable_trace_links(deliverable_id) WHERE unlinked_at IS NULL;
CREATE INDEX idx_dtl_req ON deliverable_trace_links(requirement_id) WHERE unlinked_at IS NULL;
-- v2.1: Active link uniqueness -- prevent duplicate active links
CREATE UNIQUE INDEX idx_dtl_active_unique
  ON deliverable_trace_links(deliverable_id, requirement_id) WHERE unlinked_at IS NULL;
```

#### 6.3.2 버전 이력 테이블

```sql
CREATE TABLE deliverable_versions (
  id                 BIGSERIAL PRIMARY KEY,
  deliverable_id     VARCHAR(20) NOT NULL REFERENCES deliverables(id),
  version_number     INTEGER NOT NULL,
  file_id            VARCHAR(255) NOT NULL,   -- storage reference (S3 key, etc.)
  file_name          VARCHAR(500) NOT NULL,
  file_size          BIGINT NOT NULL,
  mime_type          VARCHAR(100) NOT NULL,
  checksum           VARCHAR(64) NOT NULL,     -- SHA-256
  uploaded_by        VARCHAR(36) NOT NULL,
  uploaded_at        TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  comment            TEXT,
  status             VARCHAR(20) NOT NULL,
  project_id         VARCHAR(36) NOT NULL,

  UNIQUE(deliverable_id, version_number)
);

CREATE INDEX idx_dv_deliv ON deliverable_versions(deliverable_id);
```

#### 6.3.3 승인 이벤트 테이블

```sql
CREATE TABLE deliverable_approval_events (
  id               BIGSERIAL PRIMARY KEY,
  deliverable_id   VARCHAR(20) NOT NULL REFERENCES deliverables(id),
  version_number   INTEGER NOT NULL,
  event_type       VARCHAR(20) NOT NULL,    -- 'submit', 'review_start', 'approve', 'reject', 'lock'
  actor_id         VARCHAR(36) NOT NULL,
  actor_role       VARCHAR(30) NOT NULL,
  comment          TEXT,
  rejection_reason TEXT,
  occurred_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  project_id       VARCHAR(36) NOT NULL
);

CREATE INDEX idx_dae_deliv ON deliverable_approval_events(deliverable_id, version_number);
-- v2.1: event_type whitelist constraint
ALTER TABLE deliverable_approval_events
  ADD CONSTRAINT chk_event_type CHECK (
    event_type IN ('submit', 'review_start', 'approve', 'reject', 'lock')
  );

### 6.4 Deliverables List API

```
GET /api/deliverables?projectId={projectId}
    &phaseId={phaseId}
    &partId={partId}
    &category={DESIGN_DOC|SOURCE_CODE|TEST_RESULT|MANUAL|...}
    &status={DRAFT|SUBMITTED|IN_REVIEW|APPROVED|LOCKED|REJECTED}
    &submitterId={userId}
    &approverId={userId}
    &overdue={true|false}
    &traceLinked={true|false}
    &visibility={internal|customer}
    &view={list|checklist}
    &q={searchText}
    &page={page}&size={size}
    &sortBy={name|status|updatedAt|dueDate}
    &sortDir={asc|desc}
```

> **Note**: Query parameters map **1:1** to FilterSpec keys (section 2.2).

```typescript
interface DeliverablesListResponse {
  items: Deliverable[];
  pagination: { page: number; size: number; total: number };
  stats: {
    total: number;
    draft: number;
    submitted: number;         // pending review
    inReview: number;          // pending approval
    approved: number;
    locked: number;
    rejected: number;
    overdue: number;
    traceLinked: number;
    traceUnlinked: number;
    totalVersions: number;
  };

  /** Phase completion stats */
  phaseCompletion?: {
    phaseId: string;
    phaseName: string;
    totalRequired: number;
    submitted: number;
    approved: number;
    completionRate: number;    // 0~100
  }[];

  // --- Reliability 3-tuple (v2.1 standardized) ---
  asOf: string;
  completeness: {
    overall: number;                 // 0~100
    breakdown?: Record<string, number>;
  };
  warnings: {
    code: string;
    message: string;
    severity: "info" | "warn" | "critical";
  }[];

  // --- ScopeEcho (v2.1) ---
  scope: { projectId: string };
}
```

### 6.5 Deliverable Detail API

```
GET /api/deliverables/:deliverableId
```

```typescript
interface DeliverableDetailResponse {
  deliverable: Deliverable;
  versions: DeliverableVersion[];
  approvalChain: DeliverableApprovalChain;
  approvalHistory: DeliverableApprovalEvent[];
  linkedRequirements: {
    id: string;
    title: string;
    status: string;
  }[];
  comments: DeliverableComment[];

  // --- Reliability 3-tuple (v2.1 standardized) ---
  asOf: string;
  completeness: {
    overall: number;
    breakdown?: Record<string, number>;
  };
  warnings: {
    code: string;
    message: string;
    severity: "info" | "warn" | "critical";
  }[];

  // --- ScopeEcho (v2.1) ---
  scope: { projectId: string };
}
```

### 6.6 Deliverable Version API

```
GET  /api/deliverables/:deliverableId/versions
GET  /api/deliverables/:deliverableId/versions/:versionNumber
```

```typescript
interface DeliverableVersionListResponse {
  versions: DeliverableVersion[];
  totalVersions: number;
}
```

### 6.7 Upload API

```
POST /api/deliverables/:deliverableId/versions
Content-Type: multipart/form-data
Headers: {
  Idempotency-Key: string            // v2.1: duplicate upload prevention
}
Body: {
  file: File,
  comment: string,
  linkedRequirementIds?: string[]
}
```

```typescript
interface UploadResponse {
  deliverableId: string;
  versionNumber: number;
  fileId: string;
  fileName: string;
  fileSize: number;
  checksum: string;
  status: "DRAFT";
  uploadedAt: string;
}
```

**Upload validation rules**:

| Rule | Constraint |
|------|-----------|
| Max file size | 100 MB per file |
| Allowed MIME types | .pdf, .docx, .xlsx, .pptx, .zip, .hwp, .txt, .md, .jpg, .png |
| Max simultaneous uploads | 5 files |
| Duplicate check | SHA-256 checksum comparison within same deliverable |
| LOCKED check | v2.1 Option B: LOCKED 버전 보존 + 신규 버전 생성 허용 (Deliverable.status → DRAFT로 파생) |
| MIME content sniffing (v2.1) | 서버에서 magic number 기반 파일 유형 검증 (확장자 위조 방지) |

### 6.8 Create Deliverable API

```
POST /api/deliverables
Content-Type: multipart/form-data
Body: {
  name: string,
  projectId: string,
  phaseId: string,
  partId?: string,
  category: DeliverableCategory,
  description?: string,
  templateId?: string,
  dueDate?: string,
  visibility?: DeliverableVisibility,    // v2.1: "internal" | "customer" (default: "internal")
  linkedRequirementIds?: string[],
  file: File,
  comment?: string
}
```

### 6.9 Approval Action APIs

> **v2.1**: 모든 Approval mutation은 `Idempotency-Key` 헤더 + `If-Match` concurrency token을 지원한다.

```
PATCH /api/deliverables/:deliverableId/submit
Headers: { Idempotency-Key: string, If-Match?: string }
Body: { comment?: string }

PATCH /api/deliverables/:deliverableId/start-review
Headers: { Idempotency-Key: string, If-Match?: string }
Body: { reviewerId?: string }
-- v2.1: reviewerId optional -- server auto-assigns if not provided (§5.5 policy)

PATCH /api/deliverables/:deliverableId/approve
Headers: { Idempotency-Key: string, If-Match?: string }
Body: { comment?: string }

PATCH /api/deliverables/:deliverableId/reject
Headers: { Idempotency-Key: string, If-Match?: string }
Body: { reason: string, comment?: string }

PATCH /api/deliverables/:deliverableId/lock
Headers: { Idempotency-Key: string, If-Match?: string }
Body: { comment?: string }
```

```typescript
/** v2.1: Enriched response with currentVersion info + scopeEcho */
interface ApprovalActionResponse {
  deliverableId: string;
  previousStatus: DeliverableStatus;
  newStatus: DeliverableStatus;
  actorId: string;
  actorRole: string;
  occurredAt: string;
  comment?: string;

  // v2.1: Current version info for immediate UI update
  currentVersion: number;
  currentChecksum: string;
  versionCount: number;

  // v2.1: Approval assignment info (on submit)
  assignedReviewerId?: string;
  assignedApproverId?: string;
  assignedCustomerApproverId?: string;

  // v2.1: ScopeEcho
  scope: { projectId: string };
}
```

**Approval action error contracts**:

| Error Code | HTTP | Condition |
|-----------|------|-----------|
| `DELIVERABLE_LOCKED` | 409 | Attempt to modify LOCKED deliverable |
| `INVALID_TRANSITION` | 422 | Status transition not allowed (e.g., DRAFT -> APPROVED) |
| `INSUFFICIENT_CAPABILITY` | 403 | Missing `approve_deliverable` capability |
| `REJECTION_REASON_REQUIRED` | 422 | Reject without reason |
| `NOT_CURRENT_REVIEWER` | 403 | User is not assigned reviewer |
| `NOT_CURRENT_APPROVER` | 403 | User is not assigned approver |
| `VERSION_CONFLICT` | 409 | Concurrent modification detected |
| `CONCURRENCY_TOKEN_MISMATCH` | 412 | `If-Match` ETag mismatch (v2.1) |
| `IDEMPOTENCY_KEY_CONFLICT` | 409 | Same Idempotency-Key with different payload (v2.1) |
| `REVIEWER_NOT_ASSIGNED` | 422 | Cannot resolve reviewer from policy (v2.1) |
| `VISIBILITY_SCOPE_DENIED` | 403 | Customer role accessing internal-only deliverable (v2.1) |

### 6.10 Phase Template API

```
GET /api/phases/:phaseId/deliverable-templates?projectId={projectId}
```

```typescript
interface PhaseDeliverableTemplateResponse {
  templates: PhaseDeliverableTemplate[];
  stats: {
    totalRequired: number;
    submitted: number;
    approved: number;
    overdue: number;
    completionRate: number;    // 0~100
  };

  // --- ScopeEcho (v2.1) ---
  scope: { projectId: string };
}
```

### 6.11 Trace Link API

```
POST   /api/deliverables/:deliverableId/trace-links
Body: { requirementId: string }

DELETE /api/deliverables/:deliverableId/trace-links/:requirementId

GET    /api/deliverables/:deliverableId/trace-links
```

### 6.12 Comment API

```
POST /api/deliverables/:deliverableId/comments
Body: { content: string, versionNumber?: number }

GET  /api/deliverables/:deliverableId/comments
```

```typescript
interface DeliverableComment {
  id: string;
  deliverableId: string;
  versionNumber?: number;    // null = general comment
  authorId: string;
  authorName: string;
  authorRole: string;
  content: string;
  createdAt: string;
  updatedAt?: string;
}
```

### 6.13 Download API

```
GET /api/deliverables/:deliverableId/download
GET /api/deliverables/:deliverableId/versions/:versionNumber/download
```

> **v2.1 Download Best Practice**: UI에서 "현재 버전 다운로드"도 내부적으로
> 버전 지정 URL(`/versions/:versionNumber/download`)로 변환하여 호출한다.
> 감사/재현성을 위해 버전 지정 다운로드가 기본이다.

> **CUSTOMER_APPROVAL Download Restriction**: Customer PM can only download:
> (1) `visibility = "customer"` 인 산출물만 접근 가능 (v2.1),
> (2) `status IN ('IN_REVIEW', 'APPROVED', 'LOCKED')` 인 산출물만 다운로드 가능.
> DRAFT/SUBMITTED 및 `visibility = "internal"` 산출물은 Customer PM에게 목록 자체가 노출되지 않는다.

> **Audit Evidence Export Rule (v2.1)**:
> PMO_CONTROL → audit-evidence Export 대상은 원칙적으로 `status = "LOCKED"` 만 가능하다.
> `status = "APPROVED"` 포함 시 "잠정 증빙(Provisional)" 경고를 표시한다.
> Export는 반드시 **버전 단위**(DeliverableVersion)로 묶어서 내보내며,
> checksum + approval event history를 포함한다.

---

## 7. 컴포넌트 분해

### 7.1 폴더 구조

```
features/
  deliverables/
    pages/
      DeliverablesPage.tsx             <- List page (ViewMode branching)
      DeliverableDetailPage.tsx        <- Detail + Approval Chain + Version History

    components/
      // List
      DeliverableTable.tsx             <- Main data table
      DeliverableFilters.tsx           <- Filter bar (FilterSpec-based)
      DeliverableKpiRow.tsx            <- Top KPI card row
      DeliverableStatusBadge.tsx       <- Status badge (6 states)
      DeliverableCategoryBadge.tsx     <- Category badge

      // Detail
      DeliverableBasicInfo.tsx         <- Basic info card
      DeliverableFileInfo.tsx          <- File metadata display
      DeliverableTraceLinks.tsx        <- Requirement trace links

      // Version
      VersionHistoryTimeline.tsx       <- Version history timeline
      VersionComparePanel.tsx          <- Version diff (metadata comparison)

      // Approval
      DeliverableApprovalBox.tsx       <- Approval/Reject action panel (from React Component Design)
      ApprovalChainVisualization.tsx   <- Approval chain visual flow
      ApprovalChainPreview.tsx         <- Quick preview (list row selected)
      ApprovalCommentForm.tsx          <- Comment input for approval/rejection

      // Upload
      FileUploadDropZone.tsx           <- Drag & drop file upload area
      FileUploadProgress.tsx           <- Upload progress indicator
      FileUploadValidation.tsx         <- File validation feedback
      MultiFileUploadPanel.tsx         <- Multi-file upload panel

      // Phase Template
      PhaseDeliverableChecklist.tsx    <- Phase-based checklist view
      PhaseCompletionBar.tsx           <- Phase completion progress bar
      MissingDeliverableAlert.tsx      <- Alert for missing required deliverables

      // Customer
      CustomerApprovalPanel.tsx        <- CUSTOMER_APPROVAL right panel
      CustomerDownloadPanel.tsx        <- Download with preview

      // Comments
      DeliverableCommentList.tsx       <- Comment thread
      DeliverableCommentForm.tsx       <- Comment input

      // Actions
      DeliverableCreateModal.tsx       <- New deliverable creation modal
      DeliverableEditModal.tsx         <- Edit deliverable metadata modal
      TraceLinkDialog.tsx              <- Requirement trace link dialog

    // Right Panel mode management
    components/
      DeliverableRightPanel.tsx        <- panelMode-based branch rendering

    api/
      deliverablesApi.ts               <- Deliverable CRUD + actions
      deliverableVersionsApi.ts        <- Version management
      deliverableTraceApi.ts           <- Trace link management
      deliverableCommentsApi.ts        <- Comments
      phaseTemplatesApi.ts             <- Phase template queries

    hooks/
      useDeliverables.ts               <- List TanStack Query
      useDeliverableDetail.ts          <- Detail TanStack Query
      useDeliverableVersions.ts        <- Version list Query
      useDeliverableApproval.ts        <- Approval actions mutations
      useDeliverableUpload.ts          <- Upload mutation + progress
      usePhaseTemplates.ts             <- Phase template Query
      useDeliverableTrace.ts           <- Trace links Query
      useDeliverableComments.ts        <- Comments Query
      usePanelMode.ts                  <- Right Panel mode state

    types/
      deliverable.ts                   <- Type definitions
```

### 7.2 DeliverableList.tsx (from React Component Design)

```typescript
interface DeliverableListProps {
  viewMode: ViewModePreset;
  onRowSelect: (deliverable: Deliverable) => void;
  onRowDoubleClick: (deliverable: Deliverable) => void;
}

function DeliverableList({ viewMode, onRowSelect, onRowDoubleClick }: DeliverableListProps) {
  const columns = getColumnsForPreset(viewMode);
  const { data, isLoading } = useDeliverables(viewMode);

  return (
    <DataTable
      columns={columns}
      data={data?.items ?? []}
      loading={isLoading}
      pagination={data?.pagination}
      onRowClick={onRowSelect}
      onRowDoubleClick={onRowDoubleClick}
      emptyState={<EmptyState message="산출물이 없습니다" />}
    />
  );
}
```

### 7.3 DeliverablesPage.tsx ViewMode Branching

```typescript
function DeliverablesPage() {
  const { viewMode } = useAccessContext();
  const { panelMode, setPanelMode } = usePanelMode(viewMode);
  const [selectedDeliverable, setSelectedDeliverable] = useState<Deliverable | null>(null);
  const navigate = useNavigate();

  // panelMode-based Right Panel content
  const rightPanelContent = useMemo(() => {
    switch (panelMode) {
      case "none":       return undefined;
      case "preview":    return (
        <ApprovalChainPreview deliverableId={selectedDeliverable?.id} />
      );
      case "approval":   return (
        <DeliverableApprovalBox
          deliverable={selectedDeliverable}
          viewMode={viewMode}
        />
      );
      case "upload":     return <MultiFileUploadPanel />;
      default:           return <ApprovalChainPreview deliverableId={selectedDeliverable?.id} />;
    }
  }, [panelMode, selectedDeliverable, viewMode]);

  return (
    <PageLayout
      header={
        <DeliverablePageHeader
          viewMode={viewMode}
          onUploadClick={() => setPanelMode("upload")}
        />
      }
      rightPanel={rightPanelContent}
      rightPanelDefault={PRESET_POLICIES[viewMode].ui.defaultRightPanel}
    >
      <DeliverableKpiRow viewMode={viewMode} />
      <DeliverableFilters
        viewMode={viewMode}
        filterSpec={deliverablesNode.filterSpec}
      />
      <DeliverableList
        viewMode={viewMode}
        onRowSelect={(d) => {
          setSelectedDeliverable(d);
          if (viewMode === "CUSTOMER_APPROVAL") setPanelMode("approval");
          else if (viewMode === "PM_WORK" || viewMode === "PMO_CONTROL") setPanelMode("approval");
          else if (viewMode !== "EXEC_SUMMARY") setPanelMode("preview");
        }}
        onRowDoubleClick={(d) => navigate(`/deliverables/${d.id}`)}
      />
    </PageLayout>
  );
}
```

### 7.4 DeliverableRightPanel.tsx -- panelMode Branching

```typescript
interface DeliverableRightPanelProps {
  panelMode: DeliverablePanelMode;
  selectedDeliverable?: Deliverable;
  viewMode: ViewModePreset;
}

function DeliverableRightPanel({
  panelMode,
  selectedDeliverable,
  viewMode,
}: DeliverableRightPanelProps) {
  switch (panelMode) {
    case "none":
      return null;
    case "preview":
      return (
        <>
          <ApprovalChainPreview deliverableId={selectedDeliverable?.id} />
          <DeliverableTraceLinks deliverableId={selectedDeliverable?.id} />
        </>
      );
    case "detail":
      return <DeliverableBasicInfo deliverable={selectedDeliverable} />;
    case "version":
      return <VersionHistoryTimeline deliverableId={selectedDeliverable?.id} />;
    case "approval":
      return (
        <>
          <DeliverableApprovalBox
            deliverable={selectedDeliverable}
            viewMode={viewMode}
          />
          <ApprovalChainVisualization deliverableId={selectedDeliverable?.id} />
          <DeliverableCommentList deliverableId={selectedDeliverable?.id} />
        </>
      );
    case "upload":
      return <MultiFileUploadPanel />;
  }
}
```

### 7.5 DeliverableApprovalBox.tsx (from React Component Design)

```typescript
interface DeliverableApprovalBoxProps {
  deliverable?: Deliverable;
  viewMode: ViewModePreset;
}

function DeliverableApprovalBox({ deliverable, viewMode }: DeliverableApprovalBoxProps) {
  const { mutate: approve } = useDeliverableApproval("approve");
  const { mutate: reject } = useDeliverableApproval("reject");
  const { mutate: lock } = useDeliverableApproval("lock");
  const { mutate: submit } = useDeliverableApproval("submit");

  if (!deliverable) return <EmptyState message="산출물을 선택하세요" />;

  return (
    <ApprovalBox
      title={deliverable.name}
      status={deliverable.status}
      actions={getAvailableActions(deliverable.status, viewMode)}
    >
      {/* Status-dependent content */}
      {deliverable.status === "DRAFT" && (
        <Can required={["manage_deliverables"]}>
          <Button onClick={() => submit({ deliverableId: deliverable.id })}>
            제출
          </Button>
        </Can>
      )}

      {deliverable.status === "IN_REVIEW" && (
        <Can required={["approve_deliverable"]}>
          <ApprovalCommentForm
            onApprove={(comment) => approve({ deliverableId: deliverable.id, comment })}
            onReject={(reason) => reject({ deliverableId: deliverable.id, reason })}
          />
        </Can>
      )}

      {deliverable.status === "APPROVED" && (
        <Can required={["approve_deliverable"]}>
          <Button onClick={() => lock({ deliverableId: deliverable.id })}>
            확정 (Lock)
          </Button>
        </Can>
      )}
    </ApprovalBox>
  );
}
```

### 7.6 FileUploadDropZone.tsx

```typescript
interface FileUploadDropZoneProps {
  deliverableId?: string;     // existing deliverable (new version)
  projectId: string;
  phaseId?: string;
  onUploadComplete: (result: UploadResponse) => void;
  onUploadError: (error: Error) => void;
  maxFiles?: number;           // default: 5
  maxSizeMb?: number;          // default: 100
  acceptedMimeTypes?: string[];
}

function FileUploadDropZone({
  deliverableId,
  projectId,
  phaseId,
  onUploadComplete,
  onUploadError,
  maxFiles = 5,
  maxSizeMb = 100,
  acceptedMimeTypes = DEFAULT_MIME_TYPES,
}: FileUploadDropZoneProps) {
  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    accept: buildAcceptMap(acceptedMimeTypes),
    maxFiles,
    maxSize: maxSizeMb * 1024 * 1024,
    onDrop: handleDrop,
  });

  // ... drag & drop + upload progress implementation

  return (
    <div {...getRootProps()} className={cn(
      "border-2 border-dashed rounded-lg p-8 text-center",
      isDragActive ? "border-primary bg-primary/5" : "border-muted",
    )}>
      <input {...getInputProps()} />
      {isDragActive ? (
        <p>Drop files here...</p>
      ) : (
        <>
          <UploadIcon className="mx-auto mb-4" />
          <p>Drag & drop or click to upload</p>
          <p className="text-sm text-muted">
            Max {maxSizeMb}MB per file, up to {maxFiles} files
          </p>
        </>
      )}
    </div>
  );
}
```

---

## 8. AI Navigation 연동

### 8.1 산출물 관련 AI 질문 -> 화면 이동 (FilterSpec 기반)

AI는 URL 문자열이 아니라 **FilterSpec 키 기반 필터 객체**를 반환한다.
UI는 `deliverablesNode.filterSpec`을 참조하여 FilterSpec 객체를 URL 파라미터로 변환한다.

```typescript
/** AI navigation recommendation for deliverables */
interface AiDeliverableNavigation {
  targetNodeId: "deliverables";
  /** FilterSpec-based filter object -- structured, not URL string */
  filter: DeliverableFilterSpec;
  /** Direct navigation to specific deliverable */
  entityId?: string;                   // "DLV-04"
  reason: string;                      // "검토 대기 8건 확인 필요"
}
```

| Question | AI Response filter | Description |
|----------|-------------------|-------------|
| "검토 대기 산출물 있어?" | `{ status: "SUBMITTED" }` | FilterSpec.status |
| "승인 대기 건이 몇 개야?" | `{ status: "IN_REVIEW" }` | FilterSpec.status |
| "DLV-04 상세 보여줘" | `entityId: "DLV-04"` | Direct detail navigation |
| "기한 초과 산출물은?" | `{ overdue: true }` | FilterSpec.overdue |
| "설계서 목록 보여줘" | `{ category: "DESIGN_DOC" }` | FilterSpec.category |
| "반려된 산출물 있어?" | `{ status: "REJECTED" }` | FilterSpec.status |
| "내가 올린 산출물 목록" | `{ submitterId: "me" }` | FilterSpec.submitterId |
| "이번 단계 산출물은?" | `{ phaseId: "current_phase" }` | FilterSpec.phaseId |
| "이번 단계 체크리스트 보여줘" | `{ phaseId: "current_phase", view: "checklist" }` | FilterSpec.view (v2.1) |
| "고객 공개 산출물만" | `{ visibility: "customer" }` | FilterSpec.visibility (v2.1) |
| "요구사항 연결 안 된 산출물" | `{ traceLinked: false }` | FilterSpec.traceLinked |

**FilterSpec -> URL conversion utility**:

```typescript
function filterSpecToUrl(
  nodeId: string,
  filter: DeliverableFilterSpec,
  entityId?: string,
): string {
  if (entityId) return `/deliverables/${entityId}`;

  const node = getMenuNode(nodeId);
  const params = new URLSearchParams();
  for (const [key, value] of Object.entries(filter)) {
    if (value !== undefined && node.filterSpec.keys.includes(key)) {
      if (typeof value === "object" && key === "dateRange") {
        if (value.from) params.set("dateFrom", value.from);
        if (value.to) params.set("dateTo", value.to);
      } else {
        params.set(key, String(value));
      }
    }
  }
  return `${node.route}?${params.toString()}`;
}
```

### 8.2 Approval Chain에서의 AI 추천

Approval Chain 하단에 **추천 액션** 영역이 표시된다.
CTA 대상은 route가 아니라 **targetNodeId**로 지정한다.

```
-- Recommended Actions -------------------------
! DLV-04 시스템 설계서 (IN_REVIEW)
  Reviewer comment: "3장 시퀀스 보완 필요"
  -> [승인/반려 처리]    <- targetNodeId: "deliverables", entityId: "DLV-04"

! DLV-15 인수테스트 결과 (REJECTED)
  Rejection reason: "테스트 케이스 누락"
  -> [재업로드 필요]     <- targetNodeId: "deliverables", entityId: "DLV-15"

! Phase 분석/설계: 미제출 산출물 2건
  UI/UX 설계서, 테스트 계획서
  -> [체크리스트 확인]   <- targetNodeId: "deliverables",
                           filter: { phaseId: "phase-01", view: "checklist" }

i 산출물 3건이 요구사항 미연결 상태
  DLV-08, DLV-12, DLV-15
  -> [Trace 연결]        <- targetNodeId: "deliverables",
                           filter: { traceLinked: false }
```

### 8.3 Cross-Node Navigation

산출물 화면에서 다른 화면으로의 이동, 또는 다른 화면에서 산출물 화면으로의 이동:

| Source | Target | Trigger | Navigation |
|--------|--------|---------|-----------|
| Requirement Trace Panel | Deliverables Detail | "산출물" node click | targetNodeId: "deliverables", entityId |
| Deliverable Trace Links | Requirements Detail | Requirement ID click | targetNodeId: "requirements", entityId |
| Phase Checklist | Deliverable Detail | Deliverable name click | targetNodeId: "deliverables", entityId |
| Dashboard KPI | Deliverables List | "승인 대기" card click | targetNodeId: "deliverables", filter: { status: "IN_REVIEW" } |
| Audit Evidence | Deliverables List | Evidence item click | targetNodeId: "deliverables", filter: { status: "LOCKED" } |

---

## 9. 인터랙션 상세

### 9.1 테이블 행 클릭

```
Row click -> panelMode changes based on Preset
  EXEC_SUMMARY: panelMode="none" -> no change
  PM_WORK/PMO_CONTROL: panelMode="approval" -> Approval Chain + Actions
  DEV_EXECUTION: panelMode="preview" -> Quick Preview (read-centric)
  CUSTOMER_APPROVAL: panelMode="approval" -> Customer Approval Panel
Row double-click -> /deliverables/:deliverableId detail page navigation
```

### 9.2 파일 업로드 플로우

```
1. [+ 산출물 업로드] CTA click (cap: manage_deliverables)
   -> File Upload Modal opens OR panelMode switches to "upload"

2. Drag & Drop or File Picker
   -> Client-side validation:
      - File size <= 100 MB
      - MIME type in allowed list
      - Max 5 files simultaneous

3. Upload begins
   -> Progress bar shown per file
   -> Chunked upload for files > 10 MB

4. Upload complete
   -> Auto version assignment (v1, v2, v3...)
   -> Status = DRAFT
   -> Toast notification: "산출물이 업로드되었습니다 (v2)"

5. Optional: Immediate Submit
   -> [제출] button shown after upload
   -> Status DRAFT -> SUBMITTED
```

### 9.3 승인 플로우

```
PM/PMO Preset (cap: approve_deliverable):

1. Select deliverable with status=IN_REVIEW
   -> Right Panel shows Approval Chain + Comment Form

2. Review file content
   -> [다운로드] or [미리보기] (for PDF/images)

3. Decision:
   a) [승인] click
      -> Optional comment input
      -> Confirm dialog: "산출물을 승인하시겠습니까?"
      -> Status IN_REVIEW -> APPROVED
      -> Notification to submitter

   b) [반려] click
      -> Required rejection reason input
      -> Confirm dialog: "산출물을 반려하시겠습니까?"
      -> Status IN_REVIEW -> REJECTED
      -> Notification to submitter with reason

4. Lock (optional, after APPROVED):
   -> [확정(Lock)] click
   -> Confirm dialog: "확정 후 변경이 불가능합니다. 확정하시겠습니까?"
   -> Status APPROVED -> LOCKED
   -> Immutable -- becomes audit evidence
```

### 9.4 버전 재업로드 (반려 후)

```
DEV Preset (cap: manage_deliverables):

1. Deliverable with status=REJECTED selected
   -> Right Panel shows rejection reason
   -> [새 버전 업로드] CTA shown

2. Upload new file
   -> Version auto-increment (e.g., v1 -> v2)
   -> Previous version becomes read-only
   -> New version status = DRAFT

3. Submit new version
   -> Status DRAFT -> SUBMITTED
   -> Re-enters approval chain from Step 1
```

### 9.5 Trace 연결 (요구사항 <-> 산출물)

```
PM Preset (cap: manage_deliverables):

1. Detail page -> Trace Links section
   -> [요구사항 연결] CTA click

2. TraceLinkDialog opens
   -> Requirement search (by ID, title, keyword)
   -> Select requirement(s) to link

3. Confirm link
   -> deliverable_trace_links table insert
   -> Requirement Trace Chain updated (deliverable node added)
   -> Toast: "REQ-004와 연결되었습니다"
```

### 9.6 KPI 카드 클릭 인터랙션

| KPI Card | Click Action |
|----------|-------------|
| "전체 47건" | Clear all filters |
| "검토대기 8건" | Apply filter: `status=SUBMITTED` |
| "승인대기 5건" | Apply filter: `status=IN_REVIEW` |
| "승인완료 28건" | Apply filter: `status=APPROVED` |
| "확정 3건" | Apply filter: `status=LOCKED` |
| "반려 2건" | Apply filter: `status=REJECTED` |
| "기한초과 1건" | Apply filter: `overdue=true` |

> **v2.1 KPI 클릭 필터 규칙 (Preset별 차이)**:
> - EXEC_SUMMARY: KPI 클릭 시 기존 필터 전체 리셋 후 해당 status 적용.
> - PMO_CONTROL / PM_WORK: **Phase/Part 필터는 유지**하고 status만 교체 (drill-down 유지).
>   Shift+Click = 기존 status에 누적 토글 (고급 UX).
> - DEV_EXECUTION: submitterId=me는 항상 유지, status만 교체.
> - CUSTOMER_APPROVAL: visibility=customer는 항상 유지, status만 교체.

### 9.7 데이터 새로고침

| Item | Cycle |
|------|-------|
| List | Page entry + filter change |
| Detail | Page entry (realtime with asOf) |
| Versions | Detail page entry |
| Approval chain | Row selection (realtime) |
| Phase templates | Phase filter change (cache 5 min) |
| Comments | Detail page entry + polling 30s |
| Upload progress | Real-time (WebSocket or polling 2s) |

**v2.1 이벤트 기반 강제 refetch**:

| Event | Refetch Target | Optimistic Update |
|-------|---------------|-------------------|
| Upload complete (new version) | List + Detail + Versions | version count +1, status → DRAFT |
| Submit | List + Detail + Approval chain | status → SUBMITTED |
| Approval action (approve/reject/lock) | List + Detail + Approval chain | status transition |
| Trace link created/removed | Detail + Trace panel | traceLinked toggle |
| Comment added | Comments list | append new comment |
| Other user's action (WebSocket) | List (debounced 2s) | badge count update only |

---

## 10. 반응형 대응

| Width | Table | Right Panel | Filter | Upload |
|-------|-------|------------|--------|--------|
| >=1440px | Full columns | Right Panel (30%) | Inline | Inline panel |
| 1280px | Reduced columns (-3) | Drawer (toggle) | Inline | Drawer |
| <=1024px | Card view | Drawer (overlay) | Collapsible | Full modal |
| <=768px | Card view (1 col) | Full Modal | Collapsible | Full modal |

### 10.1 Card View Layout (<=1024px)

```
+-------------------------------+
| DLV-04  시스템 설계서          |
| 설계서  |  v2  |  IN_REVIEW   |
| Phase: 분석/설계              |
| 제출자: 김개발  |  2026-02-05 |
| [다운로드]  [상세보기]         |
+-------------------------------+

+-------------------------------+
| DLV-08  단위테스트 결과        |
| 테스트  |  v1  |  DRAFT       |
| Phase: 개발                   |
| 제출자: 박개발  |  2026-02-07 |
| [업로드]  [상세보기]           |
+-------------------------------+
```

---

## 11. 깨지기 쉬운 곳 체크리스트

### 11.1 동시 승인 충돌

**문제**: 2명의 Approver가 동시에 같은 산출물에 대해 승인/반려를 수행하는 경우.

**대응**:
- 서버: Optimistic Locking (`version` 필드 + `@Version` 어노테이션)
- 409 Conflict 발생 시 -> 프론트에서 자동 재조회 + "다른 사용자가 먼저 처리했습니다" 알림
- Approval event는 idempotent -- 같은 액션 중복 전송 시 동일 결과 보장

### 11.2 대용량 파일 업로드 실패

**문제**: 100MB 파일 업로드 중 네트워크 중단.

**대응**:
- Chunked upload (10MB chunks)
- 각 chunk에 대한 서버 ACK
- 재시도 로직 (3회, exponential backoff)
- 실패 시 partially uploaded chunks 자동 cleanup (24h TTL)
- 업로드 중 페이지 이탈 시 `beforeunload` 경고

### 11.3 LOCKED 상태 우회 시도

**문제**: 프론트엔드 우회로 LOCKED 산출물을 수정/삭제 시도.

**대응**:
- Backend enforcement: LOCKED 상태 check는 모든 mutation API에서 첫 번째로 수행
- `deliverables` 테이블에 DB-level CHECK constraint: `locked_at IS NOT NULL => status = 'LOCKED'`
- Audit log: LOCKED 산출물에 대한 모든 접근 시도 기록

### 11.4 버전 충돌 (동시 업로드)

**문제**: 2명의 개발자가 동시에 같은 산출물에 새 버전을 업로드.

**대응**:
- `deliverable_versions` 테이블에 `UNIQUE(deliverable_id, version_number)` 제약
- 서버에서 `SELECT MAX(version_number) + 1 FOR UPDATE` 로 version 할당
- 충돌 시 409 -> 프론트에서 재조회 후 새 version number로 재시도

### 11.5 Customer PM 다운로드 권한 누수

**문제**: Customer PM이 DRAFT/SUBMITTED 상태의 내부 산출물을 다운로드하는 경우.

**대응**:
- Backend: Download API에서 `visibility = "customer"` + `status IN ('IN_REVIEW', 'APPROVED', 'LOCKED')` 이중 검증 (v2.1)
- Frontend: 해당 상태의 다운로드 버튼 미노출 (추가 방어)
- v2.1: `visibility = "internal"` 산출물은 Customer PM에게 목록 자체가 노출되지 않음

### 11.6 FilterSpec view 키 미등록 (v2.1)

**문제**: virtualNode에 `view=checklist`를 쓰지만 FilterSpec keys에 view가 없으면 AI 딥링크 생성 시 스키마 검증 실패.

**대응**:
- v2.1에서 FilterSpec에 `view` 키를 정식 등록 + `allowedViews` 화이트리스트로 제한
- filterSpecToUrl 변환 유틸에서 view 키도 처리하도록 보장

### 11.7 Derived Status desync (v2.1)

**문제**: Deliverable.status와 currentVersion.status가 불일치하면 목록/상세 간 상태 표시가 어긋남.

**대응**:
- 서버: 모든 상태 변경(승인/반려/업로드/락) 트랜잭션에서 deliverables.status를 currentVersion.status로 동기화
- DB trigger 또는 application-level enforcement -- 직접 status UPDATE 불가
- Monitoring: `WHERE d.status != dv.status AND dv.version_number = d.current_version` alert

### 11.8 Reviewer/Approver 미할당 (v2.1)

**문제**: submit 시 reviewer/approver 자동 할당 정책이 실패하면 상태 전이가 막힘.

**대응**:
- resolveApprovalChain() 실패 시 422 `REVIEWER_NOT_ASSIGNED` 에러 + 구조화된 원인 반환
- UI에서 수동 지정 폼 fallback 제공 (PM이 직접 reviewer/approver 선택)
- Phase Template에 defaultReviewerId/defaultApproverId가 없고 Part leader도 없는 경우 PM fallback

### 11.9 LOCKED 신규 버전 정책 혼동 (v2.1)

**문제**: Option B에서 "LOCKED인데 새 버전 업로드 가능"이 사용자를 혼동시킬 수 있음.

**대응**:
- UI: LOCKED 상태에서 [새 버전 업로드] CTA 대신 [개정판 생성] 라벨 사용 -- 의미 구분 명확히
- Confirm dialog: "기존 LOCKED 버전(v2)은 감사 증빙으로 보존됩니다. 새 버전(v3)으로 개정하시겠습니까?"
- 목록에서 LOCKED 버전이 있는 산출물에 잠금 아이콘 + 현재 버전 상태 배지 병행 표시

### 11.10 MIME Content Sniffing 우회 (v2.1)

**문제**: 확장자만 `.docx`인 실행 파일이 업로드되면 보안/감사 위험.

**대응**:
- 서버: magic number 기반 파일 유형 검증 (확장자 + Content sniffing 이중 체크)
- 불일치 시 422 에러 + "파일 확장자와 실제 내용이 일치하지 않습니다" 메시지
- Audit log: MIME 불일치 시도 기록 (보안 모니터링)

---

## 12. Capability 매핑

### 12.1 행위별 Capability

| Action | Capability | Allowed Roles |
|--------|-----------|--------------|
| View deliverable list | `view_deliverables` | ALL |
| Download file | `view_deliverables` | ALL (Customer PM: limited status) |
| Upload file | `manage_deliverables` | PM, DEV, DevReader |
| Submit deliverable | `manage_deliverables` | Submitter only |
| Edit metadata | `manage_deliverables` | PM, Submitter |
| Start review | `approve_deliverable` | Reviewer |
| Approve deliverable | `approve_deliverable` | PM, PMO |
| Reject deliverable | `approve_deliverable` | PM, PMO |
| Lock deliverable | `approve_deliverable` | PM, PMO |
| Link requirement trace | `manage_deliverables` | PM |
| Delete deliverable | `manage_deliverables` | PM (DRAFT only) |
| Customer approve | `approve_deliverable` | Customer PM (visibility=customer only, v2.1) |

### 12.2 Preset별 Capability 매트릭스

| Capability | PM_WORK | PMO_CONTROL | DEV_EXECUTION | EXEC_SUMMARY | CUSTOMER_APPROVAL |
|-----------|---------|-------------|---------------|--------------|-------------------|
| `view_deliverables` | O | O | O | O | O |
| `manage_deliverables` | O | - | O (own only) | - | - |
| `approve_deliverable` | O | O | - | - | O (visibility=customer only) |

> **v2.1 Capability + Scope 조합 규칙**:
> Customer PM의 권한은 `approve_deliverable` capability + `visibility = "customer"` scope의 **교집합**이다.
> Capability만으로는 부족하며, 서버에서 `visibility` 필드를 반드시 검증한다.
> `visibility = "internal"` 산출물은 Customer PM에게 List API 응답에서 자체 필터링된다.

### 12.3 4 계층 방어

```
+-------------------------------------------+
| Layer 1: Menu/Navigation                   |
| -> view_deliverables missing = menu hidden |
+-------------------------------------------+
| Layer 2: Route Guard                       |
| -> /deliverables requires view_deliverables|
| -> /deliverables/:id same                  |
+-------------------------------------------+
| Layer 3: Action Guard                      |
| -> [업로드] requires manage_deliverables   |
| -> [승인/반려] requires approve_deliverable|
| -> [확정] requires approve_deliverable     |
| -> <Can required={[...]}> wrapper          |
+-------------------------------------------+
| Layer 4: Backend Enforcement               |
| -> All APIs validate capability + scope    |
| -> LOCKED check on all mutations           |
| -> Customer download status restriction    |
| -> visibility scope enforcement (v2.1)     |
| -> Idempotency-Key dedup (v2.1)           |
| -> If-Match concurrency token (v2.1)      |
+-------------------------------------------+
```

---

## 13. 테이블 컬럼 정의

### 13.1 전체 컬럼 (PM_WORK 기준)

| # | Column | Field | Width | Sortable | Filterable |
|---|--------|-------|-------|----------|-----------|
| 1 | 산출물 ID | id | 100px | O | - |
| 2 | 산출물명 | name | 200px | O | O |
| 3 | 카테고리 | category | 100px | - | O |
| 4 | Phase | phaseName | 120px | O | O |
| 5 | 버전 | currentVersion | 60px | O | - |
| 6 | 상태 | status | 100px | O | O |
| 7 | 제출자 | submitterName | 100px | - | O |
| 8 | 승인자 | approverName | 100px | - | O |
| 9 | 파일 크기 | currentFileSize | 80px | O | - |
| 10 | 제출일 | submittedAt | 100px | O | O |
| 11 | 기한 | dueDate | 100px | O | - |
| 12 | Trace | traceLinked | 60px | - | O |
| 13 | 버전 수 | versionCount | 60px | O | - |
| 14 | 공개범위 | visibility | 80px | - | O |

> **v2.1 visibility 컬럼**: `internal` = 자물쇠 아이콘, `customer` = 지구본 아이콘.
> CUSTOMER_APPROVAL Preset에서는 visibility=customer만 노출되므로 이 컬럼은 숨김.

### 13.2 Preset별 숨김 컬럼

| Preset | Hidden Columns |
|--------|---------------|
| EXEC_SUMMARY | #5, #7, #8, #9, #10, #12, #13, #14 |
| PMO_CONTROL | #9, #13 |
| PM_WORK | (all visible) |
| DEV_EXECUTION | #8, #12, #13, #14 |
| CUSTOMER_APPROVAL | #7, #8, #9, #10, #12, #13, #14 |

---

## 14. DoD (본 화면 완료 기준)

### 14.1 Core Functionality

- [ ] `/deliverables` list page with Preset-based column branching
- [ ] FilterSpec-based multi-dimensional filter (phaseId/partId/category/status/submitterId/approverId/dateRange/overdue/traceLinked/q)
- [ ] KPI Row: total, pending review, pending approval, approved, locked, rejected, overdue
- [ ] KPI card click -> filter application
- [ ] panelMode-based Right Panel branching (none/preview/detail/version/approval/upload)
- [ ] Row click -> panelMode changes based on Preset
- [ ] Row double-click -> `/deliverables/:deliverableId` detail navigation

### 14.2 Deliverable Lifecycle

- [ ] Status flow: DRAFT -> SUBMITTED -> IN_REVIEW -> APPROVED -> LOCKED / REJECTED
- [ ] Status badges with correct colors/icons for all 6 states
- [ ] Status transition validation (invalid transitions blocked at UI and API)

### 14.3 Upload & Version

- [ ] Drag & drop file upload (FileUploadDropZone)
- [ ] Multi-file upload (up to 5 simultaneous)
- [ ] File validation (size, MIME type)
- [ ] Version auto-increment on re-upload
- [ ] Version history timeline display
- [ ] Previous versions read-only
- [ ] Upload progress indicator
- [ ] LOCKED deliverable upload rejection

### 14.4 Approval Workflow

- [ ] 3-step approval chain: Submitter -> Reviewer -> Approver
- [ ] Approval chain visualization (ApprovalChainVisualization)
- [ ] Approve action with optional comment (cap: `approve_deliverable`)
- [ ] Reject action with required reason (cap: `approve_deliverable`)
- [ ] Lock action with confirmation dialog (cap: `approve_deliverable`)
- [ ] Customer PM approval for customer-facing deliverables
- [ ] Optimistic locking for concurrent approval conflict

### 14.5 Phase Integration

- [ ] Phase-based deliverable checklist view (`/deliverables?phaseId=:phaseId&view=checklist`)
- [ ] Phase completion progress bar
- [ ] Missing required deliverable alerts
- [ ] Phase deliverable template support

### 14.6 Trace Integration

- [ ] Deliverable -> Requirement trace link management
- [ ] Trace link dialog (search + select requirements)
- [ ] Trace link display in detail page
- [ ] Cross-navigation: Requirement detail <-> Deliverable detail

### 14.7 AI Navigation

- [ ] AI recommended actions: FilterSpec-based deep links
- [ ] Virtual nodes: pending-review, pending-approval, overdue, rejected, phase-checklist
- [ ] Cross-node navigation from/to Requirements, Dashboard, Audit Evidence

### 14.8 Comments & Collaboration

- [ ] Comment thread per deliverable
- [ ] Version-specific comments
- [ ] Approval/rejection reason as comment

### 14.9 Responsive & Security

- [ ] Responsive layout (>=1440 / 1280 / <=1024 / <=768)
- [ ] Card view for mobile breakpoints
- [ ] 4-layer permission defense (Menu/Route/Action/Backend)
- [ ] Customer PM download restriction (IN_REVIEW+ only)
- [ ] LOCKED immutability enforcement

**v2.1 추가 DoD**

- [ ] Deliverable.status = currentVersion.status 파생 (서버 READ-ONLY, 프론트 PATCH 불가)
- [ ] LOCKED Option B: LOCKED 버전 보존 + 신규 버전(v+1) 생성 허용, UI에 [개정판 생성] CTA
- [ ] FilterSpec `view` 키 정식 등록 + `allowedViews: ["list", "checklist"]` 화이트리스트
- [ ] `visibility` 필드 (`internal` / `customer`) 추가 -- 엔티티/API/필터/테이블 컬럼 일관
- [ ] Customer PM: `visibility=customer` + `status IN (IN_REVIEW, APPROVED, LOCKED)` 이중 필터 서버 강제
- [ ] Customer PM: `visibility=internal` 산출물은 List API 응답에서 자체 필터링
- [ ] Reviewer/Approver 자동 할당: Phase Template → Part Leader → PM fallback 정책 구현
- [ ] submit 시 reviewer/approver 자동 확정 + 실패 시 422 구조화된 에러 반환
- [ ] Approval API: `Idempotency-Key` 헤더 지원 (중복 요청 안전)
- [ ] Approval API: `If-Match` concurrency token 지원 (412 Precondition Failed)
- [ ] ApprovalActionResponse에 currentVersion/currentChecksum/versionCount 포함
- [ ] Reliability 3-tuple 구조화: `completeness: { overall, breakdown? }` + `warnings: { code, message, severity }[]`
- [ ] ScopeEcho: 모든 API 응답에 `scope: { projectId }` 포함
- [ ] Trace link 유일성: `(deliverable_id, requirement_id) WHERE unlinked_at IS NULL` UNIQUE 인덱스
- [ ] Upload MIME 검증: magic number + Content sniffing (확장자 위조 방지)
- [ ] approval_events event_type 화이트리스트 DB CHECK constraint
- [ ] KPI 클릭 필터: Preset별 차별화 (EXEC=리셋, PMO/PM=Phase 유지, DEV=submitter 유지)
- [ ] 이벤트 기반 강제 refetch 6개 이벤트 + optimistic update 규칙

---

## 부록 A. 상태 전이 다이어그램 (상세)

```
           manage_deliverables                manage_deliverables
[New File] -----------------> [DRAFT] -----------------------> [SUBMITTED]
                               ^   ^                              |
                               |   |                              |
                    re-upload  |   | re-upload         approve_deliverable
                   (new ver.)  |   | (new ver.)                   |
                               |   |                              v
                          [REJECTED]              [IN_REVIEW] ----------+
                               ^                     |                  |
                               |        approve_     |     approve_     |
                               |        deliverable  |     deliverable  |
                               |                     |                  |
                               +------[REJECT]-------+   [APPROVE]-----+
                                                          |
                                                          v
                                                     [APPROVED]
                                                          |
                                              approve_deliverable
                                                          |
                                                          v
                                                      [LOCKED]
                                                  (version immutable)
                                                          |
                                              manage_deliverables
                                              (re-upload new ver.)
                                                          |
                                                          v
                                                      [DRAFT]
                                                   (v+1, new chain)
```

---

## 부록 B. Preset별 화면 차이 요약 다이어그램

```
+------------------------------------------------------------------+
| EXEC_SUMMARY                                                      |
|   KPI: [total] [approved] [phase_rate]                           |
|   Table: name, category, status (compact)                        |
|   Right Panel: hidden                                            |
+------------------------------------------------------------------+

+------------------------------------------------------------------+
| PMO_CONTROL                                                       |
|   KPI: [pending_approval] [overdue] [phase_rate] [locked]        |
|   Table: full columns (-fileSize, -versionCount)                 |
|   Right Panel: Approval Chain Preview                            |
|   CTA: Lock, Audit Export                                        |
+------------------------------------------------------------------+

+------------------------------------------------------------------+
| PM_WORK                                                           |
|   KPI: [pending_review] [pending_approval] [overdue] [rejected]  |
|   Table: all columns + version + trace                           |
|   Right Panel: Approval + Actions + Trace                        |
|   CTA: Approve, Reject, Lock                                    |
+------------------------------------------------------------------+

+------------------------------------------------------------------+
| DEV_EXECUTION                                                     |
|   KPI: [my_deliverables] [pending_review] [rejected]             |
|   Table: auto-filter submitterId=me                              |
|   Right Panel: Preview (read-centric)                            |
|   CTA: Upload, Submit                                            |
+------------------------------------------------------------------+

+------------------------------------------------------------------+
| CUSTOMER_APPROVAL                                                 |
|   KPI: [total] [pending_approval] [approved]                     |
|   Table: name, status, category (limited)                        |
|   Right Panel: Customer Approval Panel                           |
|   CTA: Approve, Download                                         |
+------------------------------------------------------------------+
```

---

## 부록 C. 변경이력

| Version | Date | Changes |
|---------|------|---------|
| v1.0 | 2026-02-08 | Initial draft |
| v2.0 | 2026-02-08 | 13-area feedback integration: (1) entities PascalCase + intents 14 expansion, (2) FilterSpec ontology integration, (3) Approval Chain 3-step confirmation, (4) Version auto-increment rules, (5) Phase deliverable template, (6) Capability separation (manage_deliverables + approve_deliverable), (7) DeliverableApprovalBox component spec, (8) Right Panel panelMode 6 modes, (9) AI deep link FilterSpec-based navigation, (10) Trace integration (Deliverable <-> Requirement), (11) Customer PM download restriction, (12) LOCKED immutability enforcement, (13) Concurrent approval conflict handling |
| v2.1 | 2026-02-08 | Cross-review (10번 테스트+11번 산출물 일관성/안정성): (1) Derived Status 확정 -- Deliverable.status = currentVersion.status 서버 파생, (2) LOCKED Option B -- 버전 불변 + 신규 버전 허용, (3) FilterSpec view 키 정식 등록 + allowedViews 화이트리스트, (4) visibility 필드 추가 (Customer 스코프 데이터 레벨 강제), (5) Reviewer/Approver 자동 할당 정책 (Phase Template + Part + PM fallback), (6) Approval API Idempotency-Key + If-Match concurrency token + enriched response, (7) Reliability 3-tuple 구조화 + ScopeEcho 표준화, (8) Trace link 유일성 제약, (9) Upload MIME content sniffing, (10) Fragile checklist 5→10항, (11) Audit Evidence Export 입력 필터 강제 |
