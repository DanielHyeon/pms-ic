# 13. Lineage & History 화면설계

> 작성일: 2026-02-08
> 버전: v2.1

> **v2.1 변경 요약 (10개 항목)**:
> 1. FilterSpec에 `orphans`, `breakpoints`, `selected` 키 추가 — 온톨로지/URL/AI 일관성 확보
> 2. deepLinks/virtualNodes를 FilterSpec 기반으로 통일 (orphans=true URL 패턴 → `filter.orphans`)
> 3. Cypher 모든 traversal에 `projectId` 스코프 강제 + `edgeType` 필터 반영 + orphan 쿼리 괄호 수정
> 4. `completeness`를 `syncCompleteness` + `queryCompleteness`로 분리 — 동기화 지연 vs 렌더 한계 구분
> 5. 서버측 PresetPolicyResolver 추가 — UI-only 강제를 서버 clamp로 보완
> 6. `nodeRole` 가산점을 무조건 +10에서 조건부 +3~+7로 세분화
> 7. Graph API에서 heavy metrics 제거, `/metrics` API로 분리
> 8. ChangeHistoryItem에 `correlationId` + `source` 추가 (감사 증빙 + 트랜잭션 그룹)
> 9. LineageNode `id` = `sourceId` 통일, edge `weight` 현재 미사용 명시
> 10. Trace Link 삼중 일관성: PostgreSQL unique constraint + cycle depth limit + soft-delete tombstone

> 라우트: `/lineage`, `/lineage/:entityType/:entityId`
> 필요 Capability: `view_lineage` (조회), `manage_trace_link` (Trace 연결 생성/삭제)
> 기본 Preset: 역할에 따라 자동 결정
> 노드 역할: **Detail** (상세 노드 -- 그래프 탐색, 영향분석, 변경이력 전용)

---

## 1. 화면 개요

### 1.1 목적

Lineage & History는 **"이 엔티티가 어디서 왔고, 무엇에 영향을 주며, 언제 어떻게 바뀌었는가?"**에 대한 답을 제공한다.
기존 엑셀 기반 추적표를 **Neo4j 기반 지식 그래프(Knowledge Graph)**로 전환하여, 엔티티 간 관계(Trace Link)와 변경 이력(Change History)을 실시간으로 시각화한다.

> **핵심 분리 원칙**: 요구사항 화면의 Trace Panel(02_요구사항관리 S5)은 **단일 요구사항 기준 1-depth 추적 체인**을 보여주는 반면,
> Lineage 화면은 **모든 엔티티 타입을 기준으로 N-depth 그래프 탐색과 영향 분석**을 제공한다.
> 또한 감사 증빙(16_감사증빙)의 데이터 소스로서, 외부 감사가 직접 접근할 수 있는 몇 안 되는 화면 중 하나이다.

### 1.2 설계 원칙

| 원칙 | 설명 |
|------|------|
| **그래프 중심 탐색** | Force-directed graph 시각화로 엔티티 간 관계를 직관적으로 파악 |
| **양방향 탐색** | Upstream(원인 추적) + Downstream(영향 분석) 동시 지원 |
| **N-depth 제어** | 탐색 깊이(depth)를 사용자가 제어하여 정보 과부하 방지 |
| **이중 뷰** | Graph View(관계 시각화) + Timeline View(변경 이력) 토글 |
| **영향 분석 우선** | "이것이 바뀌면 뭐가 영향받나?" 질문에 1-click 답변 |
| **FilterSpec = 온톨로지** | 필터 키가 AI/URL/백엔드 공통 스키마로 통합 |
| **Neo4j 백엔드** | PostgreSQL은 트랜잭션 원본, Neo4j는 그래프 탐색 전용 (Outbox 패턴으로 동기화) |
| **감사 친화적** | AUDIT_EVIDENCE Preset에서 전체 그래프 읽기 + Export 가능 |
| **Trace Link 무결성** | Orphan(고아 노드), Breakpoint(끊어진 체인) 자동 감지 및 경고 |
| **서버 Preset Clamp** | Preset별 nodeType/depth/edgeType 제한은 서버에서 강제 (UI-only 우회 방지) |
| **completeness 이중 축** | syncCompleteness(PG→Neo4j 동기화율) + queryCompleteness(렌더 한계 절삭) 분리 |
| **ID 안정성** | UI에서 참조하는 `id`는 항상 PostgreSQL `sourceId` (Neo4j 내부 ID 비노출) |
| **Cypher 스코프 안전** | 모든 traversal 쿼리에 `projectId` 조건 + `edgeType` allowlist 강제 |
| **nodeRole 조건부 가산** | detail 노드 가산점은 그래프/영향분석/체인 키워드에만 +3~+7 (무조건 +10 금지) |

### 1.3 핵심 질문 -> 위젯 매핑

| 사용자 질문 | 화면 영역 | 설명 |
|-----------|---------|------|
| "이 요구사항이 변경되면 영향받는 항목은?" | Impact Panel (Right) | Downstream traversal + 영향 목록 |
| "REQ-034의 전체 Trace Chain 보여줘" | Graph View (Main) | entityType=Requirement, entityId=REQ-034 |
| "끊어진 추적 경로가 있어?" | Metrics KPI + Graph | orphan_count, breakpoint_count 하이라이트 |
| "이 Epic의 변경 이력 보여줘" | Timeline View (Main) | Change History timeline |
| "Task에서 Requirement까지 역추적해줘" | Graph View (Main) | direction=upstream 탐색 |
| "BLOCKS 관계에 있는 항목만 보여줘" | Graph Filter | edgeType=BLOCKS 필터 |
| "최근 1주일 변경 내역은?" | Timeline View (Main) | dateRange 필터 |
| "전체 Trace 커버리지 현황은?" | Metrics KPI Row | total_nodes, total_edges, orphan_count |
| "이 Decision이 어떤 Risk에서 왔어?" | Graph View (Main) | entityId=DEC-004, direction=upstream |
| "Deliverable에 연결 안 된 요구사항 있어?" | Orphan Detection | orphan 필터 (unlinked entities) |

---

## 2. MenuOntology 노드

### 2.1 타입 확정 (v2.0 → v2.1 변경사항)

01_대시보드 / 02_요구사항 / 03_백로그 v2.0 패턴을 동일하게 적용한다.

| 항목 | v1.0 | v2.0 | v2.1 (확정) | 변경 사유 |
|------|------|------|------------|----------|
| `entities` | 소문자 | PascalCase | — | EntityType enum 정규화 |
| `intents` | 4개 | 14개 | — | 영향분석/변경이력/필터 질문 커버리지 확보 |
| Capability | 단일 | 2개 분리 | — | Trace 연결 생성/삭제는 별도 권한 |
| `filterSpec` | 5키 | 9키 | **12키** | `orphans`, `breakpoints`, `selected` 추가 |
| `virtualNodes` | 2개 | 5개 | 5개 (filter 기반) | `matchFilters` 도입, URL hack 제거 |
| `metrics` | 3개 | 5개 | — | — |
| `nodeRole` | 없음 | `"detail"` +10 | `"detail"` **+3~+7 조건부** | 라우팅 편향 방지 |
| `completeness` | — | 단일 숫자 | **sync + query 분리** | 동기화 지연 vs 렌더 절삭 구분 |
| Cypher scope | — | projectId 부분 | **projectId 전역 강제** | 프로젝트 경계 오염 방지 |

### 2.2 FilterSpec 정의

FilterSpec은 **이 화면이 지원하는 필터 스키마**를 온톨로지 내부에 선언한다.
AI가 딥링크를 생성할 때, URL 파라미터 문자열이 아니라 **FilterSpec 키 기반 필터 객체**를 반환한다.

```typescript
/** Graph Entity Type -- Lineage 노드 타입 */
export type LineageEntityType =
  | "Requirement"
  | "Epic"
  | "Feature"
  | "Story"
  | "Task"
  | "TestCase"
  | "Deliverable"
  | "Issue"
  | "Decision"
  | "Risk";

/** Graph Edge Type -- Lineage 엣지 타입 */
export type LineageEdgeType =
  | "TRACES_TO"
  | "DERIVED_FROM"
  | "BLOCKS"
  | "DEPENDS_ON"
  | "TESTS"
  | "PRODUCES"
  | "ESCALATED_TO";

/** Traversal Direction */
export type TraversalDirection = "upstream" | "downstream" | "both";

/** 리니지 필터 스키마 -- 온톨로지 내장 (v2.1: 12키) */
export interface LineageFilterSpec {
  /** 시작(포커스) 엔티티 타입 -- 단일 선택 */
  entityType?: LineageEntityType;
  /** 시작(포커스) 엔티티 ID */
  entityId?: string;
  /** 탐색 깊이 (1~10, 기본 3) */
  depth?: number;
  /** 탐색 방향 */
  direction?: TraversalDirection;
  /** 엣지 타입 필터 (복수 선택 가능) */
  edgeType?: LineageEdgeType[];
  /** 노드 타입 필터 (복수 선택 가능) -- UI "Node Types" 드롭다운 */
  nodeType?: LineageEntityType[];
  /** 변경 이력 날짜 범위 */
  dateRange?: {
    from?: string;   // ISO 8601
    to?: string;     // ISO 8601
  };
  /** 자유 검색어 */
  q?: string;
  /** 뷰 모드 */
  view?: "graph" | "timeline";
  // --- v2.1 추가 키 ---
  /** 고아 노드만 표시 */
  orphans?: boolean;
  /** 끊어진 체인만 표시 */
  breakpoints?: boolean;
  /** URL 상태 복원용 선택 엔티티 sourceId */
  selected?: string;
}
```

> **depth 제한**: 최대 10. 기본값 3. depth가 높을수록 Neo4j 쿼리 비용이 급증하므로,
> depth >= 5 시 사용자에게 확인 다이얼로그를 표시한다.

**URL 직렬화 규칙 (v2.1)**:

| FilterSpec 키 | URL 직렬화 | 예시 |
|--------------|-----------|------|
| `entityType` | 단일 값 | `?entityType=Requirement` |
| `edgeType` | 배열 → repeat key | `?edgeType=TRACES_TO&edgeType=BLOCKS` |
| `nodeType` | 배열 → repeat key | `?nodeType=Requirement&nodeType=Epic` |
| `dateRange` | dot notation | `?dateRange.from=2026-02-01&dateRange.to=2026-02-08` |
| `orphans` | boolean → `"true"` 만 직렬화 | `?orphans=true` |
| `breakpoints` | boolean → `"true"` 만 직렬화 | `?breakpoints=true` |
| `selected` | sourceId 문자열 | `?selected=REQ-034` |
| `depth` | 숫자 → 문자열 | `?depth=5` |
| 기타 스칼라 | 그대로 | `?direction=upstream&view=timeline` |

> **entityType vs nodeType 개념 분리**:
> - `entityType` + `entityId` = **포커스(시작점)** — 단일 선택. 엔티티 상세 진입 시 사용.
> - `nodeType[]` = **필터** — 복수 선택. 그래프에서 보여줄 노드 타입 제한.
> - UI 상단 드롭다운 라벨: "Node Types" (v2.0의 "Entity: All" → v2.1에서 명칭 변경)

### 2.3 Lineage 노드 (확정본)

```typescript
const lineageNode: MenuOntologyNodeV2 = {
  nodeId: "lineage",
  label: "Lineage & History",
  route: "/lineage",
  icon: "AccountTreeRounded",
  domain: "trace",
  nodeRole: "detail",              // v2.1: conditional bonus +3~+7 (graph/impact/chain keywords only, NOT flat +10)

  requiredCaps: ["view_lineage"],

  // --- Intents: 14 ---
  intents: [
    // Ask category
    "ask_trace_impact",             // "What's affected if this changes?"
    "ask_trace_coverage",           // "What's the overall trace coverage?"
    "ask_lineage_graph",            // "Show the lineage graph for REQ-034"
    "ask_change_history",           // "What changed in the last week?"
    "ask_upstream_trace",           // "Where did this Task come from?"
    "ask_downstream_trace",         // "What does this Requirement produce?"
    "ask_orphan_entities",          // "Are there disconnected entities?"
    "ask_breakpoint_status",        // "Are there broken trace chains?"
    "ask_dependency_graph",         // "Show me the dependency graph"
    "ask_blocking_chain",           // "What's blocking this item?"
    // Do category
    "do_create_trace_link",         // "Link this Story to the TestCase"
    "do_remove_trace_link",         // "Remove the link between..."
    "do_export_lineage",            // "Export the lineage report"
    "do_run_impact_analysis",       // "Run impact analysis for REQ-034"
  ],
  canonicalQuestions: [
    "이 요구사항이 변경되면 영향받는 항목은?",
    "REQ-034의 전체 추적 경로 보여줘",
    "끊어진 추적 경로가 있어?",
    "이 Epic의 변경 이력 알려줘",
    "Task에서 Requirement까지 역추적해줘",
    "BLOCKS 관계만 보여줘",
    "최근 1주일 변경 내역은?",
    "전체 Trace 커버리지 현황은?",
    "고아 노드(연결 없는 엔티티) 있어?",
    "이 Decision은 어떤 Risk에서 나왔어?",
    "영향 분석 실행해줘",
    "Trace Link 추가해줘",
  ],
  entities: [
    "Requirement", "Epic", "Feature", "Story", "Task",
    "TestCase", "Deliverable", "Issue", "Decision", "Risk",
  ],
  keywords: [
    "리니지", "계보", "추적", "영향분석", "변경이력", "그래프",
    "연결", "관계", "의존", "블로킹", "고아", "끊어진",
    "lineage", "trace", "impact", "history", "graph",
    "dependency", "blocking", "orphan", "breakpoint",
    "upstream", "downstream",
  ],
  metrics: [
    "total_nodes",
    "total_edges",
    "orphan_count",
    "max_chain_depth",
    "breakpoint_count",
  ],

  // --- FilterSpec embedded in ontology (v2.1: 12 keys) ---
  filterSpec: {
    keys: [
      "entityType", "entityId", "depth", "direction",
      "edgeType", "nodeType", "dateRange", "q", "view",
      "orphans", "breakpoints", "selected",               // v2.1
    ],
    defaults: {
      depth: "3",
      direction: "both",
      view: "graph",
    },
  },

  defaultPreset: "PM_WORK",
  presetPolicies: [
    {
      preset: "PM_WORK",
      ui: {
        density: "detailed",
        defaultRightPanel: "open",
        highlight: {
          metricKeys: ["total_nodes", "breakpoint_count", "orphan_count"],
          widgetKeys: ["LINEAGE_GRAPH", "IMPACT_PANEL", "CHANGE_TIMELINE"],
        },
      },
      suggestedActions: [
        {
          key: "create_link",
          label: "Trace Link 생성",
          requiredCaps: ["manage_trace_link"],
          targetNodeId: "lineage",
        },
        {
          key: "run_impact",
          label: "영향 분석 실행",
          requiredCaps: ["view_lineage"],
          targetNodeId: "lineage",
        },
        {
          key: "export_lineage",
          label: "Lineage Export",
          requiredCaps: ["export_reports"],
          targetNodeId: "reports",
        },
      ],
    },
    {
      preset: "PMO_CONTROL",
      ui: {
        density: "standard",
        defaultRightPanel: "open",
        highlight: {
          metricKeys: ["orphan_count", "breakpoint_count", "total_edges"],
          widgetKeys: ["LINEAGE_GRAPH", "IMPACT_PANEL", "METRICS_SUMMARY"],
        },
      },
      suggestedActions: [
        {
          key: "compliance_report",
          label: "준수 보고서",
          requiredCaps: ["export_reports"],
          targetNodeId: "reports",
        },
        {
          key: "orphan_review",
          label: "고아 노드 리뷰",
          requiredCaps: ["view_lineage"],
          targetNodeId: "lineage",
        },
      ],
    },
    {
      preset: "DEV_EXECUTION",
      ui: {
        density: "standard",
        defaultRightPanel: "closed",
        highlight: {
          metricKeys: ["total_nodes", "total_edges"],
          widgetKeys: ["LINEAGE_GRAPH"],
        },
      },
      // DEV: read-only graph exploration, no write actions
    },
    {
      preset: "EXEC_SUMMARY",
      ui: {
        density: "compact",
        defaultRightPanel: "closed",
        highlight: {
          metricKeys: ["total_nodes", "orphan_count"],
          widgetKeys: ["LINEAGE_GRAPH", "METRICS_SUMMARY"],
        },
      },
      // Sponsor: high-level dependency overview only
    },
    {
      preset: "CUSTOMER_APPROVAL",
      ui: {
        density: "compact",
        defaultRightPanel: "open",
        defaultFilters: {
          nodeType: ["Requirement", "Epic", "Deliverable"],  // v2.1: typed array
          direction: "downstream",
        },
        highlight: {
          metricKeys: ["total_nodes"],
          widgetKeys: ["LINEAGE_GRAPH", "IMPACT_PANEL"],
        },
      },
      // Customer: limited to Requirement -> Deliverable chain
    },
    {
      preset: "AUDIT_EVIDENCE",
      ui: {
        density: "compact",
        defaultRightPanel: "closed",
        highlight: {
          metricKeys: [
            "total_nodes", "total_edges", "orphan_count",
            "breakpoint_count", "max_chain_depth",
          ],
          widgetKeys: [
            "LINEAGE_GRAPH", "CHANGE_TIMELINE",
            "METRICS_SUMMARY", "EXPORT_PANEL",
          ],
        },
      },
      suggestedActions: [
        {
          key: "export_evidence",
          label: "증빙 Export",
          requiredCaps: ["export_audit_evidence"],
          targetNodeId: "audit-evidence",
        },
        {
          key: "export_full_graph",
          label: "전체 그래프 Export",
          requiredCaps: ["view_lineage"],
          targetNodeId: "lineage",
        },
      ],
    },
  ],

  // --- DeepLink: routeTemplate standard (:param form) --- (v2.1: filter-based)
  deepLinks: [
    {
      pattern: "/lineage/:entityType/:entityId",
      description: "Entity-specific lineage graph",
      requiredParams: ["entityType", "entityId"],
    },
    {
      pattern: "/lineage?entityType=:entityType&direction=:direction",
      description: "Entity type filtered lineage with direction",
      requiredParams: ["entityType", "direction"],
    },
    {
      pattern: "/lineage?edgeType=:edgeType",
      description: "Edge type filtered lineage",
      requiredParams: ["edgeType"],
    },
    {
      pattern: "/lineage?view=timeline&dateRange.from=:from&dateRange.to=:to",
      description: "Change timeline with date range",
      requiredParams: ["from", "to"],
    },
    {
      pattern: "/lineage?orphans=true",                    // v2.1: FilterSpec key
      description: "Orphan entities filter",
      requiredParams: [],
    },
    {
      pattern: "/lineage?breakpoints=true",                // v2.1
      description: "Breakpoint (broken chain) entities filter",
      requiredParams: [],
    },
  ],

  // --- Virtual nodes: deep links promoted to ontology layer-2 (v2.1: matchFilters) ---
  virtualNodes: [
    {
      virtualId: "lineage.impact",
      label: "Impact Analysis",
      routeTemplate: "/lineage/:entityType/:entityId?direction=downstream&depth=5",
      requiredParams: ["entityType", "entityId"],
      matchFilters: { direction: "downstream" },           // v2.1
      intents: ["ask_trace_impact", "do_run_impact_analysis"],
      description: "Downstream impact analysis for a specific entity",
    },
    {
      virtualId: "lineage.upstream",
      label: "Upstream Trace",
      routeTemplate: "/lineage/:entityType/:entityId?direction=upstream",
      requiredParams: ["entityType", "entityId"],
      matchFilters: { direction: "upstream" },             // v2.1
      intents: ["ask_upstream_trace"],
      description: "Upstream origin trace for a specific entity",
    },
    {
      virtualId: "lineage.orphans",
      label: "Orphan Entities",
      routeTemplate: "/lineage?orphans=true",
      requiredParams: [],
      matchFilters: { orphans: true },                     // v2.1: FilterSpec key
      intents: ["ask_orphan_entities"],
      description: "Disconnected entities with no relationships",
    },
    {
      virtualId: "lineage.breakpoints",                    // v2.1: split from orphans
      label: "Breakpoint Entities",
      routeTemplate: "/lineage?breakpoints=true",
      requiredParams: [],
      matchFilters: { breakpoints: true },                 // v2.1: FilterSpec key
      intents: ["ask_breakpoint_status"],
      description: "Entities with broken expected trace chains",
    },
    {
      virtualId: "lineage.timeline",
      label: "Change Timeline",
      routeTemplate: "/lineage?view=timeline",
      requiredParams: [],
      matchFilters: { view: "timeline" },                  // v2.1
      intents: ["ask_change_history"],
      description: "Change history timeline view",
    },
    {
      virtualId: "lineage.audit-trail",
      label: "Audit Trail",
      routeTemplate: "/lineage?view=timeline&preset=AUDIT_EVIDENCE",
      requiredParams: [],
      matchFilters: { view: "timeline" },                  // v2.1
      intents: ["ask_audit_readiness"],
      description: "Full audit trail for external auditors",
    },
  ],

  // --- Scope 2-layer separation ---
  scope: {
    keys: ["project"],
    params: ["projectId"],
  },

  priority: 5,
};
```

---

## 3. 화면 구조

### 3.1 Right Panel panelMode 정의

Right Panel은 항상 동일한 영역이지만, **panelMode**에 따라 표시 내용이 달라진다.

```typescript
/** Right Panel mode for Lineage screen */
export type LineagePanelMode =
  | "none"           // Right Panel hidden (EXEC_SUMMARY, DEV_EXECUTION)
  | "entity_detail"  // Selected entity detail information
  | "impact"         // Impact analysis result list
  | "change_log"     // Entity change history detail
  | "link_editor"    // Trace link create/delete (PM_WORK only)
  | "export";        // Export options (AUDIT_EVIDENCE)
```

**panelMode 결정 규칙**:

| Context | Preset | Default panelMode |
|---------|--------|-------------------|
| Graph view + no node selected | ALL | `"none"` |
| Graph view + node selected | EXEC_SUMMARY | `"none"` (Right Panel hidden) |
| Graph view + node selected | PM_WORK / PMO_CONTROL | `"entity_detail"` |
| Graph view + node selected | CUSTOMER_APPROVAL | `"entity_detail"` |
| Graph view + node selected | AUDIT_EVIDENCE | `"entity_detail"` |
| Graph view + node selected | DEV_EXECUTION | `"entity_detail"` (Right Panel toggleable) |
| Impact analysis executed | PM_WORK / PMO_CONTROL | `"impact"` |
| Change history selected | ALL | `"change_log"` |
| Link creation mode | PM_WORK | `"link_editor"` |
| Export mode | AUDIT_EVIDENCE | `"export"` |

### 3.2 전체 레이아웃 -- Graph View (기본)

```
+----------------------------------------------------------------------+
|  Page Header                                                           |
|  Lineage & History  [ AI Insurance Claims ]                            |
|  [ Entity: All v ]  [ Direction: Both v ]  [ Depth: 3 v ]             |
|  [ Edge Type v ]  [ Search ... ]          [ + Trace Link ]  [ Export ] |
+----------------------------------------------------------------------+
|                                                                        |
|  +----------+  +----------+  +----------+  +----------+  +----------+ |
|  | Total    |  | Total    |  | Orphan   |  | Max Chain|  | Break-   | |
|  | Nodes    |  | Edges    |  | Count    |  | Depth    |  | points   | |
|  |  142     |  |  198     |  |  3  !    |  |  7       |  |  5  !    | |
|  +----------+  +----------+  +----------+  +----------+  +----------+ |
|                                                                        |
|  +--- View Toggle ---+                                                 |
|  | [Graph] | Timeline |                                                |
|  +-------------------+                                                 |
|                                                                        |
|  +--- Graph Canvas (Main 70%) -------+--- Right Panel (30%) ----------+|
|  |                                   |                                 ||
|  |            [Req]                  | panelMode: "entity_detail"      ||
|  |           /     \                 |                                 ||
|  |      [Epic]     [Epic]           | Entity: REQ-034                 ||
|  |      /    \         \             | Type: Requirement               ||
|  |  [Feat] [Feat]    [Feat]         | Title: SSO integration          ||
|  |   |       |          |            | Status: Accepted                ||
|  |  [Story] [Story]  [Story]        | Created: 2026-01-15             ||
|  |   |       |          |            | Modified: 2026-02-01            ||
|  | [Task]  [Task]    [Task]         |                                 ||
|  |   |       |          |            | --- Connected Entities ---      ||
|  | [TC]    [TC]      [TC]           | Upstream: 0                     ||
|  |   |       |          |            | Downstream: 12                  ||
|  | [Dlv]  [Dlv]      [Dlv]         |                                 ||
|  |                                   | --- Change History ---          ||
|  |  Legend:                          | 2026-02-01 Modified (PM)        ||
|  |  --- TRACES_TO                    | 2026-01-28 Accepted (PM)        ||
|  |  -.- DERIVED_FROM                 | 2026-01-15 Created (System)     ||
|  |  xxx BLOCKS                       |                                 ||
|  |  === DEPENDS_ON                   | --- Impact Summary ---          ||
|  |  ... TESTS                        | Affected items: 12              ||
|  |  >>> PRODUCES                     | [ Run Full Impact Analysis ]    ||
|  |  ~~~ ESCALATED_TO                 |                                 ||
|  |                                   | --- Quick Actions ---           ||
|  |  [ Zoom + ]  [ Zoom - ]          | [ View in Backlog ]             ||
|  |  [ Fit ]     [ Reset ]           | [ View in Requirements ]        ||
|  |  [ Fullscreen ]                   | [ Add Trace Link ]              ||
|  |                                   |                                 ||
|  +-----------------------------------+---------------------------------+|
|                                                                        |
+------------------------------------------------------------------------+
```

### 3.3 전체 레이아웃 -- Timeline View

```
+----------------------------------------------------------------------+
|  Page Header                                                           |
|  Lineage & History  [ AI Insurance Claims ]                            |
|  [ Entity: All v ]  [ Date: 2026-02-01 ~ 2026-02-08 ]                 |
|  [ Search ... ]                                          [ Export ]    |
+----------------------------------------------------------------------+
|                                                                        |
|  +----------+  +----------+  +----------+  +----------+  +----------+ |
|  | Total    |  | Changes  |  | Entities |  | Most     |  | Break-   | |
|  | Changes  |  | This Wk  |  | Modified |  | Active   |  | points   | |
|  |  47      |  |  12      |  |  28      |  | REQ-034  |  |  5  !    | |
|  +----------+  +----------+  +----------+  +----------+  +----------+ |
|                                                                        |
|  +--- View Toggle ---+                                                 |
|  | Graph | [Timeline] |                                                |
|  +-------------------+                                                 |
|                                                                        |
|  +--- Timeline (Main 70%) -----------+--- Right Panel (30%) ----------+|
|  |                                   |                                 ||
|  |  2026-02-08                       | panelMode: "change_log"        ||
|  |  |                                |                                 ||
|  |  o  REQ-034  Modified             | Change Detail                  ||
|  |  |  Field: acceptance.primary     |                                 ||
|  |  |  Old: "pending" -> New: "Y"    | Entity: REQ-034                ||
|  |  |  By: PM Park                   | Type: Requirement              ||
|  |  |                                | Action: Field Update            ||
|  |  o  TSK-155  Status Changed       |                                 ||
|  |  |  TODO -> IN_PROGRESS           | Field: acceptance.primary      ||
|  |  |  By: Dev Kim                   | Before: "pending"              ||
|  |  |                                | After: "Y"                     ||
|  |  2026-02-07                       |                                 ||
|  |  |                                | Changed By: PM Park            ||
|  |  o  E-12  Story Added             | Changed At: 2026-02-08 09:32   ||
|  |  |  S-91 linked to E-12           |                                 ||
|  |  |  By: PM Park                   | --- Diff View ---              ||
|  |  |                                | { acceptance: {                ||
|  |  o  DEC-004  Created              |     primary: "pending"  // del ||
|  |  |  Decision: Arch change         |     primary: "Y"        // add ||
|  |  |  By: PM Park                   |   }                            ||
|  |  |                                | }                               ||
|  |  2026-02-06                       |                                 ||
|  |  |                                | --- Related Entities ---       ||
|  |  o  DLV-007  Upload               | Epic: E-12                     ||
|  |  |  File: design_v3.pdf           | Stories: S-88, S-91            ||
|  |  |  By: Dev Lee                   | [ View in Graph ]              ||
|  |  |                                |                                 ||
|  |  o  ISS-042  Escalated            |                                 ||
|  |  |  To Risk: RISK-005             |                                 ||
|  |  |  By: PM Park                   |                                 ||
|  |  |                                |                                 ||
|  |  [ Load More ... ]                |                                 ||
|  |                                   |                                 ||
|  +-----------------------------------+---------------------------------+|
|                                                                        |
+------------------------------------------------------------------------+
```

### 3.4 Entity-specific Lineage (`/lineage/:entityType/:entityId`)

```
+----------------------------------------------------------------------+
|  Page Header                                                           |
|  <- Lineage  Requirement / REQ-034  SSO Integration                    |
|  [ Direction: Both v ]  [ Depth: 3 v ]  [ Edge Type v ]               |
|                                              [ Impact Analysis ]       |
+----------------------------------------------------------------------+
|                                                                        |
|  +----------+  +----------+  +----------+  +----------+               |
|  | Upstream |  | Down-    |  | Direct   |  | Chain    |               |
|  | Nodes    |  | stream   |  | Links    |  | Depth    |               |
|  |  0       |  |  12      |  |  4       |  |  5       |               |
|  +----------+  +----------+  +----------+  +----------+               |
|                                                                        |
|  +--- View Toggle ---+                                                 |
|  | [Graph] | Timeline |                                                |
|  +-------------------+                                                 |
|                                                                        |
|  +--- Graph Canvas (Main 70%) -------+--- Right Panel (30%) ----------+|
|  |                                   |                                 ||
|  |                                   | panelMode: "impact"            ||
|  |                                   |                                 ||
|  |           [*REQ-034*]             | --- Impact Analysis ---         ||
|  |           /          \             |                                 ||
|  |     [Epic-12]    [Epic-15]       | If REQ-034 changes:             ||
|  |     /     \           \           |                                 ||
|  |  [F-20] [F-21]     [F-30]       | HIGH IMPACT (4):                ||
|  |    |       |           |          | o Story S-88 (IN_PROGRESS)     ||
|  | [S-88]  [S-91]     [S-105]      | o Story S-91 (READY)           ||
|  |    |       |           |          | o TC-21 (FAIL)                 ||
|  | [TSK-155] [TSK-170] [TSK-180]   | o DLV-007 (PENDING)            ||
|  |    |       |           |          |                                 ||
|  | [TC-21]  (none) !   [TC-45]     | MEDIUM IMPACT (5):              ||
|  |  FAIL      ^          PASS       | o Task TSK-155 (IN_PROGRESS)   ||
|  |    |    breakpoint     |          | o Task TSK-170 (TODO)          ||
|  | [DLV-007]           [DLV-012]   | o Task TSK-180 (TODO)          ||
|  |  PENDING             APPROVED    | o Feature F-20                 ||
|  |                                   | o Feature F-21                 ||
|  |  * = focus entity                |                                 ||
|  |  ! = breakpoint (chain broken)   | LOW IMPACT (3):                 ||
|  |                                   | o Epic E-12                    ||
|  |                                   | o Epic E-15                    ||
|  |                                   | o Feature F-30                 ||
|  |                                   |                                 ||
|  |                                   | Breakpoints: 1                 ||
|  |                                   | ! S-91 -> TC (missing)         ||
|  |                                   |                                 ||
|  +-----------------------------------+---------------------------------+|
|                                                                        |
+------------------------------------------------------------------------+
```

---

## 4. Preset별 차이

### 4.1 PM_WORK (PM) -- Full graph exploration + Trace link management

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | total_nodes, total_edges, orphan_count, max_chain_depth, breakpoint_count |
| Graph View | Full force-directed graph, all node types, all edge types |
| Filter | entityType, direction, depth, edgeType, nodeType, dateRange, q |
| Right Panel | panelMode: entity_detail / impact / link_editor |
| CTA | `Trace Link 생성` (cap: manage_trace_link), `영향 분석` (cap: view_lineage), `Export` (cap: export_reports) |
| Timeline | Full change history with diff view |

### 4.2 PMO_CONTROL (PMO) -- Impact analysis + compliance reporting

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | orphan_count (highlighted), breakpoint_count (highlighted), total_edges |
| Graph View | Full graph, breakpoint/orphan highlighted in red |
| Filter | entityType, direction, depth, edgeType, nodeType |
| Right Panel | panelMode: impact / entity_detail |
| CTA | `준수 보고서` (cap: export_reports), `고아 노드 리뷰` (cap: view_lineage) |
| Timeline | Full access, compliance-focused view |

### 4.3 DEV_EXECUTION (DEV/DevReader) -- Read-only graph exploration

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | total_nodes, total_edges (basic metrics only) |
| Graph View | Full graph (read-only, no link editing) |
| Filter | entityType, direction, depth (limited to 5), q |
| Right Panel | panelMode: entity_detail (toggle, default closed) |
| CTA | None (read-only) |
| Timeline | Read-only access |

### 4.4 EXEC_SUMMARY (Sponsor) -- High-level dependency overview

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | total_nodes, orphan_count (compact) |
| Graph View | Simplified graph (only top-level entities: Requirement, Epic, Deliverable) |
| Filter | entityType (limited), direction |
| Right Panel | panelMode: "none" (hidden by default) |
| CTA | None (read-only overview) |
| Timeline | Hidden |

### 4.5 CUSTOMER_APPROVAL (Customer PM) -- Limited trace view

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | total_nodes (compact) |
| Graph View | Filtered to Requirement -> Deliverable chain only |
| Filter | Limited: direction=downstream, nodeType=Requirement/Epic/Deliverable |
| Right Panel | panelMode: entity_detail (open) |
| CTA | None (read-only, deliverable chain only) |
| Timeline | Limited (Requirement and Deliverable changes only) |

### 4.6 AUDIT_EVIDENCE (External Auditor) -- Full read access for audit trail

| 영역 | 표시 내용 |
|------|---------|
| KPI Row | All 5 metrics (full visibility for audit) |
| Graph View | Full graph (read-only) |
| Filter | All filters available (full audit access) |
| Right Panel | panelMode: entity_detail / export |
| CTA | `증빙 Export` (cap: export_audit_evidence), `전체 그래프 Export` (cap: view_lineage) |
| Timeline | Full change history (audit trail) |

> **AUDIT_EVIDENCE 특이사항**: 이 화면은 감사가 접근 가능한 몇 안 되는 화면 중 하나이다.
> AUDIT_EVIDENCE Preset은 Lineage 화면에서는 전환 가능하다 (대시보드와 다름).
> 모든 데이터는 읽기 전용이며, Export 기능만 활성화된다.

---

## 5. 그래프 모델 상세

### 5.1 노드 타입 (Neo4j Node Labels)

```typescript
/** Lineage Graph Node (v2.1: id = sourceId for UI stability) */
interface LineageNode {
  /**
   * Stable entity ID = PostgreSQL sourceId.
   * Neo4j internal ID is NOT exposed (changes on re-index/re-import).
   * All UI selection, URL routing, API calls use this id.
   */
  id: string;
  /** Entity type (node label) */
  type: LineageEntityType;
  /** Display label */
  label: string;
  /** Entity title */
  title: string;
  /** Current status */
  status: string;
  /** Project scope */
  projectId: string;
  /** Metadata */
  metadata: {
    createdAt: string;
    updatedAt: string;
    createdBy: string;
    phase?: string;
    part?: string;
    priority?: string;
    [key: string]: any;
  };
}
```

| Node Type | Neo4j Label | Icon | Color | Description |
|-----------|-------------|------|-------|-------------|
| Requirement | `:Requirement` | Description | `#1565C0` (Blue) | RFP requirement |
| Epic | `:Epic` | ViewList | `#6A1B9A` (Purple) | Backlog Epic |
| Feature | `:Feature` | Extension | `#7B1FA2` (Light Purple) | Feature under Epic |
| Story | `:Story` | AutoStories | `#4527A0` (Deep Purple) | User Story |
| Task | `:Task` | Assignment | `#00695C` (Teal) | Execution task |
| TestCase | `:TestCase` | BugReport | `#E65100` (Orange) | Test case |
| Deliverable | `:Deliverable` | InsertDriveFile | `#2E7D32` (Green) | Output artifact |
| Issue | `:Issue` | Warning | `#C62828` (Red) | Issue/problem |
| Decision | `:Decision` | Gavel | `#F57F17` (Amber) | Decision record |
| Risk | `:Risk` | Shield | `#AD1457` (Pink) | Risk item |

### 5.2 엣지 타입 (Neo4j Relationship Types)

```typescript
/** Lineage Graph Edge */
interface LineageEdge {
  /** Source node ID */
  source: string;
  /** Target node ID */
  target: string;
  /** Relationship type */
  type: LineageEdgeType;
  /** Edge metadata */
  metadata: {
    createdAt: string;
    createdBy: string;
    weight?: number;        // importance/strength (0~1) -- v2.1: RESERVED, currently unused. Impact severity uses pathLength + status, NOT weight.
    description?: string;   // edge annotation
  };
}
```

| Edge Type | Label | Direction | Source -> Target Example | Line Style | Color |
|-----------|-------|-----------|------------------------|------------|-------|
| `TRACES_TO` | Traces | Forward | Requirement -> Epic | Solid | `#1565C0` |
| `DERIVED_FROM` | Derived | Reverse | Story -> Requirement | Dashed | `#6A1B9A` |
| `BLOCKS` | Blocks | Forward | Issue -> Task | Dotted (thick) | `#C62828` |
| `DEPENDS_ON` | Depends | Forward | Task -> Task | Dash-dot | `#00695C` |
| `TESTS` | Tests | Forward | TestCase -> Story | Dotted | `#E65100` |
| `PRODUCES` | Produces | Forward | Task -> Deliverable | Solid (thick) | `#2E7D32` |
| `ESCALATED_TO` | Escalated | Forward | Issue -> Risk -> Decision | Wavy | `#F57F17` |

### 5.3 일반적인 Trace Chain 패턴

```
Requirement  --TRACES_TO-->  Epic  --TRACES_TO-->  Feature
     |                                                |
     |                                          --TRACES_TO-->  Story
     |                                                            |
     |                                                      --TRACES_TO-->  Task
     |                                                            |
     |                                              --TESTS-->  TestCase
     |
     +--PRODUCES--> Deliverable

Issue  --BLOCKS-->  Task
Issue  --ESCALATED_TO-->  Risk  --ESCALATED_TO-->  Decision

Task  --DEPENDS_ON-->  Task  (inter-task dependencies)
Story --DERIVED_FROM--> Requirement (reverse trace)
```

### 5.4 Neo4j Cypher 쿼리 패턴

> **v2.1 필수 규칙**:
> 1. **projectId 스코프 강제**: 모든 쿼리에 `projectId = $projectId` 조건 필수. traversal 중간 노드도 `ALL(x IN nodes(path) WHERE x.projectId = $projectId)` 로 검증.
> 2. **edgeType 필터 반영**: FilterSpec의 `edgeType[]`가 주어지면, 서버측 **쿼리 빌더**가 relationship type allowlist를 조립하여 traversal에 적용. 예: `-[r:TRACES_TO|BLOCKS*1..$depth]->`. 빈 edgeType은 전체 허용.
> 3. **Cypher 파라미터 바인딩**: relationship type은 Cypher에서 파라미터로 직접 전달이 불가하므로, 서버에서 allowlist 기반으로 안전하게 문자열 조립 후 실행.

#### 5.4.1 Downstream Traversal (영향 분석)

```cypher
// v2.1: projectId scope + edgeType filter
// Server query builder assembles relationship types from $edgeTypes allowlist
// Example: if edgeType=["TRACES_TO","BLOCKS"] -> -[r:TRACES_TO|BLOCKS*1..$depth]->
// Example: if edgeType=[] (empty) -> -[r*1..$depth]-> (all types)

MATCH (start {sourceId: $entityId, projectId: $projectId})
WHERE start:$entityType                    // label injected by server (allowlist only)
MATCH path = (start)-[r:TRACES_TO|BLOCKS|DEPENDS_ON|TESTS|PRODUCES|ESCALATED_TO*1..$depth]->(downstream)
WHERE ALL(x IN nodes(path) WHERE x.projectId = $projectId)
RETURN
  nodes(path) AS nodes,
  relationships(path) AS edges,
  length(path) AS chainDepth
ORDER BY chainDepth ASC
```

#### 5.4.2 Upstream Traversal (원인 추적)

```cypher
// v2.1: projectId scope mandatory
MATCH (target {sourceId: $entityId, projectId: $projectId})
WHERE target:$entityType
MATCH path = (upstream)-[r*1..$depth]->(target)
WHERE ALL(x IN nodes(path) WHERE x.projectId = $projectId)
RETURN
  nodes(path) AS nodes,
  relationships(path) AS edges,
  length(path) AS chainDepth
ORDER BY chainDepth ASC
```

#### 5.4.3 Bidirectional Traversal

```cypher
// v2.1: projectId scope mandatory
MATCH (focus {sourceId: $entityId, projectId: $projectId})
WHERE focus:$entityType
MATCH path = (n)-[r*1..$depth]-(focus)
WHERE ALL(x IN nodes(path) WHERE x.projectId = $projectId)
RETURN DISTINCT
  nodes(path) AS nodes,
  relationships(path) AS edges
```

#### 5.4.4 Orphan Detection

```cypher
// v2.1: fixed OR precedence with parentheses + projectId scope
MATCH (orphan)
WHERE orphan.projectId = $projectId
  AND NOT (orphan)--()
  AND (orphan:Requirement OR orphan:Epic OR orphan:Story
    OR orphan:Task OR orphan:TestCase OR orphan:Deliverable
    OR orphan:Feature OR orphan:Issue OR orphan:Decision OR orphan:Risk)
RETURN orphan
```

#### 5.4.5 Breakpoint Detection

```cypher
// v2.1: includes all 10 entity types, status <> CANCELLED filter
// Story without TestCase
MATCH (s:Story {projectId: $projectId})
WHERE NOT (s)<-[:TESTS]-(:TestCase)
  AND s.status <> 'CANCELLED'
RETURN s AS entity, 'Story->TestCase' AS missingLink

UNION

// Epic without Story (direct or via Feature)
MATCH (e:Epic {projectId: $projectId})
WHERE NOT (e)-[:TRACES_TO]->(:Story)
  AND NOT (e)-[:TRACES_TO]->(:Feature)-[:TRACES_TO]->(:Story)
  AND e.status <> 'CANCELLED'
RETURN e AS entity, 'Epic->Story' AS missingLink

UNION

// Requirement without downstream trace
MATCH (r:Requirement {projectId: $projectId})
WHERE NOT (r)-[:TRACES_TO]->()
  AND r.status <> 'CANCELLED'
RETURN r AS entity, 'Requirement->Epic/Feature' AS missingLink

UNION

// Task without upstream Story/Epic
MATCH (t:Task {projectId: $projectId})
WHERE NOT ()<-[:TRACES_TO]-(t) AND NOT ()-[:TRACES_TO]->(t)
  AND t.status <> 'CANCELLED'
RETURN t AS entity, 'Task->Story (upstream)' AS missingLink
```

### 5.5 그래프 메트릭스 계산

```typescript
interface LineageMetrics {
  /** Total number of nodes in the visible graph */
  total_nodes: number;
  /** Total number of edges in the visible graph */
  total_edges: number;
  /** Entities with no connections (orphans) */
  orphan_count: number;
  /** Maximum depth of the longest trace chain */
  max_chain_depth: number;
  /** Number of expected-but-missing links (breakpoints) */
  breakpoint_count: number;
}

interface LineageMetricsDetail extends LineageMetrics {
  /** Breakdown by node type */
  nodesByType: Record<LineageEntityType, number>;
  /** Breakdown by edge type */
  edgesByType: Record<LineageEdgeType, number>;
  /** Orphan details */
  orphans: {
    entityId: string;
    entityType: LineageEntityType;
    title: string;
  }[];
  /** Breakpoint details */
  breakpoints: {
    entityId: string;
    entityType: LineageEntityType;
    title: string;
    missingLink: string;     // e.g., "Story->TestCase"
    description: string;
  }[];
}
```

---

## 6. 데이터 구조 / API

### 6.1 Lineage Graph API

```
GET /api/lineage/graph?projectId={projectId}
    &entityType={entityType}
    &entityId={entityId}
    &depth={1-10}
    &direction={upstream|downstream|both}
    &edgeType={TRACES_TO,BLOCKS,...}
    &nodeType={Requirement,Epic,...}
    &q={searchText}
```

> **참고**: 쿼리 파라미터는 S2.2 FilterSpec 키와 **1:1 매핑**된다.
> v2.1 추가: `orphans`, `breakpoints`, `selected` 파라미터도 지원.

#### 6.1.1 서버측 Preset Clamp (v2.1)

서버는 요청의 `preset` (JWT에서 추출) 기반으로 FilterSpec을 **강제 제한(clamp)** 한다.
UI-only 강제는 API 직접 호출/AI 오작동 시 우회 가능하므로, **서버에서 동일 규칙을 이중 적용**한다.

```typescript
/** Server-side Preset Policy Resolver */
interface PresetPolicyResolver {
  clamp(
    requestFilter: LineageFilterSpec,
    preset: ViewModePreset,
    caps: Capability[]
  ): {
    effectiveFilter: LineageFilterSpec;
    clampedFields: string[];        // which fields were overridden
    deniedActions: string[];        // which mutation actions are blocked
  };
}

/** Preset별 clamp 규칙 */
const PRESET_CLAMP_RULES: Record<ViewModePreset, Partial<LineageFilterSpec> & { maxDepth: number; allowedNodeTypes?: LineageEntityType[] }> = {
  PM_WORK:           { maxDepth: 10 },
  PMO_CONTROL:       { maxDepth: 10 },
  DEV_EXECUTION:     { maxDepth: 5 },
  EXEC_SUMMARY:      { maxDepth: 3, allowedNodeTypes: ["Requirement", "Epic", "Deliverable"] },
  CUSTOMER_APPROVAL: { maxDepth: 5, allowedNodeTypes: ["Requirement", "Epic", "Deliverable"], direction: "downstream" },
  AUDIT_EVIDENCE:    { maxDepth: 10 },
};
```

> 모든 API 응답에 `appliedFilter` 를 포함하여, 클라이언트가 "내가 요청한 것과 서버가 적용한 것이 다른지" 확인 가능.

```typescript
interface LineageGraphResponse {
  /** Graph data */
  graph: {
    nodes: LineageNode[];
    edges: LineageEdge[];
  };

  /** Focus entity (if entityId specified) -- id = sourceId (v2.1) */
  focus?: {
    id: string;                   // = sourceId (stable PostgreSQL ID)
    type: LineageEntityType;
    title: string;
  };

  /**
   * v2.1: Lightweight visible-graph metrics only.
   * Heavy metrics (orphan_count, breakpoint_count, max_chain_depth) are from GET /metrics API (cached 5min).
   */
  visibleMetrics: {
    nodeCount: number;          // nodes in this response
    edgeCount: number;          // edges in this response
  };

  /** Pagination (for large graphs) */
  pagination: {
    totalNodes: number;
    returnedNodes: number;
    truncated: boolean;       // true if graph exceeded max render limit
    maxNodes: number;         // server-side limit (default: 500)
    truncatedReason?: string; // v2.1: "maxNodes exceeded" | "depth limit" | "timeout"
    suggestedFilters?: string[]; // v2.1: ["Add nodeType filter", "Reduce depth"]
  };

  // --- Reliability 3-tuple (v2.1: sync vs query split) ---
  asOf: string;
  completeness: {
    /** PostgreSQL -> Neo4j Outbox sync progress (0~1) */
    sync: number;
    /** Query result completeness (1.0 = full, <1.0 = truncated/timed-out) */
    query: number;
  };
  warnings: { code: string; message: string; severity: "info" | "warn" | "critical"; }[];

  /** v2.1: server-applied filter after preset clamp */
  appliedFilter: LineageFilterSpec;
  scope: { projectId: string };
}
```

### 6.2 Impact Analysis API

```
GET /api/lineage/impact?projectId={projectId}
    &entityType={entityType}
    &entityId={entityId}
    &depth={1-10}
```

```typescript
interface ImpactAnalysisResponse {
  /** Source entity */
  source: {
    id: string;
    type: LineageEntityType;
    title: string;
  };

  /** Impacted entities grouped by severity */
  impact: {
    high: ImpactItem[];     // directly connected, in-progress
    medium: ImpactItem[];   // 2nd degree connections
    low: ImpactItem[];      // 3rd+ degree connections
  };

  /** Summary counts */
  summary: {
    totalAffected: number;
    highCount: number;
    mediumCount: number;
    lowCount: number;
    breakpointCount: number;
  };

  /** Breakpoints in the impact chain */
  breakpoints: {
    entityId: string;
    entityType: LineageEntityType;
    title: string;
    missingLink: string;
    description: string;
  }[];

  /** Graph data for visualization */
  graph: {
    nodes: LineageNode[];
    edges: LineageEdge[];
  };

  // --- Reliability 3-tuple (v2.1: sync vs query) ---
  asOf: string;
  completeness: {
    sync: number;
    query: number;
  };
  warnings: { code: string; message: string; severity: "info" | "warn" | "critical"; }[];
  scope: { projectId: string };
}

interface ImpactItem {
  id: string;
  type: LineageEntityType;
  title: string;
  status: string;
  impactLevel: "high" | "medium" | "low";
  /** Path from source to this entity */
  pathLength: number;
  /** Edge types in the path */
  pathEdges: LineageEdgeType[];
  /** Reason for impact level */
  reason: string;
}
```

### 6.3 Change History API

```
GET /api/lineage/history?projectId={projectId}
    &entityType={entityType}
    &entityId={entityId}
    &dateRange.from={ISO8601}
    &dateRange.to={ISO8601}
    &page={page}&size={size}
```

```typescript
interface ChangeHistoryResponse {
  items: ChangeHistoryItem[];
  pagination: {
    page: number;
    size: number;
    total: number;
  };

  /** Timeline stats */
  stats: {
    totalChanges: number;
    changesThisWeek: number;
    entitiesModified: number;
    mostActiveEntity: {
      id: string;
      type: LineageEntityType;
      title: string;
      changeCount: number;
    };
  };

  // --- Reliability 3-tuple (v2.1: sync vs query) ---
  asOf: string;
  completeness: {
    sync: number;
    query: number;
  };
  warnings: { code: string; message: string; severity: "info" | "warn" | "critical"; }[];
  scope: { projectId: string };
}

interface ChangeHistoryItem {
  id: string;
  /** When the change occurred */
  timestamp: string;
  /** Entity that was changed */
  entity: {
    id: string;
    type: LineageEntityType;
    title: string;
  };
  /** Type of change */
  action: "created" | "updated" | "deleted" | "linked" | "unlinked" | "status_changed";
  /** Who made the change */
  actor: {
    id: string;
    name: string;
    role: string;
  };
  /** Change details */
  changes: {
    field: string;
    oldValue: any;
    newValue: any;
  }[];
  /** Related entities affected */
  relatedEntities?: {
    id: string;
    type: LineageEntityType;
    title: string;
  }[];

  // --- v2.1 additions ---
  /**
   * Transaction correlation ID.
   * Groups multiple changes from a single user action (e.g., Story create + Epic link).
   * Timeline UI can collapse items with the same correlationId.
   */
  correlationId?: string;
  /**
   * Change origin source.
   * Audit trail distinguishes AI-created links from human-created ones.
   */
  source: "ui" | "api" | "system" | "ai";
}
```

### 6.4 Metrics API

```
GET /api/lineage/metrics?projectId={projectId}
```

```typescript
interface LineageMetricsResponse {
  /**
   * v2.1: Full metrics including orphan/breakpoint/max_chain_depth.
   * Graph API returns only lightweight visibleMetrics; this API is the authoritative source.
   * KPI Row reads from this API (cached 5 min).
   */
  metrics: LineageMetricsDetail;

  /** Trend data (last 4 weeks) */
  trend: {
    week: string;
    totalNodes: number;
    totalEdges: number;
    orphanCount: number;
    breakpointCount: number;
  }[];

  // --- Reliability 3-tuple (v2.1: sync vs query) ---
  asOf: string;
  completeness: {
    sync: number;
    query: number;
  };
  warnings: { code: string; message: string; severity: "info" | "warn" | "critical"; }[];
  scope: { projectId: string };
}
```

### 6.5 Trace Link Management API

```
POST   /api/lineage/links                    // Create trace link
DELETE /api/lineage/links/:linkId            // Remove trace link
GET    /api/lineage/links/suggestions        // AI-suggested links
```

> **v2.1 Mutation Headers**:
> - `Idempotency-Key: {uuid}` — POST/DELETE 멱등성 보장
> - `If-Match: {etag}` — DELETE 시 낙관적 동시성 검사

```typescript
/** Create Trace Link request */
interface CreateTraceLinkRequest {
  projectId: string;
  sourceType: LineageEntityType;
  sourceId: string;
  targetType: LineageEntityType;
  targetId: string;
  edgeType: LineageEdgeType;
  description?: string;
}

/** Create Trace Link response */
interface CreateTraceLinkResponse {
  linkId: string;
  source: { id: string; type: LineageEntityType; title: string };
  target: { id: string; type: LineageEntityType; title: string };
  edgeType: LineageEdgeType;
  createdAt: string;
  createdBy: string;
  /** Updated metrics after link creation */
  updatedMetrics: LineageMetrics;
}

/** AI-suggested trace links */
interface TraceLinkSuggestion {
  sourceType: LineageEntityType;
  sourceId: string;
  sourceTitle: string;
  targetType: LineageEntityType;
  targetId: string;
  targetTitle: string;
  suggestedEdgeType: LineageEdgeType;
  confidence: number;           // 0~1
  reason: string;               // "Same keyword 'SSO' appears in both"
}

interface TraceLinkSuggestionsResponse {
  suggestions: TraceLinkSuggestion[];
  asOf: string;
}
```

### 6.6 Export API

```
POST /api/lineage/export
```

```typescript
interface LineageExportRequest {
  projectId: string;
  format: "pdf" | "csv" | "json" | "graphml";
  scope: {
    entityType?: LineageEntityType;
    entityId?: string;
    depth?: number;
    direction?: TraversalDirection;
  };
  includeChangeHistory: boolean;
  includeImpactAnalysis: boolean;
  dateRange?: {
    from: string;
    to: string;
  };
}

interface LineageExportResponse {
  exportId: string;
  status: "queued" | "processing" | "completed" | "failed";
  downloadUrl?: string;         // available when completed
  statusUrl: string;            // v2.1: polling endpoint for export progress
  retryAfterMs?: number;        // v2.1: suggested polling interval (default 3000)
  estimatedSize?: string;       // "2.4 MB"
  estimatedTime?: string;       // "~30s"
}
```

---

## 7. 컴포넌트 분해

### 7.1 폴더 구조

```
features/
  traceability/
    pages/
      LineagePage.tsx              <- Main page (Graph + Timeline toggle)
      EntityLineagePage.tsx        <- Entity-specific (/lineage/:entityType/:entityId)
    layout/
      LineageShell.tsx             <- Common layout (KPI + Main + RightPanel)
      ViewToggle.tsx               <- Graph / Timeline toggle
    components/
      // Graph View
      LineageGraph.tsx             <- Force-directed graph canvas (core)
      GraphNode.tsx                <- Individual node renderer
      GraphEdge.tsx                <- Individual edge renderer
      GraphControls.tsx            <- Zoom, fit, reset, fullscreen controls
      GraphLegend.tsx              <- Edge type legend
      GraphMinimap.tsx             <- Mini navigation map (large graphs)
      NodeTooltip.tsx              <- Hover tooltip for nodes
      NodeContextMenu.tsx          <- Right-click context menu

      // Filters
      LineageFilters.tsx           <- Filter bar (FilterSpec-based)
      EntityTypeSelect.tsx         <- Entity type multi-select
      EdgeTypeSelect.tsx           <- Edge type multi-select
      DirectionToggle.tsx          <- Upstream/Downstream/Both toggle
      DepthSlider.tsx              <- Depth control slider (1-10)
      DateRangeFilter.tsx          <- Date range picker (Timeline)

      // KPI
      LineageKpiRow.tsx            <- Metrics KPI card row
      MetricsSummaryWidget.tsx     <- Detailed metrics breakdown

      // Impact Analysis
      ImpactPanel.tsx              <- Impact analysis result panel (Right Panel)
      ImpactList.tsx               <- Grouped impact item list (High/Medium/Low)
      ImpactItem.tsx               <- Single impact item renderer
      BreakpointAlert.tsx          <- Breakpoint warning banner

      // Timeline View
      ChangeTimeline.tsx           <- Change history timeline (core)
      ChangeTimelineItem.tsx       <- Single timeline entry
      ChangeDiffView.tsx           <- Field-level diff viewer
      TimelineStats.tsx            <- Timeline statistics summary

      // Right Panel
      LineageRightPanel.tsx        <- panelMode-based branch rendering
      EntityDetailCard.tsx         <- Selected entity detail info
      EntityChangeLog.tsx          <- Per-entity change history
      QuickActionList.tsx          <- Quick navigation actions

      // Trace Link Management (PM_WORK only)
      TraceLinkEditor.tsx          <- Link create/delete panel
      TraceLinkForm.tsx            <- New link creation form
      LinkSuggestionList.tsx       <- AI-suggested links
      LinkConfirmDialog.tsx        <- Link creation confirmation

      // Export (AUDIT_EVIDENCE)
      ExportPanel.tsx              <- Export configuration panel
      ExportFormatSelect.tsx       <- Format selection (PDF/CSV/JSON/GraphML)
      ExportScopeConfig.tsx        <- Export scope configuration
      ExportProgressBar.tsx        <- Export progress indicator

      // Common
      OrphanBadge.tsx              <- Orphan entity badge/indicator
      BreakpointBadge.tsx          <- Breakpoint chain indicator
      LineageReliabilityBanner.tsx <- Reliability banner (asOf/completeness/warnings)

    config/
      graphConfig.ts               <- Graph rendering configuration
      nodeColorMap.ts              <- Entity type -> color mapping
      edgeStyleMap.ts              <- Edge type -> line style mapping
      presetLayouts.ts             <- Preset-specific layout definitions
      presetClampConfig.ts         <- v2.1: Per-preset clamp rules (maxDepth, allowedNodeTypes, direction)

    api/
      lineageApi.ts                <- All API call functions
    hooks/
      useLineageGraph.ts           <- Graph data TanStack Query
      useImpactAnalysis.ts         <- Impact analysis Query
      useChangeHistory.ts          <- Change history Query
      useLineageMetrics.ts         <- Metrics Query
      useTraceLinkMutation.ts      <- Trace link create/delete mutation
      useGraphInteraction.ts       <- Graph zoom/pan/select state
      useLineageExport.ts          <- Export mutation + polling
      usePanelMode.ts              <- Right Panel mode state management
      useUrlStateRestore.ts        <- v2.1: URL -> FilterSpec restore on mount (orphans/breakpoints/selected)
```

### 7.2 LineagePage.tsx -- Main Page

```typescript
function LineagePage() {
  const { viewMode, effectivePreset } = useAccessContext();
  const { panelMode, setPanelMode } = usePanelMode(viewMode);
  const [activeView, setActiveView] = useState<"graph" | "timeline">("graph");
  const [selectedNode, setSelectedNode] = useState<LineageNode | null>(null);
  const [filters, setFilters] = useState<LineageFilterSpec>({
    depth: 3,
    direction: "both",
  });

  // --- v2.1: URL state restore on mount ---
  const urlFilters = useUrlStateRestore(lineageNode.filterSpec);
  useEffect(() => {
    if (urlFilters) {
      setFilters(prev => ({ ...prev, ...urlFilters }));
      if (urlFilters.view) setActiveView(urlFilters.view);
    }
  }, []); // run once on mount

  const { data: graphData, isLoading } = useLineageGraph(filters);
  const { data: metrics } = useLineageMetrics();

  // Preset-specific filter defaults (after URL restore)
  useEffect(() => {
    const presetPolicy = lineageNode.presetPolicies.find(
      p => p.preset === effectivePreset
    );
    if (presetPolicy?.ui.defaultFilters) {
      setFilters(prev => ({ ...prev, ...presetPolicy.ui.defaultFilters }));
    }
  }, [effectivePreset]);

  // --- v2.1: Sync filters -> URL (push state on filter change) ---
  useEffect(() => {
    const url = lineageFilterToUrl(filters);
    window.history.replaceState(null, "", url);
  }, [filters]);

  const handleNodeSelect = useCallback((node: LineageNode) => {
    setSelectedNode(node);
    if (effectivePreset === "EXEC_SUMMARY") {
      setPanelMode("none");
    } else {
      setPanelMode("entity_detail");
    }
  }, [effectivePreset]);

  const rightPanelContent = useMemo(() => {
    switch (panelMode) {
      case "none":          return undefined;
      case "entity_detail": return <EntityDetailCard entity={selectedNode} />;
      case "impact":        return <ImpactPanel entityId={selectedNode?.id} />;
      case "change_log":    return <EntityChangeLog entityId={selectedNode?.id} />;
      case "link_editor":   return <TraceLinkEditor />;
      case "export":        return <ExportPanel />;
      default:              return undefined;
    }
  }, [panelMode, selectedNode]);

  return (
    <LineageShell
      preset={effectivePreset}
      rightPanel={rightPanelContent}
      rightPanelDefault={
        lineageNode.presetPolicies.find(p => p.preset === effectivePreset)
          ?.ui.defaultRightPanel ?? "closed"
      }
    >
      <LineageKpiRow metrics={metrics} preset={effectivePreset} />
      <LineageFilters
        filters={filters}
        onChange={setFilters}
        filterSpec={lineageNode.filterSpec}
        preset={effectivePreset}
      />
      {/* v2.1: orphans/breakpoints quick-toggle buttons */}
      <OrphanBreakpointToggle
        orphans={filters.orphans ?? false}
        breakpoints={filters.breakpoints ?? false}
        onChange={(key, val) => setFilters(prev => ({ ...prev, [key]: val }))}
      />
      <ViewToggle active={activeView} onChange={setActiveView} />

      {activeView === "graph" ? (
        <LineageGraph
          data={graphData}
          onNodeSelect={handleNodeSelect}
          selectedNode={selectedNode}
          preset={effectivePreset}
        />
      ) : (
        <ChangeTimeline
          filters={filters}
          onItemSelect={(item) => {
            setSelectedNode(item.entity);
            setPanelMode("change_log");
          }}
        />
      )}

      {/* v2.1: dual-axis completeness banner */}
      <LineageReliabilityBanner
        asOf={graphData?.asOf}
        syncCompleteness={graphData?.completeness?.sync}
        queryCompleteness={graphData?.completeness?.query}
        warnings={graphData?.warnings}
      />
    </LineageShell>
  );
}
```

### 7.3 LineageRightPanel.tsx -- panelMode Branch Rendering

```typescript
interface LineageRightPanelProps {
  panelMode: LineagePanelMode;
  selectedNode?: LineageNode | null;
  preset: ViewModePreset;
}

function LineageRightPanel({ panelMode, selectedNode, preset }: LineageRightPanelProps) {
  switch (panelMode) {
    case "none":
      return null;
    case "entity_detail":
      return (
        <>
          <EntityDetailCard entity={selectedNode} />
          <QuickActionList
            entityType={selectedNode?.type}
            entityId={selectedNode?.id}
            preset={preset}
          />
        </>
      );
    case "impact":
      return (
        <ImpactPanel
          entityType={selectedNode?.type}
          entityId={selectedNode?.id}
        />
      );
    case "change_log":
      return (
        <EntityChangeLog
          entityType={selectedNode?.type}
          entityId={selectedNode?.id}
        />
      );
    case "link_editor":
      return (
        <Can required={["manage_trace_link"]}>
          <TraceLinkEditor sourceNode={selectedNode} />
        </Can>
      );
    case "export":
      return (
        <Can required={["export_audit_evidence"]}>
          <ExportPanel />
        </Can>
      );
  }
}
```

---

## 8. AI Navigation 연동

### 8.1 Lineage 관련 AI 질문 -> 화면 이동 (FilterSpec 기반)

AI는 URL 문자열이 아니라 **FilterSpec 키 기반 필터 객체**를 반환한다.
UI는 `lineageNode.filterSpec`을 참조하여 FilterSpec 객체를 URL 파라미터로 변환한다.

```typescript
/** AI lineage navigation response */
interface AiLineageNavigation {
  targetNodeId: "lineage";
  /** FilterSpec-based filter object */
  filter: LineageFilterSpec;
  /** Direct entity navigation */
  entityType?: LineageEntityType;
  entityId?: string;
  reason: string;
}
```

| 질문 | AI 반환 filter | 설명 |
|------|---------------|------|
| "이 요구사항 변경 영향은?" | `{ entityType: "Requirement", entityId: "REQ-034", direction: "downstream" }` | Impact analysis |
| "REQ-034 Trace Chain 보여줘" | `{ entityType: "Requirement", entityId: "REQ-034", direction: "both" }` | Full trace |
| "끊어진 추적 경로 있어?" | `{ breakpoints: true }` | v2.1: FilterSpec key |
| "고아 노드(연결 없는) 있어?" | `{ orphans: true }` | v2.1: FilterSpec key |
| "BLOCKS 관계만 보여줘" | `{ edgeType: ["BLOCKS"] }` | Edge type filter |
| "최근 1주일 변경 내역은?" | `{ view: "timeline", dateRange: { from: "2026-02-01", to: "2026-02-08" } }` | Timeline view |
| "Task에서 Requirement까지 역추적" | `{ entityType: "Task", entityId: "TSK-155", direction: "upstream" }` | Upstream trace |
| "전체 Trace 커버리지 현황은?" | `{}` (default: full graph with metrics) | Metrics overview |
| "이 Decision이 어디서 왔어?" | `{ entityType: "Decision", entityId: "DEC-004", direction: "upstream" }` | Origin trace |
| "영향 분석 실행해줘" | `{ entityType: "Requirement", entityId: "REQ-034", direction: "downstream", depth: 5 }` | Deep impact |
| "변경 이력 보여줘" | `{ view: "timeline" }` | Timeline mode |

**FilterSpec -> URL 변환 유틸**:

```typescript
/** v2.1: FilterSpec -> URL converter (repeat-key for arrays, boolean only if true) */
function lineageFilterToUrl(
  filter: LineageFilterSpec,
  entityType?: LineageEntityType,
  entityId?: string
): string {
  // Entity-specific route
  if (entityType && entityId) {
    const params = new URLSearchParams();
    if (filter.depth) params.set("depth", String(filter.depth));
    if (filter.direction) params.set("direction", filter.direction);
    if (filter.edgeType?.length) {
      filter.edgeType.forEach(e => params.append("edgeType", e));  // v2.1: repeat key
    }
    if (filter.view) params.set("view", filter.view);
    if (filter.selected) params.set("selected", filter.selected);  // v2.1
    const qs = params.toString();
    return `/lineage/${entityType}/${entityId}${qs ? `?${qs}` : ""}`;
  }

  // General lineage route
  const params = new URLSearchParams();
  for (const [key, value] of Object.entries(filter)) {
    if (value === undefined || value === null) continue;
    if (key === "dateRange" && typeof value === "object") {
      if (value.from) params.set("dateRange.from", value.from);
      if (value.to) params.set("dateRange.to", value.to);
    } else if (Array.isArray(value)) {
      value.forEach(v => params.append(key, String(v)));           // v2.1: repeat key
    } else if (typeof value === "boolean") {
      if (value) params.set(key, "true");                          // v2.1: only serialize true
    } else {
      params.set(key, String(value));
    }
  }
  return `/lineage?${params.toString()}`;
}
```

### 8.2 Graph-based AI Insight

Lineage 화면에서의 AI Insight는 **그래프 구조 분석 결과**를 기반으로 추천한다.

```typescript
interface AiLineageInsight {
  asOf: string;
  summary: string;
  severity: "info" | "warning" | "critical";

  // --- Drivers (evidence) ---
  drivers: {
    type: "orphan" | "breakpoint" | "blocking_chain" | "high_change_rate";
    label: string;
    value?: string;
    link?: {
      targetNodeId: string;
      label: string;
      filter?: LineageFilterSpec;
    };
  }[];

  // --- Next actions ---
  nextActions: {
    label: string;
    targetNodeId: string;
    filter?: LineageFilterSpec;
    entityType?: LineageEntityType;
    entityId?: string;
    suggestedPreset?: ViewModePreset;
    requiredCaps?: Capability[];
    reason: string;
  }[];
}
```

**AI Insight 예시**:

```
+------------------------------------------+
|  AI Insight                       ! warn  |
|                                          |
|  3 orphan entities and 5 breakpoints     |
|  detected in the trace graph.            |
|                                          |
|  Drivers:                                |
|  - 3 orphan nodes (no connections)       |
|  - 5 breakpoints (Story -> TC gap: 3)   |
|  - 2 blocking chains (ISS-042 -> 3 TSK) |
|                                          |
|  Recommended actions:                    |
|  1st: [ Review orphan entities ]         |
|  2nd: [ Fix breakpoint chains ]          |
|  3rd: [ Resolve blocking issues ]        |
+------------------------------------------+
```

### 8.3 Cross-screen AI Navigation

Lineage 화면에서 다른 화면으로의 AI 추천은 **targetNodeId** 기반이다.

```
--- Quick Actions (Right Panel) ---

Selected: REQ-034 (Requirement)

[ View in Requirements ]      <- targetNodeId: "requirements", entityId: "REQ-034"
[ View in Backlog (E-12) ]    <- targetNodeId: "backlog", entityId: "E-12"
[ View Test Results (TC-21) ] <- targetNodeId: "tests", entityId: "TC-21"
[ View Deliverable ]          <- targetNodeId: "deliverables", entityId: "DLV-007"
[ View Issue (ISS-042) ]      <- targetNodeId: "issues", entityId: "ISS-042"
```

---

## 9. 인터랙션 상세 (그래프 탐색)

### 9.1 Graph Node Interactions

| 인터랙션 | 동작 | 설명 |
|---------|------|------|
| **Hover** | Node Tooltip 표시 | Entity type, title, status, last modified |
| **Single Click** | Node 선택 + Right Panel 업데이트 | panelMode -> entity_detail |
| **Double Click** | Node 확장 (추가 depth 로딩) | 해당 노드 기준 depth+1 그래프 확장 |
| **Right Click** | Context Menu 표시 | "View Details", "Impact Analysis", "View in [screen]" |
| **Shift + Click** | 다중 노드 선택 | 복수 노드 선택 (경로 하이라이트용) |

### 9.2 Graph Canvas Interactions

| 인터랙션 | 동작 | 설명 |
|---------|------|------|
| **Scroll** | Zoom In/Out | 마우스 휠 줌 |
| **Drag (canvas)** | Pan | 캔버스 이동 |
| **Drag (node)** | Node 위치 조정 | Force layout에서 수동 위치 변경 |
| **Pinch** | Zoom (touch) | 터치 디바이스 줌 |
| **Double Click (canvas)** | Fit to View | 전체 그래프가 보이도록 자동 줌 |

### 9.3 Graph Controls

```
+--- Graph Controls ---+
| [ + ] Zoom In        |
| [ - ] Zoom Out       |
| [ O ] Fit to View    |
| [ R ] Reset Layout   |
| [ F ] Fullscreen     |
| [ M ] Toggle Minimap |
+----------------------+
```

### 9.4 Node Expansion (Double Click)

```
Before expansion:
  [REQ-034] ---> [Epic-12]

After double-click on [Epic-12]:
  [REQ-034] ---> [Epic-12] ---> [F-20] ---> [S-88]
                           ---> [F-21] ---> [S-91]
```

> **Depth 제한**: 확장 후 총 depth가 10을 초과하면 확장 거부 + "최대 탐색 깊이에 도달했습니다" 토스트

### 9.5 Impact Analysis Trigger

```
1. Node 선택 (Single Click)
2. Right Panel -> "Impact Analysis" 버튼 클릭
   OR Context Menu -> "Run Impact Analysis"
3. API 호출: GET /api/lineage/impact?entityType=...&entityId=...&depth=5
4. Right Panel panelMode -> "impact"
5. Graph에서 영향받는 노드 하이라이트 (red border)
6. Impact list 표시 (High/Medium/Low 그룹)
```

### 9.6 Trace Link Creation (PM_WORK only)

```
1. Node 선택 (Single Click)
2. Right Panel -> "Add Trace Link" 버튼 클릭
   OR Context Menu -> "Create Link"
3. panelMode -> "link_editor"
4. TraceLinkForm 표시:
   - Source: (선택된 노드, 자동 채움)
   - Target: (검색으로 엔티티 선택)
   - Edge Type: (드롭다운 선택)
   - Description: (선택 입력)
5. "Create" 클릭 -> POST /api/lineage/links
6. 그래프 자동 갱신 + 새 엣지 하이라이트
7. Metrics 자동 갱신 (orphan_count 감소 가능)
```

### 9.7 Timeline Interactions

| 인터랙션 | 동작 | 설명 |
|---------|------|------|
| **Item Click** | Change detail 표시 (Right Panel) | panelMode -> change_log |
| **Entity Link Click** | Graph View로 전환 + 해당 entity 포커스 | view=graph, entityId 설정 |
| **Date Range Drag** | 날짜 범위 필터 변경 | dateRange 업데이트 |
| **Load More** | 추가 이력 로딩 | Infinite scroll / "Load More" 버튼 |

### 9.8 Graph Fullscreen Mode

```
+----------------------------------------------------------------------+
|  Lineage (Fullscreen)                              [ Close Fullscreen ]|
|  [ Entity: All v ]  [ Direction: Both v ]  [ Depth: 3 v ]             |
+----------------------------------------------------------------------+
|                                                                        |
|                                                                        |
|                     [Req-034]                                          |
|                    /         \                                         |
|             [E-12]            [E-15]                                   |
|            /     \                \                                    |
|        [F-20]  [F-21]          [F-30]                                 |
|          |       |                |                                    |
|       [S-88]  [S-91]          [S-105]                                 |
|          |       |                |                                    |
|      [TSK-155] [TSK-170]    [TSK-180]                                 |
|          |       |                |                                    |
|       [TC-21] (none)!        [TC-45]                                  |
|          |                      |                                      |
|      [DLV-007]             [DLV-012]                                  |
|                                                                        |
|  +--- Controls ---+  +--- Minimap ---+                                |
|  | [+] [-] [O] [R]|  | +---------+  |                                |
|  +-----------------+  | |   .     |  |                                |
|                       | |    .    |  |                                |
|  +--- Legend ------+  | +---------+  |                                |
|  | --- TRACES_TO   |  +--------------+                                |
|  | -.- DERIVED     |                                                  |
|  | xxx BLOCKS      |  +--- Tooltip ---+                               |
|  | === DEPENDS_ON  |  | Epic-12       |                               |
|  | ... TESTS       |  | Backlog Mgmt  |                               |
|  | >>> PRODUCES    |  | IN_PROGRESS   |                               |
|  | ~~~ ESCALATED   |  +---------------+                               |
|  +-----------------+                                                  |
|                                                                        |
+------------------------------------------------------------------------+
```

### 9.9 데이터 새로고침

| 항목 | 주기 |
|------|------|
| Graph data | Page entry + filter change |
| Metrics | Page entry (cache 5min) |
| Impact analysis | On demand (user trigger) |
| Change history | Page entry + date range change |
| Manual refresh | Refresh button in Page Header |

> **Neo4j 동기화 지연**: PostgreSQL -> Neo4j Outbox 패턴으로 최대 5분 지연 가능.
> `completeness < 1.0`일 때 "데이터 동기화 중" 배너 표시 + 30초 후 자동 재시도.

---

## 10. 반응형 대응

### 10.1 브레이크포인트별 레이아웃

| 너비 | KPI Row | Main Content | Right Panel | Graph Controls |
|------|---------|-------------|-------------|----------------|
| >=1440px | 5열 가로 배치 | 70% | 30% (visible) | Floating overlay |
| 1280px | 5열 가로 배치 | 100% | Drawer (toggle) | Bottom bar |
| <=1024px | 3열 + 2열 그리드 | 100% | Drawer (overlay) | Bottom bar (compact) |
| <=768px | 1열 세로 스택 | 100% | Full Modal | Bottom bar (icons only) |

### 10.2 Graph 반응형 규칙

| 너비 | Graph 조정 | 설명 |
|------|-----------|------|
| >=1440px | Full force-directed layout | 모든 노드 라벨 표시 |
| 1280px | 노드 라벨 축약 (첫 10자) | Tooltip으로 전체 이름 |
| <=1024px | 노드 아이콘만 표시 | 라벨 숨김, 터치 최적화 |
| <=768px | 리스트 뷰로 대체 | 그래프 대신 Tree list 표시 |

### 10.3 Timeline 반응형 규칙

- **>=1440px**: 좌측 타임라인 + 우측 상세 패널 (2열)
- **1280px**: 타임라인 100% + Drawer 상세
- **<=1024px**: 타임라인 100% + Overlay Drawer
- **<=768px**: 카드 리스트 형태 + Full Modal 상세

### 10.4 그래프 -> 리스트 Fallback (모바일)

```
+--- Mobile List View (<=768px) ---+
|                                   |
|  REQ-034  Requirement             |
|  +-- E-12  Epic                   |
|  |   +-- F-20  Feature            |
|  |   |   +-- S-88  Story          |
|  |   |       +-- TSK-155  Task    |
|  |   |       +-- TC-21  TestCase  |
|  |   |       +-- DLV-007  Deliv.  |
|  |   +-- F-21  Feature            |
|  |       +-- S-91  Story          |
|  |           +-- TSK-170  Task    |
|  |           +-- (TC missing) !   |
|  +-- E-15  Epic                   |
|      +-- F-30  Feature            |
|          +-- S-105  Story         |
|              +-- TSK-180  Task    |
|              +-- TC-45  TestCase  |
|              +-- DLV-012  Deliv.  |
|                                   |
+-----------------------------------+
```

---

## 11. 깨지기 쉬운 곳 체크리스트

### 11.1 Neo4j 동기화 지연

| 증상 | 원인 | 대응 |
|------|------|------|
| 그래프에 최근 생성한 엔티티가 안 보임 | Outbox 폴링 지연 (< 5분) | completeness < 1.0 시 "동기화 중" 배너 + 30초 재시도 |
| 삭제한 엔티티가 그래프에 남아있음 | 삭제 이벤트 미처리 | asOf 시간 표시 + 수동 새로고침 버튼 |
| Edge 정보 불일치 | 관계 테이블 vs Neo4j 비동기 | Outbox 이벤트 순서 보장 (FIFO) |

### 11.2 대규모 그래프 성능

| 증상 | 원인 | 대응 |
|------|------|------|
| 그래프 렌더링 느림 (> 500 노드) | 브라우저 DOM 한계 | 서버 pagination (maxNodes: 500) + "그래프가 너무 큽니다. 필터를 추가하세요" 안내 |
| depth >= 5 시 API 응답 지연 | Neo4j 탐색 비용 급증 | depth >= 5 시 확인 다이얼로그 + 서버 타임아웃 30초 |
| 전체 프로젝트 그래프 요청 | 필터 없이 전체 조회 | entityType 또는 entityId 필수 안내 + 서버 기본 depth: 3 강제 |

### 11.3 Orphan / Breakpoint 오탐

| 증상 | 원인 | 대응 |
|------|------|------|
| 정상 엔티티가 orphan으로 표시 | Neo4j 동기화 미완료 | completeness 기반 orphan 경고 억제 (completeness < 0.8이면 orphan count에 "?" 표시) |
| CANCELLED 엔티티가 breakpoint로 잡힘 | 취소된 항목도 체인 검사 | status = CANCELLED 제외 로직 필수 |
| 의도적 미연결이 breakpoint로 표시 | 모든 체인을 필수로 가정 | "Ignore breakpoint" 마킹 기능 (PM_WORK에서 dismiss 가능) |

### 11.4 Trace Link 무결성

| 증상 | 원인 | 대응 |
|------|------|------|
| 동일 엔티티 간 중복 Link | 중복 생성 방지 미흡 | API 레벨 unique constraint (sourceId + targetId + edgeType) |
| 순환 참조 (A -> B -> A) | 사용자 실수 | API 레벨 cycle detection (link 생성 전 경로 검사) |
| 삭제된 엔티티에 대한 dangling edge | 엔티티 삭제 시 edge 미정리 | Outbox 삭제 이벤트에 cascade edge cleanup 포함 |

### 11.5 권한 관련

| 증상 | 원인 | 대응 |
|------|------|------|
| CUSTOMER_APPROVAL에서 전체 그래프 노출 | nodeType 필터 미적용 | Preset에 defaultFilters 강제 + 서버 레벨 scope 제한 |
| DEV가 Trace Link 생성 시도 | manage_trace_link 미검사 | API + UI 이중 검사 (`<Can>` 래퍼 + 서버 Capability 검증) |
| AUDIT_EVIDENCE에서 쓰기 시도 | Audit Preset은 Read-only | Audit Preset 진입 시 모든 mutation API 호출 차단 |

### 11.6 Trace Link Triple Consistency (v2.1)

| 증상 | 원인 | 대응 |
|------|------|------|
| Link가 PostgreSQL에만 생성, Neo4j에 없음 | Outbox 이벤트 발행 실패 | DB 트랜잭션 내 Outbox row INSERT → 실패 시 전체 롤백 |
| Neo4j에만 Link 존재, PostgreSQL에 없음 | Outbox 소비 후 PG 쓰기 실패 | Outbox consumer는 idempotent replay 보장 (sourceId+targetId+edgeType 유니크) |
| Outbox 이벤트 중복 소비 | Consumer 재시작 시 re-delivery | Neo4j MERGE 사용 (CREATE 대신) → 중복 안전 |

> **Triple Write Rule**: Trace Link mutation은 반드시 **PG row + Outbox event** 를 단일 DB 트랜잭션으로 묶고, Outbox consumer가 Neo4j MERGE를 수행한다. 직접 Neo4j 쓰기 금지.

### 11.7 URL State Restoration (v2.1)

| 증상 | 원인 | 대응 |
|------|------|------|
| 북마크/공유 URL로 진입 시 필터 초기화 | URL → FilterSpec 파싱 누락 | `useUrlStateRestore` 훅: mount 시 URL params → FilterSpec 변환 |
| orphans=true 로 진입했으나 일반 그래프 표시 | boolean URL param 파싱 오류 | `"true"` 문자열만 `true`로 변환, 나머지 `false` |
| edgeType 배열이 단일 값으로 파싱됨 | repeat-key → array 변환 누락 | `params.getAll(key)` 사용 (NOT `params.get(key)`) |

### 11.8 Completeness Banner Dual-Axis (v2.1)

| 증상 | 원인 | 대응 |
|------|------|------|
| sync=0.7 인데 "정상" 표시 | query completeness만 체크 | `Math.min(sync, query)` < 1.0 이면 배너 표시 |
| query=0.5 (timeout) 인데 원인 불명 | truncatedReason 미표시 | `pagination.truncatedReason` 을 배너에 포함 ("timeout" / "max_nodes") |
| 배너가 계속 "동기화 중" 표시 | sync가 영원히 < 1.0 | sync < 1.0 이 5분 이상 지속 시 "동기화 지연 — 관리자 문의" 메시지 변경 |

### 11.9 nodeRole Routing Bias (v2.1)

| 증상 | 원인 | 대응 |
|------|------|------|
| "이슈 목록 보여줘"가 Lineage로 라우팅 | nodeRole bonus가 무조건 +10 | v2.1: graph/impact/chain 키워드 있을 때만 조건부 +3~+7 보너스 |
| "변경 이력" 질문이 다른 화면 대신 Lineage로 | "변경" 키워드에 높은 가중치 | timeline 관련 키워드 ("이력", "변경") 는 +3 (최소), "영향 분석" 은 +7 (최대) |

### 11.10 Cypher edgeType Query Builder (v2.1)

| 증상 | 원인 | 대응 |
|------|------|------|
| edgeType 필터에 악의적 문자열 주입 | Cypher는 relationship type 파라미터화 불가 | 서버 allowlist 기반 문자열 조립 (사용자 입력 직접 삽입 금지) |
| 허용되지 않은 edgeType 요청 | UI에서 임의 값 전송 | 서버: `ALLOWED_EDGE_TYPES` Set 에 없으면 400 Bad Request |
| edgeType 빈 배열 전송 | 전체 관계 조회 의도 | edgeType 생략 시 7종 전체 포함 (빈 배열은 "필터 없음"으로 해석) |

---

## 12. Capability 매핑

### 12.1 Capability -> 행위 매핑

| Capability | 행위 | 설명 |
|-----------|------|------|
| `view_lineage` | 그래프 조회, 영향 분석, 변경 이력 조회 | 모든 역할에 부여 (Lineage 접근 가능 역할 한정) |
| `manage_trace_link` | Trace Link 생성/삭제 | PM에게만 부여 |
| `export_reports` | Lineage 그래프/이력 Export (PDF/CSV/JSON/GraphML) | PMO, PM |
| `export_audit_evidence` | 감사 증빙용 Lineage Export | 외부 감사에게만 부여 |

### 12.1.1 Capability vs Policy 2-Layer (v2.1)

> **핵심 구분**: Capability = "할 수 있다" (기능 허가), Policy = "어디까지" (범위 제한)

| 계층 | 역할 | 결정 시점 | 예시 |
|------|------|----------|------|
| **Capability** | 행위 허가 (boolean) | JWT 발급 시 역할에서 파생 | `manage_trace_link: true/false` |
| **Policy (Preset Clamp)** | 범위 제한 (filter/depth/direction) | API 요청 시 PresetPolicyResolver가 적용 | `maxDepth: 5`, `allowedNodeTypes: [...]` |

```text
요청 흐름:
  Client Request (filters + preset)
       │
       ▼
  [1] Capability Check ── 실패 → 403 Forbidden
       │ 성공
       ▼
  [2] PresetPolicyResolver.clamp(filters, preset)
       │
       ├─ effectiveFilter: 클램프된 필터
       ├─ clampedFields: ["depth", "nodeType"]  ← UI에 "제한 적용됨" 표시용
       └─ deniedActions: ["export"]             ← 비활성 버튼 표시용
       │
       ▼
  [3] Cypher Query (effectiveFilter 사용)
```

**UI 반영 규칙**:
- `clampedFields` 에 포함된 필터 컨트롤은 disabled + tooltip "프리셋 정책으로 제한됨"
- `deniedActions` 에 포함된 버튼은 숨김 (NOT disabled — 존재 자체를 제거)
- Capability가 없는 행위는 `<Can>` 래퍼에서 컴포넌트 자체 미렌더링

### 12.2 Preset -> Capability 매핑

| Preset | view_lineage | manage_trace_link | export_reports | export_audit_evidence |
|--------|-------------|-------------------|----------------|----------------------|
| PM_WORK | O | O | O | - |
| PMO_CONTROL | O | - | O | - |
| DEV_EXECUTION | O | - | - | - |
| EXEC_SUMMARY | O | - | - | - |
| CUSTOMER_APPROVAL | O (limited) | - | - | - |
| AUDIT_EVIDENCE | O | - | - | O |

### 12.3 역할 -> 메뉴 노출

00_총괄 S3 매트릭스 기준:

| 역할 | Lineage 접근 | 비고 |
|------|-------------|------|
| Sponsor | O | 읽기 전용, 요약 |
| PMO | O | 영향 분석 + 준수 보고서 |
| PM | O (R/W) | 전체 그래프 + Trace Link 관리 |
| DevReader (파트장) | O | 읽기 전용 |
| DEV | O | 읽기 전용 |
| Customer PM | O (제한) | Requirement -> Deliverable chain 만 |
| 외부 감사 | O | 전체 읽기 + 증빙 Export |
| 시스템 운영자 | - | Lineage 접근 불필요 |

---

## 13. DoD (본 화면 완료 기준)

### 13.1 Graph View

- [ ] Force-directed graph 렌더링 (10종 노드 타입 + 7종 엣지 타입)
- [ ] 노드 색상/아이콘이 EntityType별로 구분됨
- [ ] 엣지 스타일(실선/점선/파선)이 EdgeType별로 구분됨
- [ ] Hover 시 Node Tooltip 표시 (type, title, status, modified)
- [ ] Single click -> Right Panel entity_detail 표시
- [ ] Double click -> Node expansion (추가 depth 로딩)
- [ ] Right click -> Context Menu (View Details, Impact Analysis, Navigate)
- [ ] Zoom/Pan/Fit/Reset/Fullscreen 컨트롤 동작
- [ ] Graph Legend 표시 (엣지 타입별 범례)
- [ ] 대규모 그래프 (500+ 노드) 시 pagination + 경고 메시지
- [ ] Minimap 토글 (대규모 그래프 탐색 보조)

### 13.2 Impact Analysis

- [ ] 특정 엔티티 기준 downstream traversal 실행
- [ ] High/Medium/Low severity 그룹 분류
- [ ] Impact panel에 영향 목록 + path length 표시
- [ ] 영향받는 노드를 그래프에서 하이라이트 (red border)
- [ ] Breakpoint 감지 + 경고 표시

### 13.3 Change Timeline

- [ ] 변경 이력 타임라인 렌더링 (날짜별 그룹)
- [ ] 항목 클릭 -> Right Panel change_log 표시
- [ ] Field-level diff view (before/after) 표시
- [ ] dateRange 필터 동작
- [ ] Infinite scroll / Load More 페이지네이션

### 13.4 Trace Link Management (PM_WORK)

- [ ] Trace Link 생성 폼 (Source, Target, EdgeType) 동작
- [ ] AI 추천 링크 (suggestions) 표시 + 1-click 생성
- [ ] Link 삭제 + 확인 다이얼로그
- [ ] 생성/삭제 후 그래프 자동 갱신 + metrics 업데이트
- [ ] 중복 Link 방지 (unique constraint)
- [ ] 순환 참조 감지 + 경고

### 13.5 Metrics & KPI

- [ ] KPI Row: total_nodes, total_edges, orphan_count, max_chain_depth, breakpoint_count
- [ ] Orphan count 클릭 -> orphan 필터 적용
- [ ] Breakpoint count 클릭 -> breakpoint 하이라이트
- [ ] Preset별 KPI 표시 차이 적용

### 13.6 Preset 분기

- [ ] PM_WORK: Full graph + Trace Link R/W + Impact + Export
- [ ] PMO_CONTROL: Full graph read-only + Impact + Compliance report
- [ ] DEV_EXECUTION: Full graph read-only + depth 제한 (5)
- [ ] EXEC_SUMMARY: Simplified graph (top-level entities only) + Right Panel 숨김
- [ ] CUSTOMER_APPROVAL: Requirement -> Deliverable chain 제한
- [ ] AUDIT_EVIDENCE: Full read + Export + 증빙 Export 연동

### 13.7 FilterSpec

- [ ] entityType multi-select 동작
- [ ] direction toggle (upstream/downstream/both) 동작
- [ ] depth slider (1-10) 동작 + depth >= 5 확인 다이얼로그
- [ ] edgeType multi-select 동작
- [ ] nodeType multi-select 동작
- [ ] dateRange picker 동작 (Timeline)
- [ ] 자유 검색어 (q) 동작
- [ ] FilterSpec -> URL 직렬화/역직렬화 동작
- [ ] Preset별 defaultFilters 자동 적용
- [ ] v2.1: orphans toggle 동작 (orphan 필터링)
- [ ] v2.1: breakpoints toggle 동작 (breakpoint 필터링)
- [ ] v2.1: selected param URL 직렬화/역직렬화 동작
- [ ] v2.1: URL state restore on mount (`useUrlStateRestore` 동작)
- [ ] v2.1: repeat-key array 직렬화 (`?edgeType=X&edgeType=Y`)

### 13.8 데이터 신뢰성

- [ ] asOf 표시 규칙 (5분 이내: 숨김, 5분~1시간: "N분 전", 1시간+: 전체 표시)
- [ ] completeness < 1.0 시 "동기화 중" 배너 + 30초 재시도
- [ ] completeness < 0.8 시 orphan/breakpoint count에 "?" 표시
- [ ] warnings 배열 표시 (tooltip)
- [ ] v2.1: dual-axis completeness 배너 (sync vs query 분리 표시)
- [ ] v2.1: sync < 1.0 이 5분 이상 지속 시 "동기화 지연 — 관리자 문의" 메시지 변경
- [ ] v2.1: pagination.truncatedReason 배너 표시 ("timeout" / "max_nodes")

### 13.9 AI Navigation

- [ ] AI 질문 -> FilterSpec 기반 딥링크 생성 동작
- [ ] AI Insight Widget: orphan/breakpoint/blocking chain 기반 진단
- [ ] Quick Action List: targetNodeId 기반 cross-screen 이동
- [ ] Impact analysis 결과에서 다른 화면 딥링크 동작
- [ ] v2.1: nodeRole 조건부 보너스 (+3~+7, graph/impact/chain 키워드만)

### 13.10 반응형 + 접근성

- [ ] 반응형 레이아웃 (>=1440 / 1280 / <=1024 / <=768)
- [ ] <=768px: 그래프 -> 리스트 뷰 fallback
- [ ] WCAG AA 색상 대비 (4.5:1 이상)
- [ ] 키보드 탐색: Tab으로 노드 순회, Enter로 선택, Escape로 deselect
- [ ] Screen reader: aria-label for graph nodes ("Requirement REQ-034, SSO Integration, Accepted")
- [ ] 색상 + 텍스트 라벨 병행 (색맹 대응)

### 13.11 Export

- [ ] PDF/CSV/JSON/GraphML 형식 선택 동작
- [ ] Export scope 설정 (전체 / 특정 엔티티 기준)
- [ ] Export progress 표시 (queued -> processing -> completed)
- [ ] Download link 생성 + 자동 다운로드
- [ ] AUDIT_EVIDENCE Preset에서 증빙 Export -> `/audit/evidence` 연동
- [ ] v2.1: statusUrl 기반 polling 동작 + retryAfterMs 준수

### 13.12 Server Safety (v2.1)

- [ ] v2.1: PresetPolicyResolver 서버 클램프 동작 (maxDepth, allowedNodeTypes, direction)
- [ ] v2.1: clampedFields UI 반영 (disabled 컨트롤 + tooltip)
- [ ] v2.1: deniedActions UI 반영 (버튼 숨김)
- [ ] v2.1: Cypher 전 쿼리 projectId 스코프 적용
- [ ] v2.1: edgeType allowlist query builder (사용자 입력 주입 차단)
- [ ] v2.1: Trace Link mutation Idempotency-Key + If-Match 헤더
- [ ] v2.1: Trace Link triple write (PG + Outbox 단일 트랜잭션, Neo4j MERGE)
- [ ] v2.1: ChangeHistoryItem correlationId + source 필드 표시

---

## 부록 A. 변경이력

| 버전 | 날짜 | 변경 내용 |
|------|------|---------|
| v1.0 | 2026-02-08 | 초안 작성 |
| v2.0 | 2026-02-08 | 10개 영역 피드백 반영: (1) entities PascalCase + intents 14개 확장, (2) FilterSpec 온톨로지 내장 (9키), (3) LineageEntityType/LineageEdgeType TypeScript 정의, (4) Graph/Timeline 이중 뷰 구조, (5) Impact Analysis API + severity 분류, (6) Capability 세분화 (view_lineage + manage_trace_link), (7) Neo4j Cypher 쿼리 패턴 5종, (8) 깨지기 쉬운 곳 5영역, (9) panelMode 6종 정의, (10) AUDIT_EVIDENCE Preset 완전 지원 |
| v2.1 | 2026-02-08 | 크로스-리뷰 10개 이슈 반영: (1) FilterSpec orphans/breakpoints/selected 3키 추가 (9→12키), (2) deepLinks/virtualNodes FilterSpec matchFilters 기반 통일, (3) Cypher 전 쿼리 projectId 스코프 + edgeType allowlist query builder + orphan OR 괄호 수정, (4) completeness sync/query 이중축 분리 (전 API 응답), (5) PresetPolicyResolver 서버 클램프 + Capability vs Policy 2-layer 분리, (6) nodeRole 조건부 보너스 +3~+7 (flat +10 제거), (7) Graph API visibleMetrics 경량화 (heavy metrics → /metrics), (8) Trace Link triple consistency (PG+Outbox 단일 TX, Neo4j MERGE), (9) ChangeHistoryItem correlationId + source 추가, (10) LineageNode id=sourceId 명확화 + edge weight RESERVED + ExportResponse statusUrl/retryAfterMs + Idempotency-Key/If-Match 헤더 |

---

## 부록 B. Neo4j 스키마 참조

### B.1 Node Constraints

```cypher
// Unique constraints for each entity type
CREATE CONSTRAINT req_unique IF NOT EXISTS
  FOR (r:Requirement) REQUIRE r.sourceId IS UNIQUE;

CREATE CONSTRAINT epic_unique IF NOT EXISTS
  FOR (e:Epic) REQUIRE e.sourceId IS UNIQUE;

CREATE CONSTRAINT feature_unique IF NOT EXISTS
  FOR (f:Feature) REQUIRE f.sourceId IS UNIQUE;

CREATE CONSTRAINT story_unique IF NOT EXISTS
  FOR (s:Story) REQUIRE s.sourceId IS UNIQUE;

CREATE CONSTRAINT task_unique IF NOT EXISTS
  FOR (t:Task) REQUIRE t.sourceId IS UNIQUE;

CREATE CONSTRAINT tc_unique IF NOT EXISTS
  FOR (tc:TestCase) REQUIRE tc.sourceId IS UNIQUE;

CREATE CONSTRAINT dlv_unique IF NOT EXISTS
  FOR (d:Deliverable) REQUIRE d.sourceId IS UNIQUE;

CREATE CONSTRAINT issue_unique IF NOT EXISTS
  FOR (i:Issue) REQUIRE i.sourceId IS UNIQUE;

CREATE CONSTRAINT dec_unique IF NOT EXISTS
  FOR (d:Decision) REQUIRE d.sourceId IS UNIQUE;

CREATE CONSTRAINT risk_unique IF NOT EXISTS
  FOR (r:Risk) REQUIRE r.sourceId IS UNIQUE;
```

### B.2 Indexes

```cypher
// Project-scoped indexes for lineage queries
CREATE INDEX idx_req_project IF NOT EXISTS
  FOR (r:Requirement) ON (r.projectId);

CREATE INDEX idx_epic_project IF NOT EXISTS
  FOR (e:Epic) ON (e.projectId);

CREATE INDEX idx_story_project IF NOT EXISTS
  FOR (s:Story) ON (s.projectId);

CREATE INDEX idx_task_project IF NOT EXISTS
  FOR (t:Task) ON (t.projectId);

// Full-text index for search
CREATE FULLTEXT INDEX lineage_search IF NOT EXISTS
  FOR (n:Requirement|Epic|Feature|Story|Task|TestCase|Deliverable|Issue|Decision|Risk)
  ON EACH [n.title, n.label];
```

### B.3 Outbox Event Schema (PostgreSQL -> Neo4j)

```typescript
/** Outbox event for Neo4j sync */
interface LineageOutboxEvent {
  id: string;
  eventType: "NODE_CREATED" | "NODE_UPDATED" | "NODE_DELETED"
    | "EDGE_CREATED" | "EDGE_DELETED";
  entityType: LineageEntityType;
  entityId: string;
  payload: Record<string, any>;
  projectId: string;
  createdAt: string;
  processedAt?: string;
  status: "PENDING" | "PROCESSED" | "FAILED";
  retryCount: number;
}
```

```sql
-- lineage_outbox table
CREATE TABLE lineage.outbox_events (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  event_type    VARCHAR(20) NOT NULL,
  entity_type   VARCHAR(20) NOT NULL,
  entity_id     VARCHAR(36) NOT NULL,
  payload       JSONB NOT NULL,
  project_id    VARCHAR(36) NOT NULL,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  processed_at  TIMESTAMPTZ,
  status        VARCHAR(10) NOT NULL DEFAULT 'PENDING',
  retry_count   INT NOT NULL DEFAULT 0
);

CREATE INDEX idx_outbox_pending ON lineage.outbox_events (status, created_at)
  WHERE status = 'PENDING';
```

---

## 부록 C. Graph Rendering Library 선택

| 라이브러리 | 장점 | 단점 | 적합도 |
|-----------|------|------|--------|
| **D3.js + d3-force** | 최대 유연성, 검증된 안정성 | 높은 구현 비용 | O (선택) |
| react-force-graph | React 래퍼, 빠른 구현 | 커스텀 제한 | 대안 |
| vis-network | 풍부한 기능 | 번들 크기 큼 | 대안 |
| Cytoscape.js | 그래프 분석 기능 풍부 | 러닝 커브 | 대안 |

**권장**: D3.js + d3-force 기반 커스텀 구현.
React 래퍼로 `@visx/network` 또는 직접 D3 바인딩.
500+ 노드 시 WebGL 기반 렌더링 고려 (pixi-viewport + pixie-graph).

### C.1 Graph Configuration

```typescript
/** Graph rendering configuration */
interface GraphConfig {
  /** Force simulation parameters */
  simulation: {
    chargeStrength: number;       // -300 (repulsion)
    linkDistance: number;          // 100px
    collideRadius: number;        // 30px
    centerStrength: number;       // 0.1
    alphaDecay: number;           // 0.01
    velocityDecay: number;        // 0.3
  };

  /** Node rendering */
  node: {
    radius: number;               // 20px
    labelFontSize: number;        // 12px
    labelMaxLength: number;       // 20 chars
    selectedBorderWidth: number;  // 3px
    hoverScale: number;           // 1.2x
  };

  /** Edge rendering */
  edge: {
    strokeWidth: number;          // 2px
    arrowSize: number;            // 8px
    labelFontSize: number;        // 10px
    highlightWidth: number;       // 4px
  };

  /** Performance limits */
  limits: {
    maxNodes: number;             // 500
    maxDepth: number;             // 10
    warnDepth: number;            // 5
    animationDuration: number;    // 500ms
  };
}
```
