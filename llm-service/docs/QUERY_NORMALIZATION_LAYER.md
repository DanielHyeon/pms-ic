# ì¿¼ë¦¬ ì •ê·œí™” ë ˆì´ì–´ (Query Normalization Layer)

> **ì •ì²´ì„±**: ì´ ì‹œìŠ¤í…œì€ "í•œê¸€ ì˜¤íƒ€ë¥¼ ê³ ì¹˜ëŠ” ê¸°ëŠ¥"ì´ ì•„ë‹ˆë¼,
> **ì‚¬ìš©ì ì˜ë„ê°€ ì˜¬ë°”ë¥¸ í•¸ë“¤ëŸ¬ì— ë„ë‹¬í•˜ë„ë¡ ë³´ì¥í•˜ëŠ” "ë¼ìš°íŒ… ì•ˆì •ì„± ë ˆì´ì–´"**ì´ë‹¤.
>
> **í˜„ì¬ ìƒíƒœ**: 3-Layer í•µì‹¬ + ìš´ì˜ ê°•í™” Phase 1~3 êµ¬í˜„ ì™„ë£Œ (í…ŒìŠ¤íŠ¸ 218ê°œ í†µê³¼)

---

## ëª©ì°¨

1. [ì´ ì‹œìŠ¤í…œì´ í•´ê²°í•˜ëŠ” ë¬¸ì œ](#1-ì´-ì‹œìŠ¤í…œì´-í•´ê²°í•˜ëŠ”-ë¬¸ì œ)
2. [ì™œ 3-Layer ì•„í‚¤í…ì²˜ì¸ê°€](#2-ì™œ-3-layer-ì•„í‚¤í…ì²˜ì¸ê°€)
3. [ê° ë ˆì´ì–´ì˜ ìƒì„¸ êµ¬í˜„](#3-ê°-ë ˆì´ì–´ì˜-ìƒì„¸-êµ¬í˜„)
4. [ì „ì²´ ë°ì´í„° íë¦„](#4-ì „ì²´-ë°ì´í„°-íë¦„)
5. [ê±°ì§“ ì–‘ì„± ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜](#5-ê±°ì§“-ì–‘ì„±-ë°©ì–´-ë©”ì»¤ë‹ˆì¦˜)
6. [Phase 1: Redis ìºì‹œ + ì´ë²¤íŠ¸ ë¡œê¹… + ì„œí‚·ë¸Œë ˆì´ì»¤](#6-phase-1-redis-ìºì‹œ--ì´ë²¤íŠ¸-ë¡œê¹…--ì„œí‚·ë¸Œë ˆì´ì»¤)
7. [Phase 2: ì˜¤íƒ€ ì‚¬ì „ ìë™ í™•ì¥ (Shadow Pipeline)](#7-phase-2-ì˜¤íƒ€-ì‚¬ì „-ìë™-í™•ì¥-shadow-pipeline)
8. [Phase 3: ì„ê³„ê°’ ìë™ íŠœë‹ (Per-Group Threshold)](#8-phase-3-ì„ê³„ê°’-ìë™-íŠœë‹-per-group-threshold)
9. [NormalizationConfig ì„¤ì • ì „ì²´](#9-normalizationconfig-ì„¤ì •-ì „ì²´)
10. [íŒŒì¼ ë³€ê²½ ìš”ì•½](#10-íŒŒì¼-ë³€ê²½-ìš”ì•½)
11. [í…ŒìŠ¤íŠ¸ í˜„í™©](#11-í…ŒìŠ¤íŠ¸-í˜„í™©)
12. [Admin API ì—”ë“œí¬ì¸íŠ¸](#12-admin-api-ì—”ë“œí¬ì¸íŠ¸)
13. [KPI ì§€í‘œ](#13-kpi-ì§€í‘œ)
14. [ê°•í™”ëœ ì„¤ê³„ ì›ì¹™ 10ê°€ì§€](#14-ê°•í™”ëœ-ì„¤ê³„-ì›ì¹™-10ê°€ì§€)

---

## 1. ì´ ì‹œìŠ¤í…œì´ í•´ê²°í•˜ëŠ” ë¬¸ì œ

### 1.1 ì¦ìƒ

ì‚¬ìš©ìê°€ "í˜„ì¬ í…ŒíŠ¸íŠ¸ ì¤‘ì¸ taskëŠ”?"ì´ë¼ê³  ì…ë ¥í•˜ë©´, ì˜ë„ëŠ” ëª…í™•íˆ **"í…ŒìŠ¤íŠ¸ ì¤‘ì¸ íƒœìŠ¤í¬ ì¡°íšŒ"**ì´ë‹¤.
í•˜ì§€ë§Œ ê¸°ì¡´ ë¶„ë¥˜ê¸°ëŠ” ì´ë ‡ê²Œ ë™ì‘í–ˆë‹¤:

```
"í˜„ì¬ í…ŒíŠ¸íŠ¸ ì¤‘ì¸ taskëŠ”?"
  â†’ INTENT_PATTERNSì—ì„œ "í…ŒìŠ¤íŠ¸ ì¤‘" í‚¤ì›Œë“œ ê²€ìƒ‰
  â†’ "í…ŒíŠ¸íŠ¸ ì¤‘" â‰  "í…ŒìŠ¤íŠ¸ ì¤‘" (ì •í™• ë¶€ë¶„ ë¬¸ìì—´ ë§¤ì¹­ ì‹¤íŒ¨)
  â†’ Priority 1, 2, 3 ëª¨ë‘ ë¶ˆì¼ì¹˜
  â†’ Legacy íŒ¨í„´ ë§¤ì¹­ë„ ì‹¤íŒ¨
  â†’ ìµœì¢…: UNKNOWN â†’ RAG(ë¬¸ì„œ ê²€ìƒ‰)ë¡œ ë¼ìš°íŒ…
```

**ê²°ê³¼**: DBì—ì„œ ì‹¤ì‹œê°„ íƒœìŠ¤í¬ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ì „ìš© í•¸ë“¤ëŸ¬(`handle_tasks_by_status`)ê°€ ìˆìŒì—ë„, ì‚¬ìš©ìëŠ” RAG ê¸°ë°˜ì˜ ë¶€ì •í™•í•œ ë¬¸ì„œ ê²€ìƒ‰ ë‹µë³€ì„ ë°›ê²Œ ëœë‹¤.

### 1.2 ê·¼ë³¸ ì›ì¸

`answer_type_classifier.py`ì˜ í‚¤ì›Œë“œ ë§¤ì¹­ì´ **ì •í™• ë¶€ë¶„ ë¬¸ìì—´ ë¹„êµ**(`kw in query_lower`)ë§Œ ì‚¬ìš©í–ˆê¸° ë•Œë¬¸ì´ë‹¤.

```python
# ê¸°ì¡´ ì½”ë“œ (answer_type_classifier.py:432)
matched = [kw for kw in keywords if kw in query_lower]
```

í•œê¸€ì€ ìëª¨ ì¡°í•© êµ¬ì¡° íŠ¹ì„±ìƒ í•œ ê¸€ìë§Œ í‹€ë ¤ë„ ì™„ì „íˆ ë‹¤ë¥¸ ìœ ë‹ˆì½”ë“œ ì½”ë“œí¬ì¸íŠ¸ê°€ ë˜ë¯€ë¡œ, `in` ì—°ì‚°ìë¡œëŠ” ì ˆëŒ€ ë§¤ì¹­í•  ìˆ˜ ì—†ë‹¤.

### 1.3 ì´ê²ƒì´ ë‹¨ìˆœ ì˜¤íƒ€ ë¬¸ì œê°€ ì•„ë‹Œ ì´ìœ 

ì´ ë¬¸ì œì˜ ë³¸ì§ˆì€ **"ì˜¤íƒ€"ê°€ ì•„ë‹ˆë¼ "ë¼ìš°íŒ… ì‹¤íŒ¨"**ì´ë‹¤.

| ê´€ì  | "ì˜¤íƒ€ ìˆ˜ì •" í”„ë ˆì´ë° | "ë¼ìš°íŒ… ì•ˆì •ì„±" í”„ë ˆì´ë° |
|------|---------------------|----------------------|
| ëª©í‘œ | ì‚¬ìš©ì í…ìŠ¤íŠ¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ê³ ì¹˜ê¸° | ì˜ë„ë¥¼ ì˜¬ë°”ë¥¸ í•¸ë“¤ëŸ¬ì— ì „ë‹¬í•˜ê¸° |
| ì‹¤íŒ¨ ì‹œ ê²°ê³¼ | ì˜¤íƒ€ê°€ ë‚¨ì•„ìˆìŒ (ë¬´í•´) | **ì˜ëª»ëœ í•¸ë“¤ëŸ¬ í˜¸ì¶œ** (ìœ í•´) |
| ì¸¡ì • ì§€í‘œ | êµì • ì •í™•ë„ | **ë¼ìš°íŒ… ì •í™•ë„** |
| ì˜í–¥ ë²”ìœ„ | í…ìŠ¤íŠ¸ í’ˆì§ˆ | **ì‘ë‹µ í’ˆì§ˆ, ì‚¬ìš©ì ê²½í—˜ ì „ì²´** |

ì˜ëª»ëœ ë¼ìš°íŒ…ì€ ë‹¨ìˆœíˆ "ì˜¤íƒ€ê°€ ë³´ì´ëŠ”" ê²ƒê³¼ ì°¨ì›ì´ ë‹¤ë¥´ë‹¤:
- `TASKS_BY_STATUS` â†’ DB ì‹¤ì‹œê°„ ì¡°íšŒ â†’ ì •í™•í•œ íƒœìŠ¤í¬ ëª©ë¡
- `UNKNOWN` â†’ RAG ë¬¸ì„œ ê²€ìƒ‰ â†’ ê´€ë ¨ ì—†ëŠ” ë¬¸ì„œ ì¡°ê° ë°˜í™˜

**ì‚¬ìš©ìì˜ ì˜ë„ëŠ” ì •í™•í–ˆì§€ë§Œ, ì‹œìŠ¤í…œì´ ê·¸ê²ƒì„ ì˜¬ë°”ë¥¸ ì‹¤í–‰ ê²½ë¡œë¡œ ì—°ê²°í•˜ì§€ ëª»í•œ ê²ƒì´ë‹¤.**

---

## 2. ì™œ 3-Layer ì•„í‚¤í…ì²˜ì¸ê°€

### 2.1 ë‹¨ì¼ ë ˆì´ì–´ë¡œ ì¶©ë¶„í•˜ì§€ ì•Šì€ ì´ìœ 

ê° ì ‘ê·¼ë²•ì€ ê³ ìœ í•œ ê°•ì ê³¼ í•œê³„ê°€ ìˆë‹¤:

| ì ‘ê·¼ë²• | ê°•ì  | í•œê³„ |
|--------|------|------|
| í¼ì§€ ë§¤ì¹­ | 0ms, ì™¸ë¶€ ì˜ì¡´ì„± ì—†ìŒ | ìëª¨ ìœ ì‚¬ë„ ì„ê³„ê°’ ë¯¸ë§Œì´ë©´ ë†“ì¹¨ (ì˜ˆ: "ë¦¬ìŠ¤ê±°"â†’"ë¦¬ìŠ¤í¬" = 0.67) |
| ì˜¤íƒ€ ì‚¬ì „ | 0ms, 100% ì •í™• | ì‚¬ì „ì— ì—†ëŠ” ì˜¤íƒ€ëŠ” ì²˜ë¦¬ ë¶ˆê°€ |
| LLM êµì • | ë¯¸ë“±ë¡ ì˜¤íƒ€ë„ ì²˜ë¦¬ | 200-500ms ì§€ì—°, ëª¨ë¸ ë¡œë“œ í•„ìš” |

**ì–´ë–¤ ë‹¨ì¼ ë ˆì´ì–´ë„ "ë¹ ë¥´ê³  + ì •í™•í•˜ê³  + ë²”ìš©ì "ì¼ ìˆ˜ ì—†ë‹¤.**

### 2.2 3-Layer ë¶„ë¦¬ ì›ì¹™: ì •í™•ë„ vs ë¹„ìš© vs ìœ„í—˜

3ê°œ ë ˆì´ì–´ëŠ” **"ì–¸ì œ, ì–¼ë§ˆë‚˜ ë§ì€ ìì›ì„ íˆ¬ì…í•  ê²ƒì¸ê°€"**ë¥¼ ì ì§„ì ìœ¼ë¡œ ê²°ì •í•œë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì‚¬ìš©ì ì…ë ¥: "í˜„ì¬ í…ŒíŠ¸íŠ¸ ì¤‘ì¸ taskëŠ”?"                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: ì˜¤íƒ€ ì‚¬ì „ (ë¹„ìš©: 0ms, ìœ„í—˜: 0)                          â”‚
â”‚  "í…ŒíŠ¸íŠ¸" â†’ KOREAN_TYPO_MAPì— ì¡´ì¬ â†’ "í…ŒìŠ¤íŠ¸"ë¡œ ì¹˜í™˜               â”‚
â”‚  ê²°ê³¼: "í˜„ì¬ í…ŒìŠ¤íŠ¸ ì¤‘ì¸ taskëŠ”?"                                  â”‚
â”‚                                                                   â”‚
â”‚  âœ… í•´ê²°ë¨ â†’ ë¶„ë¥˜ê¸° ì§„ì…                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: ìëª¨ í¼ì§€ ë§¤ì¹­ (ë¹„ìš©: ~0ms, ìœ„í—˜: ê±°ì§“ ì–‘ì„± ê°€ëŠ¥)         â”‚
â”‚  í‚¤ì›Œë“œ "í…ŒìŠ¤íŠ¸ ì¤‘" vs ì¿¼ë¦¬ ë‚´ ìŠ¬ë¼ì´ë”© ìœˆë„ìš°                       â”‚
â”‚  ìëª¨ ìœ ì‚¬ë„ >= ê·¸ë£¹ë³„ ì„ê³„ê°’ì´ë©´ ë§¤ì¹­ ì¸ì •                          â”‚
â”‚  (Phase 3: domain_fixed=0.80, ambiguous=0.85, default=0.82)       â”‚
â”‚                                                                   â”‚
â”‚  âœ… Layer 2ì—ì„œ ì´ë¯¸ êµì • â†’ ì •í™• ë§¤ì¹­ (ìœ ì‚¬ë„ 1.0)                  â”‚
â”‚  (ë§Œì•½ L2 ì‚¬ì „ì— ì—†ì—ˆë‹¤ë©´, L1ì´ ìëª¨ ë¹„êµë¡œ 0.83 ë§¤ì¹­)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                      ë¶„ë¥˜ ê²°ê³¼: TASKS_BY_STATUS âœ…
                              â”‚
                   (ë§Œì•½ ì—¬ì „íˆ UNKNOWNì´ë¼ë©´)
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: LLM êµì • (ë¹„ìš©: 200-500ms, ìœ„í—˜: ëª¨ë¸ ì˜ì¡´)             â”‚
â”‚  L1 ê²½ëŸ‰ ëª¨ë¸(2.6B)ì—ê²Œ ì˜¤íƒ€ êµì • ìš”ì²­                              â”‚
â”‚  êµì •ëœ ì¿¼ë¦¬ë¡œ ë¶„ë¥˜ê¸° ì¬ì‹¤í–‰                                        â”‚
â”‚                                                                   â”‚
â”‚  âš¡ UNKNOWNì¼ ë•Œë§Œ ì‹¤í–‰ â†’ í‰ì†Œì—ëŠ” ë¹„ìš© 0                           â”‚
â”‚  ğŸ“‹ Phase 1: Negative ìºì‹œ + Rate Limitìœ¼ë¡œ L3 í­ì£¼ ë°©ì–´           â”‚
â”‚  ğŸ“‹ Phase 2: L3 ì„±ê³µ íŒ¨í„´ì„ ìë™ ìˆ˜ì§‘ â†’ L2 ì‚¬ì „ í™•ì¥ í›„ë³´           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 ê° ë ˆì´ì–´ì˜ ì„¤ê³„ ì² í•™

| ë ˆì´ì–´ | ì² í•™ | íŠ¸ë¦¬ê±° ì¡°ê±´ | ë¹„ìš© | ê±°ì§“ ì–‘ì„± ìœ„í—˜ |
|--------|------|------------|------|--------------|
| **L2: ì˜¤íƒ€ ì‚¬ì „** | í™•ì‹¤í•œ ê²ƒì„ í™•ì‹¤í•˜ê²Œ | ë§¤ ìš”ì²­ (ì‚¬ì „ ë§¤ì¹­) | 0ms | **ì—†ìŒ** (ì•Œë ¤ì§„ ë§¤í•‘ë§Œ) |
| **L1: ìëª¨ í¼ì§€** | êµ¬ì¡°ì  ìœ ì‚¬ì„±ìœ¼ë¡œ ì¶”ë¡  | ë§¤ ìš”ì²­ (í‚¤ì›Œë“œ ë§¤ì¹­ ì‹œ) | ~0ms | **í†µì œë¨** (ê·¸ë£¹ë³„ ì„ê³„ê°’) |
| **L3: LLM êµì •** | ëª¨ë¥´ë©´ ë¬¼ì–´ë³´ê¸° | UNKNOWN + í•œê¸€ í¬í•¨ + rate limit + negative ìºì‹œ miss | 200-500ms | **ë‚®ìŒ** (LLM íŒë‹¨) |

**ì‹¤í–‰ ìˆœì„œê°€ L2 â†’ L1 â†’ L3ì¸ ì´ìœ :**

- L2(ì‚¬ì „)ê°€ ë¨¼ì €ì¸ ì´ìœ : 100% í™•ì‹¤í•œ êµì •ì„ ìµœìš°ì„  ì ìš©í•˜ë©´, L1ì˜ ê±°ì§“ ì–‘ì„± ìœ„í—˜ì´ ì¤„ì–´ë“ ë‹¤.
- L1(í¼ì§€)ì´ L3(LLM) ì „ì¸ ì´ìœ : L1ì€ 0msì´ë¯€ë¡œ "ì‹œë„í•´ë´ë„ ì†í•´ ì—†ë‹¤". L3ëŠ” 200-500msì´ë¯€ë¡œ L1ì´ í•´ê²°í•˜ë©´ í˜¸ì¶œ ìì²´ë¥¼ íšŒí”¼í•œë‹¤.
- L3ê°€ ë§ˆì§€ë§‰ì¸ ì´ìœ : ê°€ì¥ ë¹„ì‹¸ê³  ê°€ì¥ ë²”ìš©ì ì´ë¯€ë¡œ, "ë‚˜ë¨¸ì§€ ë‘ ë ˆì´ì–´ë¡œë„ í•´ê²° ì•ˆ ë˜ëŠ” ê²½ìš°"ì—ë§Œ íˆ¬ì…í•œë‹¤.

---

## 3. ê° ë ˆì´ì–´ì˜ ìƒì„¸ êµ¬í˜„

### 3.1 Layer 2: PM ë„ë©”ì¸ ì˜¤íƒ€ ì‚¬ì „

**íŒŒì¼**: `utils/korean_normalizer.py` â€” `KOREAN_TYPO_MAP`, `apply_typo_corrections()`

**ì›ë¦¬**: í”„ë¡œì íŠ¸ ê´€ë¦¬ ë„ë©”ì¸ì—ì„œ ë¹ˆë²ˆí•˜ê²Œ ë°œìƒí•˜ëŠ” í•œê¸€/ì˜ë¬¸ ì˜¤íƒ€ë¥¼ ì •ì  ë”•ì…”ë„ˆë¦¬ë¡œ ë§¤í•‘í•œë‹¤.

```python
KOREAN_TYPO_MAP = {
    "í…ŒíŠ¸íŠ¸": "í…ŒìŠ¤íŠ¸",    # ã……â†’ã…Œ ì˜¤íƒ€ (ì¸ì ‘ í‚¤)
    "ìŠ¤í”„ëŸ°íŠ¸": "ìŠ¤í”„ë¦°íŠ¸", # ã…£â†’ã…“ ì˜¤íƒ€
    "ë°±ëŸ¬ê·¸": "ë°±ë¡œê·¸",    # ã…—â†’ã…“ ì˜¤íƒ€
    "ë¦¬ìŠ¤ê±°": "ë¦¬ìŠ¤í¬",    # ã…‹â†’ã„±, ã…¡â†’ã…“ ì˜¤íƒ€
    "ê²€ì½”": "ê²€í† ",       # ã…Œâ†’ã…‹ ì˜¤íƒ€
    "taks": "task",       # ì˜ë¬¸ ì „ì¹˜ ì˜¤íƒ€
    # ... 30+ í•­ëª©
}
```

**ì£¼ì… ìœ„ì¹˜ 1 â€” ë¶„ë¥˜ê¸° ì§„ì…ì **:
```
íŒŒì¼: classifiers/answer_type_classifier.py
í•¨ìˆ˜: AnswerTypeClassifier.classify()
ìœ„ì¹˜: query.strip() ì§í›„, query_lower ìƒì„± ì „
```

```python
# Layer 2: Apply typo dictionary corrections before classification
original_query = query
query = apply_typo_corrections(query)
was_corrected = query != original_query
if was_corrected:
    logger.info(f"Typo correction: '{original_query}' -> '{query}'")
```

**ì£¼ì… ìœ„ì¹˜ 2 â€” í•¸ë“¤ëŸ¬ ë ˆë²¨**:
```
íŒŒì¼: workflows/intent_handlers.py
í•¨ìˆ˜: handle_tasks_by_status()
```

```python
message_lower = apply_typo_corrections(ctx.message).lower()
```

**íŠ¹ì„±**:
- ë¹„ìš©: O(nÃ—m), n=ì¿¼ë¦¬ ê¸¸ì´, m=ì‚¬ì „ í¬ê¸° (~30). ì‹¤ì§ˆì ìœ¼ë¡œ ë§ˆì´í¬ë¡œì´ˆ ë‹¨ìœ„.
- ì •í™•ë„: 100% (ì‚¬ì „ì— ìˆëŠ” ì˜¤íƒ€ì— í•œí•´)
- ìœ„í—˜: 0% (ì‚¬ì „ì˜ ê° í•­ëª©ì€ ìˆ˜ì‘ì—…ìœ¼ë¡œ ê²€ì¦ë¨)
- í•œê³„: ì‚¬ì „ì— ë“±ë¡ë˜ì§€ ì•Šì€ ì˜¤íƒ€ëŠ” ì²˜ë¦¬ ë¶ˆê°€

---

### 3.2 Layer 1: í•œê¸€ ìëª¨ ë¶„í•´ + í¼ì§€ ë§¤ì¹­

**íŒŒì¼**: `utils/korean_normalizer.py` â€” `decompose_korean()`, `jamo_similarity()`, `fuzzy_keyword_in_query()`

**ì›ë¦¬**: í•œê¸€ì„ ìëª¨(ì´ˆì„±/ì¤‘ì„±/ì¢…ì„±)ë¡œ ë¶„í•´í•˜ì—¬, ìœ ë‹ˆì½”ë“œ ì½”ë“œí¬ì¸íŠ¸ê°€ ì•„ë‹Œ **ìŒì†Œ êµ¬ì¡°** ìˆ˜ì¤€ì—ì„œ ë¹„êµí•œë‹¤.

#### 3.2.1 ìëª¨ ë¶„í•´ (decompose_korean)

í•œê¸€ ìœ ë‹ˆì½”ë“œ êµ¬ì¡°:
```
ì½”ë“œí¬ì¸íŠ¸ = 0xAC00 + (ì´ˆì„± Ã— 21 Ã— 28) + (ì¤‘ì„± Ã— 28) + ì¢…ì„±

"í…Œ" = 0xD14C = 0xAC00 + (16 Ã— 21 Ã— 28) + (4 Ã— 28) + 0
       â†’ ì´ˆì„±[16]=ã…Œ, ì¤‘ì„±[4]=ã…”, ì¢…ì„±[0]=ì—†ìŒ
       â†’ ['ã…Œ', 'ã…”']

"ìŠ¤" = 0xC2A4 = 0xAC00 + (9 Ã— 21 Ã— 28) + (18 Ã— 28) + 0
       â†’ ì´ˆì„±[9]=ã……, ì¤‘ì„±[18]=ã…¡
       â†’ ['ã……', 'ã…¡']
```

ë¶„í•´ ê²°ê³¼:
```
"í…ŒìŠ¤íŠ¸" â†’ ['ã…Œ', 'ã…”', 'ã……', 'ã…¡', 'ã…Œ', 'ã…¡']   (6 ìëª¨)
"í…ŒíŠ¸íŠ¸" â†’ ['ã…Œ', 'ã…”', 'ã…Œ', 'ã…¡', 'ã…Œ', 'ã…¡']   (6 ìëª¨)
                     â†‘
              ì´ í•œ ìœ„ì¹˜ë§Œ ë‹¤ë¦„ (ã……â†’ã…Œ)
```

#### 3.2.2 ìëª¨ ìœ ì‚¬ë„ ê³„ì‚° (jamo_similarity)

`difflib.SequenceMatcher`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‘ ìëª¨ ì‹œí€€ìŠ¤ì˜ ìœ ì‚¬ë„ë¥¼ ê³„ì‚°í•œë‹¤.

```
ratio = 2 Ã— (ì¼ì¹˜í•˜ëŠ” ìëª¨ ìˆ˜) / (ì´ ìëª¨ ìˆ˜ì˜ í•©)
```

ì‹¤ì¸¡ ìœ ì‚¬ë„ ê°’:
```
"í…ŒìŠ¤íŠ¸" vs "í…ŒíŠ¸íŠ¸"   = 0.833  (1 ìëª¨ ì°¨ì´)
"ìŠ¤í”„ë¦°íŠ¸" vs "ìŠ¤í”„ëŸ°íŠ¸" = 0.889  (1 ìëª¨ ì°¨ì´: ã…£â†’ã…“)
"ë°±ë¡œê·¸" vs "ë°±ëŸ¬ê·¸"    = 0.857  (1 ìëª¨ ì°¨ì´: ã…—â†’ã…“)
"ì§„í–‰ ìƒ" vs "ì§„í–‰ ì¤‘"  = 0.800  (ê±°ì§“ ì–‘ì„± ê²½ê³„ê°’)
"íƒœìŠ¤í¬" vs "ë¦¬ìŠ¤í¬"    = 0.667  (ì™„ì „íˆ ë‹¤ë¥¸ ë‹¨ì–´, ì ‘ë¯¸ì‚¬ë§Œ ê³µìœ )
```

#### 3.2.3 ê·¸ë£¹ë³„ ì„ê³„ê°’ (Phase 3ì—ì„œ ì—…ê·¸ë ˆì´ë“œ)

**ê¸°ì¡´**: ëª¨ë“  í‚¤ì›Œë“œì— ë‹¨ì¼ ì„ê³„ê°’ 0.82 ì ìš©

**í˜„ì¬ (Phase 3 ì ìš©)**: í‚¤ì›Œë“œ ê·¸ë£¹ë³„ ì°¨ë“± ì„ê³„ê°’

```python
# services/threshold_tuner.py
KEYWORD_TO_GROUP = {
    # domain_fixed: ë„ë©”ì¸ ê³ ìœ  ë‹¨ì–´ â†’ ë‚®ì€ ì„ê³„ê°’ (0.80)
    "ìŠ¤í”„ë¦°íŠ¸": "domain_fixed",
    "ë°±ë¡œê·¸": "domain_fixed",
    "íƒœìŠ¤í¬": "domain_fixed",
    "ë¦¬ìŠ¤í¬": "domain_fixed",
    # ...

    # ambiguous: ì¼ë°˜ì–´ì™€ í˜¼ë™ ê°€ëŠ¥ â†’ ë†’ì€ ì„ê³„ê°’ (0.85)
    "í…ŒìŠ¤íŠ¸ ì¤‘": "ambiguous",
    "ì§„í–‰ ì¤‘": "ambiguous",
    "ê²€í†  ì¤‘": "ambiguous",
    # ...

    # time_context: ì‹œê°„ í‘œí˜„ â†’ í‘œì¤€ ì„ê³„ê°’ (0.82)
    "ì´ë²ˆ ì£¼": "time_context",
    "ê¸ˆì£¼": "time_context",
    # ...
}

DEFAULT_GROUP_THRESHOLDS = {
    "domain_fixed": 0.80,   # ë„ë©”ì¸ ê³ ìœ  â†’ ì¢€ ë” ê´€ëŒ€í•˜ê²Œ
    "ambiguous": 0.85,      # ëª¨í˜¸í•œ ë‹¨ì–´ â†’ ë” ì—„ê²©í•˜ê²Œ
    "time_context": 0.82,   # ì‹œê°„ ë§¥ë½ â†’ í‘œì¤€
    "default": 0.82,        # ë¯¸ë¶„ë¥˜ í‚¤ì›Œë“œ
}
```

**ë¶„ë¥˜ê¸° ì—°ë™** (`classifiers/answer_type_classifier.py`):
```python
from services.threshold_tuner import get_keyword_threshold

# í‚¤ì›Œë“œë³„ë¡œ ê·¸ë£¹ ì„ê³„ê°’ì„ ìë™ ì¡°íšŒí•˜ì—¬ ì ìš©
matched = [
    kw for kw in keywords
    if fuzzy_keyword_in_query(kw, query_lower, threshold=get_keyword_threshold(kw))
]
has_required = any(
    fuzzy_keyword_in_query(req, query_lower, threshold=get_keyword_threshold(req))
    for req in requires_any
)
```

**ì™œ ê·¸ë£¹ë³„ì¸ê°€:**
- "ìŠ¤í”„ë¦°íŠ¸"ì²˜ëŸ¼ ë„ë©”ì¸ ê³ ìœ  ë‹¨ì–´ëŠ” ì„ê³„ê°’ì„ ë‚®ì¶°ë„ ê±°ì§“ ì–‘ì„± ìœ„í—˜ì´ ë‚®ìŒ
- "ì§„í–‰ ì¤‘"ì²˜ëŸ¼ "ì§„í–‰ ìƒ", "ì§„í–‰ë¥ " ë“±ê³¼ í˜¼ë™ ê°€ëŠ¥í•œ ë‹¨ì–´ëŠ” ë†’ì€ ì„ê³„ê°’ í•„ìš”
- ë‹¨ì¼ 0.82ë¡œëŠ” ì´ ë‘ ê°€ì§€ ìš”êµ¬ë¥¼ ë™ì‹œì— ë§Œì¡±ì‹œí‚¬ ìˆ˜ ì—†ìŒ

#### 3.2.4 ì„ê³„ê°’ ê²°ì • ê·¼ê±° (default 0.82 ê¸°ì¤€)

ì„ê³„ê°’ ì„ ì •ì€ **"ê°€ì¥ ìœ ì‚¬í•œ ê±°ì§“ ì–‘ì„±"ê³¼ "ê°€ì¥ ë‚®ì€ ì •ë‹¹ ì˜¤íƒ€"ì˜ ê°­**ì—ì„œ ê²°ì •ëœë‹¤.

```
ê±°ì§“ ì–‘ì„± ì˜ì—­ (ë§¤ì¹­í•˜ë©´ ì•ˆ ë¨):
  "ì§„í–‰ ìƒ" vs "ì§„í–‰ ì¤‘" = 0.800  â† ì˜ë¯¸ê°€ ì™„ì „íˆ ë‹¤ë¦„
  "ë¦¬ìŠ¤í¬" vs "íƒœìŠ¤í¬"   = 0.667  â† ë‹¤ë¥¸ ë„ë©”ì¸ ê°œì²´

ì •ë‹¹ ì˜¤íƒ€ ì˜ì—­ (ë§¤ì¹­í•´ì•¼ í•¨):
  "í…ŒíŠ¸íŠ¸" vs "í…ŒìŠ¤íŠ¸"   = 0.833  â† ìµœì†Œê°’
  "ë°±ëŸ¬ê·¸" vs "ë°±ë¡œê·¸"   = 0.857
  "ìŠ¤í”„ëŸ°íŠ¸" vs "ìŠ¤í”„ë¦°íŠ¸" = 0.889

ê°­: [0.800] ---- 0.82 ---- [0.833]
                  â†‘
            ì„ê³„ê°’ ì„¤ì • ì§€ì 
```

#### 3.2.5 ìŠ¬ë¼ì´ë”© ìœˆë„ìš°: "ë™ì¼ ê¸¸ì´ë§Œ" ê·œì¹™

```python
# í‚¤ì›Œë“œì™€ ë™ì¼í•œ ê¸¸ì´ì˜ ìœˆë„ìš°ë§Œ ê²€ì‚¬
for i in range(query_len - kw_len + 1):
    window = query[i:i + kw_len]
    sim = jamo_similarity(keyword, window)
```

`kw_len - 1` ìœˆë„ìš°ë¥¼ í—ˆìš©í•˜ì§€ ì•ŠëŠ” ì´ìœ :

```
í‚¤ì›Œë“œ "ë¦¬ìŠ¤í¬" (3ê¸€ì)ì— ëŒ€í•´ kw_len-1=2 ìœˆë„ìš°ë¥¼ í—ˆìš©í•˜ë©´:

ì¿¼ë¦¬ "ì´ë²ˆ ì£¼ ë§ˆê° íƒœìŠ¤í¬"ì—ì„œ 2ê¸€ì ìœˆë„ìš° "ìŠ¤í¬" ì¶”ì¶œ
  "ìŠ¤í¬" ìëª¨: ['ã……', 'ã…¡', 'ã…‹', 'ã…¡']        (4 ìëª¨)
  "ë¦¬ìŠ¤í¬" ìëª¨: ['ã„¹', 'ã…£', 'ã……', 'ã…¡', 'ã…‹', 'ã…¡'] (6 ìëª¨)

  SequenceMatcher: 'ã……','ã…¡','ã…‹','ã…¡' 4ê°œ ì¼ì¹˜
  ratio = 2 Ã— 4 / (4 + 6) = 0.80 â†’ ì„ê³„ê°’ ì´ˆê³¼!

  ê²°ê³¼: "íƒœìŠ¤í¬"ê°€ "ë¦¬ìŠ¤í¬"ë¡œ ë§¤ì¹­ â†’ RISK_ANALYSISë¡œ ì˜¤ë¶„ë¥˜
```

**ë™ì¼ ê¸¸ì´ ìœˆë„ìš°ë§Œ ì‚¬ìš©í•˜ë©´ ì ‘ë¯¸ì‚¬ ê³µìœ ë¡œ ì¸í•œ ì§§ì€-ìœˆë„ìš° ê±°ì§“ ì–‘ì„±ì„ ì›ì²œ ì°¨ë‹¨í•œë‹¤.**

#### 3.2.6 ì£¼ì… ìœ„ì¹˜

```
íŒŒì¼: classifiers/answer_type_classifier.py
í•¨ìˆ˜: AnswerTypeClassifier.classify()
```

**ë³€ê²½ ì „**:
```python
matched = [kw for kw in keywords if kw in query_lower]
has_required = any(req in query_lower for req in requires_any)
```

**ë³€ê²½ í›„ (Phase 3 ë°˜ì˜)**:
```python
matched = [
    kw for kw in keywords
    if fuzzy_keyword_in_query(kw, query_lower, threshold=get_keyword_threshold(kw))
]
has_required = any(
    fuzzy_keyword_in_query(req, query_lower, threshold=get_keyword_threshold(req))
    for req in requires_any
)
```

`fuzzy_keyword_in_query`ëŠ” ë‚´ë¶€ì—ì„œ **ë¨¼ì € ì •í™• ë§¤ì¹­(`keyword in query`)ì„ ì‹œë„**í•˜ê³ , ì‹¤íŒ¨í•  ë•Œë§Œ ìŠ¬ë¼ì´ë”© ìœˆë„ìš° í¼ì§€ ë§¤ì¹­ìœ¼ë¡œ ì§„ì…í•œë‹¤.

---

### 3.3 Layer 3: LLM ê¸°ë°˜ ì¿¼ë¦¬ êµì • (Fallback)

**íŒŒì¼**: `utils/korean_normalizer.py` â€” `normalize_query_with_llm()`, `LLMNormalizerCache`
**ì£¼ì… ìœ„ì¹˜**: `workflows/chat_workflow_v2.py` â€” `_classify_answer_type_node()`

**ì›ë¦¬**: Layer 1+2ë¡œ í•´ê²°ë˜ì§€ ì•Šì•„ UNKNOWNìœ¼ë¡œ ë¶„ë¥˜ëœ ì¿¼ë¦¬ì— ëŒ€í•´, L1 ê²½ëŸ‰ ëª¨ë¸(LFM2-2.6B)ì—ê²Œ ì˜¤íƒ€ êµì •ì„ ìš”ì²­í•˜ê³  ì¬ë¶„ë¥˜í•œë‹¤.

#### 3.3.1 íŠ¸ë¦¬ê±° ì¡°ê±´ (Phase 1 ê°•í™”)

```python
if result.answer_type == AnswerType.UNKNOWN and self.llm_l1:
    if has_korean(message):
        # Phase 1: Negative ìºì‹œ í™•ì¸ (L3 ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€)
        if cache_manager.get_negative(message):
            # ì´ì „ì— L3ê¹Œì§€ í˜¸ì¶œí–ˆì§€ë§Œ ì—¬ì „íˆ UNKNOWNì´ì—ˆë˜ ì¿¼ë¦¬ â†’ ê±´ë„ˆëœ€
            pass
        # Phase 1: L3 Rate Limit í™•ì¸ (í´ëŸ¬ìŠ¤í„° ë‹¨ìœ„)
        elif cache_manager.rate_limiter.is_allowed():
            normalized = normalize_query_with_llm(self.llm_l1, message, self.model_path_l1)
```

íŠ¸ë¦¬ê±° ì¡°ê±´ (ëª¨ë‘ ì¶©ì¡± í•„ìš”):
1. **ë¶„ë¥˜ ê²°ê³¼ê°€ UNKNOWN**: L1+L2ê°€ ì´ë¯¸ ì‹œë„ëœ í›„
2. **L1 ëª¨ë¸ì´ ë¡œë“œë˜ì–´ ìˆìŒ**: ëª¨ë¸ ë¯¸ë¡œë“œ ì‹œ ì¡°ìš©íˆ ê±´ë„ˆëœ€
3. **í•œê¸€ì´ í¬í•¨ëœ ì¿¼ë¦¬**: ì˜ë¬¸ ì „ìš© ì¿¼ë¦¬ì—ëŠ” ë¶ˆí•„ìš”
4. **(Phase 1) Negative ìºì‹œ miss**: ì´ë¯¸ L3 ì‹¤íŒ¨í•œ ì¿¼ë¦¬ëŠ” ì¬í˜¸ì¶œ ë°©ì§€
5. **(Phase 1) Rate Limit í—ˆìš©**: í´ëŸ¬ìŠ¤í„° ì „ì²´ 30/min ì œí•œ ì´ë‚´

#### 3.3.2 LLM í”„ë¡¬í”„íŠ¸

```
Fix Korean typos in this sentence. Only correct typos, do not change meaning.
Input: {query}
Output:
```

ì˜ë„ì ìœ¼ë¡œ **ìµœì†Œí•œì˜ ì§€ì‹œ**ë§Œ í¬í•¨í•œë‹¤:
- max_tokens=100, temperature=0.1: ê±°ì˜ ê²°ì •ë¡ ì ì¸ ì§§ì€ ì¶œë ¥ë§Œ í—ˆìš©

#### 3.3.3 ì¬ë¶„ë¥˜ ë¡œì§

```python
normalized = normalize_query_with_llm(llm_l1, message, model_path_l1)
if normalized and normalized.strip() != message.strip():
    retry_result = classifier.classify(normalized)
    if retry_result.answer_type != AnswerType.UNKNOWN:
        result = retry_result              # ìƒˆ ë¶„ë¥˜ ê²°ê³¼ ì±„íƒ
        state["message"] = normalized      # í•˜ìœ„ í•¸ë“¤ëŸ¬ì— êµì •ëœ ì¿¼ë¦¬ ì „ë‹¬
    else:
        cache_manager.set_negative(message)  # Phase 1: Negative ìºì‹œ ì„¤ì •
```

ì•ˆì „ ì¥ì¹˜:
- êµì • ê²°ê³¼ê°€ ì›ë³¸ê³¼ ë™ì¼í•˜ë©´ ë¬´ì‹œ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
- ì¬ë¶„ë¥˜ ê²°ê³¼ë„ UNKNOWNì´ë©´ ì›ë˜ ê²°ê³¼ ìœ ì§€ + **Negative ìºì‹œ ì„¤ì • (3ë¶„ TTL)**
- ì˜ˆì™¸ ë°œìƒ ì‹œ `logger.warning`ë§Œ ë‚¨ê¸°ê³  ì›ë˜ UNKNOWN íë¦„ ê³„ì† (ì ˆëŒ€ í¬ë˜ì‹œí•˜ì§€ ì•ŠìŒ)

#### 3.3.4 ìºì‹œ ê³„ì¸µ (Phase 1 ê°•í™”)

**ê¸°ì¡´**: ì¸ë©”ëª¨ë¦¬ LRU (256 entries, `LLMNormalizerCache`)

**í˜„ì¬ (Phase 1 ì ìš©)**: 3ë‹¨ê³„ ê³„ì¸µ ìºì‹œ (`services/normalization_cache.py`)

| ìºì‹œ | ìš©ë„ | TTL | ì¡°ê±´ |
|------|------|-----|------|
| ì •ê·œí™” ìºì‹œ | raw_query â†’ normalized + layers | 1ì‹œê°„ | í•­ìƒ ì„¤ì • |
| Negative ìºì‹œ | raw_query â†’ "í™•ì¸ëœ UNKNOWN" | 3ë¶„ | L3 í˜¸ì¶œ í›„ì—ë„ UNKNOWNì¸ ê²½ìš°ë§Œ |
| ë¶„ë¥˜ ìºì‹œ | normalized_query â†’ intent + confidence | 10ë¶„ | intent != UNKNOWNì¸ ê²½ìš°ë§Œ |

**Negative ìºì‹œ ì—„ê²© ì •ì˜**:
```
"confirmed UNKNOWN"ì˜ ì •ì˜:
  1. L1/L2 ì •ê·œí™”ë¥¼ ì ìš©í•œ classifier.classify() ê²°ê³¼ê°€ UNKNOWN
  AND
  2. L3 LLM ì •ê·œí™”ë¥¼ í˜¸ì¶œí–ˆì§€ë§Œ ì—¬ì „íˆ UNKNOWN

ì´ ì¡°ê±´ì—ì„œë§Œ negative ìºì‹œ set.
L1/L2ë§Œìœ¼ë¡œ UNKNOWNì¸ ê²½ìš°ëŠ” negative ìºì‹œë¥¼ ì„¤ì •í•˜ì§€ ì•ŠëŠ”ë‹¤.
```

---

## 4. ì „ì²´ ë°ì´í„° íë¦„

```
ì‚¬ìš©ì ì…ë ¥: "í˜„ì¬ ìŠ¤í”„ëŸ°íŠ¸ì—ì„œ í…ŒíŠ¸íŠ¸ ì¤‘ì¸ taksëŠ”?"
  â”‚
  â–¼
[answer_type_classifier.py:classify()]
  â”‚
  â”œâ”€ L2 ì˜¤íƒ€ ì‚¬ì „ ì ìš©:
  â”‚   "ìŠ¤í”„ëŸ°íŠ¸" â†’ "ìŠ¤í”„ë¦°íŠ¸"
  â”‚   "í…ŒíŠ¸íŠ¸"  â†’ "í…ŒìŠ¤íŠ¸"
  â”‚   "taks"   â†’ "task"
  â”‚   ê²°ê³¼: "í˜„ì¬ ìŠ¤í”„ë¦°íŠ¸ì—ì„œ í…ŒìŠ¤íŠ¸ ì¤‘ì¸ taskëŠ”?"
  â”‚
  â”œâ”€ Priority 1 INTENT_PATTERNS ë£¨í”„:
  â”‚   â”‚
  â”‚   â”œâ”€ RISK_ANALYSIS: keywords=["ë¦¬ìŠ¤í¬",...]
  â”‚   â”‚   L1 fuzzy_keyword_in_query("ë¦¬ìŠ¤í¬", ..., threshold=0.80) â† domain_fixed
  â”‚   â”‚   â†’ ë¶ˆì¼ì¹˜ â†’ skip
  â”‚   â”‚
  â”‚   â”œâ”€ TASKS_BY_STATUS: keywords=["í…ŒìŠ¤íŠ¸ ì¤‘",...]
  â”‚   â”‚   L1 fuzzy_keyword_in_query("í…ŒìŠ¤íŠ¸ ì¤‘", ..., threshold=0.85) â† ambiguous
  â”‚   â”‚   â†’ exact match hit! âœ…
  â”‚   â”‚   requires_any=["task",...] â†’ "task" in query âœ…
  â”‚   â”‚   â†’ TASKS_BY_STATUS ë°˜í™˜ (confidence: 0.80)
  â”‚   â”‚
  â”‚   â””â”€ (ì´í›„ ì²´í¬ ë¶ˆí•„ìš”, early return)
  â”‚
  â–¼
[chat_workflow_v2.py:_route_after_answer_type()]
  â”‚
  â”œâ”€ intent = "tasks_by_status"
  â”œâ”€ has_dedicated_handler("tasks_by_status") â†’ True
  â””â”€ return "intent_handler"
  â”‚
  â–¼
[intent_handlers.py:handle_tasks_by_status()]
  â”‚
  â”œâ”€ message_lower = apply_typo_corrections(ctx.message).lower()
  â”‚   â†’ "í˜„ì¬ ìŠ¤í”„ë¦°íŠ¸ì—ì„œ í…ŒìŠ¤íŠ¸ ì¤‘ì¸ taskëŠ”?"
  â”‚
  â”œâ”€ fuzzy_keyword_in_query("í…ŒìŠ¤íŠ¸", message_lower) â†’ True
  â”‚   â†’ status_filter = "REVIEW"
  â”‚   â†’ query = TASKS_IN_REVIEW_QUERY
  â”‚
  â”œâ”€ execute_query(TASKS_IN_REVIEW_QUERY, {project_id: ...})
  â””â”€ return ResponseContract(intent="tasks_by_status", data={tasks: [...]})
```

---

## 5. ê±°ì§“ ì–‘ì„± ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜

| ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜ | ë°©ì–´ ëŒ€ìƒ | êµ¬í˜„ ìœ„ì¹˜ |
|-------------|----------|----------|
| ê·¸ë£¹ë³„ ì„ê³„ê°’ (Phase 3) | ë„ë©”ì¸ë³„ ìµœì  FP/FN ê· í˜• | `threshold_tuner.py` + `answer_type_classifier.py` |
| ë™ì¼ ê¸¸ì´ ìœˆë„ìš° | "ìŠ¤í¬"â†’"ë¦¬ìŠ¤í¬" ë“± ì ‘ë¯¸ì‚¬ ê³µìœ  | `fuzzy_keyword_in_query()` ìŠ¬ë¼ì´ë”© ìœˆë„ìš° |
| ìˆ˜ì‘ì—… ì‚¬ì „ë§Œ | ì‚¬ì „ ì˜¤ë¥˜ë¡œ ì¸í•œ ì˜ë¯¸ ì™œê³¡ | `KOREAN_TYPO_MAP` |
| UNKNOWNì¼ ë•Œë§Œ L3 | ì •ìƒ ë¶„ë¥˜ëœ ì¿¼ë¦¬ì— ë¶ˆí•„ìš”í•œ LLM í˜¸ì¶œ | `_classify_answer_type_node()` ì¡°ê±´ë¬¸ |
| Negative ìºì‹œ (Phase 1) | L3 ì¤‘ë³µ í˜¸ì¶œ (L3 storm) | `normalization_cache.py` |
| L3 Rate Limit (Phase 1) | í´ëŸ¬ìŠ¤í„° ì „ì²´ L3 ë¹„ìš© í­ì¦ | `L3RateLimiter` (Redis INCR + ë¡œì»¬ í´ë°±) |
| ì›ë³¸ != êµì •ì¼ ë•Œë§Œ ì¬ë¶„ë¥˜ | LLMì´ ë³€ê²½ ì—†ì´ ë°˜í™˜ ì‹œ ë¬´í•œ ì¬ì‹œë„ | `_classify_answer_type_node()` ë¹„êµ |
| ì¬ë¶„ë¥˜ë„ UNKNOWNì´ë©´ í¬ê¸° | LLM êµì •ì´ ë„ì›€ ì•ˆ ë˜ëŠ” ê²½ìš° | `_classify_answer_type_node()` ì¡°ê±´ë¬¸ |
| ì˜ˆì™¸ ì‹œ ì›ë³¸ ìœ ì§€ | LLM ì˜¤ë¥˜ê°€ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì°¨ë‹¨ | `try/except` + `logger.warning` |
| ì‘ë‹µ ê¸¸ì´ ì œí•œ | LLMì´ ì¥ë¬¸ ìƒì„± ì‹œ | `len(text) <= len(query) * 2` |

---

## 6. Phase 1: Redis ìºì‹œ + ì´ë²¤íŠ¸ ë¡œê¹… + ì„œí‚·ë¸Œë ˆì´ì»¤

### 6.1 ëª©í‘œ

ì¸ë©”ëª¨ë¦¬ ì „ìš© ìºì‹œë¥¼ **ê³„ì¸µí™”ëœ Redis+ë©”ëª¨ë¦¬ ìºì‹œ**ë¡œ êµì²´í•˜ê³ , ì •ê·œí™” ì´ë²¤íŠ¸ ë¡œê¹…ì„ ì¶”ê°€í•˜ì—¬ Phase 2/3ì˜ ë°ì´í„° ê¸°ë°˜ì„ ë§ˆë ¨í•œë‹¤.

### 6.2 êµ¬í˜„ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `services/normalization_cache.py` | ê³„ì¸µí™” ìºì‹œ + ì„œí‚·ë¸Œë ˆì´ì»¤ + Rate Limiter |
| `config/constants.py` | `NormalizationConfig` ë°ì´í„°í´ë˜ìŠ¤ |
| `observability/p4_events.py` | `QUERY_NORMALIZED` ì´ë²¤íŠ¸ íƒ€ì… + í˜ì´ë¡œë“œ |
| `service_state.py` | `redis_client` ì†ì„± ì¶”ê°€ |
| `app.py` | Redis ì´ˆê¸°í™” (timeout + fallback) |

### 6.3 Redis ì„œí‚·ë¸Œë ˆì´ì»¤

```
ìƒíƒœ: CLOSED (ì •ìƒ) â†’ OPEN (ì°¨ë‹¨) â†’ HALF_OPEN (ì‹œí—˜)

ì „í™˜ ì¡°ê±´:
- CLOSED â†’ OPEN: 30ì´ˆ ë‚´ Redis ì˜¤ë¥˜ 3íšŒ ì´ìƒ
- OPEN â†’ HALF_OPEN: 30ì´ˆ ê²½ê³¼ í›„ ìë™
- HALF_OPEN â†’ CLOSED: 1íšŒ ì„±ê³µ
- HALF_OPEN â†’ OPEN: 1íšŒ ì‹¤íŒ¨

OPEN ìƒíƒœì—ì„œëŠ” Redis ì ‘ê·¼ ìì²´ë¥¼ ê±´ë„ˆë›°ê³  ë©”ëª¨ë¦¬ ìºì‹œë§Œ ì‚¬ìš©.
```

**í•µì‹¬ íš¨ê³¼**: Redis ì¥ì• ê°€ "ëª¨ë“  ìš”ì²­ë§ˆë‹¤ timeout"ìœ¼ë¡œ ì¦í­ë˜ëŠ” ê²ƒì„ ë°©ì§€.

### 6.4 ìºì‹œ í‚¤ ì„¤ê³„

```
ì •ê·œí™”:  norm:v1:<sha256(query.strip().lower())[:16]>
Negative: neg:v1:<sha256(query.strip().lower())[:16]>
ë¶„ë¥˜:    class:v1:<sha256(query)[:16]>:<classifier_ver>
```

**q_fingerprint ì¶”ì **: valueì— full SHA256(`q_fp`)ì„ ì €ì¥í•˜ê³ , P4 ì´ë²¤íŠ¸ì—ë„ ë™ì¼ `q_fp`ë¥¼ ë‚¨ê¹€. ì¥ì•  ë¶„ì„ ì‹œ "ìºì‹œ í‚¤ â†” ì´ë²¤íŠ¸ ë¡œê·¸ â†” ì¿¼ë¦¬" ì—°ê²°ì´ ê°€ëŠ¥.

### 6.5 L3 Rate Limit: í´ëŸ¬ìŠ¤í„° ë‹¨ìœ„

```
1ì°¨: Redis INCR + TTL (í´ëŸ¬ìŠ¤í„° ì „ì²´ 30/min ì œí•œ)
     key: "l3_ratelimit:v1:<minute_bucket>"
     INCR í›„ count > 30ì´ë©´ L3 skip
     TTL 120ì´ˆ ìë™ ë§Œë£Œ

2ì°¨: Redis ë¶ˆê°€ ì‹œ threading ê¸°ë°˜ ë¡œì»¬ ì¹´ìš´í„° (í”„ë¡œì„¸ìŠ¤ ë‹¨ìœ„ 30/min)
```

### 6.6 ì´ë²¤íŠ¸ ìƒ˜í”Œë§

```python
EVENT_SAMPLE_RATE_NORMAL = 0.1    # ì •ìƒ ë¶„ë¥˜: 10% ìƒ˜í”Œë§
EVENT_SAMPLE_RATE_L3 = 1.0        # L3 í˜¸ì¶œ/UNKNOWN: 100% ì „ìˆ˜ ê¸°ë¡

# íŒë‹¨ ê¸°ì¤€:
# - l3_called == True â†’ 100% emit
# - negative_cache_hit == True â†’ 100% emit
# - ê·¸ ì™¸ â†’ 10% ëœë¤ ìƒ˜í”Œë§
```

### 6.7 Redis ì—°ê²° ì˜µì…˜

```python
redis.Redis(
    host=config.host,
    port=config.port,
    socket_connect_timeout=0.1,    # 100ms
    socket_timeout=0.15,            # 150ms
    retry_on_timeout=False,         # ì¬ì‹œë„ ì—†ìŒ (ì¦‰ì‹œ í´ë°±)
    health_check_interval=30,
    decode_responses=True,
)
```

---

## 7. Phase 2: ì˜¤íƒ€ ì‚¬ì „ ìë™ í™•ì¥ (Shadow Pipeline)

### 7.1 ëª©í‘œ

L3 êµì • ì„±ê³µ íŒ¨í„´ì„ **ìë™ ìˆ˜ì§‘**í•˜ê³ , **Shadow ì‚¬ì „**ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ í‰ê°€í•œ ë’¤, **ìˆ˜ë™ ìŠ¹ì¸**ì„ ê±°ì³ì„œë§Œ í”„ë¡œë•ì…˜ ì‚¬ì „ì— ë°˜ì˜í•œë‹¤.

**ì ˆëŒ€ ì›ì¹™: ìë™ ìˆ˜ì§‘ì€ OK, ìë™ ë°˜ì˜ì€ ê¸ˆì§€.**

### 7.2 êµ¬í˜„ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `services/typo_candidate_collector.py` | L3 êµì • í›„ë³´ ìë™ ìˆ˜ì§‘ + Shadow ì‚¬ì „ ê´€ë¦¬ |
| `routes/normalization_admin_routes.py` | ê´€ë¦¬ì API (í›„ë³´ ëª©ë¡/ìŠ¹ê²©/í†µê³„) |
| `routes/__init__.py` | ê´€ë¦¬ì blueprint ë“±ë¡ |

### 7.3 3ë‹¨ê³„ ì•ˆì „ íŒŒì´í”„ë¼ì¸

```
(A) í›„ë³´ ìˆ˜ì§‘ (ìë™)
    ì¡°ê±´: UNKNOWN AND L3 êµì • í›„ ì¬ë¶„ë¥˜ ì„±ê³µ
    ì €ì¥: fingerprint + ë§ˆìŠ¤í‚¹ëœ í˜•íƒœ (ì›ë¬¸ ì €ì¥ ê¸ˆì§€)

(B) í›„ë³´ ì •ì œ (ìë™ í•„í„°)
    - ë™ì¼ êµì • NíšŒ ì´ìƒ ë°˜ë³µ (ê¸°ë³¸: 10íšŒ)
    - êµì • ì•ˆì •ì„± > 0.9 (top1_count / total_count)
    - intent ì•ˆì •ì„± > 0.9 (top_intent / total)

(C) ë°˜ì˜ (ë‹¨ê³„ì )
    1ë‹¨ê³„: Shadow ì‚¬ì „ì— ë°˜ì˜ (ì‹¤ì œ êµì • ì—†ì´ "í–ˆë‹¤ë©´?" ê¸°ë¡ë§Œ)
    2ë‹¨ê³„: ìˆ˜ë™ ìŠ¹ì¸ í›„ í”„ë¡œë•ì…˜ ë°˜ì˜
```

### 7.4 Redis ZSET ê¸°ë°˜ í›„ë³´ ì €ì¥

```
1. ì›ë¬¸ë³„ êµì • ë¶„í¬ (ZSET)
   í‚¤: typo:cand:v1:<orig_fp[:16]>
   member: <corrected_fp[:16]>
   score: count
   â†’ stability = ZSCORE(top1) / SUM(all scores)

2. ì›ë¬¸ ë©”íƒ€ë°ì´í„° (HASH)
   í‚¤: typo:cand:meta:v1:<orig_fp[:16]>
   í•„ë“œ: first_seen, last_seen, total_count, masked_original, masked_corrected

3. êµì •ë³„ intent ë¶„í¬ (ZSET)
   í‚¤: typo:intent:v1:<orig_fp[:16]>:<corrected_fp[:16]>
   member: <intent>
   score: count
   â†’ intent_stability = ZSCORE(top_intent) / SUM(all scores)
```

### 7.5 Shadow ì‚¬ì „ í‰ê°€

- Shadow êµì •ì€ ì‹¤ì œ ë¼ìš°íŒ…ì— ì ìš©í•˜ì§€ ì•Šê³ , "ì ìš©í–ˆë‹¤ë©´ ê²°ê³¼ê°€ ë‹¬ëì„ì§€"ë§Œ ê¸°ë¡
- UNKNOWNì´ê±°ë‚˜ L3ê°€ í˜¸ì¶œëœ ì¼€ì´ìŠ¤ì—ë§Œ shadow ë¹„êµ (ë¹„ìš© ì œì–´)
- ê²°ê³¼ê°€ ë‹¬ë¼ì§„ ì¼€ì´ìŠ¤ë§Œ ì´ë²¤íŠ¸ emit

### 7.6 PII ë³´í˜¸

```
[ì €ì¥ O] sha256 fingerprint, PIIMasker.mask_query() ë§ˆìŠ¤í‚¹ í˜•íƒœ, intent, count
[ì €ì¥ X] ì›ë¬¸(raw query), ì‚¬ìš©ì ID, ì„¸ì…˜ ì •ë³´
```

---

## 8. Phase 3: ì„ê³„ê°’ ìë™ íŠœë‹ (Per-Group Threshold)

### 8.1 ëª©í‘œ

ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ìµœì  ì„ê³„ê°’ì„ ë„ì¶œí•˜ë˜, ê·¸ë£¹ë³„ ê¸°ë³¸ ì„ê³„ê°’ì€ ì¦‰ì‹œ ì ìš©. ë™ì  íŠœë‹(signal recording + recommendations)ì€ `ENABLE_THRESHOLD_TUNING` í”Œë˜ê·¸ë¡œ ì œì–´.

### 8.2 êµ¬í˜„ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `services/threshold_tuner.py` | í‚¤ì›Œë“œ ê·¸ë£¹ ì •ì˜, ì„ê³„ê°’ ê´€ë¦¬, ë¹„ìš©í•¨ìˆ˜ ê¸°ë°˜ ì¶”ì²œ |
| `classifiers/answer_type_classifier.py` | `get_keyword_threshold()` ì—°ë™ |
| `routes/normalization_admin_routes.py` | ì„ê³„ê°’ ì¡°íšŒ/ì¶”ì²œ/ì˜¤ë²„ë¼ì´ë“œ API |

### 8.3 í‚¤ì›Œë“œ ê·¸ë£¹ ì²´ê³„

```python
KEYWORD_TO_GROUP = {
    # domain_fixed (0.80): ë„ë©”ì¸ ê³ ìœ  ë‹¨ì–´ â†’ ë‚®ì€ ì„ê³„ê°’
    "ìŠ¤í”„ë¦°íŠ¸": "domain_fixed",  "sprint": "domain_fixed",
    "ë°±ë¡œê·¸": "domain_fixed",    "backlog": "domain_fixed",
    "íƒœìŠ¤í¬": "domain_fixed",    "task": "domain_fixed",
    "ë¦¬ìŠ¤í¬": "domain_fixed",    "risk": "domain_fixed",
    "ìœ„í—˜": "domain_fixed",      "ì™„ë£Œëœ": "domain_fixed",
    # ...

    # ambiguous (0.85): ì¼ë°˜ì–´ì™€ í˜¼ë™ ê°€ëŠ¥ â†’ ë†’ì€ ì„ê³„ê°’
    "í…ŒìŠ¤íŠ¸ ì¤‘": "ambiguous",    "ì§„í–‰ ì¤‘": "ambiguous",
    "ê²€í†  ì¤‘": "ambiguous",      "ëŒ€ê¸° ì¤‘": "ambiguous",
    # ...

    # time_context (0.82): ì‹œê°„ í‘œí˜„ â†’ í‘œì¤€ ì„ê³„ê°’
    "ì´ë²ˆ ì£¼": "time_context",   "ì´ë²ˆì£¼": "time_context",
    "ê¸ˆì£¼": "time_context",
    # ...
}
```

### 8.4 ë¹„ìš©í•¨ìˆ˜ (ê°€ì¤‘ ìµœì í™”)

```
ë¹„ìš© = FP_count Ã— FP_WEIGHT + FN_count Ã— FN_WEIGHT + L3_count Ã— L3_WEIGHT

ê°€ì¤‘ì¹˜:
  FP_WEIGHT = 10   â† ê°€ì¥ ë¹„ìŒˆ: ì˜ëª»ëœ ë¼ìš°íŒ…
  FN_WEIGHT = 3    â† ì°¨ì„ : UNKNOWN/RAGë¡œ ê°€ëŠ” ë¹„ìš©
  L3_WEIGHT = 2    â† ì§€ì—°/ë¹„ìš©

ëª©í‘œ: ì´ ë¹„ìš©í•¨ìˆ˜ë¥¼ ìµœì†Œí™”í•˜ëŠ” threshold íƒìƒ‰
```

### 8.5 ë°©í–¥ì„± ì¶”ì²œ ë¡œì§

```python
# FPìœ¨ì´ 5% ì´ˆê³¼ â†’ ì„ê³„ê°’ ì˜¬ë¦¼ (ë” ì—„ê²©í•˜ê²Œ)
if fp_rate > 0.05:
    recommended = current + 0.02  # 10% ì´ˆê³¼ë©´ 0.04

# FNìœ¨ì´ 10% ì´ˆê³¼ â†’ ì„ê³„ê°’ ë‚´ë¦¼ (ë” ê´€ëŒ€í•˜ê²Œ)
elif fn_rate > 0.10:
    recommended = current - 0.02  # 20% ì´ˆê³¼ë©´ 0.04

# ì„ê³„ê°’ ë²”ìœ„: [0.75, 0.92]
```

### 8.6 ìµœì†Œ ìƒ˜í”Œ ê°€ë“œ

```
ê·¸ë£¹ë‹¹ ì´ë²¤íŠ¸ ìµœì†Œ 1,000ê±´ ë¯¸ë§Œì´ë©´ ì¶”ì²œ ë³´ë¥˜.
ì‹ ë¢°ë„: high (>=5000), medium (>=1000), low (<1000)
```

### 8.7 Admin ì„ê³„ê°’ ì˜¤ë²„ë¼ì´ë“œ

```python
# ê´€ë¦¬ìê°€ íŠ¹ì • ê·¸ë£¹ì˜ ì„ê³„ê°’ì„ ìˆ˜ë™ ì¡°ì •
tuner.apply_override("domain_fixed", 0.78)

# ìš°ì„ ìˆœìœ„: admin override > default group threshold > global default (0.82)
# ë²”ìœ„ ì œí•œ: [0.75, 0.92]
```

### 8.8 FP Proxy ì‹ í˜¸ (í–¥í›„ ë°ì´í„° ìˆ˜ì§‘ìš©)

ìš´ì˜ì—ì„œ FP(ê±°ì§“ ì–‘ì„±)ë¥¼ ì§ì ‘ ì¸¡ì •í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ proxy ì‹ í˜¸ë¥¼ ì •ì˜:

1. **ì‚¬ìš©ì ì¬ì§ˆë¬¸ (30ì´ˆ ì´ë‚´)**: "ì•„ë‹ˆ" / "ë¬´ìŠ¨" / "ë‹¤ì‹œ" ë¥˜ íŒ¨í„´
2. **í•¸ë“¤ëŸ¬ ê²°ê³¼ê°€ empty/error**: êµì • í›„ ë¼ìš°íŒ…ëœ í•¸ë“¤ëŸ¬ê°€ ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í•¨
3. **íŒ¨ëŸ¬í”„ë ˆì´ì¦ˆ**: ì‚¬ìš©ìê°€ ì¦‰ì‹œ ë‹¤ë¥¸ í‘œí˜„ìœ¼ë¡œ ë°˜ë³µ ì§ˆë¬¸

---

## 9. NormalizationConfig ì„¤ì • ì „ì²´

```python
# config/constants.py

@dataclass(frozen=True)
class NormalizationConfig:
    """Query normalization cache, rate limiting, and tuning configuration."""

    # === Redis cache TTL ===
    NORMALIZATION_CACHE_TTL_SECONDS: int = 3600      # 1h
    NEGATIVE_CACHE_TTL_SECONDS: int = 180            # 3min
    CLASSIFICATION_CACHE_TTL_SECONDS: int = 600      # 10min

    # === Cache key prefixes ===
    NORM_CACHE_PREFIX: str = "norm:v1:"
    NEG_CACHE_PREFIX: str = "neg:v1:"
    CLASS_CACHE_PREFIX: str = "class:v1:"

    # === Redis circuit breaker ===
    CIRCUIT_BREAKER_FAILURE_THRESHOLD: int = 3
    CIRCUIT_BREAKER_WINDOW_SECONDS: int = 30
    CIRCUIT_BREAKER_RECOVERY_SECONDS: int = 30

    # === L3 rate limiting ===
    L3_MAX_CALLS_PER_MINUTE: int = 30
    L3_RATE_LIMIT_KEY: str = "l3_ratelimit:v1"

    # === Event sampling ===
    EVENT_SAMPLE_RATE_NORMAL: float = 0.1            # 10%
    EVENT_SAMPLE_RATE_L3: float = 1.0                # 100%

    # === Feature flags ===
    ENABLE_REDIS_CACHE: bool = True
    ENABLE_NEGATIVE_CACHE: bool = True
    ENABLE_EVENT_LOGGING: bool = True
    ENABLE_CANDIDATE_COLLECTION: bool = False         # Phase 2
    ENABLE_SHADOW_DICT: bool = False                  # Phase 2
    ENABLE_THRESHOLD_TUNING: bool = False             # Phase 3 (signal recording)

    # === Memory fallback ===
    MEMORY_CACHE_MAXSIZE: int = 256

    # === Version tracking ===
    NORMALIZER_VERSION: str = "v1.0"
    TYPO_DICT_VERSION: str = "v1.0"
    THRESHOLD_VERSION: str = "v1.0"
```

**ì°¸ê³ **: `ENABLE_THRESHOLD_TUNING=False`ëŠ” **ë™ì  signal recordingê³¼ ì¶”ì²œ ê¸°ëŠ¥ë§Œ** ë¹„í™œì„±í™”í•œë‹¤. ê·¸ë£¹ë³„ ê¸°ë³¸ ì„ê³„ê°’(domain_fixed=0.80 ë“±)ì€ í•­ìƒ ì ìš©ëœë‹¤.

---

## 10. íŒŒì¼ ë³€ê²½ ìš”ì•½

### ì‹ ê·œ íŒŒì¼

| íŒŒì¼ | Phase | ì—­í•  |
|------|-------|------|
| `utils/korean_normalizer.py` | ê¸°ì´ˆ | 3-Layer ì •ê·œí™” ëª¨ë“ˆ ì „ì²´ |
| `services/normalization_cache.py` | 1 | ê³„ì¸µí™” ìºì‹œ + ì„œí‚·ë¸Œë ˆì´ì»¤ + Rate Limiter |
| `services/typo_candidate_collector.py` | 2 | L3 êµì • í›„ë³´ ìë™ ìˆ˜ì§‘ + Shadow ì‚¬ì „ |
| `services/threshold_tuner.py` | 3 | í‚¤ì›Œë“œ ê·¸ë£¹ë³„ ì„ê³„ê°’ ê´€ë¦¬ + ë¹„ìš©í•¨ìˆ˜ ì¶”ì²œ |
| `routes/normalization_admin_routes.py` | 2, 3 | ê´€ë¦¬ì API (í›„ë³´/Shadow/ì„ê³„ê°’/í†µê³„) |
| `tests/test_korean_normalizer.py` | ê¸°ì´ˆ | ìëª¨ ë¶„í•´, ìœ ì‚¬ë„, í¼ì§€ ë§¤ì¹­, ì‚¬ì „, LLM ëª¨í‚¹, ìºì‹œ |
| `tests/test_typo_tolerance_integration.py` | ê¸°ì´ˆ | ì˜¤íƒ€â†’ì˜¬ë°”ë¥¸ intent ë¼ìš°íŒ… + ê±°ì§“ ì–‘ì„± ë¶€ì¬ í™•ì¸ |
| `tests/test_normalization_cache.py` | 1 | ìºì‹œ + ì„œí‚·ë¸Œë ˆì´ì»¤ + Rate Limiter |
| `tests/test_normalization_events.py` | 1 | ì´ë²¤íŠ¸ í˜ì´ë¡œë“œ + ìƒ˜í”Œë§ |
| `tests/test_typo_candidate_collector.py` | 2 | í›„ë³´ ìˆ˜ì§‘ + Shadow ì‚¬ì „ |
| `tests/test_threshold_tuner.py` | 3 | í‚¤ì›Œë“œ ê·¸ë£¹, ì„ê³„ê°’ ì¡°íšŒ, ì¶”ì²œ, ì˜¤ë²„ë¼ì´ë“œ |

### ìˆ˜ì • íŒŒì¼

| íŒŒì¼ | Phase | ë³€ê²½ ë‚´ìš© |
|------|-------|----------|
| `requirements.txt` | 1 | `redis>=5.0.0` ì¶”ê°€ |
| `docker-compose.yml` | 1 | llm-serviceì— REDIS_HOST/PORT ì—°ê²°, depends_on ì¶”ê°€ |
| `config/constants.py` | 1 | `NormalizationConfig` ë°ì´í„°í´ë˜ìŠ¤ ì¶”ê°€ |
| `service_state.py` | 1 | `redis_client` ì†ì„± ì¶”ê°€ |
| `observability/p4_events.py` | 1 | `QUERY_NORMALIZED` ì´ë²¤íŠ¸ íƒ€ì… ì¶”ê°€ |
| `app.py` | 1 | Redis ì´ˆê¸°í™” (timeout + ì„œí‚·ë¸Œë ˆì´ì»¤ ì—°ë™) |
| `classifiers/answer_type_classifier.py` | ê¸°ì´ˆ, 3 | L2 ì‚¬ì „ ì ìš©, L1 í¼ì§€ ë§¤ì¹­, Phase 3ì—ì„œ `get_keyword_threshold()` ì—°ë™ |
| `workflows/intent_handlers.py` | ê¸°ì´ˆ | í•¸ë“¤ëŸ¬ ë‚´ L1+L2 ì£¼ì… |
| `workflows/chat_workflow_v2.py` | ê¸°ì´ˆ, 1, 2 | L3 ì¬ì‹œë„ + negative ìºì‹œ + ì´ë²¤íŠ¸ ë°œí–‰ + í›„ë³´ ìˆ˜ì§‘ |
| `routes/__init__.py` | 2 | `normalization_admin_bp` blueprint ë“±ë¡ |

---

## 11. í…ŒìŠ¤íŠ¸ í˜„í™©

```
test_korean_normalizer.py           53 passed   (ê¸°ì´ˆ: ìëª¨ ë¶„í•´, ìœ ì‚¬ë„, í¼ì§€ ë§¤ì¹­, ì‚¬ì „, LLM ëª¨í‚¹)
test_typo_tolerance_integration.py  15 passed   (ê¸°ì´ˆ: ì˜¤íƒ€â†’intent ë¼ìš°íŒ… í†µí•©)
test_p0_intent_routing.py           23 passed   (ê¸°ì¡´ íšŒê·€ í…ŒìŠ¤íŠ¸, ë³€ê²½ ì—†ìŒ)
test_normalization_cache.py         48 passed   (Phase 1: ìºì‹œ, ì„œí‚·ë¸Œë ˆì´ì»¤, Rate Limiter)
test_normalization_events.py        20 passed   (Phase 1: ì´ë²¤íŠ¸ í˜ì´ë¡œë“œ, ìƒ˜í”Œë§)
test_typo_candidate_collector.py    13 passed   (Phase 2: í›„ë³´ ìˆ˜ì§‘, Shadow ì‚¬ì „)
test_threshold_tuner.py             46 passed   (Phase 3: ê·¸ë£¹, ì„ê³„ê°’, ì¶”ì²œ, ì˜¤ë²„ë¼ì´ë“œ)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
í•©ê³„                               218 passed, 0 failed
```

`test_classifier_regression.py`ì˜ 6ê°œ ì‹¤íŒ¨ëŠ” **ì´ë²ˆ ë³€ê²½ê³¼ ë¬´ê´€í•œ ê¸°ì¡´ ì´ìŠˆ**ì´ë‹¤ (Priority 1 ì¸í…íŠ¸ ì‹œìŠ¤í…œì´ ë„ì…ëœ í›„ mixed/howto ê¸°ëŒ€ê°’ì´ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì€ ê²ƒ). `test_p0_intent_routing.py`ê°€ í˜„ì¬ ë™ì‘ì˜ ê¶Œìœ„ ìˆëŠ” í…ŒìŠ¤íŠ¸ì´ë‹¤.

---

## 12. Admin API ì—”ë“œí¬ì¸íŠ¸

### Phase 2 ì—”ë“œí¬ì¸íŠ¸

| Method | ê²½ë¡œ | ì„¤ëª… |
|--------|------|------|
| GET | `/api/normalization/stats` | ìºì‹œ + í›„ë³´ ìˆ˜ì§‘ í†µê³„ |
| GET | `/api/normalization/candidates` | í•„í„°ëœ í›„ë³´ ëª©ë¡ (`min_count`, `min_stability` íŒŒë¼ë¯¸í„°) |
| GET | `/api/normalization/shadow-dict` | í˜„ì¬ Shadow ì‚¬ì „ í•­ëª© |
| POST | `/api/normalization/shadow-dict/promote` | í›„ë³´ â†’ Shadow ìŠ¹ê²© (`original_fp`, `corrected_text`) |

### Phase 3 ì—”ë“œí¬ì¸íŠ¸

| Method | ê²½ë¡œ | ì„¤ëª… |
|--------|------|------|
| GET | `/api/normalization/thresholds` | í˜„ì¬ ê·¸ë£¹ë³„ ì„ê³„ê°’ + íŠœë„ˆ í†µê³„ |
| GET | `/api/normalization/thresholds/recommendations` | ë¹„ìš©í•¨ìˆ˜ ê¸°ë°˜ ì„ê³„ê°’ ì¶”ì²œ (min 1000 samples) |
| POST | `/api/normalization/thresholds/override` | ê´€ë¦¬ì ì„ê³„ê°’ ì˜¤ë²„ë¼ì´ë“œ (`keyword_group`, `threshold`) |

**ë³´ì•ˆ**: í”„ë¡œë•ì…˜ì—ì„œ RBACìœ¼ë¡œ ê´€ë¦¬ì roleë§Œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ë³´í˜¸ í•„ìš”.

---

## 13. KPI ì§€í‘œ

| # | KPI | ë°ì´í„° ì†ŒìŠ¤ | ëª©í‘œ |
|---|-----|-----------|------|
| 1 | UNKNOWN ë¹„ìœ¨ | P4 ì´ë²¤íŠ¸ (intent_classified) | ì „ì²´ ì¿¼ë¦¬ì˜ 15% ë¯¸ë§Œ |
| 2 | L3 í˜¸ì¶œ ë¹„ìœ¨ | P4 ì´ë²¤íŠ¸ (query_normalized, l3_called=true) | ì „ì²´ ì¿¼ë¦¬ì˜ 5% ë¯¸ë§Œ |
| 3 | L3 ì¬ë¶„ë¥˜ ì„±ê³µë¥  | P4 ì´ë²¤íŠ¸ (l3_success=true) | L3 í˜¸ì¶œì˜ 60% ì´ìƒ |
| 4 | ê±°ì§“ ì–‘ì„± ì˜ì‹¬ë¥  | ì¬ì§ˆë¬¸ 30ì´ˆ ë‚´ + FP proxy ì‹ í˜¸ | 1% ë¯¸ë§Œ |
| 5 | p95 ì‘ë‹µ ì§€ì—° (L3 ê²½ë¡œ) | Metrics (answer_type_time_ms) | 800ms ë¯¸ë§Œ |
| 6 | Top ì˜¤íƒ€ í›„ë³´ ì•ˆì •ì„± | Candidate collector (stability score) | ìŠ¹ê²© í›„ë³´ 90% ì´ìƒ |

---

## 14. ê°•í™”ëœ ì„¤ê³„ ì›ì¹™ 10ê°€ì§€

| # | ì›ì¹™ | ê·¼ê±° |
|---|------|------|
| 1 | **Redis: "ìˆìœ¼ë©´ ì“°ê³ , í”ë“¤ë¦¬ë©´ ì¦‰ì‹œ í¬ê¸°"** | ì„œí‚·ë¸Œë ˆì´ì»¤ + ì§§ì€ timeout í•„ìˆ˜. Redis ì¥ì• ê°€ ìš”ì²­ p95ë¥¼ ëŠ˜ë¦¬ëŠ” ê²ƒì„ ë°©ì§€. |
| 2 | **ìºì‹œ í‚¤ì— `q_fingerprint` í¬í•¨** | ì´ë²¤íŠ¸â†”ìºì‹œ ì—°ê²°ì„ ìœ„í•´ valueì— full SHA256 fingerprint í¬í•¨. |
| 3 | **ë¶„ë¥˜ ìºì‹œëŠ” non-UNKNOWNë§Œ** | UNKNOWNì„ ìºì‹œí•˜ë©´ ê°œì„  ê¸°íšŒ ì°¨ë‹¨. ë²„ì „ í‚¤ í¬í•¨ (classifier_ver + dict_ver + threshold_ver). |
| 4 | **Negative ìºì‹œëŠ” L3 ì‹¤íŒ¨ í›„ì—ë§Œ** | "confirmed UNKNOWN" = (L1/L2ë¡œ UNKNOWN) AND (L3ë¥¼ í˜¸ì¶œí–ˆì§€ë§Œ ì—¬ì „íˆ UNKNOWN). |
| 5 | **L3 rate limitì€ í´ëŸ¬ìŠ¤í„° ë‹¨ìœ„** | Redis INCR+TTLë¡œ í´ëŸ¬ìŠ¤í„° ì „ì²´ ì œí•œ, Redis ë¶ˆê°€ ì‹œ ë¡œì»¬ í´ë°±. |
| 6 | **ì´ë²¤íŠ¸ ìƒ˜í”Œë§: ì •ìƒ 10%, L3 100%** | ì •ìƒ ì¼€ì´ìŠ¤ëŠ” ìƒ˜í”Œë§, L3/UNKNOWN ì¼€ì´ìŠ¤ëŠ” ì „ìˆ˜ ê¸°ë¡. |
| 7 | **í›„ë³´ ì €ì¥ì€ ZSETìœ¼ë¡œ êµì • ë¶„ì‚° ì¸¡ì •** | `stability = top1_count / total_count`. intent ë¶„í¬ë„ ë³„ë„ ZSET. |
| 8 | **Admin API: RBAC + ê°ì‚¬ ë¡œê·¸** | ì‚¬ì „ ì§ì ‘ ìˆ˜ì • ê¸ˆì§€. ìŠ¹ê²©ì€ ë‹¨ê³„ë³„ (í›„ë³´ â†’ shadow â†’ ìˆ˜ë™ ë°˜ì˜). |
| 9 | **ì„ê³„ê°’ íŠœë‹: FP proxy ì‹ í˜¸ + ìµœì†Œ ìƒ˜í”Œ ê°€ë“œ** | ê·¸ë£¹ë‹¹ ìµœì†Œ 1,000ê±´ ë¯¸ë§Œì´ë©´ ì¶”ì²œ ë³´ë¥˜. FP_WEIGHT=10 > FN_WEIGHT=3. |
| 10 | **í›„ë³´ ìˆ˜ì§‘ ì‹œ PIIëŠ” fingerprintë§Œ ì €ì¥** | `PIIMasker.mask_query()` + fingerprint ì €ì¥. ì›ë¬¸ ë³µì› ë¶ˆê°€ëŠ¥. |
